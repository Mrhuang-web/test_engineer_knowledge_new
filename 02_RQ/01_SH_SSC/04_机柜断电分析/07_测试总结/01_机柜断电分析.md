# 01总结

```
涉及模块为：后端（composite，cabinet）,v2-sc-m-sh-service


实时断电触发逻辑：
	重点：
		只要3路大于阈值-就进入机柜断电的判断（后面只要3路之中有1路满足小于阈值就会触发告警）
		后面3路全部大于单路阈值那就会恢复正常自动消警
		如果未配置，那么应该为空，且不纳入考核中
	1、会定时从es中采集数据到数据表cabinet_history表
	2、cabinet_history有一个标识字段 - 首次进入都是为0
		正常情况下有两个条件：首要条件机柜电流之和>3路之和阈值,通过这个后后面只需要判断每个单路是否小于单路阈值
			首次进入cabinet_history,标识均为0,后台根据设备机柜用电关系配置取到记录 - 进行阈值判断
			满足电流之和>3路之和阈值,标识就会变为1,后面每次更新数据只需要判断单路是否有存在小于单路阈值的,有就告警
	3、触发告警条件,会入库到current表中
	4、每5分钟进行一次判断（取当前时间前5分钟的数据进行判断）
	5、实时/历史维度，采用自增id
	


实时断电消除规则
    1、根据系统采集比对（系统消除）
        消除后，实时删除，然后会到历史里面
    2、手动（需要用户有该按钮权限）
    3、规则消除（修改或编辑规则页面就会将原有实时告警全部消除）
    


语音播报全局告警
	语音播报：
		1、当前与监控视图分开的，只有进入机柜断电分析页面才会进行语音播报
		2、每10s进行一次播报
	全局告警（弹窗）
		1、需要用户有全局告警的权限
		2、告警需要由本地时间与告警事件进行比对
			通过current接口返回的start_time比对
			首次登录：
				目前把登录时间永久存储到了本地，然后拿这个时间和触发的告警时间进行比较
				如果时间>=本地存储时间，就会显示提示 -->  目前是在个人工作平台里面才能看到
				然后就会把触发告警的时间替换到本地里面
					接着进行比较，比较时间>=上一次接口请求时间的数据
					如此重复循环
			已登录且触发告警：
				会把触发告警的时间替换到本地里面
				接着进行比较，比较时间>=上一次接口请求时间的数据
					如此重复循环
            全局告警（弹窗）
                每1min（还是10s）进行一次比对 - 然后进行回显
```





```
数据准备（有对应脚本）
	1、机房-机柜列-机柜-用电关系需要先配置
	2、通过写入cabinet_history数据表 - 实现es同步数据表
	3、触发接口将数据表判断入库到实时告警表中,进行告警
	

curl命令（涉及服务  v2-sc-m-sh-service）：
	curl --location 'http://10.12.12.161:31241/v1/energyCabinet/powerOutage/history/handlePowerRecovery' \ --header 'Content-Type: application/json' \--data '{}'
```





```
业务逻辑梳理（完整版） -- 目前业务链路已经有对应py脚本
	
	前置条件：想要产生告警，先要在配置中配置机房，且开启告警，此次就是配置机柜，且机柜电流测点值满足阈值才会触发
		配置涉及表：
			energy_cabinet_attribute_config  		--> 机柜用电关系配置
			energy_cabinet_mete			     		--> 机柜用电关系配置的测点信息
			energy_cabinet_poweroutage_config		--> 机柜断电阈值配置
			energy_cabinet_poweroutage_config_scope	--> 机柜断电机房范围配置
	
	定时采集es数据到fsu_point_data中(每天都会更新 -- 最上层数据)
	每5分钟回去轮询fsu_point_data数据到cabinet_history表中(首次采集起来,status为0,需要断电分析后更替状态)
		同步到cabinet_history需要调用curl - 分析汇总【cabinet不填，则表示统计全部的机柜数据进来】
		curl --location --request POST 'http://192.178.101.103:9102/v1/energyCabinet/statiscCabinetHisDataMysql' \
		--header 'Authorization: Bearer null' \
        --header 'Head_token: 7ccc1a4a79d37ebb2c992b7c8c4dac10' \
        --header 'RUBICK-AJAX-REQUEST: true' \
        --header 'X-REQUESTED-WITH: XMLHttpRequest' \
        --header 'head_orgAccount: alauda' \
        --header 'head_userName: alauda' \
        --header 'session_state;' \
        --header 'x-request-nonce: 1741083809702' \
        --header 'x-request-timestamp: 1741083809702' \
        --header 'Content-Type: application/json' \
        --data-raw '{
            "cabinetId": "602811e97aae447ebd55316bf537ed43",
            "startTime": "2025-12-25 15:00:00", 
            "endTime": "2025-12-25 15:50:00"
        }'
   
   [与上一步间距不大]每5分钟进行机柜断电的业务判断，满足则会产生告警并纳入energy_cabinet_poweroutage_current表中
		回去检索cabinet_history是否满足三路之和阈值，满足status变更为1，完成前置条件，后续都只判断单路是否满足阈值情况，除非恢复status才会变更
		判断逻辑则为：
			三路情况，两路情况，单路情况
			未配置情况不纳入考核
			各种场景...
		需要触发curl，正则的告警统计
			http://10.12.5.122:31573/v1/energyCabinet/powerOutage/history/handlePowerRecovery
	
	[已产生告警消除]数据会流入energy_cabinet_poweroutage_history中
```

