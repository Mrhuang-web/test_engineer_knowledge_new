# 江苏亚奥门禁通讯协议与韦根协议解析
## 一、江苏亚奥门禁通讯协议解析
### （一）通信基础参数
| 参数 | 配置详情 |
|------|----------|
| 接口类型 | RS485 |
| 波特率 | 9600 |
| 起始位 | 1位 |
| 数据位 | 8位 |
| 停止位 | 1位 |
| 校验方式 | 无校验 |
| 包头标识 | 55H（1字节） |
| 包尾标识 | AAH（1字节） |

### （二）协议帧格式
#### 1. 基础结构
`55H(1字节) + 地址(1字节) + 长度(1字节) + 数据包(最大255字节) + 校验和(1字节) + AAH(1字节)`

#### 2. 字段说明
| 字段 | 详细说明 |
|------|----------|
| 地址 | 取值范围0-255，部分设备地址跳线仅支持部分地址空间 |
| 长度 | 标识数据包的字节数，最大支持255字节 |
| 数据包 | 由1字节命令 + N字节参数/数据组成，核心功能执行载体 |
| 校验和 | 为数据包所有字节的累加和，用于验证数据传输完整性 |

#### 3. 格式示例
`55,7F,02,03,00,03,AA`
- 55：包头
- 7F：设备地址
- 02：数据包长度
- 03：命令字
- 00：命令参数
- 03：校验和（03+00=03）
- AA：包尾

### （三）核心功能命令详解
#### 1. 上报组信息（命令字：01H）
- **命令格式**：`55H + 地址 + 长度(01H) + 命令字(01H) + 校验(01H) + AAH`
- **响应格式**：`55H + 地址 + 长度(09H) + 命令字(01H) + 组类型(8字节) + 校验 + AAH`
- **功能说明**：上报设备8组（0-7）数据类型，每组1字节
- **组类型定义**：
  - 02H：AI（模拟输入）
  - 04H：DI（数字输入）
  - 06H：DO（数字输出）
  - FFH：空
- **门禁组配置**：AI一组、DI一组、DO一组

#### 2. 上报门禁运行数据（命令字：02H）
- **响应格式**：`55H + 地址 + 长度 + 命令字(02H) + 板识别字(1字节) + 数据 + 校验 + AAH`
- **功能说明**：上报各通道实时运行数据
- **关键字段解析**：
  - **板识别字**：高4位为组号（0-7），低4位为组类型（AI=02H、DI=04H、DO=06H），示例：24H表示第3号组为DI类型
  - **数据格式**：
    | 组类型 | 数据长度 | 数据说明 |
    |--------|----------|----------|
    | AI | 16字节（带符号BCD码） | 0-6号通道：门状态（00H=门关、01H=刷卡开门、02H=中心遥控开门、03H=门内开门、04H=非正常开门）；7号通道：未上报记录个数；低字节在前，示例：34,20对应物理值2034 |
    | DI | 1字节 | 0-5号通道有效：0=1号红外告警、1=1号红外正常；2=1号出门按钮按下、3=2号出门按钮按下；4=1号门磁开、5=2号门磁开；仅红外状态供上位机使用 |
    | DO | 1字节 | 0-1号通道有效：1=门锁打开、0=门锁合上，上位机无需干预 |

#### 3. 远程开门控制（命令字：03H）
- **命令格式**：`55H + 地址 + 长度(04H) + 命令字(03H) + 组号 + 通道号 + 动作类型 + 校验 + AAH`
- **功能说明**：远程控制指定门开启
- **参数要求**：
  - 组号：固定02H
  - 通道号：0-1（对应2个门）
  - 动作类型：01H（仅支持开门操作）
- **限制条件**：一次只能控制一个门开门

#### 4. 时间管理命令
| 命令类型 | 命令字 | 格式说明 | 功能细节 |
|----------|--------|----------|----------|
| 查询时间 | 09H | 命令格式：`55H + 地址 + 长度(01H) + 命令字(09H) + 校验(09H) + AAH` | 查询控制器实时时间，内置不掉电时钟；时间格式（16进制）：年（2字节，低字节在前，2000-9999）、月（1字节，1-12）、日（1字节，1-31）、时（1字节，0-23）、分（1字节，0-59）、秒（1字节，0-59） |
| 设置时间 | 10H | 命令/响应格式：`55H + 地址 + 长度(08H) + 命令字(10H) + 时间(7字节) + 校验 + AAH` | 配置控制器时间，时间格式同查询命令 |

#### 5. 卡片管理命令
| 命令类型 | 命令字 | 格式与参数 | 功能说明 |
|----------|--------|------------|----------|
| 发长期卡 | 11H | 命令格式：`55H + 地址 + 长度(05H) + 命令字(11H) + 卡号(4字节) + 校验 + AAH`；响应格式：`55H + 地址 + 长度(06H) + 命令字(11H) + 结果(1字节) + 卡号(4字节) + 校验 + AAH` | 发放长期有效卡（无有效期）；卡号为32位16进制数，低字节在前，不足32位高位补0；不可写卡厂商保证唯一性，可写卡由发卡程序保证 |
| 删除长期卡 | 12H | 命令格式：`55H + 地址 + 长度(05H) + 命令字(12H) + 卡号(4字节) + 校验 + AAH`；响应结果：0=失败、1=成功 | 删除指定长期卡 |
| 发短期卡 | 13H | 命令格式：`55H + 地址 + 长度(0DH) + 命令字(13H) + 卡号(4字节) + 有效期(8字节) + 校验 + AAH`；有效期格式：开始年（2字节）、开始月（1）、开始日（1）、结束年（2）、结束月（1）、结束日（1） | 发放有有效期卡；响应结果：0=失败、1=成功、2=卡已存在（更新有效期） |
| 删除短期卡 | 14H | 命令格式同删除长期卡；响应结果：0=失败、1=成功 | 删除指定短期卡 |
| 删除所有长期卡 | 15H | 命令格式：`55H + 地址 + 长度(01H) + 命令字(15H) + 校验(15H) + AAH` | 批量删除所有长期卡 |
| 删除所有短期卡 | 16H | 命令格式类似删除所有长期卡 | 批量删除所有短期卡 |
| 删除所有卡 | 17H | 命令格式同上 | 删除所有长期卡+短期卡 |

#### 6. 记录与参数查询命令
| 命令类型 | 命令字 | 关键说明 |
|----------|--------|----------|
| 删除所有开门记录 | 18H | 命令格式：`55H + 地址 + 长度(01H) + 命令字(18H) + 校验(18H) + AAH`；响应结果：0=失败、1=成功 |
| 查询参数 | 21H | 命令格式同上；查询参数包括：最新记录位置（0-1499，2字节）、当前有效记录（0-1500，2字节）、未读记录数（0-1500，2字节）、长期卡数（0-1024，2字节）、短期卡数（0-500，2字节）；数据为16进制，低字节在前 |
| 取长期卡 | 22H | 命令格式：`55H + 地址 + 长度(03H) + 命令字(22H) + 序号(2字节) + 校验 + AAH`；按First-Next方式取卡，序号0-1023；响应含卡序号、新序号（-1无后续）、卡号 |
| 取短期卡 | 23H | 命令格式同取长期卡，序号0-499；响应额外含有效期信息 |
| 取开门记录 | 26H | 命令格式同上，序号0-1499；记录原因含门状态（0=关、1=开）和记录状态（1=刷卡、2=遥控、3=门内、4=非正常）；响应含时间、门序号（0-1） |
| 取新开门记录 | 27H | 命令格式：`55H + 地址 + 长度(01H) + 命令字(27H) + 校验(27H) + AAH`；按先入先出取未上报记录，响应格式同取开门记录 |

## 二、韦根协议解析
### （一）协议基础信息
| 项目 | 详情 |
|------|------|
| 制定方 | 摩托罗拉公司 |
| 定位 | 国际统一的门禁系统通信标准，用于读卡器与控制器间数据传输 |
| 核心特点 | 结构简单、抗干扰强、单向通信（默认读卡器→控制器） |
| 传输介质 | 三线制：DATA0（绿色，传输0）、DATA1（白色，传输1）、GND（黑色，信号地） |

### （二）电气特性与传输规则
1. **信号表示**：
   - 二进制0：DATA0线产生负脉冲（3-5V→0V），DATA1保持高电平
   - 二进制1：DATA1线产生负脉冲，DATA0保持高电平
   - 空闲状态：DATA0、DATA1均为高电平
2. **时序参数**：
   - 脉冲宽度（TP）：约100微秒
   - 位周期（TW）：约1600微秒
   - 传输距离：最远150-200米（取决于线缆质量，推荐22AWG线缆）

### （三）常见数据格式
#### 1. 标准26位格式（应用最广泛）
| 位段 | 长度 | 功能说明 |
|------|------|----------|
| 第1位 | 1位 | 偶校验位，覆盖第2-13位，确保该区间含偶数个1 |
| 第2-9位 | 8位 | 设施码（Facility Code），范围0-255，区分不同地点/系统 |
| 第10-25位 | 16位 | 卡号（Card Number），范围0-65535，唯一标识持卡人 |
| 第26位 | 1位 | 奇校验位，覆盖第14-25位，确保该区间含奇数个1 |
- **示例**：地区码01（8位）、卡号0001（16位），韦根输出为`1 00000001 0000000000000001 0`

#### 2. 34位格式
| 位段 | 长度 | 功能说明 |
|------|------|----------|
| 第1位 | 1位 | 偶校验位，覆盖第2-17位 |
| 第2-17位 | 16位 | 设施码（HID码），范围0-65535 |
| 第18-33位 | 16位 | 卡号（PID码），范围0-65535 |
| 第34位 | 1位 | 奇校验位，覆盖第18-33位 |

### （四）协议优势与局限性
| 类别 | 具体内容 |
|------|----------|
| 优势 | 1. 硬件实现简单，成本低，仅需3根线连接<br>2. 差分信号传输，抗电磁干扰能力强<br>3. 兼容性广，支持HID、Indala等主流卡片<br>4. 静态功耗低（Iq<1mA），适合门禁低功耗场景 |
| 局限性 | 1. 单向通信，无法实现控制器→读卡器数据反馈<br>2. 传输速率低（几Kbps），仅适用于卡号等短数据传输<br>3. 校验能力弱，仅能检测单比特错误，无纠错功能<br>4. 数据格式不统一（26/34/37位等），需设备间匹配 |

### （五）实际应用注意事项
1. **接线规范**：严格区分DATA0（绿）、DATA1（白）、GND（黑），避免接反导致数据传输失败
2. **抗干扰措施**：布线时远离强电线路（如220V电源线），超过50米建议使用屏蔽线缆
3. **接收处理**：控制器需采用外部中断接收数据，避免查询方式导致丢帧（查询延迟可能错过脉冲信号）
4. **安全增强**：现代系统可结合动态码生成、AES-128加密、双向认证等方式提升数据安全性，弥补协议原生安全短板

## 三、江苏亚奥门禁协议与韦根协议关联对比
| 维度 | 江苏亚奥门禁协议 | 韦根协议 |
|------|------------------|----------|
| 应用层级 | 门禁控制器与上位机/管理系统间的通信协议 | 读卡器与门禁控制器间的物理层传输协议 |
| 通信方向 | 双向（上位机发命令+控制器响应） | 单向（默认读卡器→控制器） |
| 数据内容 | 门状态、卡片管理、时间配置、记录查询等完整门禁功能数据 | 仅卡号、设施码等身份标识数据 |
| 帧结构 | 含地址、长度、命令、校验等字段，结构复杂 | 仅脉冲序列，无复杂帧结构 |
| 典型应用 | 上位机远程控制开门、批量卡片管理、历史记录查询 | 读卡器读取卡片信息后传输给控制器 |
| 协同场景 | 韦根读卡器将卡号传输至江苏亚奥门禁控制器，控制器通过亚奥协议向上位机上报数据/接收控制命令 |