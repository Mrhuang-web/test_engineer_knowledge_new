# 钛迪ES2200门禁控制器协议详细文档

## 1. 协议概述
钛迪ES2200门禁控制器协议是深圳市纽贝尔电子有限公司的门禁通讯协议，采用RS485/RS422通信接口，用于门禁系统的监控和控制。

## 2. 通信参数
- 接口类型：RS485/RS422
- 通信速率：1200bps, 2400bps, 4800bps, 9600bps, 19200bps, 38400bps
- 数据格式：1起始位，8数据位，1停止位
- 校验方式：无校验

## 3. 协议格式

### 3.1 基本格式
| 序号 | 字段 | 字节数 | 符号 | 说明 |
|------|------|--------|------|------|
| 1 | 起始符 | 1 | SOI | 发送信息起始符=7EH（START OF INFORMATION） |
| 2 | 版本 | 1 | SEQ/VER | 通信协议的版本（=10H，表示1.0） |
| 3 | 组内地址 | 1 | ADR | 被定名设备的RS485/RS422网上地址（设备ID）（有效值：1-254） |
| 4 | 类码与组地址 | 1 | CID1 | D7—D4为设备分类码（门禁控制类=8）；D3—D0为设备分组号（0—15） |
| 5 | 类别 | 1 | CID2/RTN | 主控制机发送命令时为CID2，SM回答时为RTN |
| 6 | 参数长度校验 | 2 | L.TH | 携带参数的长度标识部分 |
| 7 | 参数 | N字节 | INFO | 传递的信息部分 |
| 8 | 桢校验 | 2 | CHK-SUM | 传送一桢信息的检查和 |
| 9 | 结束符 | 1 | EOI | 发送信息结束符=0DH（END OF INFORMATION） |

### 3.2 数据传输方法
- SOI（=7EH）, EOI（=0DH）是按单字节(HEX)直接发送
- 其它(从VER至SUM结束)都是将单字节(HEX)按高半4位(0-9,A-F)、低半4位(0-9,A-F)拆分开，按ASCII码发送，先高4位ASCII码，后低4位ASCII码

### 3.3 通信类型
- 设置SM的权限确认
- 设置SM参数命令
- 读取SM信息的命令

### 3.4 命令帧格式

#### 3.4.1 SU发送命令帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号（从0X10开始） |
| 3 | ADR | 1 | 设备地址（1-254） |
| 4 | CID1 | 1 | 设备类型标识（高半字节=8） |
| 5 | CID2 | 1 | 命令分类码 |
| 6 | L.TH | 2 | 数据信息部分字节长度 |
| 7 | COMINFO | N | 命令参数 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

#### 3.4.2 SM对SU的设置命令的应答帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号 |
| 3 | ADR | 1 | 设备地址 |
| 4 | CID1 | 1 | 设备类型标识 |
| 5 | RTN | 1 | 处理结果 |
| 6 | L.TH | 2 | 0,0 |
| 7 | 无 | - | 无 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

#### 3.4.3 SM对SU读取命令的返回帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号 |
| 3 | ADR | 1 | 设备地址 |
| 4 | CID1 | 1 | 设备类型标识 |
| 5 | RTN | 1 | 处理结果 |
| 6 | L.TH | 2 | 数据信息部分字节长度 |
| 7 | DATAINFO | N | 返回数据 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

## 4. 功能分类

### 4.1 访问权限的确认
用于确认用户的访问权限

### 4.2 设置命令
用于设置门禁设备的参数

### 4.3 读取信息命令
用于读取门禁设备的信息

## 5. 注意事项

1. 通信速率可以根据实际情况设置，但SM内应有改变速率的机制
2. 协议版本号必须匹配，否则会导致命令执行失败
3. 设备地址必须在有效范围内（1-254）
4. 设备分类码必须正确设置（门禁控制类=8）
5. 校验和必须正确计算，否则会导致命令执行失败
6. 数据传输时需要注意SOI和EOI的特殊处理

## 6. 典型应用流程

1. 初始化RS485/RS422通信接口
2. 构建SU发送命令帧，包括起始符、版本号、地址、分类码、长度、命令参数、校验和和结束符
3. 发送命令帧到门禁设备
4. 接收门禁设备的应答帧
5. 解析应答帧，提取处理结果和返回数据
6. 根据处理结果执行相应的操作
7. 定期轮询门禁设备的状态，实现实时监控

## 7. 故障处理

1. 通信超时：检查通信线路、设备地址和通信参数
2. 命令执行失败：检查命令格式、校验和、版本号是否正确
3. 数据解析错误：检查返回数据的格式是否符合协议要求
4. 处理结果异常：根据RTN值查找对应的错误原因

## 8. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令分类码实现
- 扩展后的协议必须保持向前兼容性

## 9. 开发建议

1. 建议使用RS485/RS422通信库简化开发工作
2. 实现命令超时重发机制，提高通信可靠性
3. 定期检查设备的运行状态，及时发现故障
4. 实现数据缓存机制，防止数据丢失
5. 遵循协议规范，确保与设备的正常通信
6. 注意数据传输时的特殊处理，特别是SOI和EOI字段
7. 正确计算和验证校验和，确保数据完整性