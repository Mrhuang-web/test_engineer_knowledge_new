# 前提事项

## 前提描述

```
快速接入新国标B服务

    1、启动新国标模拟器：
        SVN目录/spider-doc/public/08系统测试/05测试工具/simfsu_newstandard
        主要修改config.py 指定fsu数据库、模拟器端口、B-server端口（或者nginx代理的端口）
    2、/spider-doc/public/08系统测试/05_测试工具/sim_fsu_newstandard/数据准备.py (指定fsuID)
    3、注册前修改 t_cfg_fsu表username和password
        即要与数据准备中，写入中间库fsu表中的username和password一致
    4、模拟器页面-注册fsu
    5、模拟器页面-配置上报




B接口接入
    新增fsu时需要手动配置 新增fsu时，需要手动配置用户名密码
    	通过接口（/v1/binterface/reloadFsuInfoCache）进行刷新缓存
    在我们进行fsu数据准备（模拟器的中的《数据准备.py》）
    	后将fsu表的对应的fsu的username和password同步到t_cfg_fsu表
    fsu注册Bclient会检查：
    	B接口fsu中的username和password 与t_cfg_fsu中的user_name和password(加密 s256+大写)做对比
    	
    	




docker部署
	docker启动脚本注意binterface-service-client的APPLICATION_NAME=必须是binterface-service
	
    docker run —name $i-server-gz-p1 —net host —log-driver=json-file —log-opt max-size=30m —log-opt max-file=3 —env spring.cloud.inetutils.preferred-networks=$ip —env RUN_MODE=server —env SERVER_PORT=13567 —env APPLICATION_NAME=$i-server-gz-p1 —env ENV_NACOS=10.1.203.120:8848 —env ENV_TYPE=guizhou —env ENV_NACOS_PASSWORD=’D&V2HR43TutFjf%aKqk’ -v /tmp/logs/$a:/opt/data/logs/ -d 10.1.6.34:8080/spider/gemc/$i:$tag


	docker run —name $i-client-gz-p1 —net host —log-driver=json-file —log-opt max-size=30m —log-opt max-file=3 —env spring.cloud.inetutils.preferred-networks=$ip —env RUN_MODE=client —env SERVER_PORT=13565 —env APPLICATION_NAME=binterface-service —env ENV_NACOS=10.1.203.120:8848 —env ENV_TYPE=guizhou —env ENV_NACOS_PASSWORD=’D&V2HR43TutFjf%aKqk’ -v /tmp/logs/$a:/opt/data/logs/ -d 10.1.6.34:8080/spider/gemc/$i:$tag


	docker run —name $i-dataHandle-gz-p1 —net host —log-driver=json-file —log-opt max-size=30m —log-opt max-file=3 —env spring.cloud.inetutils.preferred-networks=$ip —env RUN_MODE=dataHandle —env SERVER_PORT=13563 —env APPLICATION_NAME=$i-dataHandle-gz-p1 —env ENV_NACOS=10.1.203.120:8848 —env ENV_TYPE=guizhou —env ENV_NACOS_PASSWORD=’D&V2HR43TutFjf%aKqk’ -v /tmp/logs/$a:/opt/data/logs/ -d 10.1.6.34:8080/spider/gemc/$i:$tag




B接口服务器组【 nginx文件配置  -- 可以通过ps -ef|grep  nginx找到对应文件目录看配置 】
      upstream binterfaceBackend {
          server 12.11.11.111:18183;
          server 12.11.11.113:18184;
      }
      server {
        listen 28080;  
        server_name 12.11.11.111;  
        client_max_body_size 100M;  
        underscores_in_headers on;  
        location / {      
        	#root   /usr/local/nginx/html;      
        	#index  index.html index.htm;      
        	proxy_pass http://binterfaceBackend;      
        	proxy_pass_request_headers on;     
        	proxy_set_header Host $host:$proxy_port;      
        	proxy_set_header X-Real-IP $remote_addr;      
        	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      
        	add_header 'Access-Control-Allow-0rigin' '*';      
        	add_header 'Access-Control-Allow-Methods' 'GET,POST,DELETE';      
        	add_header 'Access-Control-Allow-Header' 'Content-Type,*';  }
    }
```

```
数据库必要表【针对新企标的】

CREATE TABLE t_cfg_fsu_command_config (
id int(11) NOT NULL AUTO_INCREMENT COMMENT ‘id’,
fsu_id varchar(255) NOT NULL COMMENT ‘fsu设备的id’,
command varchar(1024) NOT NULL COMMENT ‘下发指令’,
isdel tinyint(1) NOT NULL DEFAULT ‘0’ COMMENT ‘是否删除’,
PRIMARY KEY (id)
) ENGINE=InnoDB COMMENT=’fsu下发指令配置’;

ALTER TABLE t_cfg_fsu ADD udp_port INT DEFAULT NULL COMMENT ‘udp端口’;
ALTER TABLE t_cfg_fsu ADD new_version INT DEFAULT 0 COMMENT ‘是否为新企标，1：是，0：否，默认为0’;
ALTER TABLE t_cfg_fsu ADD user_name VARCHAR(32) DEFAULT NULL COMMENT ‘用户名’;
ALTER TABLE t_cfg_fsu ADD pass_word VARCHAR(256) DEFAULT NULL COMMENT ‘密码’;
ALTER TABLE t_cfg_fsu ADD sftp_port INT DEFAULT NULL COMMENT ‘sftp端口’;




CREATE TABLE t_cfg_telesignal (
device_id VARCHAR(50) NOT NULL COLLATE ‘utf8_general_ci’,
lsc_id VARCHAR(20) NOT NULL COLLATE ‘utf8_general_ci’,
device_type INT(11) NULL DEFAULT NULL,
mete_id VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
mete_name VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
raw_mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
up_effect INT(11) NULL DEFAULT NULL,
low_effect INT(11) NULL DEFAULT NULL,
mete_index INT(11) NULL DEFAULT NULL,
mete_cid BIGINT(50) NULL DEFAULT NULL,
signal_kind INT(11) NULL DEFAULT NULL,
last_value INT(11) NULL DEFAULT NULL,
last_time DATETIME NULL DEFAULT NULL,
explain_type INT(11) NULL DEFAULT ‘0’,
report_type INT(11) NULL DEFAULT NULL,
report_level INT(11) NULL DEFAULT NULL,
mask_type INT(11) NULL DEFAULT NULL,
mask_mid VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mask_string VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mask_value INT(11) NULL DEFAULT NULL,
delay_time INT(11) NULL DEFAULT NULL,
description VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
isshield INT(11) NULL DEFAULT NULL,
storageperiod BIGINT(20) NULL DEFAULT NULL,
describer VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
alarmthresbhold INT(11) NULL DEFAULT NULL,
alarmlevel INT(11) NULL DEFAULT NULL,
link_mete_id VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
PRIMARY KEY (device_id, mete_id) USING BTREE
)
COLLATE=’utf8_general_ci’
ENGINE=InnoDB
ROW_FORMAT=DYNAMIC
;



CREATE TABLE t_cfg_telemeter (
device_id VARCHAR(50) NOT NULL COLLATE ‘utf8_general_ci’,
lsc_id VARCHAR(20) NOT NULL COLLATE ‘utf8_general_ci’,
device_type INT(11) NULL DEFAULT NULL,
mete_id VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
mete_name VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
up_effect FLOAT NULL DEFAULT NULL,
low_effect FLOAT NULL DEFAULT NULL,
mete_precision INT(11) NULL DEFAULT NULL,
unit VARCHAR(16) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mete_index INT(11) NULL DEFAULT NULL,
mete_cid BIGINT(50) NULL DEFAULT NULL,
mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
raw_mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
limit_band FLOAT NULL DEFAULT NULL,
change_limit FLOAT NULL DEFAULT NULL,
valid_mid VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
valid_string VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
invalid_value FLOAT NULL DEFAULT NULL,
last_value FLOAT NULL DEFAULT NULL,
last_time DATETIME NULL DEFAULT NULL,
description VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
hilimit1 FLOAT NULL DEFAULT NULL,
lolimit1 FLOAT NULL DEFAULT NULL,
hilimit2 FLOAT NULL DEFAULT NULL,
lolimit2 FLOAT NULL DEFAULT NULL,
hilimit3 FLOAT NULL DEFAULT NULL,
lolimit3 FLOAT NULL DEFAULT NULL,
hilimit4 FLOAT NULL DEFAULT NULL,
lolimit4 FLOAT NULL DEFAULT NULL,
stander FLOAT NULL DEFAULT NULL,
isshield INT(11) NULL DEFAULT NULL,
storageperiod BIGINT(20) NULL DEFAULT NULL,
absoluteval FLOAT NULL DEFAULT NULL,
relativeval FLOAT NULL DEFAULT NULL,
link_mete_id VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
expression TEXT NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
expression_desc TEXT NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
PRIMARY KEY (device_id, mete_id) USING BTREE,
INDEX index_t_cfg_telemeter_1 (mete_id) USING BTREE
)
COLLATE=’utf8_general_ci’
ENGINE=InnoDB
ROW_FORMAT=DYNAMIC
;




CREATE TABLE t_cfg_telecontrol (
device_id VARCHAR(50) NOT NULL COLLATE ‘utf8_general_ci’,
lsc_id VARCHAR(20) NOT NULL COLLATE ‘utf8_general_ci’,
device_type INT(11) NULL DEFAULT NULL,
mete_id VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
mete_name VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mete_code VARCHAR(20) NULL DEFAULT NULL COLLATE ‘utf8_bin’,
raw_mete_code VARCHAR(20) NULL DEFAULT NULL COLLATE ‘utf8_bin’,
mete_index INT(11) NULL DEFAULT NULL,
mete_cid BIGINT(50) NULL DEFAULT NULL,
control_status INT(11) NULL DEFAULT NULL,
control_value INT(11) NULL DEFAULT NULL COMMENT ‘控制参数’,
enable_string VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
succeed_string VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
trigger_string VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
describer VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
description VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
PRIMARY KEY (device_id, mete_id) USING BTREE
)
COLLATE=’utf8_general_ci’
ENGINE=InnoDB
ROW_FORMAT=DYNAMIC
;



CREATE TABLE t_cfg_teleadjust (
device_id VARCHAR(50) NOT NULL COLLATE ‘utf8_general_ci’,
lsc_id VARCHAR(20) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
device_type INT(11) NULL DEFAULT NULL,
mete_id VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
mete_name VARCHAR(256) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
raw_mete_code VARCHAR(20) NOT NULL COLLATE ‘utf8_bin’,
up_effect FLOAT NULL DEFAULT NULL,
low_effect FLOAT NULL DEFAULT NULL,
mete_precision INT(11) NULL DEFAULT NULL,
unit VARCHAR(16) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
mete_index INT(11) NULL DEFAULT NULL,
mete_cid BIGINT(50) NULL DEFAULT NULL,
adjust_kind INT(11) NULL DEFAULT NULL,
last_value FLOAT NULL DEFAULT NULL,
last_time DATETIME NULL DEFAULT NULL,
description VARCHAR(512) NULL DEFAULT NULL COLLATE ‘utf8_general_ci’,
stander FLOAT NULL DEFAULT NULL,
controlenable INT(11) NULL DEFAULT NULL,
PRIMARY KEY (device_id, mete_id) USING BTREE
)
COLLATE=’utf8_general_ci’
ENGINE=InnoDB
ROW_FORMAT=DYNAMIC
;
```



## 文件准备

- B接口镜像选择【目前有GEMC - 即广东的，SNEMS - 即陕西的】
  - 通过进入CICD、流水线搜索binter
  - 选择对应环境B接口【通过流水线名称跳转；或构建详情跳转】即可查看对应镜像
  - 同时注意：需要把端口改成8080
  - ![image-20250921004113333](../00_插图/03_B接口从0到1搭建【服务器版】.assets/image-20250921004113333.png)
- 

```
广东为例
 
文件准备
	B接口镜像选择【目前有GEMC - 即广东的，SNEMS - 即陕西的】
		
	

文件部署注意事项
	需要吧一个binter镜像拆分成三个子节点
	还需要有一个ftp的镜像
	然后kafka，可以重启，或是连已有的【怎么连？】
	然后ng代理配置
		需要找到ng对应位置，参考已有的b接口的ng配置是怎么样的
		ps -ef|grep nginx
```







