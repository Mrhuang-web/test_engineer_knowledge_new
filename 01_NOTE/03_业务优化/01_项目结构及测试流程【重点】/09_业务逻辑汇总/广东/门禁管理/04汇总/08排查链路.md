# 01事件排查

```
事件由entrance服务发起

1、先检查entrance_command topic指令（由entrance服务自行下发发起的）
2、接着检查decode服务（消费的topic）
3、接着检查entrance_encode_command（decode对entrance_command的编码）
4、检查gateway-center服务（是否消费entrance_encode_command）
5、检查模拟器（是否接收到gateway-center消费下发的请求）
6、检查模拟器是否组装返回指令（即是否有fsu --> 向动环的指令）
7、检查center服务是否接收设备响应
8、检查entrance_raw_data topic（由center接收到模拟器响应后打过来的）
9、检查decode服务（是否消费 entrance_raw_data 的响应）
    │  │  - 接收设备响应                                          │  │
    │  │  - 从缓存获取请求信息                                    │  │
    │  │  - 解码响应                                              │  │
    │  │  - 应答队列 (AckPendingQueue.ack)                        │  │
10、检查entrance_decode_command topic（由decode解析响应后的设备响应）
	特别注意：
		entrance_decode_command来判断回包是否存在问题，分析response是否为this device has non-response struct
		根据协议和回的包进行判断
		再结合entrance_encode_command，判断是否是没有下发导致回复失败
11、检查entrance服务（是否最后消费了entrance_decode_command的设备响应）


确保模拟器和center服务时间一致
	entrance下发时间（入kafka时间）
	decode消费时间
	center消费时间 
	模拟器回应时间

日志过滤
	entrance和decode，可以根据模拟器端口号进行过滤
	entrance -->
		事件连接失败
		协议名称（可以看是否是编码什么的不满足要求）
```



```
日志快速排查指令
    下发指令排查
    
    docker logs --tail 4000 -f iot-center2 | awk '
    /下发给设备10.12.5.142：10107/ { 
        thread=$6; 
        print "\n【指令】", $0; 
        next 
    }
    $6==thread && /message=/ { 
        print "【报文】", $0; 
        thread="" 
    }
    '

	上送指令排查
	
	补充




	组合排查
	docker logs --tail 4000 -f iot-center2 | awk '
    # 模式1：10107 指令下发
    /下发给设备10.12.5.142：10107/ { 
        thread=$6; 
        print "\n【10107指令下发】", $0; 
        next 
    }
    $6==thread && /message=/ && thread!="" { 
        print "【10107指令报文】", $0; 
        thread=""; 
        next 
    }

    # 模式2：10116 响应处理
    /接收到10.12.5.142:10107的数据/ { 
        thread2=$6; 
        print "\n【10107收到数据】", $0; 
        next 
    }
    $6==thread2 && /发送设备10.12.5.142:10107响应消息/ { 
        print "【10107发送响应】", $0; 
        thread2=""; 
        next 
    }
    '





日志捕捉：
	docker logs --tail 10000 iot-center2 > /tmp/iot.log
	
修改时间：
	sudo date -s "2026-01-30 23:18:00"   临时
	
	永久
	# 关闭 NTP 时间同步（如果开启的话）
    sudo timedatectl set-ntp false

    # 设置日期时间
    sudo timedatectl set-time "2025-01-30 14:30:00"

    # 重新开启 NTP 同步（如果需要）
    sudo timedatectl set-ntp true
```









```
疑问：
	为啥raw_data -- 同个ip端口，1s内打了很多个数据到topic（43条）--> 3*2*3
```

