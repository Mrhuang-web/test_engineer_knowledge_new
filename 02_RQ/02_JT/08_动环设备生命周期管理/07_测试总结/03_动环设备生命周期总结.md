# 01总结

```
数据关联：
	涉及到综资数据【综资同步到es中,目前测试环境中es数据很多脏数据,即综资动环设备id（sys_device_id）是空的,导致无法和动环的关联】
	只有把综资设备id和动环设备id进行匹配,再对动环id设备进行历史告警写入,才能进行统计
	如果需要有效数据,需要找雨涵到现网捞es综资数据,然后本地进行导入到es中（目前实现脚本进行方向写入-即动环写入到es）

服务
	hidden服务（后端明林，前端贵荣）
	
告警创建
	主要是通过综资的power_device_id  -- >  然后动环的power_device_id字段，关联上综资里面的

字段说明：
	更新周期：每天或是触发器，让拿到es数据，然后把数据与mysql的周期字典匹配，然后统计后到详情表
	在网时长：是通过综资时间和当前时间的差进行的
	超期服役：通过计算出来的在网时长/周期
	其余的都是取综资表
	具体字段根据需求文档中陕西参考中查看
	
匹配逻辑：
	1、先校验批次（即zz_data_sync_info对应批次信息）
	2、通过映射表匹配或是名称匹配（匹配站点和机房 -- 仅数据中心和通信枢纽楼[核心机楼]）
	3、满足（站点、机房已经与动环匹配的设备，则记录到设备详情表中）
	4、再通过对应的power_device_id,把综资和动环的设备关联起来
	5、这样子触发动环告警,就会进行统计,统计为动环设备【即目前关联的综资】后的告警
		其实就相当于动环的是动态的告警统计,综资的是静态的设备信息,两者结合
		就即知道动态情况,和原始设备情况
		统计好像是dwd还是啥来着【alert告警索引】

业务逻辑：
	设备详情表【来源综资 - 与综资es数据做比较 - 选一到两个区域即可】：
		注意：es综资同步过来的,需要机房映射表中有对应的动环id[dh_name]  -- 好像是综资里面的关系、只是说也可以关联到动环的
		
		不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
	
	设备生命周期【来源详情表 - 与详情表做比较 - 选一到两个区域即可】：
		只统计12种设备类型
		注意：统计的都只是12种设备类型的四种服役类型、且注意[高压直流电源类型未加入 -- 后面优化好像加入了]
		
		统计分析：
			统计逻辑：超期服役包含 - >=150和<150[总数多加了一次>=150,总数的已修改,其余按原需求即可]
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		设备分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		厂家分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		地市分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
	生命周期-统计分析-过滤省份没有设备的，不需要展示
	生命周期-地市统计-目前高压直流没有数据
```



```
涉及es模式
    注意：
        需要连接的es数据表【10.1.203.38:9200】
    综资-原始数据   [接口字段与es表字段一致]
    	具体映射关系：查看zz_data_sync_info
        空间表
            站点报表：（es）ods_zz_area_site_202508
            柳州柳江县恒创通讯器材经营部:2017-5

            机房报表：（es）ods_zz_area_room_202508
        动环属性表
            站点动环属性表：ods_zz_site_property_2025
            机房动环属性表：ods_zz_room_property_2025
            变压器设备报表：ods_zz_device_pe_transform_2025
            变换设备：
            开关电源：ods_zz_device_pe_switch_power_2025
            智能电表：ods_zz_device_pe_smart_mete_2025
            动环监控：ods_zz_device_pe_power_monitor_2025
            发电机组：ods_zz_device_pe_power_generation_2025
            低压直流配电：ods_zz_device_pe_low_dc_distribution_2025
            低压交流配电：ods_zz_device_pe_low_ac_distribution_2025
            高压直流电源：ods_zz_device_pe_high_power_2025
            高压配电设备：ods_zz_device_pe_high_distribution_2025
            高压直流配电：ods_zz_device_pe_high_dc_distribution_2025
            节能设备：ods_zz_device_pe_energy_save_2025
            ods_zz_device_pe_battery_li_202508
            蓄电池：ods_zz_device_pe_battery_202508
            空调：ods_zz_device_pe_air_202508
            其他：ods_zz_device_pe_other
        动环(站点、机房)属性表
            ods开头 -- 映射关联表（即es索引与索引的映射）
```



```
业务表：
    overdue_device_detail 超期服役-设备详情表’;
        有sys_device_id才会显示【这个是综资的设备id,需要用这个id结合触发curl,来实现与动环的关联】	
    overdue_count_total 超期服役-统计分析总表’;
    overdue_count_device 超期服役-设备类型统计分析报表’;
    overdue_count_manufactor 超期服役-厂家统计分析报表’;
    overdue_count_city 超期服役-地市统计分析报表’;
    overdue_device_alert_monthly 超期服役-设备月度告警频次表’;
    overdue_device_type_dict 超期服役-配置字典表； — 20231108 逻辑从代码迁移到数据库表配置完成


触发器、定时器
	# 一次执行全部,但是会按顺序执行
	curl --location --request GET 'http://localhost:28028/v1/hiddenDanger/startOverdueAll'
	
	# 仅执行详情表
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue1"
	【下面分析汇总表，都是会有每天的日期的，具体存多少天的就不清楚了】
	详情表 - 需要前面的同步完，执行后才有数据，不然执行后，当天的数据就是0
			例如：今天是28号，但是详情表是昨天数据，那么执行后，分析总表就没有对应数据
	# 仅统计分析
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue2"
	# 仅设备
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue3"
	# 厂家
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue4"
	# 仅地市
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue5"

    2.定时任务默认配置
        ${
            overdue.cron:0 0 4 * * ?
        }

    3、告警触发
        curl --location --request GET 'http://localhost:28028/v1/hiddenDanger/startOverdueAlert?202508'
```











## 附录

| ***\*设备类型\**** | ***\*设备子类\****                                           | ***\*更新周期\**** |
| ------------------ | ------------------------------------------------------------ | ------------------ |
| 变压器             | 全部                                                         | 15年               |
| 高压配电           | 全部                                                         | 15年               |
| 高压直流电源       | 全部                                                         | 10年               |
| 高压直流配电       | 全部                                                         | 15年               |
| 低压交流配电       | 全部                                                         | 15年               |
| 发电机组           | 全部                                                         | 15年               |
| 开关电源           | 全部                                                         | 12年               |
| 低压直流配电       | 全部                                                         | 15年               |
| UPS设备            | 全部                                                         | 10年               |
| 蓄电池             | 1.UPS铅酸电池                                                | 6年                |
|                    | 2.操作电源铅酸电池                                           | 8年                |
|                    | 3.发电机组铅酸电池                                           | 6年                |
|                    | 4.高压直流铅酸电池                                           | 8年                |
|                    | 5.开关电源锂电池                                             | 10年               |
|                    | 6.开关电源铅酸电池                                           | 8年                |
|                    | 7.直流屏铅酸电池                                             | 8年                |
| 空调               | 1.设备类型为普通空调时更新周期6年；                          | 6年                |
|                    | 2.设备类型为其他（机房专用空调、中央空调末端），设备子类为恒湿机、柜式空调 | 6年                |
|                    | 3.设备子类为风冷专用空调                                     | 8年                |
|                    | 4.设备类型为其他（机房专用空调、中央空调末端），设备子类为列间空调、嵌入式空调、热管背板、双冷源专用空调、水冷专用空调 | 10年               |
| 动环监控           | 1.设备子类为FSU、CSC、LSC                                    | 5年                |
|                    | 2.设备子类为蓄电池采集设备                                   | 8年                |





| 设备类型     | device_type     |      |      |
| ------------ | --------------- | ---- | ---- |
| 地市         | city_id         |      |      |
| 站点         | related_site    |      |      |
| 设备标识     | res_code        |      |      |
| 机房         | related_room    |      |      |
| 设备子类     | device_subclass |      |      |
| 设备名称     | zh_label        |      |      |
| 厂家         | vendor_id       |      |      |
| 型号         | product_name    |      |      |
| 开始使用时间 | start_time      |      |      |
| 入网时间     | start_time      |      |      |
|              |                 |      |      |

***\*超期服役设备详情表\****

| 字段           | 字段说明                                                     |      |      |
| -------------- | ------------------------------------------------------------ | ---- | ---- |
| 日期           | 根据综资表的日期                                             |      |      |
| 设备类型       | 综资device_type                                              |      |      |
| 地市           | 综资city_id                                                  |      |      |
| 站点           | 综资related_site                                             |      |      |
| 设备标识       | 综资res_code                                                 |      |      |
| 机房           | 综资related_room                                             |      |      |
| 设备子类       | 综资device_subclass                                          |      |      |
| 设备名称       | 综资zh_label                                                 |      |      |
| 厂家           | 综资vendor_id                                                |      |      |
| 型号           | 综资product_name                                             |      |      |
| 开始使用时间   | 综资start_time                                               |      |      |
| 入网时间       | start_time                                                   |      |      |
| 在网运行时长   | 计算，现在时间（默认前一天的时间）-start_time                |      |      |
| 更新周期       | 根据设备类型按以下表的更新周期填对应年                       |      |      |
| 服役年限分区段 | 更新周期的百分比可配，比如80%，现默认70%，比例可配，根据配置的计算（现在时间-start_time）/更新周期，本字段枚举，若更新周期<（现在时间-start_time），则为“超期服役”；若更新周期>（现在时间-start_time），且（现在时间-start_time）/更新周期<70%的更新周期，则为“<70%”；若更新周期>（现在时间-start_time），且（现在时间-start_time）/更新周期>70%的更新周期，则为“>70%在超期内”； |      |      |
| 动环系统设备ID | 综资power_device_id                                          |      |      |
| 故障告警频次   | 关联动环系统的device_id，默认计算该设备近一个自然月的告警次数，进行累加，如果没有一月的告警数据以从开始有的告警开始进行累加；其中告警统计周期可以进行设置，设置从几月到几月，比如2023年-1到2023年-3；最早只能选到当前时间（查询条件日期）的上月，因为当前月份数据不完整不能统计； |      |      |