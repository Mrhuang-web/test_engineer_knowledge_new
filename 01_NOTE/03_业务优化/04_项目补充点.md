# B接口操作



# C接口操作



# 机柜【B接口 v通用】

## 机柜管理

配置机柜列和机柜的（增、删、改、配置用电关系（供电路由1、2、3、4的电压电流功率电能测点设置））
**一个供电路由内设置的设备应该是同一个**（目前前端还未限制）

#### 机柜配置-报表-可视化页面-数据准备

```
机柜列和机柜都在路由1和路由2的电能和功率配置测点数据
ES中相关设备测点数据每小时写一条数据
机房内接入FSU
```

- 报表数据计算

  ```
  `curl "http://10.12.3.79:28091/v1/energy/scheduleCabinetReport?dayDate=2024-10-31&roomId=" 
  
  curl "http://10.12.3.79:28091/v1/energy/scheduleCabinetColumnReport?dayDate=2024-10-31&roomId="`
  ```

- 广西报表数据计算

```
curl "http://localhost:9101/v1/energy/scheduleCabinetReport?dayDate=2025-06-13&roomId=01-07-05-02-40-01" 

curl "http://localhost:9101/v1/energy/scheduleCabinetColumnReport?dayDate=2025-06-13&roomId=01-07-05-02-40-01" 

curl "http://localhost:9101/v1/energy/scheduleCabinetReport?dayDate=2025-06-13&roomId=01-07-05-02-40-03" 

curl "http://localhost:9101/v1/energy/scheduleCabinetColumnReport?dayDate=2025-06-13&roomId=01-07-05-02-40-03"
```

- 可视化相关数据计算

  ```
  curl --location 'http://localhost:28091/v1/cabinet/view/testTask' \ --header 'Head_orgaccount: alauda' \ --header 'Head_username: alauda' \ --header 'Content-Type: application/json' \ --data '{ }'
  ```

  #### 机柜视图管理-设置机房排列展示方式

  energy_cabinet_column_view

  #### 机柜可视化-机柜详情

- 机房温湿度 017302、017301
  综合-实时数据-/v1/currentmonitor/getMeasureVal?namespace=alauda

- 机柜能耗总电量-机柜报表的总电量（能耗管理-机柜报表分析-机柜报表-机柜总电量（kWh））

  ```
  curl "http://10.1.203.121:9991/v1/energy/scheduleCabinetReport?dayDate=2024-04-13&roomId="
  ```

  energy_cabinet_daily_report

- 计算实时PUE：取用机房能耗用电关系的总个IT的，找到8类设备替换成功对应功率测点系数复用，计算实时PUE（每小时计算一次，取最近2小时的fsu，存储在redis->energy:roomPue01-32-07-01-08-01）
  
  ```
  第二、三位（设备类型编码） 设备类型 信号标准名 信号编码ID 单位
  01 高压配电 总有功功率P 001325 kW
  02 低压交流配电 总有功功率P 002345 kW
  04 低压直流配电 直流功率 004304 kW
  08 UPS设备 输出总有功功率P 008342 kW
  09 UPS配电 输入xx总有功功率P 009331 kW
  88 高压直流电源配电 主路总功率 088306 kW
  92 智能电表 总有功功率 092330 kW
  96 交流母线配电 始端XX总有功功率 096314 kW
  ```
  
  ```
  `curl -X POST "http://localhost:9988/v1/energy/calRoomPue" -H "Content-Type: application/json" -H "Accept: application/json" -H "head_orgAccount: alauda" -H "head_userName: alauda" -d '{"precinctId":"01-32-13-10-31-01","namespace":"alauda"}'`
  ```
  
  没有查询到缓存数据会计算
  
  ```
  Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession[@5018b7ec](https://github.com/5018b7ec)]
  2024-04-15 14:38:48.736 INFO 7 —- [ool-14-thread-5] c.a.g.e.s.s.ComplexEnergyConfigSchedule : 机房01-32-13-10-31-01生成计算公式：总用电- (1212001006000000006587*088306_0**1)+(1212001006000000006584\*092330_0**1)+(1212001006000000006563*008342_0**1)+(1212001006000000006567\*008342_0**1)，it用电- (1212001006000000006563*008342_0**0.8)+(1212001006000000006567\*008342_0**0.8)+(1212001006000000006584*092330_0**0.8)
  2024-04-15 14:38:48.743 INFO 7 —- [ool-14-thread-5] c.a.g.e.s.s.ComplexEnergyConfigSchedule : 机房01-32-13-10-31-01计算实时pue成功
  2024-04-15 14:38:51.045 INFO 7 —- [nio-9988-exec-3] c.a.g.e.s.s.ComplexEnergyConfigSchedule : 查询机房01-32-13-10-31-01从redis的缓存值成功
  ```
  
- 昨日、上月平均PUE取自能耗机房的总用电量(机房能耗报表)

- 机柜负载比等数据

  ```
  curl --location 'http://10.1.203.121:9991/v1/cabinet/view/testTask' \ --header 'Head_orgaccount: alauda' \ --header 'Head_username: alauda' \ --header 'Content-Type: application/json' \ --data '{ }'
  ```














# 水管理【C接口】

- **涉及模块**
  - 水资源看板、用水分析、用水关系、水资源报表

### 用水关系配置

- 能耗-水关系配置-运算类型为按类型汇总的关系被引用后不能修改和删除；
- 按类型汇总的关系中引用关系可以修改但是不能修改为其他运算类型和删除。
- 如 M A B C分别是运算类型为按测点运算、测点运算、按类型汇总、手动填报， B B按类型汇总了M，D按类型汇总引用了ABC，E也是按类型汇总引用了D ；
- 则 M A C【可以修改】但是不能【修改为其他运算类型和删除】，B D不可修改和删除 E可以删改

#### 涉及的表

- water_mete;字典
- water_second_type;字典
- water_device_mete_day;
- water_device_mete_month;
- water_formula_config; 用水关系配置
- water_formula_config_his;
- water_formula_config_total;
- water_manual_month_config;用水类型中运算类型为手动填报
- water_manual_month_cost; 用水类型中运算类型为手动填报的月水量
- water_precinct_project_device;
- water_station_building_day; 日水量
- water_station_building_month; 各种用水类型的月水量（月差值不是用日累加）

#### 涉及模块：

- 前端，后端（energy-service，water-service,composite-service）

#### 测试开发用接口

```
water-service中执行，看日志也是下面都是

1.水资源计算指定时间段（月末-月初）的连接为：

curl -—location -—request GET 'http://localhost:28026/v1/waterConfig/executeMonthBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06&endTime=2025-06'


curl --location --request GET 'http://localhost:28026/v1/waterConfig/executeMonthBetweenTime?stationIdStr=01-01-08-04-03-01&startTime=2025-08&endTime=2025-08'


# dcim数据中心2 01-19-05-07-08-02
curl --location --request GET 'http://localhost:28026/v1/waterConfig/executeMonthBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06&endTime=2025-06'
```

```
water-service中执行
01-23-07-01-06-01

2.水资源计算指定时间段（日）的链接为  -- 向下汇总-因此时间必须时开始最大结束最小：

日级别的计算，只计算测点运算，向下汇总不进行计算
因为手动填报这种只有月度的，向下汇总可能汇总到手动计算这些，所以都不计算，日级别，只计算测点运算
curl --location --request GET 'http://localhost:28066/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-24-09-04-44-02&startTime=2025-05-31&endTime=2025-02-01'



curl --location --request GET 'http://localhost:28026/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-02-05-03-04-03&startTime=2025-08-01&endTime=2025-08-03'

curl --location --request GET 'http://localhost:28026/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06-03&endTime=2025-06-03'


dcim数据中心2
curl --location --request GET 'http://localhost:28026/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06-01&endTime=2025-05-29'
```

#### 定时任务[可以用]：

```
下面都在water-sevice中执行

1.删除水资源一年以前测点详情（天）的链接为：保留过去一年的
`curl --location --request GET 'http://localhost:28026/v1/waterConfig/deleteDayMete'`
```

```
Preparing: delete from water_device_mete_day where time < ?
==> Parameters: 2024-06-01(String)
<== Updates: 0
```

```
2.水资源定时任务计算（月）的链接为：
`curl --location --request POST 'http://localhost:28026/v1/waterConfig/formulaEnergyMonthTest'`
```

```
3.水资源定时任务计算（天）的链接为：
`curl --location --request POST 'http://localhost:28026/v1/waterConfig/formulaEnergyDayTest'`
```

```
4、每月1号凌晨20分执行生成当月运算类型为手动填报配置（使用water_formula_config where config_type = ‘2’填充water_manual_month_config where TIME = “2025-06数据）

commonWaterConfig.dealMonthManualConfig: 0 20 0 1 * ? ##

链接： `curl --location --request GET 'http://localhost:28026/v1/waterConfig/dealMonthManualConfig'`
任务执行关键词：生成当月手动配置定时任务
```

