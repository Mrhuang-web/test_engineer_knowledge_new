# 邦讯门禁控制器通信协议

## 一、概述与支持

*   **技术支持范围**: 提供动态链接库、底层通信协议和简单编程案例。**不提供电话、邮件或其他技术支持服务**。
*   **适用范围**: 推荐用于门禁和考勤系统，不建议用于其他未经测试的环境，否则可能增加返修率。
*   **系统要求**: 动态库仅支持 Windows XP 及以上操作系统。

## 二、核心功能
读取/校准时间、提取/删除记录、权限管理（下发/修改/删除/清空/读取）、时段管理、门控制（在线/常开/常闭/延时）、搜索/配置TCPIP控制器、远程开门、启用密码键盘、启用报警门磁事件记录、双门/多门互锁、首卡开门、多卡开门、胁迫密码、超级密码、定时任务、扩展板设置、控制器格式化。

## 三、设备型号与序列号 (S/N)
*   **485控制器** (串口: 9600,N,8,1):
    *   `11000-19999`: 1001 单门双向
    *   `21000-29999`: 1002 双门双向
    *   `41000-49999`: 1004 四门单向
*   **.NET控制器** (UDP通信, 默认端口 60000):
    *   `30000-39999`: 1002.NET 单门双向
    *   `50000-59999`: 1001.NET 双门双向
    *   `60000-64999`: 1004.NET 四门单向
*   **特别说明**:
    *   协议内卡号由 **区号** + **ID号** 组成（依据Motorola卡定义）。
    *   例如：日常卡号 `25409969`，在协议中表示为：区号=`254`，ID号=`09969`。
    *   建议从 **读取运行状态信息[1081]** 指令开始操作。
    *   开发中可使用 **格式化[10FF]** 指令恢复出厂设置。

## 四、基本数据格式

### 4.1 短时间格式 (4字节)
采用压缩格式，共32位（4字节）。
*   **时分秒 (Time)**: `0-4位:时(0-23)` | `5-10位:分(0-59)` | `11-15位:秒(0-29, 每单位2秒)`。
*   **年月日 (Date)**: `0-6位:年(相对2000年,0-119)` | `7-10位:月(1-12)` | `11-15位:日(1-31)`。
*   **示例**: `[B3 02 0D 5D]` → `02B3`(年月日) `5D0D`(时分秒) → 2001年5月19日 11时40分26秒。
*   **库函数参考**: `WComm_UDP.dll` 中的 `MSDateHmsToWCDateHms`, `WCDateToMSDate`, `MSDateYmdToWCDateYmd`。

### 4.2 记录格式 (10字节)
`卡号(4)` + `刷卡年月日(2)` + `刷卡时分秒(2)` + `记录状态(1)` + `记录选项(1)`

*   **卡号构成**:
    *   **标准8位卡号**: `卡号（4）= ID号(2，低在前) + 区号(1) + 0x00(固定对齐)`。
    *   **非标准10位卡号**: 由4个字节直接组成，低字节在前。
*   **记录选项 (Byte9)**:
    *   `Bit3=1`: 刷卡时分秒精确到秒 (V80驱动以上)。
    *   `Bit2=1`: V80以上驱动的记录格式。
    *   `Bit0=1`: 卡号为非标准10位卡号 (V80驱动以上功能)。
*   **读卡器与门对应关系**:
    *   单/双门双向控制器: 读卡器1/2对应1号门，读卡器3/4对应2号门。
    *   四门单向控制器: 读卡器与门一一对应。

#### 4.2.1 记录状态表 (完整卡号 > 100)
| 记录状态(Hex) | 操作 | 代表意义 |
| :--- | :--- | :--- |
| `00` | 允许通过 | 1号读卡器刷卡开门 |
| `01` | 允许通过 | 2号读卡器刷卡开门 |
| `02` | 允许通过 | 3号读卡器刷卡开门 |
| `03` | 允许通过 | 4号读卡器刷卡开门 |
| `80-83` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 原因不明 |
| `90-93` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 没有权限 |
| `A0-A3` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 密码不对 |
| `B0-B3` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 系统有故障 |
| `C0-C3` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 反潜回, 多卡开门或多门互锁 |
| `C4-C7` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 反潜回 |
| `C8-CB` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 多卡 |
| `CC-CF` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 首卡 |
| `D0-D3` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 门为常闭 |
| `D4-D7` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 互锁 |
| `E0-E3` | 禁止通过 | (1-4)号读卡器刷卡禁止通过: 卡过期或不在有效时段 |

**(特殊说明：将地址位 `0x37` 的参数值设为 `01` 可显示禁止通过的具体原因)**

#### 4.2.2 特殊操作记录表 (完整卡号 < 100)
| 完整卡号 | 记录状态(Hex) | 操作 | 代表意义 |
| :--- | :--- | :--- | :--- |
| `0` | `00` | 按钮 | 1号门按钮动作 |
| `1` | `00` | 按钮 | 2号门按钮动作 |
| `2` | `00` | 按钮 | 3号门按钮动作 |
| `3` | `00` | 按钮 | 4号门按钮动作 |
| `0` | `03` | 远程开门 | 1号门远程开门动作 |
| `1` | `03` | 远程开门 | 2号门远程开门动作 |
| `2` | `03` | 远程开门 | 3号门远程开门动作 |
| `3` | `03` | 远程开门 | 4号门远程开门动作 |
| `5` | `00` | 超级密码开门 | 1号读卡器超级密码开门 |
| `5` | `01` | 超级密码开门 | 2号读卡器超级密码开门 |
| `5` | `02` | 超级密码开门 | 3号读卡器超级密码开门 |
| `5` | `03` | 超级密码开门 | 4号读卡器超级密码开门 |
| `8` | `00` | 门打开 | 1号门打开[门磁信号] |
| `9` | `00` | 门打开 | 2号门打开[门磁信号] |
| `10` | `00` | 门打开 | 3号门打开[门磁信号] |
| `11` | `00` | 门打开 | 4号门打开[门磁信号] |
| `12` | `00` | 门关闭 | 1号门关闭[门磁信号] |
| `13` | `00` | 门关闭 | 2号门关闭[门磁信号] |
| `14` | `00` | 门关闭 | 3号门关闭[门磁信号] |
| `15` | `00` | 门关闭 | 4号门关闭[门磁信号] |
| `0` | `81` | 胁迫报警 | 1号读卡器胁迫报警 |
| `1` | `81` | 胁迫报警 | 2号读卡器胁迫报警 |
| `2` | `81` | 胁迫报警 | 3号读卡器胁迫报警 |
| `3` | `81` | 胁迫报警 | 4号读卡器胁迫报警 |
| `0` | `82` | 门长时间未关报警 | 1号门长时间未关报警 |
| `1` | `82` | 门长时间未关报警 | 2号门长时间未关报警 |
| `2` | `82` | 门长时间未关报警 | 3号门长时间未关报警 |
| `3` | `82` | 门长时间未关报警 | 4号门长时间未关报警 |
| `0` | `84` | 非法闯入报警 | 1号门非法闯入报警 |
| `1` | `84` | 非法闯入报警 | 2号门非法闯入报警 |
| `2` | `84` | 非法闯入报警 | 3号门非法闯入报警 |
| `3` | `84` | 非法闯入报警 | 4号门非法闯入报警 |
| `4` | `A0` | 火警 | 火警动作[针对整个控制器] |
| `6` | `A0` | 强制 | 强制锁门[针对整个控制器] |

### 4.3 权限信息 (16字节，预设3万个)
*   **格式**: `卡号(4)` + `备用1(2)` + `卡截止年月日(2)` + `门号(1)` + `密码(3)` + `控制时段索引号(4)`
*   **说明**:
    *   **门号**: 从 `01` 开始，最大 `04`。
    *   **卡截止年月日**: 使用短时间格式中的年月日定义，默认 `[9F C7]` (2099年12月31日)。
    *   **控制时段索引号**: `00`=禁止；`01`=有效期内任意时间有效。
    *   **密码**: 3字节，默认 `123456` (十六进制 `40E201`)。
    *   **备用1**: `=0` 表示普通用户组；`>0` 表示此权限所属的特殊群组（适用于多卡开门用户）。
*   **发送顺序**: 必须先发 **1号门** 的权限（门号相同的，先发卡号小的），再发2号门...依此类推。

### 4.4 控制时段 (256组，每组24字节)
*   **每组格式**:
    `星期控制(1)` + `下一个链接时段(1)` + `保留(2)` +
    `起始时分秒1(2)` + `终止时分秒1(2)` +
    `起始时分秒2(2)` + `终止时分秒2(2)` +
    `起始时分秒3(2)` + `终止时分秒3(2)` +
    `起始日期(2)` + `终止日期(2)` + `保留(4)`

*   **索引号**: `0-255`。第 `0` 组始终作为禁止刷卡时段，第 `1` 组始终作为任意时间有效组（0、1组修改值无效）。`2-255` 组用户可修改。
*   **星期控制字节** (`1`=当前星期有效，`0`=无效):
    | Bit位 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | 0=受时段控制<br>1=任意时间有效 | 日 | 六 | 五 | 四 | 三 | 二 | 一 |
    *   七天都有效为 `0x7F`，仅周一到周五有效为 `0x1F`。
*   **日期控制**: 起始/终止日期使用短时间格式中的年月日定义。默认起始 `[21 00]` (2000年1月1日)，终止 `[9F 29]` (2020年12月31日)。
*   **逻辑关系**: 刷卡时，需**同时满足**日期控制、星期控制、以及三个时分秒控制段中的任意一个，才可通过。
*   **下一个链接时段**: 用于并列时段检查。如果此值不为 `FF` 或 `0`，当此时段不允许通过时，会引入相应号的时段再进行权限检查。

### 4.5 首卡开门
通过**定时任务**实现。
1.  在设置权限时，对拥有首卡权限的用户，将其`备用1`的值设为 `1`。
2.  首卡使用状态:
    *   `0x00`: 刷首卡后作正常处理。
    *   `0x11`: 刷首卡后，门切换到常开。
    *   `0x12`: 刷首卡后，门切换到常闭。
    *   `0x13`: 刷首卡后，门切换到在线。
    *   `0x14`: 只许首卡才能开门，刷首卡后，不切换。

*   **操作示例** (实现早上8:00首卡开门后他人可进，下午18:30后仅首卡可进):
    1.  发送启用定时任务指令: `F410360001`
    2.  发送指令: `F3100001`
    3.  发送任务1 (8:00): `F510000100000600407F9B1300` (`0040`=8点, `9B`=1号门刷首卡后切换到在线)
    4.  发送任务2 (18:30): `F510000106000600987F9B1400` (`0098`=18:30, `9B14`=1号门仅首卡可开)

### 4.6 多卡开门 (含多群组)
*   **总体要求** (不分群组): 通过参数修改指令设置地址位 `0xB8` (1号读卡器)、`0xB9` (2号)、`0xBA` (3号)、`0xBB` (4号)。`00`=无要求，`>0`=要求的人数。
*   **群组要求**: 通过参数修改指令设置地址位 `0xBC-0xDB`，分别对应各个读卡器的8个群组（群1-群8）。默认各群要求人数=0。
*   **权限设置**: 用户所属群组通过权限信息中的`备用1`字段标识（例如，主任设为群1成员，则`备用1=1`）。
*   **操作示例** (要求1号读卡器同时3人刷卡，其中必须有1人是主任):
    1.  发送指令: `F410B80003` (3人同时刷卡)
    2.  发送指令: `F410BC0001` (1号读卡器的1号群必须要有1人到场)

### 4.7 扩展板设置
通过 **参数修改指令** 设置以下地址位。每个扩展口有6个参数（报警源、控制位、事件类型1、事件类型2、动作延时低字节、动作延时高字节）。
| 地址位 | 说明 | 默认值 | 备注 |
| :--- | :--- | :--- | :--- |
| `0x98` | 1号扩展口的报警源/联动源 | `0x01` | 默认报警源1号门 |
| `0x9E` | 2号扩展口的报警源/联动源 | `0x02` | 默认报警源2号门 |
| `0xA4` | 3号扩展口的报警源/联动源 | `0x04` | 默认报警源3号门 |
| `0xAA` | 4号扩展口的报警源/联动源 | `0x08` | 默认报警源4号门 |
| `0x9A` | 1号扩展口的事件类型1 | `0x27` | 默认为胁迫/门开未关闭/非法闯入/火警 |
| `0xA0` | 2号扩展口的事件类型1 | `0x27` | 同上 |
| `0xA6` | 3号扩展口的事件类型1 | `0x27` | 同上 |
| `0xAC` | 4号扩展口的事件类型1 | `0x27` | 同上 |
| `0x9C`/`0x9D`| 1号扩展口动作延时 (低/高) | `0x64`/`0x00`| 组成双字节数，单位0.1秒 (默认10秒) |
| `0xA2`/`0xA3`| 2号扩展口动作延时 (低/高) | `0x64`/`0x00`| 同上 |
| `0xA8`/`0xA9`| 3号扩展口动作延时 (低/高) | `0x64`/`0x00`| 同上 |
| `0xAE`/`0xAF`| 4号扩展口动作延时 (低/高) | `0x64`/`0x00`| 同上 |

*   **报警源/触发源**: 通过Bit位组合指定源头。`Bit0=1`表示1号门，`Bit1=1`表示2号门，`Bit2=1`表示3号门，`Bit3=1`表示4号门。
*   **扩展口控制位** (硬件驱动V16以上支持):
    *   `Bit2=1`: 如果此端口作为非法闯入报警输出时，有报警则一直输出。
    *   `Bit1=1`: 如果此端口作为门未关闭报警输出时，有报警则一直输出。
    *   `Bit2`优先级高于`Bit1`。
    *   `Bit0=1`: 如果此端口作为门未关闭报警输出时，报警复位则输出立即停止(无延时)。
*   **事件类型1** (`Bit`位为1时生效):
    *   `Bit0`: 胁迫
    *   `Bit1`: 门开未关闭
    *   `Bit2`: 非法闯入
    *   `Bit3`: 联动
    *   `Bit4`: 非法卡刷卡
    *   `Bit5`: 火警
*   **事件类型2** (只能选择其中一个为1):
    *   `Bit0`: 继电器互动 (保持一致状态，不受延时限制)
    *   `Bit1`: 门磁互动 (保持一致状态，不受延时限制)
    *   `Bit2`: 按钮互动 (保持一致状态，不受延时限制)

## 五、通信接口

### 5.1 通信基本格式 (34字节帧)
*   **485控制器**: 串口通信，速率 `9600,N,8,1`。
*   **.NET控制器**: UDP通信，默认端口 `60000`。
*   **帧结构**:
    *   **帧头 (5字节)**: `起始位(1)` + `板地址(2)` + `功能位(2)`
    *   **数据帧 (26字节)**: 指令参数，无数据时用 `0x00` 填充。
    *   **帧尾 (3字节)**: `校验和(2)` + `终止位(1)`
*   **字节说明**:
    *   **起始位**: 固定值 `0x7E`。
    *   **板地址**: 产品序列号S/N（十进制转十六进制，**低位在前**）。例如 S/N=40000 (`0x9C40`)，表示为 `40 9C`。
    *   **功能位**: 指令代码，**低位在前**。
    *   **校验和**: 等于第 **1 至 30** 字节的累加和（取双字节，低位在前）。
    *   **终止位**: 固定值 `0x0D`。
*   **示例中的 `XX`** 需依据实际情况填入。

**(后续所有指令描述，若不足34字节，均需按此格式补齐：起始位+板地址，填充00，校验和，终止位。)**

### 5.2 参数修改指令 `[F410]`
*   **功能**: 修改指定地址位的参数值。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6 | 7-8 | 9-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `F410` | 地址位 | `00` | 设定值(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `F4` `10` | XX | `00` | XX XX | `00`...`00` |
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6-30 | 31-32 | 33 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `F410` | 返回值 | `00`填充 | 校验和 | `0D` |
    | 值(hex) | `7E` | XX XX | `F4` `10` | XX | `00`...`00` | XX XX | `0D` |
*   **说明**: 执行成功则返回的 **Byte5 (返回值)** 与设定的值相同。

### 5.3 参数读取指令 `[F110]`
*   **功能**: 读取指定地址位的参数值。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6 | 7-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `F110` | 地址位 | `00` | `00`填充 |
    | 值(hex) | `7E` | XX XX | `F1` `10` | XX | `00` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6-30 | 31-32 | 33 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `F110` | 参数值 | `00`填充 | 校验和 | `0D` |
    | 值(hex) | `7E` | XX XX | `F1` `10` | XX | `00`...`00` | XX XX | `0D` |
*   **说明**: 执行成功则 **Byte5** 返回指定地址的参数值。

### 5.4 读取运行状态信息 `[1081]`
*   **功能**: 获取控制器当前运行状态、记录数、权限数、指定记录预览及设备状态。**是实现监控的关键指令**。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-8 | 9-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `8110` | 要读取的最新记录索引位(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `81` `10` | XX XX XX XX | `00`...`00` |
    *   **最新记录索引位**: `00000000` 或 `FFFFFFFF` 表示最新一条记录；否则读取指定索引位置。索引从1开始，低位在前。
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 说明 | 值(hex)示例 |
    | :--- | :--- | :--- |
| 0 | 起始位 | `7E` |
| 1-2 | 板地址 | XX XX |
| 3-4 | 功能位 | `81` `10` |
| 5-11 | **当前时间** (年 月 日 星期 时 分 秒) | `07` `08` `03` `05` `14` `08` `22` |
| 12-14 | **刷卡记录数** (L H) | `00` `00` `00` |
| 14-16 | **权限数量** (Byte14高4位 + Byte16 + Byte15) | `00` `00` `00` |
| 17-25 | **指定索引位置的刷卡记录值** (前9字节，若无记录则全为`FF`) | `FF` `FF` `FF` `FF` `FF` `FF` `FF` `FF` `FF` |
| 26 | **继电器状态** (Bit0=继1, 1=开锁; Bit1=继2; Bit2=继3; Bit3=继4) | `00` |
| 27 | **门磁按钮状态** (高4位:门磁4/3/2/1; 低4位:按钮4/3/2/1) | `00` |
| 28 | **故障号** | `00` |
| 29 | 保留 | `00` |
| 30 | 刷卡记录最后一个字节 | `FF` |
| 31-32 | 校验和 | XX XX |
| 33 | 终止位 | `0D` |
    *   **门磁状态**: `0`=门关闭，`1`=门打开。
    *   **按钮状态**: `0`=按钮按下，`1`=按钮松开。
    *   **故障号** (`Bit`位为1时有效):
        *   `Bit0`: 系统故障1
        *   `Bit1`: 系统故障2
        *   `Bit2`: 控制器时钟有故障
        *   `Bit3`: 系统故障4
        *   `Bit4`: 网络芯片有故障
*   **监控技巧**: 先读取最新记录索引位的记录，获取刷卡记录数。然后用 **`刷卡记录数 + 1`** 填充到索引位上再次读取运行状态，以获取下一条记录。循环此过程可实现实时监控。通信超时可设为400-500毫秒。

### 5.5 远程开门 `[109D]`
*   **功能**: 远程打开指定门（仅当门控制为“在线”时生效）。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9D10` | 门号 | `00`填充 |
    | 值(hex) | `7E` | XX XX | `9D` `10` | `01` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9D10` | `00`(成功) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `9D` `10` | `00` | `00`...`00` |
*   **说明**: 门号从 `1` 开始，最大 `4`。

### 5.6 设置时间 `[108B]`
*   **功能**: 校准控制器时间。时间采用 **BCD码**。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `8B10` | 年 | 月 | 日 | 星期 | 时 | 分 | 秒 | `00`填充 |
    | 值(hex) | `7E` | XX XX | `8B` `10` | `07` | `08` | `03` | `05` | `14` | `20` | `43` | `00`...`00` |
    *   **示例**: `07 08 03 05 14 20 43` → 2007年 08月 03日 星期五 14点 20分 43秒。
    *   **星期**: `00`=日, `01`=一, `02`=二, `03`=三, `04`=四, `05`=五, `06`=六。
*   **返回指令 (控制器 -> PC)**: 返回与设置相同的日期和时间数据帧。

### 5.7 设置门控制参数 (在线/延时) `[108F]`
*   **功能**: 设置门的控制方式及开门延时。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6 | 7-8 | 9-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `8F10` | 门号 | 控制方式 | 门延时(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `8F` `10` | `01` | `03` | `1E` `00` | `00`...`00` |
    *   **门号**: `1-4`。
    *   **控制方式**: `1`=常开, `2`=常闭, `3`=在线控制。
    *   **门延时**: 以0.1秒为单位。`0x001E` = 3秒。
*   **返回指令 (控制器 -> PC)**: 返回与设置相同的数据帧。

### 5.8 权限处理
#### 5.8.1 清空权限 `[1093]`
*   **功能**: 清除控制器内所有权限。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-30 |
    | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9310` | `00`填充 |
    | 值(hex) | `7E` | XX XX | `93` `10` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 0 | 1-2 | 3-4 | 5 | 6-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9310` | 成功=`01`/失败=`00` | `00`填充 |
    | 值(hex) | `7E` | XX XX | `93` `10` | `01` | `00`...`00` |

#### 5.8.2 读取权限 `[1095]`
*   **功能**: 读取指定索引号的权限信息。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-6 | 7-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9510` | 权限索引号(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `95` `10` | `01` `00` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**: 返回16字节权限信息（卡号4+备用2+截止日期2+门号1+密码3+时段索引4）。若返回全`FF`或全`0`，则表示无此权限。

#### 5.8.3 尾部加权限 `[109B]`
*   **功能**: 在权限列表尾部添加一个新权限。
*   **发送指令 (PC -> 控制器)**: 发送完整的16字节权限信息（索引号+权限数据）。
*   **返回指令 (控制器 -> PC)**: Byte5返回 `01`=成功，`00`=失败。
*   **注意**: 执行此指令前建议先清空权限，然后从索引1开始顺序发送。

#### 5.8.4 添加或修改权限 `[1107]`
*   **功能**: 添加新权限或修改已存在的权限（由卡号确定）。**仅适合权限数<1000的情况**。
*   **发送指令 (PC -> 控制器)**: 发送完整的16字节权限信息（前2字节为`00 00`）。
*   **返回指令 (控制器 -> PC)**: Byte5返回 `01`=成功，`00`=失败。
*   **说明**: 若权限已存在，则修改其后12字节（卡号不变）；若不存在，则添加。

#### 5.8.5 删除一个权限 `[1108]`
*   **功能**: 删除指定的权限（由卡号确定）。**仅适合权限数<1000的情况**。
*   **发送指令 (PC -> 控制器)**: 发送卡号（4字节），其余部分可用`00`填充。
*   **返回指令 (控制器 -> PC)**: Byte5返回 `01`=成功，`00`=失败。

### 5.9 时段处理
#### 5.9.1 读取控制时段 `[1096]`
*   **功能**: 读取指定索引的控制时段信息。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-6 | 7-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `9610` | 时段索引号(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `96` `10` | `02` `00` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**: 返回24字节的时段信息。**注意**: 索引0和1返回的数据无意义（0始终禁止，1始终任意时间有效）。

#### 5.9.2 修改控制时段 `[1097]`
*   **功能**: 修改指定索引的控制时段信息。
*   **发送指令 (PC -> 控制器)**: 发送完整的24字节时段信息（索引号+时段数据）。
*   **返回指令 (控制器 -> PC)**: 成功则返回与发送一致的时段信息。

### 5.10 记录处理
#### 5.10.1 读取指定索引位的记录信息 `[108D]`
*   **功能**: 提取指定索引的刷卡记录。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-8 | 9-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `8D10` | 记录索引位(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `8D` `10` | `01` `00` `00` `00` | `00`...`00` |
    *   **记录索引位**: `00000000` 或 `FFFFFFFF` 表示最新记录，否则读取指定位置。索引从1开始，低位在前。
*   **返回指令 (控制器 -> PC)**: 返回10字节记录数据。若指定位置无记录，则Byte5-8为`FFFFFFFF`。

#### 5.10.2 清除指定数量的记录 `[108E]`
*   **功能**: 从最早记录开始，清除指定数量的记录。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-8 | 9-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `8E10` | 要清除的记录数量(L H) | `00`填充 |
    | 值(hex) | `7E` | XX XX | `8E` `10` | `01` `00` `00` `00` | `00`...`00` |
    *   **数量**: 从1开始计数，低位在前。
*   **返回指令 (控制器 -> PC)**: 成功时Byte5返回`00`。
*   **重要提示**: **禁止执行读取1条删除1条的操作**。正常操作是提取完所有记录后再批量删除。

### 5.11 扩展功能 (通过参数修改指令 `[10F4]` 实现)
*   **设置读卡器是否使用密码键盘**:
    *   地址位: `0x26`(1号), `0x27`(2号), `0x28`(3号), `0x29`(4号)。`00`=不启用, `01`=启用。
    *   示例: `F410260001` (启用1号读卡器密码键盘)。
*   **设置是否启用报警/门磁事件记录**:
    *   `0x2D`: 是否记录按钮事件 (`00`=不启用, `01`=启用)。
    *   `0x2E`: 是否记录报警事件 (`00`=不启用, `01`=启用)。
    *   `0xDC`: 是否记录门磁事件 (`00`=不启用, `01`=启用)。
    *   `0x30`: 启用报警功能项 (`0`=不启用, `1`=启用相应位):
        *   `Bit0`: 胁迫报警
        *   `Bit1`: 门打开时间过长未关闭报警
        *   `Bit2`: 非法闯入 (门未刷卡强制打开) 报警
        *   `Bit4`: 任何不开门的刷卡操作都当作"非法刷卡"输出报警
        *   `Bit5`: 胁迫密码必须有合法卡刷了之后才行
    *   示例: `F410300007` (同时启用胁迫+门打开过长+非法闯入报警，`1+2+4=7`)。
*   **设置是否启用反潜回**:
    *   `0x2F`: 启用反潜回 (`00`=不启用, `01`=启用)。
    *   `0xB0`: 读卡器性质 (与反潜回配合使用)。
    *   **启用示例**:
        *   情况一 (单门1,2反潜;双门1,2与3,4反潜): `F4102F0001` + `F410B000FA`
        *   情况二 (双门1,3进,2,4出): `F4102F0002` + `F410B000FA`
*   **设置多门互锁**:
    *   地址位: `0x1E`(1号门), `0x1F`(2号门), `0x20`(3号门), `0x21`(4号门)。`00`=不启用, `01`=启用。
    *   **设置1,2号门互锁**: `F4101E0001` + `F4101F0001`
    *   **设置1,2,3号门互锁 (四门控制器)**: `F4101E0071` + `F4101F0071` + `F410200071`
*   **设置胁迫密码** (启用胁迫报警后才有效):
    *   地址位: `0x5A`(低), `0x5B`(中), `0xB3`(高)。整个控制器只能设一个。
    *   示例 (设置胁迫密码`123456`=`0x01E240`):
        `F4105A0040` + `F4105B00E2` + `F410B30001`
*   **设置或取消开门密码**:
    *   每个读卡器有4组密码，每组2字节。无密码用`FF FF`填充。
    *   地址位: `0x5C-0x63`(1号读卡器), `0x64-0x6B`(2号), `0x6C-0x73`(3号), `0x74-0x7B`(4号)。
    *   示例 (给1号读卡器添加密码`123456`=`0x01E240`):
        `F4105C0040` + `F4105D00E2` + `F4105E00FF` + `F4105F00FF` ... (必须填满4组)
*   **设置启用输入"*卡号*密码#"开门**:
    *   地址位 `0xB1`: `Bit0`=1号读卡器允许, `Bit1`=2号, `Bit2`=3号, `Bit3`=4号。
    *   示例: `F410B1000F` (4个读卡器都启用)。
*   **设置开门超时报警的时间长**:
    *   地址位: `0x33`(低字节), `0xB2`(高字节)。单位0.1秒。
    *   示例 (设置26秒=`260`=`0x0104`): `F410330004` + `F410B20001`

### 5.12 定时任务的实现 `[10F5]`
*   **功能**: 设置定时任务（如定时切换门状态）。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 说明 | 值(hex)示例 |
    | :--- | :--- | :--- |
    | 0-4 | 起始位+板地址+功能位`F510` | `7E` XX XX `F5` `10` |
    | 5-6 | 固定值`00 01` | `00` `01` |
    | 7-8 | 任务索引号 (以`06`递增) | `00` `00` |
    | 9 | 固定值`00` | `00` |
    | 10-12 | 动作时间[时分秒] (短时间格式) | `06` `00` `01` |
    | 13 | 星期控制 (Bit0=一...Bit6=日，1=有效) | `00` |
    | 14 | 门号 | `01` |
    | 15 | 门控制方式 (`01`=常开,`02`=常闭,`03`=在线) | `00` |
    | 16 | 备用 (若不为0，则表示月份，星期控制表示日期) | `00` |
    | 17-30 | 填充`00` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**: 成功则返回的Byte10-15与发送的Byte5-10值相同。
*   **操作流程**:
    1.  发送启用指令: `F410360001`
    2.  发送指令: `F3100001`
    3.  发送定时任务指令 (例如7点1号门常开): `F510000100000600387F010100`
    4.  (可发送多个任务)
    5.  最后发送生效指令: `0911` (返回Byte5: `01`=成功, `00`=失败)
*   **取消定时任务**: `F410360000`

### 5.13 设备基本信息 `[1082]`
*   **功能**: 读取控制器基本信息（生产日期、驱动版本、型号等）。
*   **发送指令 (PC -> 控制器)**: 标准格式，数据部分全`00`。
*   **返回指令 (控制器 -> PC)**:
    | 字节 | 说明 | 值(hex)示例 |
    | :--- | :--- | :--- |
    | 5-7 | 驱动发布日期 (年月日 BCD码) | `07` `07` `31` |
    | 8 | 驱动版本 (十六进制) | `1A` (版本26) |
    | 9 | 控制器型号 | `62`=双门双向, `64`=四门单向, `61`=单门双向 |

### 5.14 格式化 `[10FF]`
*   **功能**: 使控制器恢复出厂设置并重启。
*   **发送指令 (PC -> 控制器)**:
    | 字节 | 0 | 1-2 | 3-4 | 5-6 | 7-30 |
    | :--- | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | 板地址 | `FF10` | 选项值`551C` | `00`填充 |
    | 值(hex) | `7E` | `40` `9C` | `FF` `10` | `55` `1C` | `00`...`00` |
*   **说明**: 此指令**不返回信息**。控制器将重启，所有参数恢复出厂设置。需等待CPU运行指示灯正常闪烁后，通过`1081`指令确认效果。

### 5.15 .NET控制器搜索及配置协议
#### 5.15.1 搜索.NET设备 `[1101]`
*   **功能**: 通过UDP广播搜索网络中的.NET控制器。
*   **发送指令 (PC -> 控制器)**: UDP广播包，端口`60000`，板地址设为`FF FF`。
    | 字节 | 0 | 1-2 | 3-4 | 5-30 |
    | :--- | :--- | :--- | :--- | :--- |
    | 说明 | `7E` | `FF` `FF` | `0111` | `00`填充 |
    | 值(hex) | `7E` | `FF` `FF` | `01` `11` | `00`...`00` |
*   **返回指令 (控制器 -> PC)**: 返回控制器的网络设置信息 (MAC地址、IP、掩码、网关、UDP端口)。

#### 5.15.2 配置TCPIP `[11F2]`
*   **功能**: 配置.NET控制器的网络参数。
*   **发送指令 (PC -> 控制器)**: 发送完整的网络配置信息。
*   **说明**: 执行此指令后**不会有返回信息**。需等待约3秒后，通过搜索指令`[1101]`来确认是否配置成功。