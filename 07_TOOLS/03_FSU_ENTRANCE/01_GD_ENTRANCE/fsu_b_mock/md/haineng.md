# 深圳海能智能门禁通讯协议解析
## 一、通信接口
| 参数 | 配置详情 |
|------|----------|
| 接口类型 | RS485 |
| 波特率 | 9600 |
| 起始位 | 1位 |
| 数据位 | 8位 |
| 停止位 | 1位 |
| 校验方式 | 无校验 |

## 二、协议格式
### 1. 基础格式
`68H(1字节) + 地址(1字节) + 长度(1字节) + 数据包(最大255字节) + 校验和(1字节) + 0DH(1字节)`

### 2. 字段说明
| 字段 | 说明 |
|------|------|
| 包头 | 固定为68H |
| 包尾 | 固定为0DH |
| 地址 | 1字节，取值范围0-255（部分设备地址跳线仅支持部分地址空间） |
| 长度 | 1字节，标识数据包的字节数，最大255 |
| 数据包 | 由命令（1字节）及其参数组成，最大255字节 |
| 校验和 | 1字节，为数据包所有字节的累加和 |

### 3. 示例
`68,01,02,83,00,83,0D`
- 68：包头
- 01：地址
- 02：长度
- 83：命令
- 00：命令参数
- 83：校验和
- 0D：包尾

## 三、核心命令详解
### 3.1 上报组信息（命令字：81H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(81H) + 校验(81H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(09H) + 命令字(81H) + 组类型(8字节) + 校验 + 0DH`

#### 功能
上报设备的组信息，组类型从0-7依次上报各组数据类型，每组占用1字节

#### 组类型定义
| 类型标识 | 含义 |
|----------|------|
| 02H | AI（模拟输入） |
| 04H | DI（数字输入） |
| 06H | DO（数字输出） |
| FFH | 空 |

#### 门禁组定义
AI一组、DI一组、DO一组

### 3.2 上报门禁运行数据（命令字：82H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(82H) + 校验(82H) + 0DH`

#### 响应格式
`68H + 地址 + 长度 + 命令字(82H) + 板识别字(1字节) + 数据 + 板识别字(1字节) + 数据 + … + 校验 + 0DH`

#### 功能
上报各个通道的数据

#### 关键字段说明
| 字段 | 说明 |
|------|------|
| 板识别字 | 高4位为组号（0-7），低4位为组类型（AI-02H、DI-04H、DO-06H）<br>示例：24H表示第3号组为DI |

#### 数据格式（按组类型）
##### AI（模拟输入）
- 数据长度：16字节（带符号BCD码）
- 通道映射：0-7号通道，每个通道2字节（低字节在前，高字节在后）
  - 示例：34,20 对应物理值2034
- 通道含义：
  - 0-6号通道：门状态（目前支持2个门）
    - 00H：门关
    - 01H：刷卡开门
    - 02H：中心遥控开门
    - 03H：门内开门
    - 04H：非正常开门
  - 7号通道：新记录个数（未上报的记录数）
- 说明：通道数不足8个仍保留16字节，无效通道数据无意义

##### DI（数字输入）
- 数据长度：1字节（8路数字输入状态，位0-7对应通道0-7）
- 实际有效通道（6个）：
| 通道号 | 设备名称 | 状态定义 |
|--------|----------|----------|
| 0 | 1号红外 | 0=告警，1=正常 |
| 1 | 2号红外 | 0=告警，1=正常 |
| 2 | 1号出门按钮 | 0=按下，1=未按 |
| 3 | 2号出门按钮 | 0=按下，1=未按 |
| 4 | 1号门磁 | 0=门关，1=门开 |
| 5 | 2号门磁 | 0=门关，1=门开 |
- 说明：仅红外状态供上位机使用，出门按钮和门磁由门禁控制器自主处理

##### DO（数字输出）
- 数据长度：1字节（8路数字输出状态，位0-7对应通道0-7）
- 实际有效通道（2个）：门锁控制
  - 1=打开，0=合上
- 说明：上位机一般无需干预

### 3.3 远程开门控制（命令字：83H）
#### 命令格式
`68H + 地址 + 长度 + 命令字(83H) + 组号 + 通道号 + 动作类型 + 校验 + 0DH`

#### 功能
远程控制门禁开门

#### 参数说明
| 参数 | 取值范围 | 说明 |
|------|----------|------|
| 组号 | 02H | 固定组号 |
| 通道号 | 0-1 | 对应2个门 |
| 动作类型 | 01H | 仅支持开门操作 |

#### 说明
一次只能控制一个门开门

### 3.4 查询时间（命令字：89H）
#### 功能
查询门禁控制器的实际时间

#### 时间格式（16进制表示）
| 字段 | 范围 | 字节数 | 说明 |
|------|------|--------|------|
| 年 | 2000-9999 | 2 | 低字节在前 |
| 月 | 1-12 | 1 | - |
| 日 | 1-31 | 1 | - |
| 时 | 0-23 | 1 | - |
| 分 | 0-59 | 1 | - |
| 秒 | 0-59 | 1 | - |

#### 说明
门禁控制器内置不掉电实时时钟

### 3.5 设置时间（命令字：90H）
#### 功能
设置门禁控制器的时间

#### 时间格式
同3.4节查询时间的格式

### 3.6 发长期卡（命令字：91H）
#### 功能
发放长期有效门禁卡（未删除前一直有效，无有效期）

#### 命令格式
`68H + 地址 + 长度(08H) + 命令字(91H) + 卡号(4字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，采用Intel格式（低字节在前）<br>不足32位高位补"0" |
| 结果 | 表示发卡成功与否 |

#### 说明
- 不可写卡由厂商保证唯一性，可写卡由发卡程序保证唯一性

### 3.7 删除长期卡（命令字：92H）
#### 功能
删除指定长期门禁卡

#### 命令格式
`68H + 地址 + 长度(05H) + 命令字(92H) + 卡号(4字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 结果 | 0=删除失败，1=删除成功 |

### 3.8 发短期卡（命令字：93H）
#### 功能
发放有有效期的门禁卡（有效期内有效）

#### 命令格式
`68H + 地址 + 长度(0DH) + 命令字(93H) + 卡号(4字节) + 有效期(8字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(93H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 有效期 | 起始时间+结束时间（16进制表示） |
| 结果 | 0=发卡失败，1=发卡成功，2=卡已存在（有效期已修改） |

#### 有效期格式
| 字段 | 范围 | 字节数 | 说明 |
|------|------|--------|------|
| 开始年 | 2000-9999 | 2 | 低字节在前 |
| 开始月 | 1-12 | 1 | - |
| 开始日 | 1-31 | 1 | - |
| 结束年 | 2000-9999 | 2 | 低字节在前 |
| 结束月 | 1-12 | 1 | - |
| 结束日 | 1-31 | 1 | - |

### 3.9 删除短期卡（命令字：94H）
#### 功能
删除指定短期门禁卡

#### 命令格式
`68H + 地址 + 长度(05H) + 命令字(94H) + 卡号(4字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(94H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 结果 | 0=删除失败，1=删除成功 |

### 3.10 删除所有长期卡（命令字：95H）
#### 功能
删除门禁内所有长期卡

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(95H) + 结果(1字节) + 保留(4字节) + 校验 + 0DH`

#### 结果说明
0=删除失败，1=删除成功

### 3.11 删除所有短期卡（命令字：96H）
#### 功能
删除门禁内所有短期卡

#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(96H) + 校验(96H) + 0DH`

#### 结果说明
0=删除失败，1=删除成功

### 3.12 删除所有卡（命令字：97H）
#### 功能
删除门禁内所有长期卡和短期卡

#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(97H) + 校验(97H) + 0DH`

#### 结果说明
0=删除失败，1=删除成功

### 3.13 删除所有开门记录（命令字：98H）
#### 功能
删除门禁内所有开门记录

#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(98H) + 校验(98H) + 0DH`

#### 结果说明
0=删除失败，1=删除成功

### 3.14 查询参数（命令字：A1H）
#### 功能
查询门禁内部各类记录信息相关参数

#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(A1H) + 校验(A1H) + 0DH`

#### 参数格式（16进制表示，低字节在前）
| 序号 | 参数名称 | 范围 | 字节数 | 意义 |
|------|----------|------|--------|------|
| 1 | 最新记录位置 | 0-1499 | 2 | 当前最新开门记录的位置序号 |
| 2 | 当前有效记录 | 0-1500 | 2 | 当前有效的开门记录个数 |
| 3 | 未读记录数 | 0-1500 | 2 | 未上报的开门记录个数 |
| 4 | 长期卡数 | 0-1024 | 2 | 有效长期卡的个数 |
| 5 | 短期卡数 | 0-500 | 2 | 有效短期卡的个数 |

### 3.15 取长期卡（命令字：A2H）
#### 功能
获取有效的长期卡信息

#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A2H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(0BH) + 命令字(A2H) + 结果(1字节) + 卡序号(2字节) + 新序号(2字节) + 卡号(4字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取卡的序号（0-1023） |
| 卡序号 | 当前卡的序号 |
| 新序号 | 下一个有效卡的序号（-1表示无后续卡） |
| 卡号 | 32位卡号 |
| 结果 | 0=取卡失败，1=取卡成功（无后续卡），2=取卡成功（有后续卡） |

#### 说明
取卡采用First-Next方式，从指定序号开始获取首个有效卡及下一个有效卡序号

### 3.16 取短期卡（命令字：A3H）
#### 功能
获取有效的短期卡信息

#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A3H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(13H) + 命令字(A3H) + 结果(1字节) + 卡序号(2字节) + 新序号(2字节) + 卡号(4字节) + 有效期(8字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取卡的序号（0-499） |
| 卡序号 | 当前卡的序号 |
| 新序号 | 下一个有效卡的序号（-1表示无后续卡） |
| 卡号 | 32位卡号 |
| 有效期 | 同3.8节短期卡有效期格式 |
| 结果 | 0=取卡失败，1=取卡成功（无后续卡），2=取卡成功（有后续卡） |

#### 说明
取卡采用First-Next方式，从指定序号开始获取首个有效卡及下一个有效卡序号

### 3.17 取开门记录（命令字：A6H）
#### 功能
获取有效的开门记录

#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A6H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(14H) + 命令字(A6H) + 结果(1字节) + 记录序号(2字节) + 新记录序号(2字节) + 卡号(4字节) + 记录原因(1字节) + 时间(7字节) + 门序号(1字节) + 保留(3字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取记录的序号（0-1499） |
| 记录序号 | 当前记录的序号 |
| 新记录序号 | 下一个有效记录的序号（-1表示无后续记录） |
| 卡号 | 32位卡号（全0表示非刷卡开门） |
| 时间 | 记录发生时间（同3.4节时间格式） |
| 门序号 | 发生操作的门序号（0-1） |

#### 记录原因格式（1字节）
| 位结构 | 说明 |
|--------|------|
| 高3位 | 保留 |
| 第4位 | 门状态（0=门关，1=门开） |
| 低4位 | 记录状态（1=刷卡开门，2=中心遥控开门，3=门内按钮开门，4=非正常开门） |

#### 说明
取记录采用First-Next方式，从指定序号开始获取首个有效记录及下一个有效记录序号

### 3.18 取新开门记录（命令字：A7H）
#### 功能
获取有效的新开门记录（未上报的记录）

#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(A7H) + 校验(A7H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(14H) + 命令字(A7H) + 结果(1字节) + 记录序号(2字节) + 新记录序号(2字节) + 卡号(4字节) + 记录原因(1字节) + 时间(7字节) + 门序号(1字节) + 保留(1字节) + 校验 + 0DH`

#### 关键参数
| 参数 | 说明 |
|------|------|
| 记录序号 | 当前记录的序号 |
| 新记录序号 | 下一个有效记录的序号（-1表示无后续记录） |
| 卡号 | 32位卡号（全0表示非刷卡开门） |
| 记录原因 | 同3.17节记录原因格式 |
| 时间 | 记录发生时间（同3.4节时间格式） |
| 门序号 | 发生操作的门序号（0-1） |
| 结果 | 0=取记录失败，1=取记录成功 |

#### 说明
取新记录采用先入先出方式，每次获取当前最早的一条新记录