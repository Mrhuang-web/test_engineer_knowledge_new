# 单门门禁控制器ACUC协议字节转换逻辑+事件指令映射全梳理
结合你提供的实际透传数据帧，重新明确协议**字节拆分/ASCII转换规则**、**字段长度校验逻辑**，并精准映射附录历史记录中**各事件的下发/请求指令**、**发起方式**，解决字节比对和事件指令匹配核心问题。

## 一、核心字节转换与解析逻辑（关键修正+实操示例）
协议核心规则：**仅起始符(SOI)、结束符(EOI)按单字节直接发送/解析，其余所有字段（VER到CHK-SUM）均需按「单字节拆分为高4位+低4位」，再分别转换为对应ASCII码**（十六进制ASCII，0-9对应30-39，A-F对应41-46），以下结合你提供的实际帧数据逐条拆解验证。

### 1. 实际帧数据与协议字段对应表
原始帧（十六进制）：`7E 31 30 30 30 38 30 30 30 30 32 30 45 30 30 30 30 30 30 30 30 30 30 30 30 30 30 46 41 45 30 0D`
协议固定结构：`SOI(1) + [VER到CHK-SUM的ASCII转换段] + EOI(1)`，字段拆解与转换如下：

| 协议字段 | 原始帧对应段       | 转换/解析过程                                                                 | 最终十六进制值 | 字节数 | 备注                     |
|----------|--------------------|------------------------------------------------------------------------------|----------------|--------|--------------------------|
| SOI（起始符） | 7E                 | 直接解析，固定值                                                             | 0x7E           | 1      | 无转换，单字节           |
| VER（版本）| 31 30              | 31=高4位0x1，30=低4位0x0 → 组合为0x10                                         | 0x10           | 1      | 拆1字节为2个ASCII码      |
| ADR（组内地址） | 30 30              | 30=高4位0x0，30=低4位0x0 → 组合为0x00                                         | 0x00           | 1      | 同上                     |
| CID1（类码+组地址） | 38 30          | 38=高4位0x8，30=低4位0x0 → 组合为0x80（门禁类0x8+组号0x0）| 0x80           | 1      | 同上                     |
| CID2（命令分类码） | 30 30          | 30=高4位0x0，30=低4位0x0 → 组合为0x00                                         | 0x00           | 1      | 下发为CID2，应答为RTN    |
| L.TH（长度+校验） | 32 30 45 30    | 前2个ASCII=32 30 → 0x20；后2个=45 30 →0x0E → 组合为0x020E（高位在前）| 0x020E         | 2      | 拆2字节为4个ASCII码      |
| INFO（参数）| 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 | 每2个ASCII组合1字节，均为0x00 → 共8字节0x00 | 0x00*8         | 8      | 拆N字节为2N个ASCII码     |
| CHK-SUM（帧校验） | 46 41 45 30    | 前2个ASCII=46 41 →0xFA；后2个=45 30 →0xE0 → 组合为0xFAE0 | 0xFAE0         | 2      | 拆2字节为4个ASCII码      |
| EOI（结束符） | 0D                 | 直接解析，固定值                                                             | 0x0D           | 1      | 无转换，单字节           |

### 2. 字节数比对核心规则（解决「字段长度与原始帧占比」问题）
1. **协议定义的「字段字节数」**：是设备内部处理的**原始字节数**（如L.TH协议定义2字节，CHK-SUM协议定义2字节）；
2. **原始帧中的「实际占比数」**：是原始字节**拆分后的ASCII码个数**，计算公式为「原始字节数 × 2」；
3. **总长度校验**：原始帧总字节数 = 1（SOI） + ∑(VER到CHK-SUM各字段原始字节数×2) + 1（EOI）。

#### 实操比对（以你提供的帧为例）
- VER到CHK-SUM原始字节数总和：1(VER)+1(ADR)+1(CID1)+1(CID2)+2(L.TH)+8(INFO)+2(CHK-SUM) = **16字节**
- 对应ASCII码个数：16 × 2 = **32个**（原始帧中31 30 到 45 30 共32个字节，完全匹配）
- 原始帧总字节数：1(SOI) +32(ASCII段)+1(EOI) = **34字节**（与你提供的帧字节数一致）

### 3. 透传数据帧的解析规则
你提供的透传帧`cid2:00 + data_info:0100011A01161430450000000000000000000000`，属于**INFO字段的子结构**，解析规则为：
- 透传帧无SOI/EOI，直接按「2个ASCII码=1个原始字节」转换；
- cid2（透传）：前2个ASCII→1字节（此处00），为透传命令子类型；
- data_info：剩余所有ASCII按2个一组组合，为透传命令的参数（此处共20字节原始参数）。

## 二、附录历史记录「事件类型-指令-发起方式」精准映射
结合协议中**访问权限确认(0x48)、设置命令(0x49)、读取信息命令(0x4A)** 三大核心命令类，以及附录14类事件类型，明确**每类事件对应的下发/请求指令、发起主体、触发条件**，解决「事件如何发起」的核心问题。

### 核心说明
1. 所有指令发起前，**若涉及设备配置/敏感操作**，需先执行「访问权限确认(0x48+0xF0+0xE0)」，密码正确（RTN=0x00）后才有操作权限；
2. 指令格式统一为「命令类(CID2) + COMMAND GROUP + COMMAND TYPE」，部分简单指令无COMMAND GROUP（直接CID2+TYPE）；
3. 「下发指令」= 上位机→门控器(SM)的控制命令；「请求指令」= 上位机←SM的读取/上报命令（主要为0x4A类读取命令）。

### 附录14类事件完整映射表（按REMARK值排序）
| 事件类型               | REMARK值 | 发起主体       | 核心下发/请求指令（CID2+GROUP+TYPE） | 事件触发条件/发起方式                                                                 |
|------------------------|----------|----------------|--------------------------------------|--------------------------------------------------------------------------------------|
| 刷卡开门               | 0x00     | 刷卡用户       | 无（SM本地触发）| 用户刷卡（支持维根26/36等），SM验证卡号/权限/时段后本地执行开门，自动记录事件           |
| 键入ID及密码开门       | 0x01     | 键盘用户       | 无（SM本地触发）| 键盘输入用户ID+密码，SM验证匹配后本地开门，自动记录事件（STATUS.D7固定为1）|
| 远程开门               | 0x02     | 上位机         | 0x49（设置）+ 0xED（单一放行）| 上位机下发远程开门指令，参数为「1字节=1」（无操作员）或「1字节=1+5字节操作员编号」（有操作员） |
| 手动开门               | 0x03     | 现场人员       | 0x49（设置）+ 0xF8（手动按键控制）| 先通过0xF8启用手动开门按键（参数1字节=0），现场按物理按键开门，SM本地记录               |
| 联动开门               | 0x04     | 联动设备/上位机 | 0x49（设置）+ 0xFC（联动输出特性）| 配置联动输入电平（0xFC），联动设备触发后SM自动开门，或上位机下发联动开门指令             |
| 报警（红外/门磁等）| 0x05     | SM本地/传感器  | 0x4A（读取）+ 0xEE/0xFB（状态读取）| 红外/门磁传感器触发（如非正常开门、红外报警），SM本地记录，上位机通过0x4A类指令读取报警状态 |
| SM掉电记录             | 0x06     | SM本地         | 无（SM自动记录）| SM断电后重新上电，自动记录上电时间、输入线状态，上位机通过读取历史记录指令获取           |
| 内部控制参数修改       | 0x07     | 上位机         | 0x48（权限）+ 0x49（设置）全系列     | 先通过0x48确认权限，再下发0x49类修改指令（改密码/增用户/改时段等），SM记录修改类型       |
| 无效卡刷卡             | 0x08     | 刷卡用户       | 无（SM本地触发）| 用户刷未注册卡号，SM验证失败，本地记录事件                                             |
| 卡片过期               | 0x09     | 刷卡用户       | 无（SM本地触发）| 用户刷已过有效期的卡片，SM验证有效期失败，本地记录                                     |
| 无进入权限             | 0x0A     | 刷卡用户       | 无（SM本地触发）| 用户刷卡有效，但无对应时段/区域的准进权限，SM验证失败，本地记录                         |
| 密码三次错误           | 0x0B     | 刷卡/键盘用户  | 无（SM本地触发）| 刷卡后输入密码连续3次错误，或键盘输入ID+密码3次错误，SM锁定并记录事件                   |
| 消防联动输入（开始/结束） | 0x22     | 消防设备       | 0x49（设置）+ 0xFC（联动特性）| 配置消防联动输入，消防设备触发则开始联动（事件来源全0），解除则结束联动（事件来源全0+1） |
| 钥匙开门               | 0x30     | 现场人员       | 0x49（设置）+ 0xF9（电磁锁类型）| 先通过0xF9设置为机械锁（参数1字节=1），现场用物理钥匙开门，SM本地记录（STATUS.D6=1表示原门开） |

## 三、关键补充：事件记录的读取与指令发起流程
### 1. 历史事件记录的**请求读取指令**（上位机←SM，核心请求指令）
用于获取附录中所有历史事件，属于「读取信息命令(0x4A)」类，常用3种指令：
| 读取需求       | 指令格式（CID2+TYPE） | 数据参数       | 返回数据               |
|----------------|-----------------------|----------------|------------------------|
| 顺序读1条记录  | 0x4A + 0xE2           | 无             | 14字节附录标准记录格式 |
| 随机读指定记录  | 0x4A + 0xE2           | 2字节位置（低位在前） | 14字节指定位置记录     |
| 读最新事件记录  | 0x4A + 0xEE           | 1字节=0        | 14字节最新1条记录      |

### 2. 所有指令的**标准发起流程**（上位机→SM）
1. 校验通信参数：确认波特率（9600/19200等）、数据格式（8N1/8E1等）与SM一致；
2. 权限确认（如需）：下发`0x48+0xF0+0xE0`，携带5字节SM密码，等待RTN=0x00（密码正确）；
3. 下发业务指令：按「协议数据包基本格式」组装指令（SOI+各字段ASCII转换+EOI），发送至SM；
4. 接收SM应答：SM返回应答帧（将CID2替换为RTN，携带返回数据），校验RTN值（0x00为成功）；
5. 读取事件记录（如需）：下发`0x4A+0xE2/0xEE`，解析返回的14字节附录记录格式。

## 四、字节转换与指令发起常见问题
1. **ASCII转换错误**：需注意A-F为大写（41-46），小写会导致SM校验失败；
2. **L.TH/CHK-SUM计算错误**：CHK-SUM为「VER到INFO最后1字节」的ASCII码累加和，模65536取补，高位在前；
3. **权限遗漏**：修改参数/远程开门等操作未先执行0x48权限确认，SM会返回RTN=0x07（无访问权限）；
4. **事件记录未读取**：附录中REMARK.D7=0表示未读取，SM存储空间满后会覆盖旧记录，需定时下发0x4A类指令读取。