# ES2000 门禁产品RS485/422 通信协议
- 版本：V1.00
- 公司：艾默生网络能源有限公司
- 日期：2003-11-12

## 目录
1. [通信规范](#一-通信规范)
2. [通信命令的种类](#二-通信命令的种类)
3. [访问权限的确认](#三-访问权限的确认)
4. [设置命令](#四-设置命令)
5. [读取信息命令](#五-读取信息命令)
6. [附录：门控器(ES2000)的历史记录格式](#附录-门控器es2000的历史记录格式)

## 一、通信规范
### 1.1 通信速率与数据格式
#### （1）通信速率与数据格式
- 通信速率：9600 或 19200，ES2000 内应有改变速率的机制。
- 数据格式：1 起始位，8 数据位，1 停止位，校验方式可选无校验（参考 ES2000 系列键盘操作说明书有关章节）。

#### （2）信息交换的数据桢（命令数据包，或信息数据包）协议数据包的基本格式
| 序号 | 字段 | 字节数 | 符号 | 说明 |
| ---- | ---- | ---- | ---- | ---- |
| 1 | 起始符 | 1 | SOI | 发送信息起始符 = 7EH（START OF INFORMATION） |
| 2 | 版本 | 1 | VER | 通信协议的版本（= 10H，表示 1.0） |
| 3 | 组内地址 | 1 | ADR | 被定名设备（ES2000）的 RS485 网上地址（设备 ID），有效值：1-254 |
| 4 | 类码与组地址 | 1 | CID1 | 一字节为设备分类码及分组码组合（D7-D0，D7 高位）。D7-D4 为设备分类码（环境控制类=8，即 D7=1，D6=D5=D4=0）；D3-D0 为设备分组号（0-15）。ES2000 暂时固定分组码=0，因此 CID1=80H |
| 5 | 类别 | 1 | CID2/RTN | 主控制机（SU）发送命令时为 CID2（命令的分类码）；ES2000 回答时为 RTN（命令处理结果） |
| 6 | 参数长度校验 | 2 | L.TH | 携带参数的长度标识部分（计算见后） |
| 7 | 参数 | N 字节 | INFO | SU 发命令时为命令参数 COMINFO（含命令分类、命令号、参数）；ES2000 回复时为返回数据 DATAINFO（参数信息） |
| 8 | 桢校验 | 2 | CHK-SUM | 传送一桢信息的检查和，从 VER 开始到 INFO 最后字节结束参与计算，高位在前 |
| 9 | 结束符 | 1 | EOI | 发送信息结束符 = 0DH（END OF INFORMATION） |

### 1.2 数据传输与超时错
#### （1）传输的方法
- SOI、EOI 按单字节（HEX）直接发送，其它（从 VER 至 SUM 结束）将单字节（HEX）按高半 4 位（0→9，A→F）、低半 4 位（0→9，A→F）拆分开，按 ASCII 码发送，先高 4 位 ASCII 码，后低 4 位 ASCII 码。
- SU 与 ES2000 之间的通信类型：
  - 设置 ES2000 的权限确认；
  - 设置 ES2000 参数命令；
  - 读取 ES2000 信息的命令。

#### SU 发送命令（设置 ES2000 工作参数，或读取 ES2000 信息）格式
| 序号 | 字节数 | 字段 | 说明 |
| ---- | ---- | ---- | ---- |
| 1 | 1 | SOI | 起始符，固定值=0×7E |
| 2 | 1 | VER | 通信协议版本号（从 0X10 开始） |
| 3 | 1 | ADR | 设备地址（1-254；0 和 255 保留） |
| 4 | 1 | CID1 | 设备类型标识控制码（门控器高半字节=8），兼作扩展 ADR（设备多于 254 个时，分组号在低半字节） |
| 5 | 1 | CID2 | 命令的不同内容标识 |
| 6 | 2 | L.TH | 数据信息部份的字节长度表示 |
| 7 | N | COMINFO | 命令参数（含命令分类、命令号、参数） |
| 8 | 2 | SUM | 校验码 |
| 9 | 1 | EOI | 结束符，固定为 0DH |

#### ES2000 对 SU 的设置命令的应答格式
| 序号 | 字节数 | 字段 | 说明 |
| ---- | ---- | ---- | ---- |
| 1 | 1 | SOI | 起始符 |
| 2 | 1 | VER | 协议版本号 |
| 3 | 1 | ADR | 设备地址 |
| 4 | 1 | CID1 | 设备类型标识控制码 |
| 5 | 1 | RTN | 命令处理结果 |
| 6 | 2 | L.TH | 固定为 0,0 |
| 7 | - | 无 | 无参数 |
| 8 | 2 | SUM | 校验码 |
| 9 | 1 | EOI | 结束符 |

#### ES2000 对 SU 读取命令的返回格式
| 序号 | 字节数 | 字段 | 说明 |
| ---- | ---- | ---- | ---- |
| 1 | 1 | SOI | 起始符 |
| 2 | 1 | VER | 协议版本号 |
| 3 | 1 | ADR | 设备地址 |
| 4 | 1 | CID1 | 设备类型标识控制码 |
| 5 | 1 | RTN | 命令处理结果 |
| 6 | 2 | L.TH | 数据信息部份的字节长度表示 |
| 7 | N | DATAINFO | 返回数据（参数信息） |
| 8 | 2 | SUM | 校验码 |
| 9 | 1 | EOI | 结束符 |

#### 字段详细说明
1. SOI：信息传输起始标志位（1 字节），固定值=0×7E，发送时按一字节（7EH）发送。
2. VER：通信协议版本号（从 0X10 开始）。
3. ADR：设备地址描述（1-254；0 和 255 保留）。
4. CID1：设备类型标识控制码（对门控器高半字节=8），兼作扩展 ADR 用（设备多于 254 个时，其分组号在 CID1 的低半字节）。
5. CID2/RTN：SU 发命令时为 CID2（命令内容标识）；ES2000 应答时为 RTN（命令处理结果）。
6. L.TH（LENGTH）：命令帧中“数据信息部份”的字节长度表示（两字节）：
   | 位段 | 说明 |
   | ---- | ---- |
   | D15-D12 | LCHKSUM（4BIT 求反加 1） |
   | D11-D8 | 长度标示码 LENID 高 4 位（INFO 的传送中 ASC 码的字节数） |
   | D7-D4 | 长度标示码 LENID 中 4 位 |
   | D3-D0 | 长度标示码 LENID 低 4 位 |
   - 计算规则：数据信息部份的字节长度=L（命令参数字节数），则发送的 ASCII 码个数 LENID=2L；按 4 位（BIT）一组（D11,D10,D9,D8）、（D7,D6,D5,D4）、（D3,D2,D1,D0）累加，结果模 16 后对 16 取补（4BIT 求反加 1）作为 LCHKSUM；检验方法：从 D15 到 D0 按 4BIT 组成 4 个 4 位数，全部相加结果为零。
7. INFO：SU 发命令时为 COMMAND INFO；ES2000 应答时为 DATA INFO。
8. SUM（CHECKSUM）：数据桢的校验码，计算方式：整个数据桢中除 SOI、EOI 和 SUM 本身之外的其他字符，按发送的 ASCII 码累加求和（双字节和），结果模 65536 后取补运算（余数取反加 1），高位在前，低位在后。
9. EOI：结束码（固定为 0DH，发送时按 0DH 直接发送）。

#### （2）超时错时间
- 超时错时间：500 毫秒

### 1.3 设备应答
ES2000 应答或返回的 RTN 基本值：
| RTN 值 | 说明 |
| ---- | ---- |
| 00H | ES2000 正常执行 SU 发来的命令 |
| 01H | VER 不符，命令未执行 |
| 02H | ES2000 接收的命令帧，累加和检查不对 |
| 03H | ES2000 接收的命令帧，参数部份的累加和检查不对 |
| 04H | 无效的 CID2 |
| 05H | 不能识别的命令格式 |
| 06H | ES2000 接收的命令帧，数据信息部份有无效数据 |
| 07H | SU 无设置 ES2000（或访问 ES2000 的重要信息）之权限 |
| E0H | SU 与 ES2000 之间的密码确认不正确 |
| E1H | SU 对 ES2000 内部密码的修改不成功 |
| E2H | ES2000 内部相应设置项存储空间已满 |
| E3H | SU 对 ES2000 内部参数的修改（或删除）不成功 |
| E4H | ES2000 内部相应设置项的存储空间已空 |
| E5H | ES2000 内部无相应信息项 |
| E6H | SU 重复设入 ES2000 相同 ID 的用户，ES2000 保持原用户不变 |
| E7H | SU 重复设入相同卡号的 RF 卡，给不同的用户 |
| E8H | SU 重复设入完全相同的用户 |

## 二、通信命令的种类
SU 与 ES2000 之间的通信命令分为以下三类：
1. 访问 ES2000 的权限确认通信命令；
2. 设置 ES2000 的参数命令；
3. 读取 ES2000 内部信息的命令。

## 三、访问权限的确认
SU 设置 ES2000 的重要信息、控制 ES2000 动作开门、读取 ES2000 内部已授权用户的登记信息等操作之前，必须通过 ES2000 的密码认证，才能建立对 ES2000 的设置（操作）权限。

### 3.1 访问权限确认
- ES2000 的密码：由 5 字节组成（出产密码为 5 字节全 0）。
- 注意：监控软件需保管好每个 ES2000 控制器的密码，系统维护商需对密码登记；若密码忘却，需按操作说明重置 ES2000 密码为全 0。
- SU 发送的命令桢：
  - CID2=48H
  - COMMAND INFO：
    | COMMAND GROUP | COMMAND TYPE | DATA |
    | ---- | ---- | ---- |
    | 0XF0 | 0XE0 | 5 字节的 ES2000 密码 |
- ES2000 返回结果：
  - RTN=0：DATA 中的 5 字节密码与 ES2000 内部密码相符，SU 已通过设定权限确认。
  - RTN=0XE0：密码不相符，SU 未通过设定权限确认。
- 权限保持时间：SU 对 ES2000 的设置权限被确认后，可保持约 255 秒；若 ES2000 检测到 SU 主动取消权限，或访问时间间隔超过 255 秒，ES2000 将自动取消 SU 的设置权限，SU 需重新进行权限确认。

### 3.2 访问权限的取消
- 权限有效时间：SU 通过密码校验后，ES2000 接受 SU 的设置，且允许 SU 设置间隔约 255 秒（ES2000 每次正确接受设置，主动提供 255 秒延长许可）；超过 255 秒未设定，ES2000 将主动关闭允许设置状态。
- 操作目的：SU 完成参数设置后，应关闭允许设置状态，防止 ES2000 被非法设置。
- SU 发送的命令桢：
  - CID2=48H
  - COMMAND INFO：
    | COMMAND GROUP | COMMAND TYPE | DATA |
    | ---- | ---- | ---- |
    | 0XF0 | 0XE1 | 无 |
- ES2000 返回结果：
  - RTN=0：ES2000 已取消 SU 的设定权限。
  - RTN≠0：SU 的设定权限未被取消。

### 3.3 修改 ES2000 的访问密码
- 前提条件：SU 需先通过“权限确认”。
- SU 发送的命令桢：
  - CID2=48H
  - COMMAND INFO：
    | COMMAND GROUP | COMMAND TYPE | DATAF1 | DATAF2 |
    | ---- | ---- | ---- | ---- |
    | 0XF0 | 0XE2 | 5 字节的 ES2000 新密码 | 校验码（1 字节） |
  - 校验码：为“5 字节的 ES2000 新密码”的 5 字节逻辑异或值。
- ES2000 返回结果：
  - RTN=0：密码修改成功。
  - RTN=0XE1：密码修改不成功。

## 四、设置命令
SU 通过对 ES2000 的访问权限认证后，可对 ES2000 的所有工作参数进行设定。
- SU 发送的命令桢：CID2=49H
- COMMAND INFO 部分：
  | COMMAND GROUP | COMMAND TYPE | DATAF |
  | ---- | ---- | ---- |
  | 0XF1 | 0XE0 至 0XFB | 参数若干字节 |
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

### 4.1 设置日期时间的命令
- COMMAND TYPE=0XE0
- DATAF：年（2 字节）、月（1 字节）、日（1 字节）、星期（1 字节）、时（1 字节）、分（1 字节）、秒（1 字节），共 8 字节（BCD 格式）。
  - 年：2000-2099（2 字节 BCD）；
  - 月：1-12（1 字节 BCD）；
  - 日：1-31（1 字节 BCD）；
  - 星期：1-7（1 字节 BCD，7 代表星期日）。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

### 4.2 设置准进时段
#### 4.2.1 设置工作日的准进时段
- COMMAND TYPE=0XE1
- DATAF 部分：
  | GROUP No.（1 字节） | 16 字节准进时段描述列表 |
  | ---- | ---- |
  | 有效值 1-4（时段编号） | HH:MM→HH:MM, HH:MM→HH:MM, HH:MM→HH:MM, HH:MM→HH:MM（4 个时段，每个时段 4 字节 BCD） |
- 说明：
  - 门控器最多存放 4 张工作日准进列表（GROUP No.=1-4），每张列表含 4 个准进时段，每个时段用“起始时间-结束时间”4 字节 BCD 码表示。
  - 示例：00:00→02:00（0X00,0X00,0X02,0X00）、04:00→06:30（0X04,0X00,0X06,0X30）等，无效时间值（如 FF、78）对应的时段无效。
  - 注意：设置时需从第一张表开始，ES2000 仅在接受第一张表设置更改时擦除 FLASH ROM。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.2.2 设置非工作日（节假日，或星期内休息日）的准进时段
- COMMAND TYPE=0XE2
- DATAF 部分（共 17 字节）：
  | GROUP No.（1 字节） | 16 字节准进时段描述列表 |
  | ---- | ---- |
  | 固定为 1 | HH:MM→HH:MM, HH:MM→HH:MM, HH:MM→HH:MM, HH:MM→HH:MM（4 个时段，每个时段 4 字节 BCD） |
- 说明：门控器最多存放 1 张“非工作日准进”列表，含 4 个准进时段。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.2.3 设定星期准进时间段列表
- COMMAND TYPE=0XF1
- DATAF：26 字节
  - 第 1-2 字节：表号（第 1 字节，有效值 0-15，代表第 1-16 张表）、星期（第 2 字节，有效值 1-7）；
  - 第 3-26 字节：该设定日的 6 个准进列表（每个时段 4 字节 BCD，格式：HH:MM→HH:MM）。
- 说明：ES2000 内最多存储 16 张表，每张表含 7 天（星期一至星期日），每天 6 个准进时段。
- 注意：设置时需从第一张表的星期一开始，ES2000 仅在接受第一张表的星期一设置更改时擦除 FLASH ROM。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

### 4.3 用户（准进人员）管理
#### 4.3.1 增加一个用户（至门控制器）
- COMMAND TYPE=0XE3
- DATAF：新用户描述（16 字节）
  | 字段 | 字节数 | 格式/说明 |
  | ---- | ---- | ---- |
  | 卡片编号 | 5 字节 | HEX 格式 |
  | 用户编号 ID | 4 字节 | BCD 格式 |
  | 用户密码 | 2 字节 | BCD 格式，ES2000 固定为 12H,34H |
  | 有效期 | 4 字节 | BCD 格式，世纪、年、月、日（如 0X20,0X12,0X12,0X31 表示 2012 年 12 月 31 日过期） |
  | 用户权限 | 1 字节 | D7-D0（D0 为低位 BIT），具体定义如下： |

#### 用户权限字节定义（D7-D0）
| D7,D6 | 权限类型 | 其他位说明 |
| ---- | ---- | ---- |
| 0,0 | 一般用户（受星期准进时段限制） | D5,D4: 保留；D3,D2,D1,D0: 适用的星期列表编号（索引系统准进列表） |
| 0,1 | 一般用户（受星期准进时段限制） | 同 D7,D6=0,0 |
| 1,0 | 一般用户（受工作日准进时段限制） | D5,D4,D3,D2: 保留；D1,D0: 工作日准进时段 GROUP.No（00=第一张表，01=第二张表，10=第三张表，11=第四张表） |
| 1,1 | 特权用户（不受任何准进时段限制，受有效期限制） | - |

- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 设置成功 |
  | 0XE2 | ES2000 内存储空间已满 |
  | E7H | 卡号重复 |
  | E6H | 用户 ID 号重复 |
  | E8H | 用户信息项全部重复设置 |
  | 其他值 | 设置不成功 |

#### 4.3.2 删除用户卡（从门控制器内）
- COMMAND TYPE=0XE4
- DATAF：6 字节
  | 1 字节指引 | 5 字节卡片编号 |
  | ---- | ---- |
  | 固定为 0 | 待删除用户的卡片编号（以卡片编号检索） |
- 功能：删除该卡号对应的用户。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 删除成功 |
  | 0XE5 | ES2000 内无该用户 |
  | 0XE4 | ES2000 内用户列表已全空 |
  | 0XE3 或其他值 | 删除不成功 |

#### 4.3.3 删除用户编号（ID）（从门控制器内）
- COMMAND TYPE=0XE4
- DATAF：6 字节
  | 1 字节指引 | 4 字节用户 ID |
  | ---- | ---- |
  | 固定为 1 | 待删除用户的 ID 编号（以用户 ID 检索） |
- 功能：删除该 ID 对应的用户。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 删除成功 |
  | 0XE5 | ES2000 内无该用户 |
  | 0XE4 | ES2000 内用户列表已全空 |
  | 0XE3 或其他值 | 删除不成功 |

#### 4.3.4 全部删除用户（从门控制器内）
- COMMAND TYPE=0XE4
- DATAF：6 字节
  | 1 字节指引 | 5 字节填充 |
  | ---- | ---- |
  | 固定为 2 | 5 字节全为 00 |
- 功能：删除门控制器内所有用户。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 删除成功 |
  | 0XE5 | ES2000 内无用户 |
  | 0XE4 | ES2000 内用户列表已全空 |
  | 0XE3 或其他值 | 删除不成功 |

### 4.4 设定门的特性参数
#### 4.4.1 门锁继电器执行时间（单独设定）
- COMMAND TYPE=0XE6
- DATAF：1 字节（有效值 1-255），单位：0.1 秒。
  - 示例：DATAF=50（十进制）表示对门锁继电器加电 5 秒钟。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.2 开门后等待进入的延时时间（单独设定）
- COMMAND TYPE=0XE7
- DATAF：1 字节（有效值 20-255），单位：0.1 秒。
  - 示例：DATAF=50（十进制）表示门锁打开后 5 秒钟内应开门进入，之后关门以确保准确上锁。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.3 门磁、开门按钮等感应器的特性（单独设定）
- COMMAND TYPE=0XE5
- DATAF：1 字节（D7-D0，D0 为低位 BIT），第一控制字，各 BIT 位定义如下：
  | BIT 位 | 控制说明 |
  | ---- | ---- |
  | D7 | 0：不监控门开关状态；1：监控门开关状态（通过门磁），异常报警（非正常开门、不能自动关门的锁刷卡后无开关机械动作、开门延时结束后未关门） |
  | D6 | 固定为 0 |
  | D5 | 固定为 1（必须靠“开门-再关门”机械动作的弹力才能锁上） |
  | D4 | 0：允许“手动开门”输入线与电源地线短接时开门；1：禁止 |
  | D3 | 0：门磁输出电平为开门时短路（通）、关门时开路（不通）；1：门磁输出电平为开门时断路（开）、关门时短路（通） |
  | D2,D1,D0 | 固定为 0,0,0 |
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.4 紧急联动及报警输出特性
- COMMAND TYPE=0XFC
- DATAF：1 字节（D7-D0，D0 为低位 BIT），第二控制字，各 BIT 位定义如下：
  | BIT 位 | 控制说明 |
  | ---- | ---- |
  | D7-D2 | 固定为 0,0,0,0,0,0 |
  | D1 | 1：“紧急事件”输入 MDIN 与 GND 闭合时，闭门，任何卡不响应；0：“紧急事件”输入 MDIN 与 GND 闭合时，常开门 |
  | D0 | 固定为 0 |
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.5 设定门开关感应器在开门状态时的有效电平（输出给门控器）
- COMMAND TYPE=0XF7
- DATAF：1 字节
  - 0：低电平有效（或继电器输出时吸合）；
  - 1：高电平有效（或继电器输出时断开）。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.6 设置系统支持维根感应头的种类及卡片编号的获取方法
- COMMAND TYPE=0XEE
- DATAF：1 字节
  - D3-D0：固定为 0,0,0,0；
  - D7-D4：卡片编号获取方式（不足 5 字节时高位补 0）：
    | D7-D4 值 | 说明 |
    | ---- | ---- |
    | 0 | 全部 BIT 作为卡片编号 |
    | 1 | 除去校验位，取全部 BIT |
    | 2 | 除去校验位，取低位 2 字节 |
    | 3 | 除去校验位，取低位 3 字节 |
    | 4 | 除去校验位，取低位 4 字节 |
    | 5 | 除去校验位，取低位 5 字节 |
    | 其他值 | 按 0 处理 |
- 说明：ES2000 自动支持维根感应头的种类 26/34/36/44；若获取的卡片编号多于 5 字节，留低位 5 字节，舍去高位字节。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.4.7 设定系统感应卡编号的获取方法
- COMMAND TYPE=0XF3
- DATAF：1 字节（感应卡阅读器 WIEGAND 格式输出 BIT 流：26BIT/36BIT/44BIT/64BIT）
  - 0：全部 BIT 作为卡片编号，不足 5 字节高位补 0；
  - 1：除去校验位，取全部 BIT，不足 5 字节高位补 0；
  - 2：除去校验位，取低位 2 字节，高位补 0；
  - 3：除去校验位，取低位 3 字节，高位补 0；
  - 4：除去校验位，取低位 4 字节，高位补 0；
  - 5：除去校验位，取低位 5 字节；
  - 其他值：按 0 处理。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

### 4.5 设定门控器工作方式
#### 4.5.1 启用或关闭 “手动开门按键”输入
- COMMAND TYPE=0XF8
- DATAF：1 字节
  - 1：关闭“手动开门按键”输入；
  - 0：启用“手动开门按键”输入。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.5.2 门开关状态监控的布防与撤防
- COMMAND TYPE=0XFB
- DATAF：1 字节
  - 0：关闭门开关状态监视；
  - 1：启用门开关状态监视。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.5.3 布防与撤防（第一控制字）
- 同 4.4.3 门磁、开门按钮等感应器的特性设定（COMMAND TYPE=0XE5，DATAF=1 字节第一控制字）。

#### 4.5.4 设定控制器的第二控制字
- 同 4.4.4 紧急联动及报警输出特性设定（COMMAND TYPE=0XFC，DATAF=1 字节第二控制字）。

### 4.6 节假日管理
#### 4.6.1 设定星期内的休息日
- COMMAND TYPE=0XEA
- DATAF：2 字节（有效值 1-7），代表星期内休息的两天（1=星期一，2=星期二，…，6=星期六，7=星期日）。
  - 示例：7,0XFF 表示仅星期日（=7）休息；非有效值表示不休息。
- ES2000 返回结果：
  - RTN=0：设置成功。
  - RTN≠0：设置不成功。

#### 4.6.2 设定国家法定节假日（不包括星期内休息日）
- COMMAND TYPE=0XEB
- DATAF：2 字节（BCD 格式），MM（月）、DD（日）。
- 说明：ES2000 内最多存放 40 个节假日。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 设置成功 |
  | 0XE2 | ES2000 内节假日存储已满（40 组） |
  | 其他值 | 设置不成功 |

#### 4.6.3 删除一组节假日
- COMMAND TYPE=0XEC
- DATAF：2 字节（BCD 格式），MM（月）、DD（日）。
  - 若 DATAF 两字节全为 00，表示全部删除节假日。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 删除成功 |
  | 0XE5 | ES2000 内无该组节假日 |
  | 0XE4 | 节假日列表已全空 |
  | 其他值 | 删除不成功 |

#### 4.6.4 清空节假日列表（全部删除）
- COMMAND TYPE=0XEC
- DATAF：2 字节，全部为 00。
- ES2000 返回结果：
  | RTN 值 | 说明 |
  | ---- | ---- |
  | 0 | 删除成功 |
  | 0XE4 | 节假日列表已全空 |
  | 其他值 | 删除不成功 |

### 4.7 记录区的管理
#### 记录区存储说明
- ES2000 的记录柜桶：从 BOTTOM（=0）到 MAXLEN（深度=16384），存储历史记录。
- 指针说明：
  - LOADP：下一次读取记录的位置指针（初始值=BOTTOM）；
  - SAVEP：下一条记录存储的位置指针（初始值=BOTTOM）；
  - 记录存储：有记录时存入 SAVEP 指向位置，SAVEP 自动加 1；
  - 记录读取：SU 读取时，ES2000 从 LOADP 指针位置读取一条记录，LOADP 自动加 1；
  - 覆盖规则：记录区存满后，ES2000 自动覆盖最早的记录（MF 的 D7=1），保留最新 MAXLEN 条记录；若覆盖操作改动 LOADP，则 MF 的 D0=1。
- 有效记录数计算：
  1. 当 SAVEP > LOADP 时：
     - 已读取记录区：BOTTOM 到 LOADP；
     - 未读取记录区：LOADP 至 SAVEP-1；
     - 未读取记录数=SAVEP-LOADP；
     - 剩余空间=MAXLEN-未读取记录数。
  2. 当 SAVEP < LOADP 时（记录存储已满且覆盖旧记录）：
     - 未读取记录区：LOADP 到 TOP、BOTTOM 至 SAVEP-1；
     - 未读取记录数=TOP（MAXLEN）-LOADP + SAVEP - BOTTOM；
     - 最早记录位置：SAVEP；
     - 最新记录位置：SAVEP-1。

#### 4.7.1 初始化记录区（清空记录）
- COMMAND TYPE=0XF0
- DATAF：5 字节，全部为 0。
- ES2000 返回结果：
  - RTN=0：操作成功。
  - RTN≠0：操作不成功。

#### 4.7.2 设定读指针
- COMMAND TYPE=0XF0
- DATAF：3 字节
  | 第 1 字节 | 第 2 字节 | 第 3 字节 |
  | ---- | ---- | ---- |
  | LOADP 低位字节 | LOADP 高位字节 | MF 字节 |
- MF 字节说明：
  - D7 位：表示整个记录区已被历史记录写入过；
  - D0 位：表示覆盖位。
- ES2000 返回结果：
  - RTN=0：操作成功。
  - RTN≠0：操作不成功。

#### 4.7.3 设定整个记录区指针
- COMMAND TYPE=0XF0
- DATAF：5 字节
  | 字段 | 字节数 | 说明 |
  | ---- | ---- | ---- |
  | SAVEP | 2 字节 | 下一条记录存储的位置（低位在前） |
  | LOADP | 2 字节 | 下一次读取记录的位置（低位在前） |
  | LOADP-MF | 1 字节 | D7=1：整个记录区已被历史记录写入过，允许读取全部；D7=0：允许读取从 0→SAVEP-1 的记录 |
- ES2000 返回结果：
  - RTN=0：操作成功。
  - RTN≠0：操作不成功。

### 4.8 远程开关门
#### 4.8.1 单一放行（不带系统操作员信息）
- COMMAND TYPE=0XED
- DATAF：1 字节
  - 1：开门；
  - 0：不操作。
- ES2000 返回结果：
  - RTN=0：开门成功。
  - RTN≠0：开门不成功。

#### 4.8.2 单一放行（带系统操作员信息）
- COMMAND TYPE=0XED
- DATAF：6 字节
  | 第 1 字节 | 后 5 字节 |
  | ---- | ---- |
  | 1：开门；0：不操作 | 操作员编号信息（存放在远程开门记录结构中的前 5 字节） |
- ES2000 返回结果：
  - RTN=0：开门成功。
  - RTN≠0：开门不成功。

## 五、读取信息命令
SU 随时可对 ES2000 的历史记录、监控状态等进行读取。
- SU 发送的命令桢：CID2=4AH
- COMMAND INFO 部分：
  | COMMAND GROUP | COMMAND TYPE | DATAF |
  | ---- | ---- | ---- |
  | 0XF2 | 0XE0 至 0XEF | 1 字节（读取记录命令时为 2 字节） |

### 5.1 读取 ES2000 的实时钟
- COMMAND TYPE=0XE0
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：年（2 字节）、月（1 字节）、日（1 字节）、星期（1 字节）、时（1 字节）、分（1 字节）、秒（1 字节），共 8 字节 BCD 格式。
    - 年：2000-2099（2 字节 BCD）。

### 5.2 读取记录信息
#### 5.2.1 读取历史记录柜桶参数
- COMMAND TYPE=0XE1
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO（9 字节）：
    | 字段 | 字节数 | 说明 |
    | ---- | ---- | ---- |
    | BOTTOM（桶底） | 2 字节 | 记录区起始位置（=0） |
    | SAVEP（下一次新记录存放指针） | 2 字节 | 下一条记录存储位置 |
    | LOADP（下一次读取记录位置指针） | 2 字节 | 下一次读取记录位置 |
    | MF（已修改 LOADP 标志） | 1 字节 | D0=0：未修改 LOADP；D0=1：已修改 LOADP |
    | MAXLEN（柜桶最大深度） | 2 字节 | 记录存储最大空间（条数），=16384 |

#### 5.2.2 顺序读取一条历史记录
- COMMAND TYPE=0XE2
- DATAF：无或 1 字节（无定义）。
- 操作：ES2000 从 LOADP 位置读取一条记录返回给 SU，同时自动将 LOADP 指向下一条记录。
- ES2000 返回结果：
  - DATAINFO：14 字节（一条记录，格式见附录）。

#### 5.2.3 随机读取记录（指定位置读取）
- COMMAND TYPE=0XE2
- DATAF：2 字节（低位在前），指定读取位置。
- 操作：ES2000 以 DATAF 为 LOADP 值，读取该位置一条记录，不改变原 LOADP 值；若记录已读完或参数指向空白记录区，返回错误提示。
- ES2000 返回结果：
  - DATAINFO：14 字节（指定位置记录，格式见附录）。

#### 5.2.4 附带顺序号读取记录（防止丢失记录）
- COMMAND TYPE=0XEE
- DATAF：1 字节，=1。
- 操作：ES2000 返回 LOADP 位置的历史记录及 LOADP 本身，共 16 字节。
  | 前 2 字节 | 后 14 字节 |
  | ---- | ---- |
  | 读出记录的位置 LOADP 值 | 记录内容（格式见附录） |
- 说明：LOADP 在 0-TOP 之间顺序排列，可判断读记录时是否因 RS485 线路问题导致记录丢失；若控制器内记录已全部读完，返回无记录标识。

#### 5.2.5 查询控制器的最新事件记录
- COMMAND TYPE=0XEE
- DATAF：1 字节，=0。
- 操作：ES2000 返回最新发生的事件记录（14 字节，格式见附录）；若无最新事件发生，返回无记录标识。
- 最新事件包括：刷卡、门磁告警、手动开门等。

### 5.3 读取时段
#### 5.3.1 读取一组工作日准进时段
- COMMAND TYPE=0XE3
- DATAF：1 字节（有效值 1-4），指定读取的组号。
- ES2000 返回结果：
  - DATAINFO：16 字节（BCD 格式），4 个准进时段（每个时段 4 字节，格式：HH:MM→HH:MM）。

#### 5.3.2 读取非工作日准进时段
- COMMAND TYPE=0XE4
- DATAF：1 字节，=1。
- ES2000 返回结果：
  - DATAINFO：16 字节（BCD 格式），4 个准进时段（每个时段 4 字节，格式：HH:MM→HH:MM）。

#### 5.3.3 读取星期一至星期日的准进时间表
- COMMAND TYPE=0XEB
- DATAF：2 字节
  - 第一字节：指定读取的表号（有效值 0-15，代表第 1-16 张表）；
  - 第二字节：该表内的星期几（1-7，7 代表星期日）。
- 说明：每张表含 7 天，每天 6 个准进时段（每个时段 4 字节 BCD），每张表共 168 字节；每次仅读取某张表的某一天的准进时段列表（24 字节）。
- ES2000 返回结果：
  - DATAINFO：24 字节（BCD 格式），6 个准进时段（每个时段 4 字节，格式：HH:MM→HH:MM）。

### 5.4 读取用户信息
#### 5.4.1 读取已存储的用户数目
- COMMAND TYPE=0XE5
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：2 字节 HEX，低 8 位在前，高 8 位在后；0,0 表示无用户。

#### 5.4.2 读取指定存储位置的用户登记资料
- 前提条件：SU 需通过权限确认。
- COMMAND TYPE=0XE6
- DATAF：2 字节 HEX 数（低位在前），指定用户存储位置（示例：0X01,0X02 表示第 513 个用户）。
- ES2000 返回结果：
  - RTN=0：DATAINFO（16 字节）
    | 字段 | 字节数 | 格式/说明 |
    | ---- | ---- | ---- |
    | 卡编号 | 5 字节 | HEX 格式 |
    | 用户编号 ID | 4 字节 | BCD 格式 |
    | 用户密码 | 2 字节 | BCD 格式 |
    | 有效期 | 4 字节 | BCD 格式（YYYY,MM,DD） |
    | 用户权限 | 1 字节 | VIP、GROUP 标识 |
  - RTN=0XE0：无权限读取用户信息，无 DATAINFO 项。

#### 5.4.3 查询指定用户编号（ID）的用户是否存在
- 前提条件：SU 需通过权限确认。
- COMMAND TYPE=0XE6
- DATAF：4 字节，待查询的用户编号。
- ES2000 返回结果：
  - RTN=0：DATAINFO（16 字节），格式同 5.4.2；
  - RTN=0XE0：无权限读取用户信息，无 DATAINFO 项。

### 5.5 读取休息日、节假日
#### 5.5.1 读取星期内休息日
- COMMAND TYPE=0XE9
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：2 字节，每个字节有效值 1-7（7 代表星期日），非有效值无意义。

#### 5.5.2 读取节假日（星期内休息日除外）
- COMMAND TYPE=0XEA
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：
    | 第 1 字节 | 后续字节 |
    | ---- | ---- |
    | 休息日的个数 N（天） | N 组日期（每组 2 字节 BCD，MM:DD），共 2×N 字节 |

### 5.6 远程监控
- COMMAND TYPE=0XE7
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：2 字节，分别为 ES2000 的工作状态和监控线路的状态。

#### 第一字节（工作状态）定义（D7-D0）
| BIT 位 | 说明 |
| ---- | ---- |
| D7 | 0：实时钟 IC 正常；1：实时钟 IC 不正常 |
| D6 | 0：存储器正常；1：存储器不正常 |
| D5 | 0：工作电源正常；1：工作电源不正常（供电电压低导致 CPU 频繁复位） |
| D4,D3 | 保留 |
| D2 | 0：不监视门开关；1：监视门开关 |
| D1 | 0：门控电磁继电器关闭；1：门控电磁继电器加电驱动 |
| D0 | 0：正常工作；1：处于报警状态 |

#### 第二字节（监控线路的状态）定义（D7-D0）
| BIT 位 | 说明 |
| ---- | ---- |
| D7 | 紧急驱动输入状态 |
| D6,D5,D4 | 固定为 0,0,0 |
| D3 | 0：门关闭；1：门开启 |
| D2 | 固定为 0 |
| D1 | 0：手动开门键松开；1：手动开门键按下 |
| D0 | 0：门控电磁继电器关闭；1：门控电磁继电器加电驱动 |

### 5.7 读取工作特性参数
#### 5.7.1 读取控制信息
- COMMAND TYPE=0XE8
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：5 字节
    | 第 1 字节 | 第 2 字节 | 第 3 字节 | 第 4 字节 | 第 5 字节 |
    | ---- | ---- | ---- | ---- | ---- |
    | 门碰开关、红外状态控制字（D0 低位） | 门锁继电器的执行时间（0.1 秒为单位） | 开门等待进入的延时时间（0.1 秒为单位） | 未定义 | 感应卡的号码获取方法控制字 |

#### 第 1 字节（门碰开关、红外状态控制字）定义（D7-D0）
| BIT 位 | 控制说明 |
| ---- | ---- |
| D7 | 0：不监控门开关状态；1：监控门开关状态（通过门磁），异常报警 |
| D6 | 固定为 0 |
| D5 | 固定为 1（必须靠“开门-再关门”机械动作的弹力才能锁上） |
| D4 | 0：允许“手动开门”输入线与电源地线短接时开门；1：禁止 |
| D3 | 0：门磁输出电平为开门时短路、关门时开路；1：门磁输出电平为开门时断路、关门时短路 |
| D2,D1,D0 | 固定为 0,0,0 |

#### 5.7.2 读取第二控制字节
- COMMAND TYPE=0XEC
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：2 字节
    | 第 1 字节 | 第 2 字节 |
    | ---- | ---- |
    | 控制器的第二控制字（D7-D0） | 未定义 |

#### 第 1 字节（第二控制字）定义（D7-D0）
| BIT 位 | 控制说明 |
| ---- | ---- |
| D7-D2 | 固定为 0,0,0,0,0,0 |
| D1 | 1：“紧急事件”输入 MDIN 与 GND 闭合时，闭门，任何卡不响应；0：“紧急事件”输入 MDIN 与 GND 闭合时，常开门 |
| D0 | 固定为 0 |

### 5.8 读取设备名称及版本号（待定）
- COMMAND TYPE=0XEF
- DATAF：1 字节，=0。
- ES2000 返回结果：
  - DATAINFO：18 字节，设备名称及版本号（名称与版本号之间用“,”隔开，示例：ES2000,VER5.01）。

### 5.9 通信命令中的参数说明
1. 所有日期、时间均采用 BCD 格式（示例：0X99 表示 99 年，0X10 表示 10 月或 10 时）。
2. 所有数值或地址参数（如 SAVEP、LOADP、有效用户数量等），由 SU 命令带入 ES2000 或 ES2000 返回 SU 时，均为低 8 位数在前，高 8 位数在后，以 HEX（或 BCD）形式表示。
3. SU 命令中 CID1（1 字节）参数用于区分设备类别（如电源类、环境类设备），在 ES2000 系列门控器中，CID1 还可扩展 ADR 用（当系统中 ES2000 数量多于 254 个时，分组号在 CID1 的低半字节）：
  | CID1（1 字节 HEX） | 说明 |
  | ---- | ---- |
  | 高半字节 | 固定为 8（表示门禁类） |
  | 低半字节 | 组号（0-15） |

## 附录：门控器(ES2000)的历史记录格式
ES2000 对以下事件发生时会记录，每条记录用 14 字节表示：
| 字段 | 字节数 | 说明 |
| ---- | ---- | ---- |
| 事件来源 | 5 字节 | 卡号、ID 号或其他标识（如报警源、修改标记等） |
| 日期、时间 | 7 字节 | 年（2 字节）、月（1 字节）、日（1 字节）、时（1 字节）、分（1 字节）、秒（1 字节）（BCD 格式） |
| 状态 | 1 字节 | STATUS（D7-D0） |
| 备注 | 1 字节 | REMARK（D7-D0，D0 为最低位），D7=0 表示记录未被 SU 读取；D7=1 表示记录已被 SU 读取 |

### 各类事件记录说明
#### 1. REMARK=0（刷卡开门记录）
- 事件来源：5 字节卡号；
- STATUS：
  | BIT 位 | 说明 |
  | ---- | ---- |
  | D7 | 0 |
  | D6 | 0：原来门处于关状态；1：原来门处于开状态 |
  | D5 | 0 |
  | D4 | 0：开门等待进入延时后，门已正常关闭；1：开门等待进入延时后，门仍开 |
  | D3-D0 | 0 |

#### 2. REMARK=2（远程（由 SU）开门记录）
- 事件来源：5 字节全 0 或上位机带入的操作员编号；
- STATUS：同 REMARK=0 的 STATUS 描述。

#### 3. REMARK=3（手动开门记录）
- 事件来源：5 字节全 0；
- STATUS：同 REMARK=0 的 STATUS 描述。

#### 4. REMARK=22H（紧急联动事件开始）
- 事件来源：5 字节全 0；
- STATUS：=0。

#### 5. REMARK=22H（紧急联动事件结束）
- 事件来源：4 字节全 0 + 第五字节=1；
- STATUS：=0。

#### 6. REMARK=5（报警（或报警取消）记录）
- 事件来源：4 字节全 0 + 报警源 AS（1 字节），AS 定义：
  | AS 值 | 说明 |
  | ---- | ---- |
  | 2 | 门开记录 |
  | 3 | 门关闭记录 |
  | 6 | ES2000 内部存储器发生错误，已自动初始化 |
  | 9 | 门碰开关监测被关闭 |
  | 10 | 门碰开关监测开启 |
- STATUS（记录发生时的输入线状态）：
  | BIT 位 | 说明 |
  | ---- | ---- |
  | D0 | 0 |
  | D1 | 0：手动按键松开；1：手动按键按下 |
  | D2 | 0 |
  | D3 | 0：门处于关状态；1：门处于开状态 |
  | D4-D7 | 保留 |

#### 7. REMARK=6（ES2000 掉电记录）
- 事件来源：ES2000 重新上电的日期、时间（月、日、时、分、秒）；
- STATUS（重新上电时的输入线状态）：
  | BIT 位 | 说明 |
  | ---- | ---- |
  | D0 | 0 |
  | D1 | 0：手动按键松开；1：手动按键按下 |
  | D2 | 0 |
  | D3 | 0：门处于关状态；1：门处于开状态 |
  | D4-D7 | 保留 |

#### 8. REMARK=7（内部控制参数被修改的记录）
- 事件来源：4 字节全 0 + 修改标记（1 字节），修改标记定义（D7-D0）：
  | BIT 位 | 说明 |
  | ---- | ---- |
  | D0 | 1：修改了 ES2000 的密码 |
  | D1 | 1：修改了门的特性控制参数 |
  | D2 | 1：增加了新用户 |
  | D3 | 1：删除了用户资料 |
  | D4 | 1：修改了实时钟 |
  | D5 | 1：修改了控制准进的时段设置 |
  | D6 | 1：修改了节假日列表 |
  | D7 | 1：修改了红外开启（关闭）的设置控制字 |

#### 9. REMARK=8（无效的用户卡刷卡记录）
- 事件来源：5 字节卡号；
- STATUS：类似 REMARK=5 的 STATUS 描述。

#### 10. REMARK=9（用户卡的有效期已过）
- 事件来源：5 字节卡号；
- STATUS：类似 REMARK=5 的 STATUS 描述。

#### 11. REMARK=10（当前时间该用户卡无进入权限）
- 事件来源：5 字节卡号；
- STATUS：类似 REMARK=5 的 STATUS 描述。


