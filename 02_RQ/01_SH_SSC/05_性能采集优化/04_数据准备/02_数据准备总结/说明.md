# å¤§å‘

```
æ•°æ®ä¸èƒ½å«æœ‰"",ä¸ç„¶ä¼šå¯¼è‡´è¯»å–çš„æ—¶å€™æœ‰é—®é¢˜ï¼Œè€Œå¯¼è‡´å˜é‡æ— æ³•ç”Ÿæˆæ— æ³•è¿”å›
```



# æ•°æ®å‡†å¤‡

```
æ€ä¹ˆå‹æµ‹

1ã€200ä¸ªè®¾å¤‡ä¸€ç»„ï¼ˆä½å‹ç›´æµé…ç”µï¼‰
```







```
import groovy.json.JsonBuilder


// æ£€æŸ¥å˜é‡æ˜¯å¦åŠ è½½æˆåŠŸ
if (!vars.get('deviceId')) {
    log.error("âŒ deviceIdå˜é‡ä¸ºç©ºï¼è¯·æ£€æŸ¥CSV Data Set Configé…ç½®")
    log.error("å¯ç”¨å˜é‡åˆ—è¡¨: " + vars.getVariableNames())
    throw new Exception("deviceIdå˜é‡ä¸ºç©ºï¼Œç»ˆæ­¢æ‰§è¡Œï¼") // âœ… æ­£ç¡®åšæ³•
}





// ========== é™æ€æŒ‡æ ‡æ¨¡æ¿ï¼ˆä¸JSONç¤ºä¾‹å®Œå…¨ä¸€è‡´ï¼‰==========
def metrics = [
    [
        meteId: "6200400004301000001",
        meteCode: "004301",
        meteName: "ç›´æµç”µå‹",
        unit: "V",
        index: 1
    ],
    [
        meteId: "6200400004302000001",
        meteCode: "004302",
        meteName: "ç›´æµç”µæµ",
        unit: "A",
        index: 2
    ],
    [
        meteId: "6200400004303000001",
        meteCode: "004303",
        meteName: "åˆ†è·¯XXè¾“å‡ºç”µæµ",
        unit: "A",
        index: 3
    ],
    [
        meteId: "6200400004304000001",
        meteCode: "004304",
        meteName: "ç›´æµåŠŸç‡",
        unit: "kW",
        index: 4
    ]
]

// ========== åŠ¨æ€è®¾å¤‡æ•°æ®ï¼ˆä»CSVè¯»å–ï¼‰==========
def deviceId = vars.get('deviceId')
def deviceName = vars.get('deviceName')
def roomName = vars.get('roomName')

// ========== æ„å»ºdataæ•°ç»„ï¼ˆæ¯ä¸ªè®¾å¤‡4ä¸ªæŒ‡æ ‡ï¼‰==========
def dataArray = metrics.collect { metric ->
    [
        rowNum: 0,
        deviceName: deviceName,
        deviceId: deviceId,
        meteId: metric.meteId,
        meteCode: metric.meteCode,
        meteKind: 1,
        meteName: metric.meteName,
        meteNo: 0,
        unit: metric.unit,
        alertLevel: 0,
        deviceType: 4,
        deviceTypeName: "ä½å‹ç›´æµé…ç”µ",
        roomName: roomName,
        meteType: 1,
        index: metric.index,
        isEdit: false,
        meteKindName: "é¥æµ‹",
        alertLevelName: "æ­£å¸¸"
    ]
}

// ========== æ„å»ºå®Œæ•´è¯·æ±‚ä½“==========
def requestBody = [
    data: dataArray,
    type: "device",
    namespace: vars.get('NAMESPACE')  // ä»ç”¨æˆ·å®šä¹‰å˜é‡è¯»å–
]

// ========== å†™å…¥è¯·æ±‚ä½“å˜é‡==========
vars.put('requestBody', new JsonBuilder(requestBody).toPrettyString())

// ========== è°ƒè¯•æ—¥å¿—ï¼ˆåœ¨jmeter.logæŸ¥çœ‹ï¼‰==========
log.info("å½“å‰è®¾å¤‡ID: ${deviceId}, è®¾å¤‡åç§°: ${deviceName}")
log.info("è¯·æ±‚ä½“é•¿åº¦: ${requestBody.toString().length()} å­—ç¬¦")
```

```
import groovy.json.JsonBuilder
import groovy.json.JsonOutput

// ========== é˜²å¾¡æ€§å˜é‡è·å– ==========
def deviceId = vars.get('deviceId')?.trim()
def deviceName = vars.get('deviceName')?.trim() ?: "UnknownDevice"
def roomName = vars.get('roomName')?.trim() ?: "UnknownRoom"
def namespace = vars.get('NAMESPACE')?.trim() ?: "default"

// ä¸¥æ ¼æ ¡éªŒ
if (!deviceId) {
    def errorMsg = """
    ${'='*50}
    âŒ deviceIdå˜é‡ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼
    ğŸ“‹ å¯ç”¨å˜é‡åˆ—è¡¨: ${vars.getVariableNames()?.sort()?.join(', ')}
    ğŸ’¡ è¯·æ£€æŸ¥ï¼š
       1. CSV Data Set Configæ˜¯å¦åœ¨JSR223ä¹‹å‰
       2. å˜é‡åæ˜¯å¦æ‹¼å†™é”™è¯¯
       3. CSVæ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
    ${'='*50}
    """
    log.error(errorMsg)
    throw new IllegalArgumentException("deviceIdä¸èƒ½ä¸ºç©ºï¼Œç»ˆæ­¢æµ‹è¯•ï¼")
}

log.info("âœ… å˜é‡åŠ è½½æˆåŠŸ: deviceId=${deviceId}, deviceName=${deviceName}, roomName=${roomName}")

// ========== æ„å»ºè¯·æ±‚ä½“ ==========
def metrics = [
    [meteId: "6200400004301000001", meteCode: "004301", meteName: "ç›´æµç”µå‹", unit: "V", index: 1],
    [meteId: "6200400004302000001", meteCode: "004302", meteName: "ç›´æµç”µæµ", unit: "A", index: 2],
    [meteId: "6200400004303000001", meteCode: "004303", meteName: "åˆ†è·¯XXè¾“å‡ºç”µæµ", unit: "A", index: 3],
    [meteId: "6200400004304000001", meteCode: "004304", meteName: "ç›´æµåŠŸç‡", unit: "kW", index: 4]
]

def dataArray = metrics.collect { metric ->
    [
        rowNum: 0,
        deviceName: deviceName,
        deviceId: deviceId,
        meteId: metric.meteId,
        meteCode: metric.meteCode,
        meteKind: 1,
        meteName: metric.meteName,
        meteNo: 0,
        unit: metric.unit,
        alertLevel: 0,
        deviceType: 4,
        deviceTypeName: "ä½å‹ç›´æµé…ç”µ",
        roomName: roomName,
        meteType: 1,
        index: metric.index,
        isEdit: false,
        meteKindName: "é¥æµ‹",
        alertLevelName: "æ­£å¸¸"
    ]
}

def requestBody = [
    data: dataArray,
    type: "device",
    namespace: namespace
]

// ========== å†™å…¥å¹¶éªŒè¯ ==========
def jsonStr = JsonOutput.toJson(requestBody)
vars.put('requestBody', jsonStr)

// åŒé‡éªŒè¯
def verify = vars.get('requestBody')
if (!verify) {
    throw new RuntimeException("å˜é‡å†™å…¥å¤±è´¥ï¼vars.put()æœªç”Ÿæ•ˆ")
}

log.info("""
${'='*50}
âœ… requestBodyå†™å…¥æˆåŠŸï¼
ğŸ“ é•¿åº¦: ${jsonStr.length()} å­—ç¬¦
ğŸ” å˜é‡éªŒè¯: ${verify.take(100)}...
${'='*50}
""")

// ========== è°ƒè¯•ï¼šä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰==========
// new File('debug_requestBody.json').text = jsonStr
```

