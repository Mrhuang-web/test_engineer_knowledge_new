\# ACUC3.0门禁控制器协议 ## 通信协议(RS485/RS422) 2013-03-12 ## 目录 1. [通信规范](#1-通信规范) 2. [通信命令的种类](#2-通信命令的种类) 3. [访问权限的确认0x48](#3-访问权限的确认0x48) 4. [设置命令0x49](#4-设置命令0x49) 5. [读取信息命令(0x4A)](#5-读取信息命令0x4a) 6. [附录: 门控器(SM)的历史记录格式](#6-附录-门控器sm的历史记录格式) ## 1. 通信规范 ### 1.1. 通信速率与数据格式 #### 1.1.1. 通信速率 9600或19200或2400B/S等，SM内应有改变速率的机制。 数据格式：1起始位，8数据位，1停止位，校验方式位。 校验方式有: 无校验; 奇校验; 偶校验; MARK(1)校验; SPACE(0)校验。 参考CHD805系列键盘操作说明书有关章节。 #### 1.1.2. 信息交换的数据桢(命令数据包，或信息数据包) 协议数据包的基本格式: |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字段|起始符|版本|组内地址|类码与组地址|类别|参数长度校验|参数|桢校验|结束符| |字节数|1|1|1|1|1|2|N字节|2|1| |符号|SOI|VER|ADR|CID1|CID2/RTN|L.TH|INFO|CHK-SUM|EOI| - SOI：发送信息起始符 =7EH (START OF INFORMATION) - EOI：发送信息结束符 =0DH (END OF INFORMATION) - VER：通信协议的版本(=10H，表示1.0) - ADR：被定名设备(CHD805A/B)的RS485网上地址(设备ID)(有效值：1-254) - CID1：一字节(D7—D0，D7高位)，D7—D4为设备分类码，环境控制类=8（D7=1，D6=D5=D4=0）；D3—D0为设备分组号(0—15)。意义：当同一系统中设备数目多于254个时，将其分组，最多可以有16*254个设备在同一系统中。 - CID2/RTN：当主控制机(HOST或SU)发送命令时为CID2，实际上是命令的分类码，区分不同类的设备；当控制器(CHD805A/B等)向SU回答时为RTN，反应对命令的处理结果。 - L．TH：为携带参数的长度标识部分(计算见后) - INFO：传递的信息部分(不同设备可以有不同的定义)，SU对SM命令时为命令参数COMINFO，包括：命令分类，命令号，参数；SM对SU的回复时为返回数据DATAINFO：参数信息； - CHK-SUM：传送一桢信息的检查和，从VER开始到INFO最后字节结束，都参与计算。SUM是两字节，高位在前。 ### 1.2. 数据传输与超时错 #### 1.2.1. 传输的方法 SOI，EOI是按单字节(HEX)直接发送，其它(从VER至SUM结束)都是将单字节(HEX)按高半4位(0-9，A-F)，低半4位(0-9，A-F)拆分开，按ASCII码发送，先高4位ASCII码，后低4位ASCII码。 SU与SM之间的通信有以下三种： - 设置SM的权限确认； - 设置SM参数命令； - 读取SM信息的命令。 SU发送命令(设置SM工作参数，或读取SM信息)格式: |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|CID2|L.TH|COMINFO|SUM|EOI| SM对SU的设置命令的应答格式: |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|无|2|1| |格式|SOI|VER|ADR|CID1|RTN|0，0|无|SUM|EOI| SM对SU读取命令的返回格式: |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|RTN|L.TH|DATAINFO|SUM|EOI| 说明如下: - SOI：信息传输起始标志位(1字节)，START OF INFORMATION，固定值=0X7E，发送时按一字节(7EH)发送。 - VER：通信协议版本号(从0X10开始)。 - ADR：设备地址描述(1—254；0和255保留)。 - CID1：设备类型标识控制码，(对门控器高半字节=8)，兼作扩展ADR用，(设备多于254个时，其分组号在CID1的低半字节)。 - CID2/RTN：在SU向SM发送命令时，该位为CID2，表明命令的不同内容，在SM向SU发应答时，该位为RTN(见下述)； - L.TH(LENGTH)：命令帧中“数据信息部份”的字节长度表示(两字节)： |高字节|高字节|高字节|高字节|高字节|高字节|高字节|高字节|低字节|低字节|低字节|低字节|低字节|低字节|低字节|低字节| |---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---| |校验码LCHKSUM|校验码LCHKSUM|校验码LCHKSUM|校验码LCHKSUM|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)| |D15|D14|D13|D12|D11|D10|D9|D8|D7|D6|D5|D4|D3|D2|D1|D0| 数据信息部份”的字节长度=L(即有L个字节数据为命令的参数)，那么发送的ASCII码个数LENID=2L，按4位(BIT)一组，即(D11，D10，D9，D8)(D7，D6，D5，D4)；(D3，D2，D1，D0)；仍按4位(BIT)相累加，结果模16后，对16取补(即4BIT求反加1)，作为LCHKSUM(D15，D14，D13，D12) 检验方法：从D15到D0按4BIT组成4个4位数，全部相加，结果得零。 - INFO：在SU向SM发送命令时，为COMMAND INFO；在SM向SU发应答时，为DATA INFO。 - SUM(CHECKSUM)：数据桢的校验码：CHECKSUM的计算是：整个数据桢中除SOI，EOI和SUM本身之外的其他字符，按发送的ASCII码累加求和(双字节和)，将结果模65536后取补运算(余数取反加1)。高位在前，低位在后。 - EOI：结束码(固定为0DH，发送是按0DH直接发送)。 #### 1.2.2. 超时错时间 500毫秒 ### 1.3. 设备应答 设备SM应答或返回的RTN基本值: |RTN值|代表含义| |---|---| |RTN=00H|SM正常执行SU发来的命令。| |RTN=01H|VER不符，命令未执行。| |RTN=02H|SM接收的命令帧，累加和检查不对。| |RTN=03H|SM接收的命令帧，参数部份的累加和检查不对。| |RTN=04H|无效的CID2。| |RTN=05H|不能识别的命令格式。| |RTN=06H|SM接收的命令帧，数据信息部份有无效数据。| |RTN=07H|SU无设置SM(或访问SM的重要信息)之权限。| |RTN=E0H|SU与SM之间的密码确认不正确。| |RTN=E1H|SU对SM内部密码的修改不成功。| |RTN=E2H|SM内部相应设置项存储空间已满。| |RTN=E3H|SU对SM内部参数的修改(或删除)不成功。| |RTN=E4H|SM内部相应设置项的存储空间已空。| |RTN=E5H|SM内部无相应信息项。| |RTN=E6H|SU重复设入SM相同ID的用户，SM保持原用户不变。| |RTN=E7H|SU重复设入相同卡号的RF卡，给不同的用户。| |RTN=E8H|SU重复设入完全相同的用户。| |RTN=EFH|未知错误| ## 2. 通信命令的种类 SU与SM之间的通信有以下三种： - 访问SM的权限确认通信命令； - 设置SM的参数命令； - 读取SM内部信息的命令。 ## 3. 访问权限的确认0x48 SU设置SM的重要信息，或控制SM动作开门，读取SM内部已授权用户的登记信息等操作之前，必须通过SM的密码认证，才能建立对SM的设置(操作)权限。 ### 3.1. 访问权限确认(0XE0) SM的密码由两部分组成：系统密码2字节(每字节：0→255)，以及SM键盘设置密码3字节，共5字节组成。 **注意**：键盘设置密码3字节是由键盘输入，只能是0—9的数字，共6个，组成3字节BCD码。监控软件要保管好每个控制器的密码，系统维护商也要对密码登记好，CHD805A/B允许从键盘修改键盘设置密码，因此，“监控软件”或“系统维护商”修改了密码，都要相互知会。一当密码忘却，就必须按操作说明重置CHD805A/B密码为全0(5字节全0，出产密码)。 SU发送的命令桢: CID2=48H COMMAND INFO: |COMMAND GROUP|COMMAND TYPE|DATA| |---|---|---| |0XF0|0XE0|5字节的SM密码| 如果DATA“5字节的SM密码”与被访问的SM的内部密码相符，则SM返回：RTN=0，表示SU对SM已通过了设定权限的确认。如果DATA“5字节的SM密码”与被访问的SM的内部密码不相符，则SM返回: RTN=0XE0，表示SU未通过设定权限确认。 SU对SM的设置权限被SM确认后，可以一直保持约1分钟，但是，当SM检测到SU主动取消设置权限时，或SU对SM的设置访问时间间隔超过1分钟，SM将自动取消SU的设置权限。SU只有重新进行“设置权限确认”，才能再次对SM进行设置(控制)操作。 ### 3.2. 访问权限的取消(0XE1) SU通过SM的密码校验后，SM才接受SU的设置，并且允许SU设置间隔约1分钟(SM每次正确接受SU的设置，主动提供1分钟延长许可)，SU在超过1分钟的时间未设定SM，SM将主动关闭允许设置状态。 SU在对SM进行参数设置完成后，应关闭SM的允许设置状态，使SM不被非法设置。SU发送的命令桢: CID2=48H COMMAND INFO: 无DATAF项。 |COMMAND GROUP|COMMAND TYPE| |---|---| |0XF0|0XE1| SM返回: RTN=0，表示SM已取消了SU的设定权限. RTN不为零，表示SU对SM的设定权限未被SM取消. ### 3.3. 修改SM的访问密码(0XE2) SU修改SM的访问密码之前，必须通过“权限确认”，SU发送的命令桢: CID2=48H COMMAND INFO: |COMMAND GROUP|COMMAND TYPE|DATAF1|DATAF2| |---|---|---|---| |0XF0|0XE2|5字节的SM新密码|校验码1字节| “5字节的SM新密码”：由2字节(每个0-255)的系统加重密码，及3字节(BCD)键盘设置密码组成。“校验码”：为“5字节的SM新密码”的5字节逻辑异或值。 SM返回: RTN=0，表示SU对SM的密码修改成功。 RTN=0XE1，表示SU对SM的密码修改不成功。 **注意**：“5字节的SM新密码”的后3字节，应为BCD码，例如：3字节分别为：0X01、0X02、0X03，则键盘设置密码为如下6个数：0，1，0，2，0，3；若后3字节为：0X23，0X98，0X76，则键盘设置密码为：2，3，9，8，7，6 如果后3字节有任一字节不是BCD码，例如：0X12，0X1F，0X56，因“F”键盘无法输入，所以实质上是关闭了键盘设置。 ## 4. 设置命令0x49 SU通过对SM的访问权限认证后，就可以对SM的所有工作参数进行设定. SU发送的命令桢: CID2=49H SU发送设置命令的COMMAND INFO部分如下： COMMAND INFO: |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF1|0XE0至0XFF|参数若干字节| SM返回： RTN=0，表示设置成功；非零值表不成功。 ### 4.1. 设置日期时间的命令(0XE0) COMMAND TYPE=0XE0 DATAF=年(2)，月，日，星期，时，分，秒，共8字节(BCD)；其中：年(2000---2099)，2字节，月(1---12)；日(1---31)，星期(1---7，=7代表星期日)。 SM返回： RTN=0，表示设置成功；非零值，表不成功。 ### 4.2. 设置准进时段 #### 4.2.1. 将准进时段、管理时段设置成缺省值(0XE1) COMMAND TYPE=0XE1，DATAF=1字节(=1) 参数1字节=1 - 设置工作日准进时段：00：00—23：59全天能进； - 设置休息日准进时段：00：00—23：59全天能进； - 设置星期一至星期日的所有准进时段表：00：00—23：59全天能进； - 管理时段：  - 门常开：无效；  - 门常闭：无效；  - 二次加密时段：无效；  - 红外、门磁监控布防时段：无效； #### 4.2.2. 置所有时段无效(0XE1) COMMAND TYPE=0XE1，DATAF=1字节(=0) 参数1字节=0， - 设置工作日准进时段：无效； - 设置休息日准进时段：无效； - 设置星期一至星期日的所有准进时段表：无效； - 管理时段：  - 门常开：无效；  - 门常闭：无效；  - 二次加密时段：无效；  - 红外、门磁监控布防时段：无效； #### 4.2.3. 设置工作日的准进时段(0XE1) COMMAND TYPE=0XE1 DATAF部分: |GROUP No.|16字节准进时段描述列表| |---|---| |1字节(1~4)|HH:MM(HH:MM，HH:MM(HH:MM，HH:MM(HH:MM，HH:MM(HH:MM| 其中：GROUP_No.(有效值1~4，1字节)，表示该时段在系统内的编号。 表示：在工作日内4段从“起始时间”至“结束时间”才准进。 门控器最多存放4张工作日准进列表(GROUP No.=1~4)，每张列表表明工作日内的4个准进时段，每个准进时段用：“起始时间---结束时间”4字节BCD码表示在该时间段内准进。 例如：00：00(02:00，04:00(06:30，08:00(20:00，22:10(22:45。表示从0点至2点，4点至6点30分，8点至20点，22点10分至22点45分，共4个时间段才准进，其它时间不准进。(上述表示HH:MM的数值均为BCD码，如22：45是0X22，0X45两字节)。 又如：07:00(08:00，09:00(09:78，FF:00(13:15，12:00(14:59，因“FF”为无效时间值，“78”也为无效时间值，所以上述的第二，三段无效，准进时间为:7点至8点，12点至14点59分，其它时间不准进。 SM返回： RTN=0，表示设置成功；其它值：不成功。 #### 4.2.4. 设置非工作日(节假日，或星期内休息日)的准进时段(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=1； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=1|HH:MM(HH:MM，HH:MM(HH:MM，HH:MM(HH:MM，HH:MM(HH:MM| 其中： 时段描述(16字节)：共4组“起始时间---结束时间”列表： HH：MM(起始) ( HH:MM(结束) HH：MM(起始) ( HH:MM(结束) HH：MM(起始) ( HH:MM(结束) HH：MM(起始) ( HH:MM(结束) 表示：在非工作日内，从“起始时间”至“结束时间”才准进。门控器最多存放1张“非工作日准进”列表。 SM返回： RTN=0，表示设置成功；其它值：不成功。 #### 4.2.5. 设定星期准进时间段列表(0XF1) COMMAND TYPE=0XF1；DATAF 26字节。 前1、2字节：表示第几张表的星期几，如9，6表示第9+1张表的星期六。SM内最多存储16张表，每张表有7天(星期一至星期日)，每天有6个准进时段，每个时段占用4字节(表示“起始时间(结束时间”的BCD值)。 第一字节的有效值0—15(=0X0F) 第二字节的有效值1—7 从第三字节至26字节该设定日的6个准进列表，每个准进列表占4字节(BCD，表示“起始时间(结束时间”) HH：MM(起始) ( HH:MM(结束)；HH：MM(起始) ( HH:MM(结束) HH：MM(起始) ( HH:MM(结束)；HH：MM(起始) ( HH:MM(结束) HH：MM(起始) ( HH:MM(结束)；HH：MM(起始) ( HH:MM(结束) SM返回： RTN=0，表示设置成功；=其它值：不成功。 ### 4.3. 用户(准进人员)管理 #### 4.3.1. 增加一个用户(至门控制器)(0XE3) COMMAND TYPE=0XE3 DATAF=新用户描述(16字节) |卡片编号|用户编号ID|用户密码|有效期4字节|用户权限1字节| |---|---|---|---|---| |5字节(HEX)|4字节(BCD)|2字节(BCD)|YYYY，MM，DD|VIP，时段码| 卡片编号高位在前，低位在后 有效期(4字节)：年(2字节)，月，日(BCD) 如：0X20，0X12，0X12，0X31，表直到2012年12月31日才过期。 用户权限(1字节)：D7---D0(D0为低位BIT) D7，D6 = 0，0：一般用户(受星期准进时段限制) = 0，1：一般用户(受星期准进时段限制) = 1，0：一般用户(受工作日/休息日准进时段限制) D7，D6 = 1，1：特权用户(不受任何准进时段限制)，但受有效期等限制。 (1)当D7，D6=1，0时，D5，D4，D3，D2：保留 D1，D0：一般用户的工作日的准进时段GROUP.No； 0，0 对应第一张表 0，1 对应第二张表 1，0 对应第三张表 1，1 对应第四张表 (2)当D7，D6=0，0或0，1时，D5，D4：保留 D3，D2，D1，D0：该用户适用的星期列表的第几张(索引系统的准进列表)。 SM返回： RTN =0，表示设置成功； =0XE2，表SM内已满； RTN =E7H，卡号重复； =E6H，用户ID号重复； =E8H，用户信息项全部重复设置 其它值：不成功。 #### 4.3.2. 更新原用户某些信息(0XE3) (1)COMMAND TYPE=0XE3 DATAF=16字节：5字节卡号 + 4字节用户号 + 7字节更新信息 |用户标识信息(卡号+ID编号)|用户标识信息(卡号+ID编号)|更新如下信息|更新如下信息|更新如下信息| |---|---|---|---|---| |卡片编号|用户编号ID|用户密码|有效期4字节|用户权限1字节| |5字节(HEX)|4字节(BCD)|2字节(BCD)|YYYY，MM，DD|VIP，时段码| (2)COMMAND TYPE=0XE3 DATAF=12字节：5字节卡号 + 7字节用户信息项 |标识|标识|更新如下信息|更新如下信息| |---|---|---|---| |卡片编号|用户密码|有效期4字节|用户权限| |5字节(HEX)|2字节(BCD)|YYYY，MM，DD|VIP，时端码| (3)COMMAND TYPE=0XE3 DATAF=6字节：5字节卡号 + 1字节(用户权限) |卡片编号|新的“用户权限”1字节| |---|---| |5字节(HEX)|VIP，时端码| (4)COMMAND TYPE=0XE3 DATAF=7字节：5字节卡号 + 2字节(用户密码) |卡片编号|新的“用户密码”2字节| |---|---| |5字节(HEX)|用户个人密码| (5)COMMAND TYPE=0XE3 DATAF=9字节：5字节卡号 + 4字节(用户有效期) |卡片编号|新的“用户有效期”4字节| |---|---| |5字节(HEX)|用户有效期：YYYY：MM：DD| 有效期(4字节)：年(2字节)，月，日(BCD) 如：0X20，0X12，0X12，0X31，表直到2012年12月31日才过期。 SM返回： RTN=0，表示设置成功； 其他值，表示不成功。 #### 4.3.3. 删除用户卡(从门控制器内)(0XE4) COMMAND TYPE=0XE4 DATAF=6字节，如下： |1字节指引|某用户的5字节卡片编号| |---|---| |=0|5字节卡片编号，删除一个用户(以卡片编号检索)| 功能：将该卡号的用户从控制器内删除。 SM返回： RTN=0，表示删除成功； =0XE5表SM内没有该用户； =0XE4，全空； RTN=0XE3，或其它值：不成功。 #### 4.3.4. 删除用户编号(ID)(从门控制器内)(0XE4) COMMAND TYPE=0XE4 DATAF=6字节，如下： |1字节指引|1字节0 + 4字节用户编号(ID)| |---|---| |=1|00+4字节用户ID ，删除一个用户(以用户ID检索)| 功能：将该ID编号的用户从控制器内删除。 SM返回： RTN=0，表示删除成功；=0XE5表SM内没有该用户；=0XE4，全空； RTN=0XE3，或其它值：不成功。 #### 4.3.5. 全部删除用户(从门控制器内)(0XE4) COMMAND TYPE=0XE4 DATAF=6字节，如下： |1字节指引|5字节卡片编号，或00+4字节用户ID| |---|---| |=2|5字节全为00 ，删除全部用户| SM返回： RTN=0，表示删除成功；=0XE5表SM内没有该用户；=0XE4，全空； RTN=0XE3，或其它值：不成功。 ### 4.4. 设定门的特性参数 #### 4.4.1. 门锁继电器执行时间(单独设定)(0XE6) COMMAND TYPE=0XE6，DATAF 1字节，(1--255)，单位：0.1 秒。 例如：DATAF=50(十进制)，表对门锁继电器加电5秒钟。 COMMAND TYPE=0XE5，DATAF 5字节或6字节时的第二字节. #### 4.4.2. 开门后等待进入的延时时间(单独设定)(0XE7) COMMAND TYPE=0XE7，DATAF为1字节，(有效值20--255)，单位：0.1 秒。 例如：DATAF=50(十进制)，表门锁打开后5秒钟内应开门进入，然后关门；未开门进入，视门电磁锁的特性，若必须由机械“开门--关门”动作，才能重新锁上，则报警，要求“开门--关门”。保证门准确锁上。 COMMAND TYPE=0XE5，DATAF 5字节或6字节时的第三字节. #### 4.4.3. 红外报警输出的被确认时间(单独设定)(0XE8) COMMAND TYPE=0XE8，DATAF为1字节，(有效值20--255)，单位：0.1 秒。 例如：DATAF=50(十进制)，表红外报警发生，经5秒钟确认后，才输出报警信号。 COMMAND TYPE=0XE5，DATAF 5字节或6字节时的第四字节. #### 4.4.4. 设定异地报警的延时时间(单独设定)(0XE9) COMMAND TYPE=0XE9，DATAF为1字节，(有效值0--255)，单位：0.1秒。 =1--255 异地报警输出时间，单位：0.1秒。(=0按256处理:25.6秒) COMMAND TYPE=0XE5，DATAF 5字节或6字节时的第五字节. COMMAND TYPE=0XE5，参数DATAF有1，或2，或5，或6: - 参数DATAF为1字节时，仅设入第一控制字(布防与撤防)，见4.6.1节 - 参数DATAF为2字节时，设入第一控制字(布防与撤防)，及第二控制字(4.6.6节) - 参数DATAF为5字节时，设入4.6.1---4.6.5节的5个参数 - 参数DATAF为6字节时，设入4.6.1---4.6.6节的6个参数 #### 4.4.5. 开启红外监控后的等待延时(0XEF) 让“开启者”有足够时间离开红外监视区，以免误报警。 COMMAND TYPE=0XEF；DATAF 2字节， 第一字节：=0 第二字节：开启延时DELAY TIME(0.1秒为单位)，有效值20--255 红外开启条件满足后，延时DELAY TIME，才开启监测红外， 在设置时请注意：DELAY TIME 1字节(20-255)单位:0.1秒，对应2-25.5秒 SM返回： RTN=0，表示设置成功；=其它值：不成功。 **注**： 1. SU通过RS485联网，随时可以开启或关闭红外监控，不受该控制字的影响，也无延时。 2．CHD805A/B在刷卡开门，或键盘输入用户ID号及密码开门，或远程RS485开门时，自动关闭红外监控； 3．CHD805A/B可由键盘开启<F4>键，或RS485远程命令开启红外监控。 #### 4.4.6. 门磁、红外等感应器的特性(单独设定)(0XE5) 门磁感应器的输出特性状态； 红外感应器的输出特性； 电控锁的输出特性； COMMAND TYPE=0XE5，DATAF= 1字节， D7---D0(D0为低位BIT) 第一控制字的每一BIT位都有其特定的意义: |BIT位|控制|说明| |---|---|---| |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 (1)非正常开门；(2)不能自动关门的锁，刷卡后无开门后--再关门的机械动作；(3)开门延时结束后，还未关门；| |D6|=0|不监控红外| ||=1|监控红外，“非法进入监控区域”则报警，产生记录。合法刷卡进入，或KEYPAD上输入用户号/密码而开门进入 ，远程RS485命令放行(进入)，控制器都会自动关闭红外监控。可以由远程RS485命令开启，或KEYPAD上直接开启。(KEYPAD上不能关闭，只能开启；只有合法刷卡才能关闭)| |D5|=0|电磁锁在断电后(或加电后)能自动锁上；| ||=1|必须靠“开门——再关门”机械动作的弹力才能锁上;| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门. =1，禁止.| |D3|=0|设定门磁输出电平为: 开门时门磁两信号线是短路(通)；门关上后，两信号线开路(不通)| ||=1|设定门磁输出电平为: 开门时门磁两信号线是断路(开)；门关上后，两信号线短路合上(通)| |D2|=0|设定红外感应器的输出电平：报警时两信号线是短路(通)；正常时(不报警)两信号线开路(不通)| ||=1|设定红外感应器的输出电平：报警时两信号线是断路(不通)；正常时(不报警)两信号线短路(通)| |D1|=0|刷卡合法，就能开门，无须再个人密码确认；| ||=1|刷卡合法，必须再个人密码确认后，才能开门；| |D0|=0|不允许从键盘单独按一个<ENT>键手动开门；| ||=1|允许从键盘单独按一<ENT>键手动开门，而节省手动开门按键；| #### 4.4.7. 联动及报警输出特性(0XFC) COMMAND TYPE=0XFC，DATAF为1字节 控制器的工作方式第二控制字为1字节(初始值=0)。它要经过如下计算得到：一字节数(D7—D0)(D0低位)，如下定义： |BIT位|控制|说明| |---|---|---| |D7|=0|联动输入CPLD1的有效电平| ||=1|| |D6|=0|联动输入CPLD2的有效电平| ||=1|| |D5||“联动CPLD1，CPLD2”输入，控制器响应的规定动作:| |D4||| |D3|=0/1|ALARM输出在报警时是“导通”=0； “开路”=1| |D2|=1|在刷卡时主动将接受到的维根数据信号发给RS485的连接电脑; =0禁止| |D1|=1|“紧急事件”输入MDIN与GND闭合时，闭门， 任何卡不响应;| ||=0|“紧急事件”输入MDIN与GND闭合时，常开门;| |D0|=0|个人输入ID号+密码开门被禁止；| ||=1|允许个人输入ID号+密码开门；| #### 4.4.8. 整体设定(1)(0XE5) 一次设定两个参数： - 门磁、红外等感应器的特性(见4.4.6节) - 联动及报警输出特性(见4.4.7节) COMMAND TYPE=0XE5，DATAF= 2字节时 第1字节为: 门磁、红外等感应器的特性(见4.4.6节) 第2字节为: 联动及报警输出特性(见4.4.7节) SM返回：RTN=0，表示成功； 其它值：不成功。 #### 4.4.9. 整体设定(2)(0XE5) 一次设定五个参数： - 门磁、红外等感应器的特性(见4.4.6节) - 门锁继电器执行时间(见4.4.1节) - 开门后等待进入的延时时间(见4.4.2节) - 红外报警输出的被确认时间(见4.4.3节) - 设定异地报警的延时时间(见4.4.4节) COMMAND TYPE=0XE5，DATAF= 5个字节时 第1字节----第5字节依次为: (1)--(5)的内容。 SM返回：RTN=0，表示成功； 其它值：不成功。 #### 4.4.10. 整体设定(3)(0XE5) 一次设定六个参数： - 门磁、红外等感应器的特性(见4.4.6节) - 门锁继电器执行时间(见4.4.1节) - 开门后等待进入的延时时间(见4.4.2节) - 红外报警输出的被确认时间(见4.4.3节) - 设定异地报警的延时时间(见4.4.4节) - 联动及报警输出特性(见4.4.7节) COMMAND TYPE=0XE5，DATAF= 6个字节时 第1字节----第6字节依次为: (1)--(6)的内容。 SM返回：RTN=0，表示成功； 其它值：不成功。 #### 4.4.11. 设定红外感应器在报警时的有效电平(输出给门控器)(0XF6) COMMAND TYPE=0XF6；DATAF 1字节， =0: 表示低电平有效(或继电器输出时，为吸合)； =1: 表示高电平(或继电器输出时，继电器断开为有效) SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.4.12. 设定门开关感应器在开门状态时的有效电平(输出给门控器)(0XF7) COMMAND TYPE=0XF7；DATAF 1字节， =0: 表示低电平有效(或继电器输出时，为吸合)； =1: 表示高电平(或继电器输出时，继电器断开为有效) SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.4.13. 设定门控电磁锁的(种类)特性(0XF9) COMMAND TYPE=0XF9；DATAF 1字节， =0: 断电或加电，能自动锁上----一般电控阴锁口； =1: 不能自动锁上，必须由“开门再关门”的机械动作才能锁上----一般电脉冲锁。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.4.14. 设置系统支持维根感应头的种类及卡片编号的获取方法(0XEE) 如果获取卡片编号的方法，结果多于5字节，则留低位5字节，舍去高位字节。 COMMAND TYPE=0XEE DATAF 1字节， D3---D0 CHD805A/B支持维根感应头的种类 =0 维根26 =1 维根36 =2 维根44 =3 维根34 CHD805A版本V3.0以上已对上述维根感应头自动支持，无需设置。 D7---D4 设定门控器从WIEGAND的BIT流中获取感应卡之编号的方式 = 0 全部BIT作为卡片编号，不足5字节，高位补0 = 1 除去校验位，取其全部BIT，不足5字节，高位补0 = 2 除去校验位，取低位2字节，高位补0 = 3 除去校验位，取低位3字节，高位补0 = 4 除去校验位，取低位4字节，高位补0 = 5 除去校验位，取低位5字节。 = 其它值 按 =0 处理 SM返回：RTN=0，表示设置成功；其它值表示不成功。 #### 4.4.15. 设定系统使用的感应卡种类(0XF2) COMMAND TYPE=0XF2； DATAF 1字节 =0 维根26 =1 维根36 =2 维根44 =3 维根34 其它值无效。 SM返回：RTN=0，表示设置成功；=其它值：不成功。 #### 4.4.16. 设定统感应卡编号的获取方法(0XF3) 感应卡阅读器WIEGAND格式输出BIT流(26BIT/36BIT/44BIT/64BIT) COMMAND TYPE=0XF3 DATAF 1字节 = 0 全部BIT作为卡片编号，不足5字节，高位补0 = 1 除去校验位，取其全部BIT，不足5字节，高位补0 = 2 除去校验位，取低位2字节，高位补0 = 3 除去校验位，取低位3字节，高位补0 = 4 除去校验位，取低位4字节，高位补0 = 5除去校验位，取低位5字节。 = 其它值 按 =0 处理 SM返回：RTN=0，表示设置成功；=其它值：不成功。 ### 4.5. 设定门控器工作方式 #### 4.5.1. 启用或关闭CHD805键盘<ENT>开门许可(0XF4) 如果CHD805A/B安装室内，利用其自身的键盘<ENT>作为“手动开门按键” COMMAND TYPE=0XF4，DATAF 1字节，=0关闭; =1启动 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.5.2. 设定是否刷卡加密码(0XF5) COMMAND TYPE=0XF5；DATAF 1字节， =0：表示只要卡片合法，且在准进时段内就能开门，无需输入用户密码。 =1：表示必须卡片合法，且在准进时段内，要求输入用户密码，正确后，才能开门进入。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.5.3. 启用或关闭 “手动开门按键”输入(0XF8) COMMAND TYPE=0XF8；DATAF 1字节， =1: 表示关闭； =0: 表示启用。(注意: 1表示关闭; 0启用) SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.5.4. 红外监控的布防与撤防(0XFA) COMMAND TYPE=0XFA；DATAF 1字节， =0: 关闭监视； =1: 打开监视。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.5.5. 门开关状态监控的布防与撤防(0XFB) COMMAND TYPE=0XFB；DATAF 1字节， =0 关闭监视(门开关状态)； =1 监视(门开关状态)。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.5.6. 布防与撤防(第一控制字)(0XE5) COMMAND TYPE=0XE5，DATAF= 1字节时，D7---D0(D0为低位BIT) 第一控制字的每一BIT位都有其特定的意义: |BIT位|控制|说明| |---|---|---| |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 (1)非正常开门；(2)不能自动关门的锁，刷卡后无开门后--再关门的机械动作；(3)开门延时结束后，还未关门；| |D6|=0|不监控红外| ||=1|监控红外，“非法进入监控区域”则报警，产生记录。合法刷卡进入，或KEYPAD上输入用户号/密码而开门进入 ，远程RS485命令放行(进入)，控制器都会自动关闭红外监控。可以由远程RS485命令开启，或KEYPAD上直接开启。(KEYPAD上不能关闭，只能开启；只有合法刷卡才能关闭)| |D5|=0|电磁锁在断电后(或加电后)能自动锁上；| ||=1|必须靠“开门——再关门”机械动作的弹力才能锁上;| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门| ||=1|禁止| |D3|=0|设定门磁输出电平为: 开门时门磁两信号线是短路(通)；门关上后，两信号线开路(不通)| ||=1|设定门磁输出电平为: 开门时门磁两信号线是断路(开)；门关上后，两信号线短路合上(通)| |D2|=0|设定红外感应器的输出电平：报警时两信号线是短路(通)；正常时(不报警)两信号线开路(不通)| ||=1|设定红外感应器的输出电平：报警时两信号线是断路(不通)；正常时(不报警)两信号线短路(通)| |D1|=0|刷卡合法，就能开门，无须再个人密码确认；| ||=1|刷卡合法，必须再个人密码确认后，才能开门；| |D0|=0|不允许从键盘单独按一个<ENT>键手动开门；| ||=1|允许从键盘单独按一<ENT>键手动开门，而节省手动开门按键；| 参考4.4.6，4.4.8，4.4.9，4.4.10 #### 4.5.7. 设定控制器的第二控制字(0XFC) COMMAND TYPE=0XFC，DATAF为1字节 控制器的工作方式第二控制字为1字节(初始值=0)。它要经过如下计算得到：一字节数(D7—D0)(D0低位)，如下定义： |BIT位|控制|说明| |---|---|---| |D7|=0|联动输入CPLD1的有效电平| ||=1|| |D6|=0|联动输入CPLD2的有效电平| ||=1|| |D5||“联动CPLD1，CPLD2”输入，控制器响应的规定动作:| |D4||| |D3|=0/1|ALARM输出在报警时是“导通”=0； “开路”=1| |D2|=1|在刷卡时主动将接受到的维根数据信号发给RS485的连接电脑;| ||=0|禁止| |D1|=1|“紧急事件”输入MDIN与GND闭合时，闭门， 任何卡不响应;| ||=0|“紧急事件”输入MDIN与GND闭合时，常开门;| |D0|=0|个人输入ID号+密码开门被禁止；| ||=1|允许个人输入ID号+密码开门；| 参考4.4.7节 参考4.4.9节 COMMAND TYPE=0XE5 ，DATAF 2字节时的第二字节. 参考4.4.10节 COMMAND TYPE=0XE5 ，DATAF 6字节时的第六字节. #### 4.5.8. 设定控制器的第三控制字(0XFD) COMMAND TYPE=0XFD，DATAF为1字节 控制器的工作方式第三控制字为1字节(初始值=0)。它要经过如下计算得到：一字节数(D7—D0)(D0低位)，如下定义： 第三字节控制字： |BIT位|控制|说明| |---|---|---| |D7|0/1|=1起用常闭门时段， 在设置的常闭门时段内，将门常闭| |D6|=0|=1起用常开门时段， 在设置的常开门时段内，将门常开(节假日、休息日除外)| ||=1|| |D5||=0检查 “一般准进人员”的准进时端; =1不检查| |D4||=0检查 “一般准进人员”的授权有效期; =1不检查| |D3|=0/1|=1开启胁迫报警功能; =0关闭| |D2|=0/1|=1“刷卡正确必须输入个人密码”的时间段开启| |D1|=1|分体刷卡头“刷卡正确必须输入个人密码”| ||=0|分体刷卡头刷卡正确即可| |D0|=1|主体刷卡头“刷卡正确必须输入个人密码”| ||=0|主体刷卡头刷卡正确即可| ### 4.6. 节假日管理 #### 4.6.1. 设定星期内的休息日(0XEA) COMMAND TYPE=0XEA，DATAF 2字节(1--7)，代表星期内休息哪两天。 1--6，星期一 至 星期六，7，星期日。 其它值，表示不休息，如：7，0XFF，表示仅星期日(=7)休息。 SM返回： RTN=0，表示成功； 其它值：不成功。 #### 4.6.2. 设定国家法定节假日(不包括星期内休息日)(0XEB) COMMAND TYPE=0XEB；DATAF 2字节：MM，DD (月，日)BCD表示。 注： SM内最多存放40个节假日。 SM返回： RTN=0，表示成功；=0XE2表SM内已满40组；其它值：不成功。 #### 4.6.3. 删除一组节假日(0XEC) COMMAND TYPE=0XEC；DATAF 2字节：MM，DD (月，日)BCD表示。 如 DATAF 2字节全00，表全部删除。 SM返回：RTN=0，表示删除成功；=0XE5表SM内没有该组； RTN=0XE4， 节假日列表已经全空; 其它值：不成功。 #### 4.6.4. 清空节假日列表(全部删除)(0XEC) COMMAND TYPE=0XEC；DATAF 2字节：全部为00，表全部删除。 SM返回：RTN=0，表示删除成功；RTN=0XE4， 节假日列表已经全空;	其它值：不成功。 ### 4.7. 记录区的管理 控制器内历史记录的存储示意: 记录未满: [记录存储示意图] SU 只能读取 “底”BOTTOM(=0)至 “顶”TOP(=SAVEP—1)的区段之有效记录。BOTTOM位置为最早(旧)的记录， “顶” TOP位置为最新的记录。TOP+1(=SAVEP) 至MAXLEN—1区间都是空白区。 TOP的值等于MAXLEN SU能读取整个记录区的记录，记录最早(旧)至最新存放位置： SAVEP ( MAXLEN ( BOTTOM ( SAVEP — 1 SAVEP—1位置为最新记录，而SAVEP位置为最早(旧)记录。 柜桶最大深度MAXLEN：表示SM存储历史记录的最大空间(条数)；当该空间存储满后，SM将自动覆盖最早的记录(MF的D7=1)，存储最新的记录，保留的最新记录MAXLEN条。SM的“覆盖”操作若改动“最后读取指针 LOADP”，则MF的D0=1。 如下计算有效记录数： (1)当MF的D7=0，有效记录数N=SAVEP—BOTTOM LOADP的有效范围：BOTTOM至SAVEP—1 (2)当MF的D7=1，有效记录数 N=MAXLEN LOADP的有效范围：BOTTOM至MAXLEN—1，注意：最早(旧)记录在SAVEP	位置，而最新记录在SAVEP—1位置。 如 MF的D0=0 SM内LOADP处的历史记录与SU已读取的记录，是联贯的； 如 MF的D0=1 SM内LOADP处的历史记录与SU已读取的记录，是不联贯的，部分最早记录在SM中被覆盖。 #### 4.7.1. 初始化记录区(清空记录)(0XF0) COMMAND TYPE=0XF0；DATAF 5字节全部为0 SM返回：RTN=0，表示成功； 其它值：不成功。 #### 4.7.2. 设定读指针(0XF0)(修改) COMMAND TYPE=0XF0；DATAF 5字节 |LOADP|MF | |---|---| |低字节在前（4字节）|1字节| MF(或LOADP-MF)字节的D7位:表示记录区已满位; D0位表示覆盖位。 SM返回：RTN=0，表示成功；其它值：不成功。 #### 4.7.3. 设定整个记录区指针(0XF0)(修改) COMMAND TYPE=0XF0；DATAF 9字节 SAVEP：（4字节）表示SM下一条记录存储的位置（低位在前）； LOADP：（4字节）表示SU下一次读取记录的位置（低位在前）； LOADP—MF（1字节） D7=1，整个记录区都允许读取； D7=0，允许读取从0(SAVEP-1 的位置的记录 SM返回：RTN=0，表示成功； 其它值：不成功。 ### 4.8. 远程开关门 #### 4.8.1. 单一放行(不带系统操作员信息)(0XED) COMMAND TYPE=0XED	， DATAF 1字节时， =1 开门； =0 不操作； SM返回：RTN=0，表示开门成功；其它值：不成功。 #### 4.8.2. 单一放行(带系统操作员信息)(0XED) COMMAND TYPE=0XED DATAF=6字节 |第1字节|后5字节| |---|---| |=1开门 =0不操作|操作员编号信息 存放在远程开门记录结构中的前5字节| SM返回：RTN=0，表示开门成功； 其它值：不成功。 #### 4.8.3. 远程命令开门(立即常开一段时间)(OXFE) COMMAND TYPE=0XFE; DATAF 2字节，第1字节=0 固定；第2字节=常开的时间(1—255)分钟。 SM返回：RTN=0，表示设置成功； = 其它值：不成功 #### 4.8.4. 远程命令门停止常开(0XFE) COMMAND TYPE=0XFE; DATAF 2字节， 第1字节=0 固定； 第2字节=0 。 将 “门常开”停止。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.8.5. 远程命令门立即常闭一段时间(布防)(0XFE) COMMAND TYPE=0XFE; DATAF 2字节， 第1字节=1 固定； 第2字节=常闭的时间(1—255)分钟。 在常闭时不接受刷卡等开门。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.8.6. 远程命令取消常闭(撤防)(0XFE) COMMAND TYPE=0XFE; DATAF 2字节， 第1字节=0 固定； 第2字节=0 ; SM返回：RTN=0，表示为告警；=其它值：不成功 #### 4.8.7. 声光报警器状态查询(0XFF) COMMAND TYPE=0XFF; DATAF 2字节， 第1字节=0 固定； 第2字节=0 ; SM返回：RTN=0，表示无告警；=1：正在告警；=2：未启用告警 #### 4.8.8. 无条件启动声光报警器(0XFF) COMMAND TYPE=0XFF; DATAF 2字节， 第1字节=1 固定； 第2字节=0 ; SM返回：RTN=0，表示成功；=其它值：不成功 #### 4.8.9. 无条件停止声光报警器(0XFF) COMMAND TYPE=0XFF; DATAF 2字节， 第1字节=2 固定； 第2字节=0 ; SM返回：RTN=0，表示成功；=其它值：不成功 #### 4.8.10. 无条件禁用声光报警器(0XFF) COMMAND TYPE=0XFF; DATAF 2字节， 第1字节=3 固定； 第2字节=0 ; SM返回：RTN=0，表示成功；=其它值：不成功 #### 4.8.11. 启用声光报警器(0XFF) COMMAND TYPE=0XFF; DATAF 2字节， 第1字节=4 固定； 第2字节=0 ; SM返回：RTN=0，表示成功；=其它值：不成功 ### 4.9. 设置管理时段 #### 4.9.1. 设置工作日内门常开时段(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=5； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=5|HH:MM(HH:MM， HH:MM(HH:MM，HH:MM(HH:MM， HH:MM(HH:MM| 其中： 时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示： 在工作日内， 从“起始时间”至 “结束时间”门常开，无须刷卡。休息日、节假日无效。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.9.2. 设置一天内门常闭时段(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=7； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=7|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”门常闭，刷卡无效。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.9.3. 设置自动开启对红外、门开关的监控时段(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=8； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=8|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”监控门开关及红外。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.9.4. 设置一天内二次加密时段(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=6； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=6|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”刷卡必须输入个人密码。如果二次密码确认时段开启，那么“星期内休息日、节假日”刷卡必须输入用户个人密码。 SM返回：RTN=0，表示设置成功；其它值：不成功。 ### 4.10. 布防与撤防 #### 4.10.1. 红外监控的布防与撤防(0XFA) COMMAND TYPE=0XFA; DATAF 1字节， =0: 关闭监视； =1: 打开监视。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.10.2. 门开关状态监控的布防与撤防(0XFB) COMMAND TYPE=0XFB; DATAF 1字节， =0 关闭监视(门开关状态)；=1 监视(门开关状态)。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.10.3. 设置自动开启对红外、门开关的监控时段(自动监控布防)(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=8； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=8|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”监控门开关及红外。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.10.4. 设置一天内门常闭时段(自动闭门布防)(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=7； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=7|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”门常闭，刷卡无效。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.10.5. 远程命令即时布防(闭门布防)(0XFE) COMMAND TYPE=0XFE; DATAF 2字节， 第1字节=1 固定； 第2字节=常闭的时间(1—255)分钟。 在常闭时不接受刷卡等开门。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.10.6. 远程命令撤消常闭安防(0XFE) COMMAND TYPE=0XFE; DATAF 2字节， 第1字节=1 固定； 第2字节=0 ; SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 4.10.7. 准进(二次加密)限制(布防)(0XE2) COMMAND TYPE=0XE2 DATAF部分(共17字节): 第1字节必须=6； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=6|HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM， HH:MM(HH:MM| 其中：时段描述(16字节)：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在一天内， 从“起始时间”至 “结束时间”刷卡必须输入个人密码。 SM返回：RTN=0，表示设置成功；其它值：不成功。 #### 4.10.8. 布防撤防控制字 参考: 4.5.6， 4.5.7， 4.5.8节。 ### 4.11. 设置DI3功能参数(0XD0) COMMAND TYPE=0XD0；DATAF 1字节 = 0:不使用 = 1:作红外通道 = 2:消防告警联动通道 = 3:钥匙开门检测通道 SM返回：RTN=0，表示成功； 其它值：不成功 ### 4.12. 设置读卡认证信息(0XD1) COMMAND TYPE=0XD1；DATAF 16字节 | | | |---|---| | | | SM返回：RTN=0，表示成功； 其它值：不成功 ### 4.13. 恢复出厂设置(0XD2) 此命令将会擦出整片FLASH，然后使用默认参数； COMMAND TYPE=0XD2；DATAF 0字节 SM返回：RTN=0，表示成功； 其它值：不成功 ## 5. 读取信息命令(0x4A) SU 随时都可以对SM的历史记录，监控状态等进行读取。 SU发送的命令桢: CID2 = 4AH SU发送读取命令的COMMAND INFO部分如下： |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF2|0XE0至0XEF|1字节(读取记录命令时，2字节)| ### 5.1. 读取SM的实时钟(0XE0) COMMAND TYPE=0XE0; DATAF ( 1字节) =0 SM 返回： DATAINFO：年(2)，月，日，星期，时，分，秒，共8字节BCD。 其中： 年(2字节)：2000---2099 ### 5.2. 读取记录信息 #### 5.2.1. 读取历史记录柜桶参数(0XE1) COMMAND TYPE=0XE1; DATAF(1字节) =0 SM 返回： DATAINFO(9字节)： 桶底BOTTOM(2字节)； 下一次新记录存放指针 SAVEP(2字节)； 下一次读取记录位置指针 LOADP(2字节) SM已修改LOADP标志MF (1字节)(D0=0 未修改)。 柜桶最大深度MAXLEN(2字节)； 说明： (1)SM内未存满(未覆盖最早历史记录) BOTTOM LOADP SAVEP MAXLEN 已读取过 未读取过 空白区 SU 只能读取BOTTOM(=0)至TOP(SAVEP)—1的区段之有效记录。 BOTTOM位置为最早(旧)的记录，SAVEP—1位置为最新的记录。 SAVEP至MAXLEN—1区间都是空白区。 (2)SM内已存满(已覆盖最早历史记录) 至最新 由最早 新 BOTTOM SAVEP LOADP MAXLEN 已被覆盖 TOP的值等于MAXLEN SU能读取整个记录区的记录，记录最早(旧)至最新存放位置： SAVEP ( MAXLEN ( BOTTOM ( SAVEP — 1 SAVEP—1位置为最新记录，而SAVEP位置为最早(旧)记录。 柜桶最大深度MAXLEN：表示SM存储历史记录的最大空间(条数)； 当该空间存储满后，SM将自动覆盖最早的记录(MF的D7=1)，存储最新的 记录，保留的最新记录MAXLEN条。SM的“覆盖”操作若改动“最后读 取指针 LOADP” ，则MF的D0=1 如下计算有效记录数： (1)当MF的D7=0，有效记录数N=SAVEP—BOTTOM LOADP的有效范围：BOTTOM至SAVEP—1 (2)当MF的D7=1，有效记录数 N=MAXLEN LOADP的有效范围：BOTTOM至MAXLEN—1，注意：最早(旧)记 录在SAVEP位置，而最新记录在SAVEP—1位置。 如 MF的D0=0 SM内LOADP处的历史记录与SU已读取的记录，是联贯的； 如 MF的D0=1 SM内LOADP处的历史记录与SU已读取的记录，是不联贯的， 部分最早记录在SM中被覆盖。 #### 5.2.2. 顺序读取一条历史记录(0XE2) COMMAND TYPE=0XE2 DATAF 无 或 1字节(无定义) SM从LOADP位置读取一条记录返给SU， SM自动将LOADP指向下一条记录。 SM 返回：DATAINFO为 DATAF 位置的一条记录(14字节)，参见附录1。 #### 5.2.3. 随机读取记录(指定位置读取)(0XE2) COMMAND TYPE=0XE2 DATAF (2字节)参数(低位在前)， SM以DATAF位LOADP值， 在此位置读取一条历史记录，SM不改变原LOADP值。 如果SM内历史记录已全部读完(LOADP位置已是空白)，或参数DATAF指向空白记录区，	SM将返回错误提示。 SM 返回：DATAINFO为 DATAF 位置