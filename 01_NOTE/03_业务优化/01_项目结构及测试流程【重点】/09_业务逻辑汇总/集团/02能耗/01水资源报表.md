# 前置说明

```
涉及模块：
	能耗-用水关系（前置条件）
		配置注意项：
			运算类型为按类型汇总的关系被引用后不能修改和删除
			按类型汇总的关系中引用关系可以修改，但是不能修改为其他运算类型和删除
				eg：M A B C分别是运算类型为按测点运算、测点运算、按类型汇总、手动填报
					B B按类型汇总了M
					D D按类型汇总引用了ABC
					E E也是按类型汇总引用了D
					则 M A C【可以修改】但是不能【修改为其他运算类型和删除】
					B D不可修改和删除 E可以删改
	能耗-水资源报表（数据来源）
	能耗-用水分析
	能耗-水资源看板



涉及curl-定时任务：
	前端，后端（energy-service，water-service,composite-service）
测试开发用接口
	1.水资源计算指定时间段（月末-月初）的连接为：
	curl —location —request GET ‘http://localhost:28026/v1/waterConfig/executeMonthBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06&endTime=2025-06‘
    2.水资源计算指定时间段（日）的链接为：
    日级别的计算，只计算测点运算，向下汇总不进行计算，应为手动填报这种只有月度的，向下汇总可能汇总到手动计算这些，所以都不计算，日级别，只计算测点运算
    curl —location —request GET ‘http://localhost:28066/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-24-09-04-44-02&startTime=2025-05-31&endTime=2025-02-01‘
    
    定时任务：
    1.删除水资源一年以前测点详情（天）的链接为：保留过去一年的
    curl --location --request GET 'http://localhost:28026/v1/waterConfig/deleteDayMete'
    2.水资源定时任务计算（月）的链接为：
    curl --location --request POST 'http://localhost:28026/v1/waterConfig/formulaEnergyMonthTest'
    3.水资源定时任务计算（天）的链接为：
    curl --location --request POST 'http://localhost:28026/v1/waterConfig/formulaEnergyDayTest'
    4、每月1号凌晨20分执行生成当月运算类型为手动填报配置（使用water_formula_config where config_type = ‘2’填充water_manual_month_config where TIME = “2025-06数据）
    
    watet服务yaml
        commonWaterConfig.dealMonthManualConfig: 0 20 0 1 * ? ##
        链接： curl --location --request GET 'http://localhost:28026/v1/waterConfig/dealMonthManualConfig'
        任务执行关键词：生成当月手动配置定时任务



涉及的表
    water_mete;字典
    water_second_type;字典
    water_device_mete_day;
    water_device_mete_month;
    water_formula_config; 用水关系配置
    water_formula_config_his;
    water_formula_config_total;
    water_manual_month_config;用水类型中运算类型为手动填报
    water_manual_month_cost; 用水类型中运算类型为手动填报的月水量
    water_precinct_project_device;
    water_station_building_day; 日水量
    water_station_building_month; 各种用水类型的月水量（月差值不是用日累加）
    t_cfg_dict; 排查楼栋的类型是否为生产楼



单水表水量限制
    select * from t_cfg_dict
        where col_name in ('water_device_month_max_value','water_device_month_max_value',
        'water_device_day_max_value','water_device_day_max_value');
    # 日、月 单水表，日水量和月水量若统计超过配置的值，会异常，页面不会展示该数据

水资源看板
	全部已配置（绿色）：该省（市）下所有生产楼用水类型已配置
	生产楼和制冷楼 应该是省平台都还没有制冷楼概念 TBD（集团是有的）
        select * from t_cfg_dict where col_name = 'building_type' ;
			building_type 为1，生产楼；为3，制冷楼
			集团字典表有1、2、3、4，但是省平台暂时只有1、2；
	水资源看板：统计制冷楼数据根据building_type为3判定
	
	
用电关系：
	省平台空间树不会按生产楼查询过滤，会全查；但在某制冷楼下(building_type改为3)配置用水关系，列表不会展示出来


水资源报表：
	列表不会查出制冷楼水量相关数据

```

# 用电关系配置

```
注意:目前没有设备类型啥的限制（随便加上去就行了）

配置维度：
	目前只做数据中心——数据中心配置粒度为楼栋，楼栋仅限生产楼，用户需点进站点或楼栋节点进行用水配置

计算逻辑：
	
	测点运算及按类型汇总：
		在每月1日凌晨对上月数据进行一次定时汇算
		每月7日凌晨对上月进行第二次汇算，并刷新月度数据
	
	测点运算：
		每个测点用次月1日0时最近水表数据 - 当月1日0时最近水表数据进行月度结果计算（最近限制为1前后一小时内，如无法取到数值算异常）
		测点运算中，每个测点的月度数据计算结果如果为负值，判定为换表/归零
		对于异常、换表/归零的数据，需重新用16时数据进行计算，如16时依然如此，用8时数据计算，如8时数据依然异常，则当月数据按0计算
	
	按类型汇总：
		手动填报计算结果为负值的，按0处理
	
	站点和楼栋用水关系配置页面有刷新数据按钮
		点击后提示用户“是否确认按最新运算规则重新计算上月用水数据？”用户选择是后，重新计算上月数据
		手填数据不受影响，依然保留历史数据
```

# 水资源报表

```
1、数据来源：
	根据接入站点机房相关测点，插入历史数据，执行日或月curl-可指定（或在用水配置页面直接刷新，日-前3天，月-上个月）
	
	1.水资源计算指定时间段（月末-月初）的连接为：
		curl —location —request GET 'http://localhost:28026/v1/waterConfig/executeMonthBetweenTime?stationIdStr=01-19-05-07-08-02&startTime=2025-06&endTime=2025-06'
    
    2.水资源计算指定时间段（日）的链接为：
    	日级别的计算，只计算测点运算，向下汇总不进行计算，应为手动填报这种只有月度的，向下汇总可能汇总到手动计算这些，所以都不计算，日级别，只计算测点运算
    	curl —location —request GET ‘http://localhost:28066/v1/waterConfig/executeDayBetweenTime?stationIdStr=01-24-09-04-44-02&startTime=2025-05-31&endTime=2025-02-01‘
    	

2、wue计算（用电需要查看能耗报表-站点/楼栋/机房维度的电表值 -- 涉及到wue计算） -- 目前是有用水量的能耗才会参与计算
	总用水/总it用电
	用水量L/IT用电量kWh。在计算时需将计算的用水量（t）*1000后计算）、再回收水资源数据   -- 单位换算
	

3、单水表水量限制（如果超出一定量就不会显示，需要解开限制）
    select * from t_cfg_dict
        where col_name in ('water_device_month_max_value','water_device_month_max_value',
        'water_device_day_max_value','water_device_day_max_value');
    # 日、月 单水表，日水量和月水量若统计超过配置的值，会异常，页面不会展示该数据
```

# 用水分析

```
1、数据都来源于水资源报表（用电需要查看能耗报表-站点/楼栋/机房维度的电表值 -- 涉及到wue计算）

```

# 水资源看板

```
1、数据都来源于水资源报表（用电需要查看能耗报表-站点/楼栋/机房维度的电表值 -- 涉及到wue计算）
2、全部已配置（绿色）：该省（市）下所有生产楼用水类型已配置
```

