# 高新兴300R门禁控制器协议详细文档

## 1. 协议概述
高新兴300R门禁控制器协议是配电智能辅助监控系统中用于门禁监控的统一通讯协议，支持多厂家设备的标准化接入和统一管理。

## 2. 系统组网架构
- 门禁模块属于智能设备，监控数据由站端FSU监控主机通过串口/USB/网口等方式接入
- 监控平台主站系统（SC）与FSU通过IP网络建立通信
- 支持多厂家设备的视频模块、动环模块、门禁模块统一接入
- 通信协议：SC与FSU之间采用UDP方式通信
- 接入要求：每个门禁模块映射独立IP+端口，SC通过FSU的IP和映射端口访问门禁模块

## 3. 协议范围
本协议分为"基本报文格式定义"和"数据流格式定义"两大部分，适用于SC解析监控场景。

## 4. 基本报文格式定义

### 4.1 基本报文数据

#### 命令号 0x0001

#### 命令描述
用于传输数据包，支持上行（FSU→SC）和下行（SC→FSU）两个方向

#### 下行方向（SC→FSU）报文格式
| 地址 | 协议字段 | 字段长度 | 字段描述 | 默认值 |
|------|----------|----------|----------|--------|
| 0 | P_header | 1 byte | 协议包开始标识 | 0xFF |
| 1-20 | P_dest_addr | 20 bytes | 目标设备地址 | FSU的ID |
| 21-28 | P_src_addr | 8 byte | 源设备地址 | SC的地址（00） |
| 29 | P_subDevType | 1 byte | 子设备类型：<br>1-串口设备<br>2-USB设备<br>3-IP网络设备（一体化设备也为3） | 1 |
| 30 | P_subDev_addr | 1 byte | 子设备地址号 | 00 |
| 31-32 | P_pLen | 2 byte | 协议族数据包长度 | 5+N |
| 33 | RtnFlag | 1 byte | 设置/应答类型 | 0xee |
| 34-35 | CommType | 2 bytes | 命令编号 | 0x0001 |
| 36-37 | 数据流长度 | 2 byte | 数据长度 | - |
| 38-(38+N-1) | 数据流 | N byte | 具体内容见数据流格式定义 | - |
| 38+N | P_verify | 1 byte | 校验字段（异或校验，不含包头包尾） | - |
| 39+N | P_tailer | 1 byte | 协议包结束标识 | 0xFE |

#### 上行方向（FSU→SC）报文格式
| 地址 | 协议字段 | 字段长度 | 字段描述 | 默认值 |
|------|----------|----------|----------|--------|
| 0 | P_header | 1 byte | 协议包开始标识 | 0xFF |
| 1-8 | P_dest_addr | 8 bytes | 目标设备地址 | SC的地址（0x00） |
| 9-28 | P_src_addr | 20 byte | 源设备地址 | FSU的ID |
| 29 | P_subDevType | 1 byte | 子设备类型（同下行定义） | 1 |
| 30 | P_subDev_addr | 1 byte | 子设备地址号 | 00 |
| 31-32 | P_pLen | 2 byte | 协议族数据包长度 | 5+N |
| 33 | RtnFlag | 1 byte | 设置/应答类型 | 0x00 |
| 34-35 | CommType | 2 bytes | 命令编号 | 0x0001 |
| 36-37 | 数据流长度 | 2 byte | 数据长度 | - |
| 38-(38+N-1) | 数据流 | N byte | 具体内容见数据流格式定义 | - |
| 38+N | P_verify | 1 byte | 校验字段（异或校验，不含包头包尾） | - |
| 39+N | P_tailer | 1 byte | 协议包结束标识 | 0xFE |

## 5. 数据流格式定义

### 5.1 数据流分类
- 门禁状态数据
- 门禁事件数据
- 门禁控制数据

### 5.2 数据流结构
数据流部分包含具体的门禁协议数据，格式由各个门禁设备厂家定义。

## 6. 功能说明

### 6.1 数据传输功能
- **功能**：用于SC与FSU之间传输门禁设备的数据
- **应用场景**：SC向FSU发送门禁控制命令，FSU向SC上报门禁状态和事件
- **数据格式**：数据流部分为具体的门禁协议数据

### 6.2 多厂家设备接入
- **功能**：支持多厂家设备的标准化接入和统一管理
- **应用场景**：不同厂家的门禁设备通过FSU接入到同一监控平台
- **特点**：每个门禁模块映射独立IP+端口，便于SC访问

## 7. 注意事项

1. 所有协议包必须包含完整的包头和包尾
2. 数据部分需要按照转义规则进行转义
3. 校验字段必须正确计算，否则会导致数据丢弃
4. 目标设备地址和源设备地址必须填写正确
5. 子设备类型和子设备地址需要根据实际情况填写
6. 每个门禁模块必须映射独立的IP+端口

## 8. 典型应用流程

1. SC向FSU发送下行命令（0x0001），包含门禁设备的控制指令
2. FSU将控制指令转发给门禁设备
3. 门禁设备执行命令并返回结果
4. FSU将门禁设备的返回结果通过上行命令（0x0001）发送给SC
5. 门禁设备产生状态变化或事件时，FSU主动向SC上报数据
6. SC解析上报的数据，实现门禁设备的实时监控

## 9. 故障处理

1. 通信超时：检查网络连接、设备地址和通信参数
2. 命令执行失败：检查命令格式、校验和是否正确
3. 数据解析错误：检查数据流格式是否符合协议要求
4. 状态异常：检查门禁设备的硬件状态

## 10. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令号实现
- 扩展后的协议必须保持向前兼容性

## 11. 开发建议

1. 建议使用UDP通信库简化开发工作
2. 实现命令超时重发机制，提高通信可靠性
3. 定期检查设备的运行状态，及时发现故障
4. 实现数据缓存机制，防止数据丢失
5. 遵循协议规范，确保与设备的正常通信
6. 注意不同厂家门禁设备的数据流格式差异
7. 正确计算和验证校验和，确保数据完整性