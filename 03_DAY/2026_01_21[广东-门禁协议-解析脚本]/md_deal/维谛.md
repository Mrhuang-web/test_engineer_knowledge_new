# 维谛ES2000门禁控制器协议详细文档

## 1. 协议概述
维谛ES2000门禁控制器协议是艾默生网络能源有限公司的门禁通讯协议，采用RS485/422通信接口，用于门禁系统的监控和控制。

## 2. 通信参数
- 接口类型：RS485/422
- 通信速率：支持9600或19200
- 数据格式：1起始位，8数据位，1停止位
- 校验方式：无校验

## 3. 协议格式

### 3.1 基本格式
| 序号 | 字段 | 字节数 | 说明 |
|------|------|--------|------|
| 1 | SOI | 1 | 起始符，固定值=7EH（START OF INFORMATION） |
| 2 | VER | 1 | 通信协议版本（=10H，表示1.0） |
| 3 | ADR | 1 | 设备RS485网上地址（有效值：1-254） |
| 4 | CID1 | 1 | 设备分类码及分组码组合：D7-D4为设备分类码（环境控制类=8），D3-D0为设备分组号（0-15），ES2000暂时固定分组码=0，故CID1=80H |
| 5 | CID2/RTN | 1 | 主控制机发命令时为CID2（命令分类码）；ES2000应答时为RTN（处理结果） |
| 6 | L.TH | 2 | 携带参数的长度标识 |
| 7 | INFO | N字节 | 传递的信息部分：SU发命令时为命令参数COMINFO；ES2000应答时为返回数据DATAINFO |
| 8 | CHK-SUM | 2 | 校验和，从VER到INFO最后字节累加计算，高位在前 |
| 9 | EOI | 1 | 结束符，固定值=0DH（END OF INFORMATION） |

### 3.2 数据传输方法
- SOI、EOI按单字节（HEX）直接发送
- 其他字段（VER至SUM）将单字节（HEX）拆分为高4位和低4位，按ASCII码发送（先高4位，后低4位）

### 3.3 命令帧格式

#### 3.3.1 SU发送命令帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号（从0X10开始） |
| 3 | ADR | 1 | 设备地址（1-254） |
| 4 | CID1 | 1 | 设备类型标识（高半字节=8） |
| 5 | CID2 | 1 | 命令分类码 |
| 6 | L.TH | 2 | 数据信息部分字节长度 |
| 7 | COMINFO | N | 命令参数 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

#### 3.3.2 ES2000对设置命令的应答帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号 |
| 3 | ADR | 1 | 设备地址 |
| 4 | CID1 | 1 | 设备类型标识 |
| 5 | RTN | 1 | 处理结果 |
| 6 | L.TH | 2 | 0,0 |
| 7 | - | - | 无 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

#### 3.3.3 ES2000对读取命令的返回帧
| 序号 | 字段 | 字节数 | 格式 |
|------|------|--------|------|
| 1 | SOI | 1 | 固定7EH |
| 2 | VER | 1 | 协议版本号 |
| 3 | ADR | 1 | 设备地址 |
| 4 | CID1 | 1 | 设备类型标识 |
| 5 | RTN | 1 | 处理结果 |
| 6 | L.TH | 2 | 数据信息部分字节长度 |
| 7 | DATAINFO | N | 返回数据 |
| 8 | SUM | 2 | 校验和 |
| 9 | EOI | 1 | 固定0DH |

## 4. 通信类型

### 4.1 权限确认
用于确认用户的访问权限

### 4.2 参数设置命令
用于设置门禁设备的参数

### 4.3 信息读取命令
用于读取门禁设备的信息

## 5. 功能说明

### 5.1 设备分类码
- 环境控制类=8（D7=1，D6=D5=D4=0）
- 设备分组号：0-15
- ES2000暂时固定分组码=0，故CID1=80H

### 5.2 命令分类码
- CID2：主控制机发命令时的命令分类码
- RTN：ES2000应答时的处理结果

### 5.3 校验和计算
- 从VER到INFO最后字节累加计算
- 高位在前
- 用于验证数据的完整性

## 6. 注意事项

1. 通信参数必须设置正确，否则会导致通信失败
2. 命令格式必须严格按照协议要求，包括起始符、版本号、地址、分类码、长度、信息、校验和和结束符
3. 数据传输时需要注意SOI和EOI的特殊处理
4. 校验和必须正确计算，否则会导致命令执行失败
5. 设备地址必须在有效范围内（1-254）
6. 协议版本号必须匹配，否则会导致命令执行失败
7. 命令分类码和处理结果需要根据实际情况设置和解析

## 7. 典型应用流程

1. 初始化RS485/422通信接口
2. 构建SU发送命令帧，包括起始符、版本号、地址、分类码、长度、命令参数、校验和和结束符
3. 发送命令帧到门禁设备
4. 接收门禁设备的应答帧
5. 解析应答帧，提取处理结果和返回数据
6. 根据处理结果执行相应的操作
7. 定期轮询门禁设备的状态，实现实时监控

## 8. 故障处理

1. 通信超时：检查通信线路、设备地址和通信参数
2. 命令执行失败：检查命令格式、校验和、版本号是否正确
3. 数据解析错误：检查返回数据的格式是否符合协议要求
4. 处理结果异常：根据RTN值查找对应的错误原因

## 9. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令分类码实现
- 扩展后的协议必须保持向前兼容性

## 10. 开发建议

1. 建议使用RS485/422通信库简化开发工作
2. 实现命令超时重发机制，提高通信可靠性
3. 定期检查设备的运行状态，及时发现故障
4. 实现数据缓存机制，防止数据丢失
5. 遵循协议规范，确保与设备的正常通信
6. 注意数据传输时的特殊处理，特别是SOI和EOI字段
7. 正确计算和验证校验和，确保数据完整性