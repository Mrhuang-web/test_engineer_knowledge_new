# 01提测

```
提测内容：
	涉及表：
	his_data_collect_device_metecodes


涉及范围：
服务：
1、currentMonitor（修改）
2、datacollection（修改）
3、distribute-service（新增）
4、binterface-service-client（修改）


配置：
1、currentMonitor
    sendToDistribution: true   
    # 实时数据请求分发，将 kafka 请求分发到 distribute-service 服务，
    当为false的时候，走之前的逻辑

2、datacollection
sendToDistribution: true  # 实时数据请求分发，将 kafka 请求分发到 distribute-service 服务，当为false的时候，走之前的逻辑
saveToEsViaKafka: true    # 之前datacollection服务采集是阻塞请求，现在改为走kafka异步处理
save.to.mysql: true       # 当 sendToDistribution=true的时候，数据会发送到kafka, 上海SC，会将采集的结果写到mysql

3、distribute-service
runMode: binterface     # distribute服务适用于B接口与C接口，以上海SC为例，采用的均是B接口，则如此配置，


脚本：
【测试环境已执行】https://gitsz1.aspirecn.com/spider/gemc/-/blob/develop_distribution/gemc/bin/dbscript/GEMC1.0.8.0/ddl/定时任务数据设备测点集合_ddl_20251120.sql


此次改造功能为解决以下问题：
（1）当发起大量的性能数据采集时，会对实时数据查询（监控视图）造成影响
（2）采集较慢或无法采集的设备会造成阻塞，导致积压，能够正常采集的设备也无法较快响应。


主要逻辑与处理方式：
1、对采集设备进行打标签处理，给设备打标识：快，慢，差
2、新增采集调整策略（采集降级）
	当队列里面达到500个设备，不再接收 tag=差 的设备，即这类型设备将丢弃掉
	当队列里面达到700个设备，不再接收 tag=慢 的设备，即这类型设备将丢弃掉
	当队列里面达到1000个设备，不再接收定时采集任务，优先保证实时监控请求的任务
3、快，慢，差计算标准：
	（1）快：采集快慢的标准是按项目时间需求来计算的（比如5分钟要完成2000个，那么快的标准就是： 5*60*1000 / 2000 = 150ms， 即150ms内完成数据采集的设备，就是快的设备）
	（2）慢：快 * (1~3)，介于快与差之间
	（3）差：> 快 * 3，即450ms
4、重试机制：当出现采集慢的时候，等待采集的队列会被塞满，当队列满了，尝试5次（重试时间间隔：3s,10s,30s,1min,3min）如果都失败，放回原队列
5、丢弃策略：当队列中等待设备>700，5分钟内采集过的设备，丢弃。
6、请求合并：新请求的设备，如果此设备在采集队列中（因为前面堵塞，导致还没有下发请求，那应该将此设备进行请求合并）
7、请求去重：在5秒内，重复请求的设备，去重处理，降低采集频率。



测试范围：
1、监控视图——设备实时数据查询（保证原有功能可用）
2、实时数据报表——设备实时数据查询（保证原有功能可用）
3、定时任务采集——正常采集，入库es（保证原有功能可用）
4、采集降级——出现采集慢/不可用设备，就当对此部分设备进行降级处理，即无法采集/采集慢的设备不能影响其他正常采集速度的设备（新增）
5、“主要逻辑与处理方式”中提及到的优化项
```

