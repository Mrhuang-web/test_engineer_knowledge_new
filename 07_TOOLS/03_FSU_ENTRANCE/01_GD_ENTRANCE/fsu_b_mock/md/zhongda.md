# 中达-CHD805门禁控制器通信协议（RS485）V2.0
## 一、通信规范
### 1.1 通信速率与数据格式
| 参数 | 配置详情 |
|------|----------|
| 通信速率 | 9600 B/S（设备支持速率调整） |
| 数据格式 | 1起始位、8数据位、1停止位 |
| 校验方式 | 支持无校验、奇校验、偶校验、MARK(1)校验、SPACE（0）校验 |
| 协议版本 | VER=10H（表示V1.0） |

#### 协议数据包基本格式
| 序号 | 字段标识 | 字节数 | 字段说明 | 固定值/规则 |
|------|----------|--------|----------|-------------|
| 1 | SOI | 1 | 信息起始符 | 7EH |
| 2 | VER | 1 | 通信协议版本 | 10H起 |
| 3 | ADR | 1 | 设备RS485地址（设备ID） | 1-254（0和255保留） |
| 4 | CID1 | 1 | 设备类型标识+扩展地址 | 高半字节=8（门禁类），低半字节为组号（0-15） |
| 5 | CID2/RTN | 1 | 命令分类码（发命令时）/处理结果（应答时） | - |
| 6 | L.TH | 2 | 参数长度标识+校验 | 含LCHKSUM（4位校验）和LENID（12位长度，LENID=2L，L为参数字节数） |
| 7 | INFO | N | 命令参数/返回数据 | 发命令时为COMINFO，应答时为DATAINFO |
| 8 | CHK-SUM | 2 | 帧校验和 | 从VER到INFO末尾ASCII码累加求和，模65536取补，高位在前 |
| 9 | EOI | 1 | 信息结束符 | 0DH |

#### 数据传输规则
- SOI、EOI按单字节直接发送，其余字段（VER至CHK-SUM）按字节拆分为高4位、低4位ASCII码发送（先高后低）。
- 超时时间：500毫秒。

### 1.2 数据传输与超时错
- 传输类型：权限确认、参数设置命令、信息读取命令。
- 超时定义：500毫秒内未收到应答则判定为超时错误。

### 1.3 设备应答（RTN值说明）
| RTN值 | 含义 |
|-------|------|
| 00H | 正常执行命令 |
| 01H | 协议版本不符，命令未执行 |
| 02H | 命令帧累加和校验错误 |
| 03H | 命令帧参数部分累加和错误 |
| 04H | 无效的CID2 |
| 05H | 无法识别的命令格式 |
| 06H | 数据信息部分含无效数据 |
| 07H | 无设置/访问重要信息的权限 |
| E0H | 密码确认不正确 |
| E1H | 内部密码修改不成功 |
| E2H | 对应设置项存储空间已满 |
| E3H | 参数修改/删除不成功 |
| E4H | 对应设置项存储空间已空 |
| E5H | 无相应信息项 |
| E6H | 重复设置相同ID用户，保留原用户 |
| E7H | 重复设置相同卡号给不同用户 |
| E8H | 重复设置完全相同的用户 |

## 二、通信命令的种类
- 分类1：设置SM（门控器）参数命令（CID2=49H）
- 分类2：读取SM内部信息命令（CID2=4AH）

## 三、设置命令（CID2=49H）
### 3.1 设置日期时间（COMMAND TYPE=0XE0）
- 功能：配置门控器实时时钟
- DATAF格式：8字节BCD码，依次为年（2字节，2000-2099）、月（1-12）、日（1-31）、星期（1-7，7=星期日）、时（0-23）、分（0-59）、秒（0-59）
- 应答：RTN=0表示成功，非0表示失败

### 3.2 设置准进时段
#### 3.2.1 恢复缺省时段（COMMAND TYPE=0XE1，DATAF=1字节=1）
- 工作日/休息日/星期准进时段：00:00-23:59（全天有效）
- 管理时段（门常开/常闭、二次加密、监控布防）：全部无效

#### 3.2.2 置所有时段无效（COMMAND TYPE=0XE1，DATAF=1字节=0）
- 准进时段（工作日/休息日/星期）：全部无效
- 管理时段：全部无效

#### 3.2.3 设置工作日准进时段（COMMAND TYPE=0XE1）
- DATAF格式：1字节GROUP No.（1-4）+16字节时段列表
- 时段列表：4组“起始时间-结束时间”，每组4字节BCD码（HH:MM(HH:MM）
- 示例：00:00(02:00 对应00,00,02,00）
- 应答：RTN=0表示成功，非0表示失败

#### 3.2.4 设置非工作日准进时段（COMMAND TYPE=0XE2）
- DATAF格式：1字节（固定=1）+1字节GROUP No.（固定=1）+16字节时段列表
- 时段列表规则同工作日，门控器最多存储1张非工作日时段表
- 应答：RTN=0表示成功，非0表示失败

#### 3.2.5 设定星期准进时段（COMMAND TYPE=0XF1，DATAF=26字节）
- 前2字节：表序号（0-15）+星期（1-7）
- 后24字节：6组“起始时间-结束时间”，每组4字节BCD码
- 存储规则：16张表，每张表含7天，每天6个时段
- 应答：RTN=0表示成功，非0表示失败

### 3.3 用户（准进人员）管理
#### 3.3.1 增加用户（COMMAND TYPE=0XE3，DATAF=16字节）
| 字段 | 字节数 | 格式/规则 |
|------|--------|-----------|
| 卡片编号 | 5 | HEX |
| 用户编号ID | 4 | BCD |
| 用户密码 | 2 | BCD（不支持0000填充） |
| 有效期 | 4 | BCD（年2字节+月1字节+日1字节） |
| 用户权限 | 1 | D7-D6：权限类型；D5：黑名单标识（1=黑名单）；D4-D0：时段表索引 |

- 权限类型定义：
  - 00/01：一般用户（受星期时段限制）
  - 10：一般用户（受工作日/休息日时段限制）
  - 11：特权用户（不受时段限制，受有效期限制）
- 应答：RTN=0成功；E2H=存储满；E7H=卡号重复；E6H=ID重复；E8H=用户信息完全重复

#### 3.3.2 更新用户信息（COMMAND TYPE=0XE3）
支持5种更新格式：
1. 16字节：5字节卡号+4字节ID+7字节（密码+有效期+权限）
2. 12字节：5字节卡号+7字节（密码+有效期+权限）
3. 6字节：5字节卡号+1字节权限
4. 7字节：5字节卡号+2字节密码
5. 9字节：5字节卡号+4字节有效期
- 应答：RTN=0表示成功，非0表示失败

#### 3.3.3 删除用户卡（COMMAND TYPE=0XE4，DATAF=6字节）
- DATAF格式：1字节指引（=0）+5字节卡片编号
- 功能：按卡号删除用户
- 应答：RTN=0成功；E5H=无该用户；E4H=存储已空；E3H=删除失败

#### 3.3.4 删除用户ID（COMMAND TYPE=0XE4，DATAF=6字节）
- DATAF格式：1字节指引（=1）+1字节00+4字节用户ID
- 功能：按ID删除用户
- 应答：同3.3.3

#### 3.3.5 全部删除用户（COMMAND TYPE=0XE4，DATAF=6字节）
- DATAF格式：1字节指引（=2）+5字节全00
- 应答：同3.3.3

### 3.4 设定门的特性参数
#### 3.4.1 门锁继电器执行时间（COMMAND TYPE=0XE6）
- DATAF：1字节（1-255），单位0.1秒
- 示例：DATAF=50 → 执行时间5秒
- 关联命令：COMMAND TYPE=0XE5（DATAF为5/6字节时的第二字节）

#### 3.4.2 开门后等待进入延时（COMMAND TYPE=0XE7）
- DATAF：1字节（20-255），单位0.1秒
- 示例：DATAF=50 → 等待5秒，超时未进入则报警
- 关联命令：COMMAND TYPE=0XE5（DATAF为5/6字节时的第三字节）

#### 3.4.3 门磁感应器特性（COMMAND TYPE=0XE5，DATAF=1字节）
| BIT位 | 控制规则 |
|-------|----------|
| D7 | 0=不监控门状态；1=监控（非正常开门/未关门/延时未关门报警） |
| D6 | 保留 |
| D5 | 0=电磁锁断电/加电能自动锁；1=需机械动作锁门 |
| D4 | 0=允许手动开门线短接开门；1=禁止 |
| D3 | 0=开门时门磁短路/关门开路；1=开门时门磁开路/关门短路 |
| D2-D0 | 保留 |

#### 3.4.4 联动及报警输出特性（COMMAND TYPE=0XFC，DATAF=1字节）
| BIT位 | 控制规则 |
|-------|----------|
| D7-D6 | 联动输入CPLD1/CPLD2有效电平 |
| D5-D4 | 联动输入响应动作定义 |
| D3 | 0=报警时ALARM输出导通；1=开路 |
| D2 | 1=刷卡时转发韦根数据至RS485；0=禁止 |
| D1 | 1=紧急事件输入闭合时闭门；0=常开 |
| D0 | 1=允许ID+密码开门；0=禁止 |

#### 3.4.5 整体设定(1)（COMMAND TYPE=0XE5，DATAF=2字节）
- 第1字节：门磁/红外感应器特性（同3.4.3）
- 第2字节：联动及报警输出特性（同3.4.4）
- 应答：RTN=0表示成功，非0表示失败

#### 3.4.6 整体设定(2)（COMMAND TYPE=0XE5，DATAF=5字节）
- 依次存储：门磁特性、继电器执行时间、等待进入延时、红外报警延时、感应卡号码获取控制字
- 应答：RTN=0表示成功，非0表示失败

#### 3.4.7 整体设定(3)（COMMAND TYPE=0XE5，DATAF=6字节）
- 在整体设定(2)基础上增加“异地报警驱动时间”（第6字节，单位0.1秒）
- 应答：RTN=0表示成功，非0表示失败

#### 3.4.8 门开关感应器有效电平（COMMAND TYPE=0XF7，DATAF=1字节）
- 0=低电平有效（继电器吸合）；1=高电平有效（继电器断开）
- 应答：RTN=0表示成功，非0表示失败

#### 3.4.9 门控电磁锁特性（COMMAND TYPE=0XF9，DATAF=1字节）
- 0=断电/加电能自动锁（电控阴锁口）；1=需机械动作锁门（电脉冲锁）
- 应答：RTN=0表示成功，非0表示失败

### 3.5 设定门控器工作方式
#### 3.5.1 红外监控布防/撤防（COMMAND TYPE=0XFA，DATAF=1字节）
- 0=关闭监视；1=打开监视
- 应答：RTN=0表示成功，非0表示失败

#### 3.5.2 门开关状态监控布防/撤防（COMMAND TYPE=0XFB，DATAF=1字节）
- 0=关闭监视；1=打开监视
- 应答：RTN=0表示成功，非0表示失败

#### 3.5.3 布防与撤防（第一控制字）（COMMAND TYPE=0XE5，DATAF=1字节）
| BIT位 | 控制规则 |
|-------|----------|
| D7 | 0=不监控门状态；1=监控（异常报警） |
| D6 | 保留 |
| D5 | 保留 |
| D4 | 0=允许手动开门线短接开门；1=禁止 |
| D3 | 门磁输出电平定义（同3.4.3） |
| D2 | 保留 |
| D1 | 0=刷卡合法直接开门；1=需密码确认 |
| D0 | 保留 |

### 3.6 节假日管理
#### 3.6.1 设定星期内休息日（COMMAND TYPE=0XEA，DATAF=2字节）
- 字节1-2：休息日（1=周一至6=周六，7=周日），非有效值表示不休息
- 示例：7,0XFF → 仅周日休息
- 应答：RTN=0表示成功，非0表示失败

#### 3.6.2 设定法定节假日（COMMAND TYPE=0XEB，DATAF=2字节）
- DATAF：月（BCD）+日（BCD）
- 存储限制：最多40个节假日
- 应答：RTN=0成功；E2H=存储满；非0=失败

#### 3.6.3 删除一组节假日（COMMAND TYPE=0XEC，DATAF=2字节）
- DATAF：月（BCD）+日（BCD），全00表示全部删除
- 应答：RTN=0成功；E5H=无该组；E4H=列表已空；非0=失败

#### 3.6.4 清空节假日列表（COMMAND TYPE=0XEC，DATAF=2字节全00）
- 应答：同3.6.3

### 3.7 记录区的管理
#### 记录存储规则
- 存储范围：BOTTOM（0）至MAXLEN（最大记录数）
- 满覆盖机制：存储满后自动覆盖最早记录（MF的D7=1）
- 有效记录数计算：
  - MF的D7=0：N=SAVEP—BOTTOM
  - MF的D7=1：N=MAXLEN

#### 3.7.1 初始化记录区（清空记录）（COMMAND TYPE=0XF0，DATAF=5字节全0）
- 应答：RTN=0表示成功，非0表示失败

### 3.8 远程开关门
#### 3.8.1 单一放行（不带操作员信息）（COMMAND TYPE=0XED，DATAF=1字节）
- 1=开门；0=不操作
- 应答：RTN=0表示成功，非0表示失败

#### 3.8.2 单一放行（带操作员信息）（COMMAND TYPE=0XED，DATAF=6字节）
- 第1字节：1=开门，0=不操作
- 第2-6字节：操作员编号
- 应答：RTN=0表示成功，非0表示失败

### 3.10 布防与撤防（重复项，同3.5.2）
- 命令：COMMAND TYPE=0XFB，DATAF=1字节
- 规则：0=关闭监视，1=打开监视
- 应答：RTN=0表示成功，非0表示失败

## 四、读取信息命令（CID2=4AH）
### 4.1 读取实时钟（COMMAND TYPE=0XE0，DATAF=1字节=0）
- 返回DATAINFO：8字节BCD码，依次为年（2）、月、日、星期、时、分、秒
- 年份范围：2000-2099

### 4.2 读取记录信息
#### 4.2.2 顺序读取一条历史记录（COMMAND TYPE=0XE2，DATAF无/1字节无定义）
- 读取规则：从LOADP位置读取，读完后LOADP自动指向下一条
- 返回DATAINFO：14字节（见附录历史记录格式）

### 4.3 读取时段
#### 4.3.1 读取工作日准进时段（COMMAND TYPE=0XE3，DATAF=1字节）
- DATAF：组号（1-4）
- 返回DATAINFO：16字节BCD码，4组“起始时间-结束时间”

#### 4.3.2 读取非工作日准进时段（COMMAND TYPE=0XE4，DATAF=1字节=1）
- 返回DATAINFO：16字节BCD码，4组“起始时间-结束时间”

#### 4.3.3 读取星期准进时段（COMMAND TYPE=0XEB，DATAF=2字节）
- DATAF：表序号（0-15）+星期（1-7）
- 返回DATAINFO：24字节BCD码，6组“起始时间-结束时间”

### 4.4 读取用户信息
#### 4.4.1 读取用户数目（COMMAND TYPE=0XE5，DATAF=1字节=0）
- 返回DATAINFO：2字节HEX（低字节在前，高字节在后），00,00表示无用户

#### 4.4.2 读取指定位置用户资料（COMMAND TYPE=0XE6，DATAF=2字节HEX）
- DATAF：用户存储位置（低字节在前）
- 返回DATAINFO：16字节（卡号5字节+ID4字节+密码2字节+有效期4字节+权限1字节）
- 应答：RTN=0成功；E0H=无权限（无DATAINFO）

### 4.5 读取休息日、节假日
#### 4.5.1 读取星期内休息日（COMMAND TYPE=0XE9，DATAF=1字节=0）
- 返回DATAINFO：2字节（有效值1-7，7=周日）

#### 4.5.2 读取法定节假日（COMMAND TYPE=0XEA，DATAF=1字节=0）
- 返回DATAINFO：第1字节=节假日个数N，后续2N字节为“月+日”（BCD）

### 4.6 远程监控（COMMAND TYPE=0XE7，DATAF=1字节=0）
#### 返回DATAINFO（2字节）
| 字节 | 位定义 | 说明 |
|------|--------|------|
| 第一字节（工作状态） | D7 | 0=实时钟正常；1=异常 |
|      | D6 | 0=存储器正常；1=异常 |
|      | D5 | 0=电源正常；1=欠压复位 |
|      | D4 | 保留 |
|      | D3 | 0=不监控红外；1=监控 |
|      | D2 | 0=不监控门开关；1=监控 |
|      | D1 | 0=继电器关闭；1=驱动 |
|      | D0 | 0=正常工作；1=报警 |
| 第二字节（线路状态） | D7 | 紧急驱动输入 |
|      | D6 | 联动输入2 |
|      | D5 | 联动输入1 |
|      | D4 | 0=联动输出关闭；1=驱动 |
|      | D3 | 0=门关闭；1=开启 |
|      | D2 | 保留 |
|      | D1 | 0=手动键松开；1=按下 |
|      | D0 | 0=继电器关闭；1=驱动 |

### 4.7 读取工作特性参数
#### 4.7.1 读取控制信息（COMMAND TYPE=0XE8）
##### 方式1：DATAF=1字节=0
- 返回DATAINFO：5字节
  - 字节1：门磁/红外控制字（同3.4.3）
  - 字节2：门锁继电器执行时间（0.1秒）
  - 字节3：开门等待延时（0.1秒）
  - 字节4：红外报警确认延时（0.1秒）
  - 字节5：感应卡号码获取控制字

##### 方式2：DATAF=1字节=1
- 返回DATAINFO：6字节（前5字节同方式1，字节6=异地报警驱动时间，0.1秒）

### 4.8 读取设备名称及版本号（COMMAND TYPE=0XEF，DATAF=1字节=0）
- 返回DATAINFO：18字节（设备名称+版本号，用“,”分隔）
- 示例：CHD805AE,VER3.01

### 4.9 通信命令参数说明
- 日期/时间格式：BCD码（如0X10表示10月/10时）
- 数值传输：低字节在前，高字节在后（HEX/BCD）
- CID1扩展：组号0-15，每组最多254台设备

## 附录：门控器（SM）历史记录格式
每条记录14字节，格式如下：
| 字段 | 字节数 | 内容说明 |
|------|--------|----------|
| 事件来源 | 5 | 卡号（刷卡开门）/00+ID（密码开门）/全0（远程/手动/联动）/掉电时间（掉电记录） |
| 日期时间 | 7 | 年（2）、月、日、时、分、秒（BCD） |
| 状态 | 1 | STATUS（D7-D0），记录事件细节 |
| 备注 | 1 | REMARK（D7=1表示已读取，D0-D6表示记录类型） |

### 主要REMARK类型说明
| REMARK值 | 记录类型 | 事件来源/STATUS关键说明 |
|----------|----------|------------------------|
| 0 | 刷卡开门 | 5字节卡号；D5=1表示未开门进入；D4=1表示延时未关门 |
| 1 | ID+密码开门 | 00+4字节ID；D7=1 |
| 2 | 远程开门 | 全0；D1=0 |
| 3 | 手动开门 | 全0；D1=0 |
| 5 | 报警/取消 | 4字节00+1字节报警源AS；AS=0=红外报警开始，2=非正常开门，18=刷卡未进入 |
| 6 | 掉电记录 | 掉电日期时间；STATUS记录上电时输入线状态 |
| 7 | 参数修改 | 4字节00+1字节修改标记；D0=1=修改密码，D2=1=新增用户 |
| 8 | 无效卡刷卡 | 5字节卡号 |
| 9 | 卡过期 | 5字节卡号 |
| 10 | 无进入权限 | 5字节卡号 |
| 11 | 密码错误3次 | 5字节卡号 |
| 40（0X40） | 门打开 | 上次开门的事件来源/REMARK |
| 41（0X41） | 门关闭 | 上次关门的事件来源/REMARK |

### 版本修改记录
| 版本号 | 修改日期 | 修改内容 |
|--------|----------|----------|
| V1.0 | 20230201 | 初始版本 |
| V2.0 | 20231103 | 增加黑名单功能 |

 