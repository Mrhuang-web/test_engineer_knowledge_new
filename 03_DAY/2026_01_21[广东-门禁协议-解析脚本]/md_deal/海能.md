# 海能门禁控制器协议详细文档

## 1. 协议概述
海能门禁控制器协议是深圳市海能通信股份有限公司的通用智能门禁通讯协议，采用RS485通信接口，用于门禁系统的监控和控制。

## 2. 通信参数
- 接口类型：RS485
- 波特率：9600
- 起始位：1位
- 数据位：8位
- 停止位：1位
- 校验方式：无校验

## 3. 协议格式

### 3.1 基本格式
`68H(1字节) + 地址(1字节) + 长度(1字节) + 数据包(最大255字节) + 校验和(1字节) + 0DH(1字节)`

### 3.2 字段说明
| 字段 | 说明 |
|------|------|
| 包头 | 固定为68H |
| 包尾 | 固定为0DH |
| 地址 | 1字节，取值范围0-255（部分设备地址跳线仅支持部分地址空间） |
| 长度 | 1字节，标识数据包的字节数，最大为255 |
| 数据包 | 由命令及参数组成，最大255字节，通常命令占1字节，其余为参数或数据 |
| 校验和 | 1字节，为数据包所有字节的累加和 |

### 3.3 示例
`68,01,02,83,00,83,0D`
- 68：包头
- 01：地址
- 02：长度
- 83：命令
- 00：命令参数
- 83：校验和
- 0D：包尾

## 4. 功能指令

### 4.1 上报组信息（命令字：81H）

#### 1. 命令格式
`68H + 地址 + 长度(01H) + 命令字(81H) + 校验(81H) + 0DH`

#### 2. 响应格式
`68H + 地址 + 长度(09H) + 命令字(81H) + 组类型(8字节) + 校验 + 0DH`

#### 3. 功能
上报设备的组信息

#### 4. 关键说明
- 组类型：从0-7依次上报各组数据类型，每组占用1字节
- 类型定义：AI-02H、DI-04H、DO-06H、空-FFH
- 门禁组定义：AI一组、DI一组、DO一组

### 4.2 上报门禁运行数据（命令字：82H）

#### 1. 命令格式
`68H + 地址 + 长度(01H) + 命令字(82H) + 校验(82H) + 0DH`

#### 2. 响应格式
`68H + 地址 + 长度 + 命令字(82H) + 板识别字(1字节) + 数据 + 板识别字(1字节) + 数据 + … + 校验 + 0DH`

#### 3. 功能
上报各个通道的数据

#### 4. 关键说明
##### （1）板识别字
- 组成：高4位为组号（0-7），低4位为组类型（AI-02H、DI-04H、DO-06H）
- 示例：24H表示第3号组为DI

##### （2）数据格式
| 组类型 | 数据说明 |
|--------|----------|
| AI | 16字节带符号BCD码，0-7号通道各2字节（低字节在前，高字节在后），不足8通道仍为16字节<br>· 前7节点：门状态（00H-门关、01H-刷卡开门、02H-中心遥控开门、03H-门内开门、04H-非正常开门）<br>· 第8节点：新记录个数（未上报记录数） |
| DI | 1字节，8路数字输入状态（位0-7对应通道0-7），实际有效通道6个：<br>· 通道0：1号红外（0-告警、1-正常）<br>· 通道1：2号红外（0-告警、1-正常）<br>· 通道2：1号出门按钮（0-按下、1-未按）<br>· 通道3：2号出门按钮（0-按下、1-未按）<br>· 通道4：1号门磁（0-门关、1-门开）<br>· 通道5：2号门磁（0-门关、1-门开） |
| DO | 1字节，8路数字输出状态（位0-7对应通道0-7），实际有效通道4个：<br>· 通道0：1号门锁（0-锁门、1-开门）<br>· 通道1：2号门锁（0-锁门、1-开门）<br>· 通道2：1号告警（0-无告警、1-告警）<br>· 通道3：2号告警（0-无告警、1-告警） |

## 5. 功能说明

### 5.1 组信息管理
- **功能**：上报设备的组信息，包括AI组、DI组、DO组
- **应用场景**：系统初始化时获取设备的组配置
- **特点**：门禁组定义固定为3组，分别对应AI、DI、DO

### 5.2 门禁运行数据上报
- **功能**：上报门禁设备的实时运行数据
- **数据内容**：门状态、红外状态、出门按钮状态、门磁状态、门锁状态、告警状态等
- **应用场景**：实时监控门禁设备的运行状态

## 6. 注意事项

1. 通信参数必须设置正确，否则会导致通信失败
2. 命令格式必须严格按照协议要求，包括包头、地址、长度、数据包、校验和和包尾
3. 校验和必须正确计算，否则会导致命令执行失败
4. 设备地址必须在有效范围内（0-255）
5. 数据包长度不能超过255字节
6. 门禁组定义固定为3组，分别对应AI、DI、DO
7. 不同组类型的数据格式和通道定义不同，需要根据实际情况解析

## 7. 典型应用流程

1. 初始化RS485通信接口
2. 发送上报组信息命令（81H），获取设备的组配置
3. 发送上报门禁运行数据命令（82H），获取门禁设备的实时运行数据
4. 解析返回的数据，提取门状态、红外状态、出门按钮状态、门磁状态、门锁状态、告警状态等信息
5. 根据需要执行相应的控制操作
6. 定期轮询门禁设备的运行数据，实现实时监控

## 8. 故障处理

1. 通信超时：检查通信线路、设备地址和通信参数
2. 命令执行失败：检查命令格式、校验和是否正确
3. 数据解析错误：检查返回数据的格式是否符合协议要求
4. 状态异常：检查门禁设备的硬件状态，如门磁、红外传感器等

## 9. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令字实现
- 扩展后的协议必须保持向前兼容性

## 10. 开发建议

1. 建议使用RS485通信库简化开发工作
2. 实现命令超时重发机制，提高通信可靠性
3. 定期检查设备的运行状态，及时发现故障
4. 实现数据缓存机制，防止数据丢失
5. 遵循协议规范，确保与设备的正常通信
6. 注意不同组类型的数据格式和通道定义的差异
7. 正确计算和验证校验和，确保数据完整性