# 人脸识别回调调试指南

## 一、调试前准备

### 1. 环境要求
- 本地运行Flask服务器：`python app.py`
- 服务器地址：`http://127.0.0.1:8090`
- Apifox工具：用于发送HTTP请求
- 可选：回调接收服务（如Postman Mock Server、Ngrok等）

### 2. 初始化设备
设备初始无密码，首次使用需要设置密码。

## 二、测试步骤

### 步骤1：初始化设备（设置密码）

#### 功能说明
首次使用设备，需要初始化密码。

#### CURL命令
```bash
curl -X POST http://127.0.0.1:8090/setPassWord \
  -d "oldPass=12345678" \
  -d "newPass=test1234"
```

#### 参数说明
- `oldPass`：旧密码（初始状态下与newPass相同）
- `newPass`：新密码（设置为`test1234`，后续测试使用此密码）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "密码设置成功",
  "code": "LAN_SUS-0",
  "data": "password is : test1234"
}
```

### 步骤2：注册测试人员

#### 功能说明
为设备添加测试人员信息。

#### CURL命令
```bash
curl -X POST http://127.0.0.1:8090/person/create \
  -d "pass=test1234" \
  -d "person={\"id\":\"test_person_001\",\"name\":\"测试人员\",\"facePermission\":2,\"idCardPermission\":2,\"faceAndCardPermission\":1}"
```

#### 参数说明
- `pass`：设备密码（步骤1中设置的`test1234`）
- `person`：人员信息JSON
  - `id`：人员ID（自定义，如`test_person_001`）
  - `name`：人员姓名
  - `facePermission`：刷脸权限（1=禁用，2=启用，默认2）
  - `idCardPermission`：身份证权限（1=禁用，2=启用，默认2）
  - `faceAndCardPermission`：人卡合一权限（1=禁用，2=启用，默认1）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "人员信息添加成功",
  "code": "LAN_SUS-0",
  "data": {
    "id": "test_person_001",
    "name": "测试人员",
    "facePermission": 2,
    "idCardPermission": 2,
    "faceAndCardPermission": 1,
    "createTime": 1705987200000,
    "iDNumber": "",
    "iDPermission": 2,
    "idcardNum": "",
    "phone": "",
    "tag": "00"
  }
}
```

### 步骤3：查询测试人员

#### 功能说明
验证人员是否成功注册。

#### CURL命令
```bash
curl -X GET "http://127.0.0.1:8090/person/find?pass=test1234&id=test_person_001"
```

#### 参数说明
- `pass`：设备密码
- `id`：人员ID（步骤2中设置的`test_person_001`）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "查询成功",
  "code": "LAN_SUS-0",
  "data": {
    "id": "test_person_001",
    "name": "测试人员",
    "facePermission": 2,
    "idCardPermission": 2,
    "faceAndCardPermission": 1,
    "createTime": 1705987200000,
    "iDNumber": "",
    "iDPermission": 2,
    "idcardNum": "",
    "phone": "",
    "tag": "00"
  }
}
```

### 步骤4：设置识别回调地址

#### 功能说明
设置识别成功后的回调通知地址。

#### CURL命令
```bash
curl -X POST http://127.0.0.1:8090/setIdentifyCallBack \
  -d "pass=test1234" \
  -d "callbackUrl=http://localhost:8080/identify_callback" \
  -d "base64Enable=1"
```

#### 参数说明
- `pass`：设备密码
- `callbackUrl`：回调地址（替换为您的回调接收服务地址）
- `base64Enable`：现场照base64开关（1=关闭，2=开启，默认1）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "设置成功",
  "code": "LAN_SUS-0",
  "data": "http://localhost:8080/identify_callback"
}
```

### 步骤5：模拟人脸识别

#### 功能说明
模拟设备识别到人员，生成识别记录并触发回调。

#### CURL命令
```bash
curl -X POST http://127.0.0.1:8090/simulateIdentify \
  -d "pass=test1234" \
  -d "personId=test_person_001"
```

#### 参数说明
- `pass`：设备密码
- `personId`：测试人员ID（步骤2中设置的`test_person_001`）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "模拟识别成功",
  "code": "LAN_SUS-0",
  "data": {
    "id": "随机ID",
    "personId": "test_person_001",
    "personName": "测试人员",
    "time": 1705987200000,
    "path": "ftp://192.168.18.17:8010/IdentifyRecords/2024-01-23/随机ID.jpg",
    "aliveType": 1,
    "identifyType": 1,
    "model": 0,
    "result": 1,
    "imgBase64": "",
    "state": 1,
    "type": "face_0"
  }
}
```

### 步骤6：检查回调接收

#### 功能说明
验证回调服务是否收到设备发送的识别记录。

#### 预期回调数据
设备会向设置的`callbackUrl`发送POST请求，数据格式如下：
```json
{
  "deviceKey": "84E0F420893301FA",
  "path": "ftp://192.168.18.17:8010/IdentifyRecords/2024-01-23/随机ID.jpg",
  "personId": "test_person_001",
  "time": "1705987200000",
  "type": "face_0"
}
```

#### 回调响应要求
回调服务需要返回以下格式，否则设备会在10分钟后重试：
```json
{
  "result": 1,
  "success": true
}
```

### 步骤7：查询识别记录

#### 功能说明
验证识别记录是否成功生成。

#### CURL命令
```bash
curl -X GET "http://127.0.0.1:8090/newFindRecords?pass=test1234&personId=test_person_001&startTime=0&endTime=1705990800000"
```

#### 参数说明
- `pass`：设备密码
- `personId`：人员ID
- `startTime`：开始时间戳（0表示不限制）
- `endTime`：结束时间戳（当前时间+1小时）

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "查询成功",
  "code": "LAN_SUS-0",
  "data": {
    "total": 1,
    "records": [
      {
        "id": "随机ID",
        "personId": "test_person_001",
        "personName": "测试人员",
        "time": 1705987200000,
        "path": "ftp://192.168.18.17:8010/IdentifyRecords/2024-01-23/随机ID.jpg",
        "aliveType": 1,
        "identifyType": 1,
        "model": 0,
        "result": 1,
        "imgBase64": "",
        "state": 1,
        "type": "face_0"
      }
    ]
  }
}
```

### 步骤8：删除测试人员

#### 功能说明
测试完成后，清理测试数据。

#### CURL命令
```bash
curl -X POST http://127.0.0.1:8090/person/delete \
  -d "pass=test1234" \
  -d "id=test_person_001"
```

#### 参数说明
- `pass`：设备密码
- `id`：人员ID

#### 预期响应
```json
{
  "result": 1,
  "success": true,
  "msg": "effective中的内容代表已删余有效的ID；invalid中的内容代表无效或者不存在的ID",
  "code": "LAN_SUS-0",
  "data": {
    "effective": "test_person_001",
    "invalid": ""
  }
}
```

## 三、常见问题排查

### 1. 密码错误
- 错误码：`LAN_EXP-1001`
- 解决方案：检查密码是否正确，初始密码为`12345678`

### 2. 参数异常
- 错误码：`LAN_EXP-1002`, `LAN_EXP-3001`, `LAN_EXP-3015`等
- 解决方案：检查参数名称、格式是否正确

### 3. 回调失败
- 现象：记录状态为2
- 解决方案：检查回调地址是否可达，响应格式是否正确

### 4. 人脸检测失败
- 错误码：`LAN_EXP-8006`至`LAN_EXP-8017`
- 解决方案：检查图片质量，确保清晰、正面、光线充足

## 四、回调接收服务推荐

### 1. Postman Mock Server
- 免费使用，配置简单
- 支持查看请求日志
- 可设置固定响应

### 2. Ngrok
- 用于将本地服务暴露到公网
- 适合本地开发测试

### 3. 自定义Node.js服务
```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/identify_callback') {
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString();
    });
    req.on('end', () => {
      console.log('收到回调:', JSON.parse(body));
      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ result: 1, success: true }));
    });
  } else {
    res.writeHead(404);
    res.end();
  }
});

server.listen(8080, () => {
  console.log('回调接收服务启动在 http://localhost:8080');
});
```

## 五、Apifox配置建议

### 1. 创建环境变量
- `base_url`: `http://127.0.0.1:8090`
- `password`: `test1234`
- `person_id`: `test_person_001`

### 2. 导入CURL命令
Apifox支持直接导入CURL命令，自动生成请求配置。

### 3. 启用请求历史
方便查看和重试请求。

## 六、测试流程图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 初始化设备     │────▶│ 注册测试人员   │────▶│ 设置回调地址   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              ▲                         │
                              │                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 删除测试人员   │◀────│ 查询识别记录   │◀────│ 模拟人脸识别   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                     │
                                                     ▼
                                             ┌─────────────────┐
                                             │ 检查回调接收   │
                                             └─────────────────┘
```

## 七、注意事项

1. 测试完成后，记得清理测试数据
2. 回调地址需确保可达
3. 设备同一时间只允许一个客户端调用
4. 图片大小限制为50MB
5. 每个人员最多可注册3张照片

## 八、扩展测试

### 1. 测试陌生人识别
```bash
curl -X POST http://127.0.0.1:8090/simulateIdentify \
  -d "pass=test1234"
```

### 2. 测试多人员识别
注册多个人员，分别模拟识别。

### 3. 测试批量删除记录
```bash
curl -X POST http://127.0.0.1:8090/newDeleteRecords \
  -d "pass=test1234" \
  -d "personId=-1"
```

---

以上就是人脸识别回调调试的完整指南，按照步骤操作即可完成本地调试。如有问题，请检查配置和参数是否正确。