# MJ200门禁控制器通信协议（V4.0）解析

## 一、协议基础概述

### 1.1 命令类别定义

MJ200V4.0门禁协议将命令划分为三大核心类别，通过`CID1`与`CID2`组合标识，具体如下：

|序号|命令类别|CID1|CID2|功能范围|
|---|---|---|---|---|
|1|获取/取消权限命令|8XH|48H|密码校验、权限撤销、密码修改、设备地址调整|
|2|设置（遥控）参数命令|8XH|49H|系统参数配置、时间校准、用户授权、遥控开门、报警延时设置等|
|3|读取参数/记录信息命令|8XH|4AH|系统参数读取、时间查询、用户信息查询、历史记录读取、设备状态监测|
### 1.2 核心术语说明

- **SU**：上位机/管理系统（发送命令方）

- **SM**：门禁控制器（接收并响应命令方）

- **SOI**：帧起始同步单元（固定6字节：`FA 55 FA 55 FA 55`）

- **EOI**：帧结束单元（固定4字节：`FD 22 FD 22`）

- **VER**：协议版本号（出厂默认`0X00`，支持后续配置）

- **ADR**：门禁设备地址（出厂默认`0XFF`，1字节，范围0-255）

- **CHKSUM**：CRC16校验值（覆盖`VER`到`COMMAND INFO`所有字节，确保数据完整性）

- **RTN**：命令执行返回码（标识命令成功/失败及错误原因）

## 二、协议帧结构详解

### 2.1 SU→SM命令帧结构（表A.2）

|序号|字段|字节数|格式/说明|示例值|
|---|---|---|---|---|
|1|SOI|6|帧起始同步码|`FA 55 FA 55 FA 55`|
|2|VER|1|协议版本号|`0X10`（V1.0）|
|3|ADR|1|设备地址|`0XFF`（出厂默认）|
|4|CID1|1|命令大类标识|`88H`（8XH中X=8）|
|5|CID2|1|命令小类标识|`48H`（获取/取消权限类）|
|6|LENGTH|2|`COMMAND INFO`数据长度|`00 07`（7字节）|
|7|COMMAND INFO|LENID/2|命令子集码+命令号+命令信息|`F0 E0 08 00 00 08 08`（密码校验）|
|8|CHKSUM|2|CRC16校验值|`2A BC`|
|9|EOI|4|帧结束码|`FD 22 FD 22`|
#### 关键补充：设备扩展地址码

由`CID1`低4位（X）与`ADR`（1字节）组成12位扩展地址，其中`X`为高4位，`ADR`为低8位，支持更多设备地址区分。

### 2.2 SM→SU响应帧结构（表A.5）

|序号|字段|字节数|格式/说明|示例值|
|---|---|---|---|---|
|1|SOI|6|帧起始同步码|`FA 55 FA 55 FA 55`|
|2|VER|1|协议版本号（与命令帧一致）|`0X10`|
|3|ADR|1|设备地址（与命令帧一致）|`0XFF`|
|4|CID1|1|命令大类标识（回声）|`88H`|
|5|RTN|1|命令执行返回码|`00H`（正常）|
|6|LENGTH|2|`DATA INFO`数据长度|`00 02`（2字节）|
|7|DATA INFO|LENID/2|响应数据（状态/参数信息）|`F0 E0`（命令子集回声）|
|8|CHKSUM|2|CRC16校验值|`B4 C8`|
|9|EOI|4|帧结束码|`FD 22 FD 22`|
### 2.3 返回码RTN定义（表A.6）

|RTN值（HEX）|含义|适用场景|
|---|---|---|
|00H|正常|命令执行成功（如权限获取、参数设置、记录读取）|
|01H|VER错|协议版本不匹配（命令帧VER与SM支持版本不一致）|
|02H|CHKSUM错|校验值计算错误（数据传输损坏或校验算法不匹配）|
|03H|ADR错|设备地址错误（SM未匹配命令帧中的ADR）|
|04H|CID1错|命令大类标识错误（CID1不在8XH范围内）|
|05H|CID2错|命令小类标识错误（CID2与CID1不匹配，如8XH+4AH应为读取类）|
|06H|接收数据LENGTH不匹配|命令帧中LENGTH与实际COMMAND INFO长度不一致|
|07H|无效数据|COMMAND INFO中包含非法参数（如时间超出范围、权限码错误）|
|0E0H|权限校验密码不符|密码校验命令中，5字节密码与SM存储密码不一致|
|0E1H|无访问权限|未通过密码校验即执行需权限的命令（如参数设置）|
|0E2H|更改密码不成功|新密码格式非法或写入失败|
|0E3H|加卡空间已满|用户授权时，SM存储的用户数量达到上限（长期卡0-1024，短期卡0-500）|
|0E4H|历史记录栈全空|读取历史记录时，记录栈无任何有效记录|
|0E5H|修改工作参数不成功|工作参数（如超时延时、报警延时）超出合法范围|
|0E6H|增加ID相同的用户|授权用户时，卡号已存在于SM用户列表中|
|0E7H|信息不存在或已无效|查询用户/记录时，目标ID/序号不存在或已被删除|
|0E8H|设置的工作参数不合法|参数值超出范围（如开门延时5-30s，设置为3s）|
|0E9H|历史记录栈满|历史记录数量达到SM存储上限（0-1499）|
|0EAH|访问受限制卡|刷卡用户为受限卡（如有效期过期、权限不足）|
|0EBH|历史记录未读取确认错误|读取历史记录后未发送确认命令，再次读取同一记录|
|0ECH|节假日表满|节假日表设置条目达到上限（16条）|
|0EDH~0EFH|其他错误|用户自定义错误（如硬件故障、通信中断）|
## 三、核心功能命令解析

### 3.1 获取/取消权限命令（CID1=8XH，CID2=48H）

需先通过密码校验获取权限，才能执行参数设置/修改操作；读取操作无需权限。

#### 3.1.1 命令详情（表A.8）

|功能|LENGTH|COMMAND INFO|备注|
|---|---|---|---|
|获取权限（密码校验）|7|GROUP=0F0H，TYPE=0E0H，INFO=5字节密码|密码正确则获取10分钟操作权限（可延长）|
|取消权限|2|GROUP=0F0H，TYPE=0E1H，INFO=无|主动终止已获取的操作权限|
|更改密码|8|GROUP=0F0H，TYPE=0E2H，INFO=5字节新密码+1字节异或校验码|异或校验码用于验证新密码完整性|
|修改门禁地址|3|GROUP=0F0H，TYPE=0E3H，INFO=1字节新地址|新地址需在0-255范围内|
#### 3.1.2 示例：获取权限命令

- **发送帧**：`FA 55 FA 55 FA 55 10 FF 88 48 00 07 F0 E0 08 00 00 08 08 2A BC FD 22 FD 22`

- **响应帧**：`FA 55 FA 55 FA 55 10 FF 88 00 00 02 F0 E0 B4 C8 FD 22 FD 22`

- **说明**：RTN=00H表示密码校验成功，获取操作权限；RTN=0E0H表示密码错误。

### 3.2 设置（遥控）参数命令（CID1=8XH，CID2=49H）

涵盖系统配置、用户管理、遥控控制等核心功能，需先获取权限。

#### 3.2.1 核心命令详情（表A.11）

|功能|LENGTH|COMMAND INFO|关键参数说明|
|---|---|---|---|
|设置系统参数|27|GROUP=0F1H，TYPE=0E0H，INFO=SG2000v10-SysSWv10-f5d3|ASCII码，含硬件版本（SG2000v10）、软件版本（SysSWv10）、序列号（f5d3），不足25字节用空格填充|
|校准SM时间|9|GROUP=0F1H，TYPE=0E1H，INFO=BCD码（年+月+日+星期+时+分+秒）|示例：04H（年）、11H（月）、21H（日）、03H（星期3）、14H（时）、51H（分）、30H（秒）|
|授权单用户|13|GROUP=0F1H，TYPE=0E2H，INFO=11字节用户资料|含1字节权限（01H=不限时、02H=限周内工作日等）、4字节卡号、3字节起始时间、3字节结束时间（表A.13）|
|撤销单用户授权|6|GROUP=0F1H，TYPE=0E3H，INFO=2字节子命令+4字节卡号|按卡号检索并删除用户权限|
|撤销所有用户授权|2|GROUP=0F1H，TYPE=0E4H，INFO=无|需提示用户确认，避免误操作|
|清除所有历史记录|2|GROUP=0F1H，TYPE=0E5H，INFO=无|清空SM中所有开门/告警记录|
|遥控开门|2|GROUP=0F1H，TYPE=0E6H，INFO=无|远程控制门开启（模式0有效）|
|线路驱动设置|3|GROUP=0F1H，TYPE=0E7H，INFO=1字节控制码|控制蜂鸣/门磁/按钮/继电器驱动（0=开启，1=关闭，表A.15）|
|设置超时关闭延时|3|GROUP=0F1H，TYPE=0E8H，INFO=1字节延时（5-60分钟）|每次设置成功后重新计时，默认10分钟|
|开门后锁锁定延时|3|GROUP=0F1H，TYPE=0E9H，INFO=1字节延时（5-30s）|刷卡/按钮开门后，电子锁延时锁定，默认8s|
|本地报警驱动延时|3|GROUP=0F1H，TYPE=0EAH，INFO=1字节延时（1-10分钟）|报警触发后，驱动蜂鸣/告警的持续时间，默认1分钟|
|允许/禁止进入|3|GROUP=0F1H，TYPE=0EBH，INFO=1字节控制（1=允许，0=禁止）|全局控制合法用户是否可进入|
|撤防/布防|3|GROUP=0F1H，TYPE=0ECH，INFO=1字节控制（0=撤防，1=布防）|布防时监测门状态，异常开门触发告警|
|节假日表设置|6|GROUP=0F1H，TYPE=0EEH，INFO=4字节/条（年+月+日+时长）|共16条，不可跨月，BCD码格式（如08100107=08年10月1日，时长7天）|
|周表设置|11|GROUP=0F1H，TYPE=0EFH，INFO=星期标识+2个时间段（各4字节）|星期标识：00H=周日~07H=假日，时间段为HH:MM格式|
|DI量参数设置|7|GROUP=0F1H，TYPE=0F2H，INFO=通道号+门限+扫描周期+告警延时+联动继电器|扫描周期/告警延时单位0.1s，不可设为0|
|DO量控制|3|GROUP=0F1H，TYPE=0F3H，INFO=1字节控制码|控制4路继电器输出（低4位有效）|
|远程开门2|2|GROUP=0F1H，TYPE=0F6H，INFO=无|仅模式1有效（与模式0区分设备驱动逻辑）|
|设置锁工作方式|3|GROUP=0F1H，TYPE=0F7H（锁1）/0F8H（锁2），INFO=1字节（0=电平锁，1=脉冲锁）|适配不同类型电子锁驱动逻辑|
|按钮/读卡器/锁模式|3|GROUP=0F1H，TYPE=0F9H，INFO=1字节（0=模式0，1=模式1）|模式0：双按钮/读卡器驱动双锁；模式1：按钮1/读卡器1驱动锁1，按钮2/读卡器2驱动锁2|
|远程复位|2|GROUP=0F1H，TYPE=0FFH，INFO=无|远程重启SM控制器|
#### 3.2.2 示例：校准SM时间命令

- **发送帧**：`FA 55 FA 55 FA 55 10 FF 88 49 00 09 F1 E1 08 05 13 01 0E 25 00 32 20 FD 22 FD 22`

- **响应帧**：`FA 55 FA 55 FA 55 10 FF 88 00 00 02 F1 E1 74 98 FD 22 FD 22`

- **说明**：RTN=00H表示时间校准成功，SM同步为命令帧中的时间。

### 3.3 读取参数/记录信息命令（CID1=8XH，CID2=4AH）

无需权限校验，可读取SM的系统参数、用户信息、历史记录等。

#### 3.3.1 核心命令详情（表A.23）

|功能|COMMAND INFO|SM返回数据|备注|
|---|---|---|---|
|读取系统参数|GROUP=0F2H，TYPE=0E0H，INFO=0|ASCII码：SG2000v10-SysSWv10-f5d3|与“设置系统参数”格式一致|
|读取SM时间|GROUP=0F2H，TYPE=0E1H，INFO=0|6字节BCD码（年+月+日+时+分+秒）|表A.25格式|
|查询指定ID用户信息|GROUP=0F2H，TYPE=0E2H，INFO=4字节卡号|11字节用户资料（同授权用户格式）|表A.13结构|
|读取授权用户数量|GROUP=0F2H，TYPE=0E3H，INFO=0|2字节（范围0-1024+500）|区分长期卡与短期卡数量|
|读取历史记录总数|GROUP=0F2H，TYPE=0E4H，INFO=0|2字节（范围0-1499）|历史记录栈中有效记录数|
|读取历史记录|GROUP=0F2H，TYPE=0E5H，INFO=0|单条记录（事件类型+卡号+时间+线路状态，表A.27）|需发送确认命令（TYPE=0E8H）才能读取下一条|
|读取门禁状态|GROUP=0F2H，TYPE=0E6H，INFO=0|2字节状态码（门状态、告警状态、驱动状态等，表A.30）|实时反映SM工作状态|
|读取延时参数|GROUP=0F2H，TYPE=0E7H，INFO=0|3字节（权限延时+报警延时+锁锁定延时）|单位分别为：分、分、秒|
|历史记录确认|GROUP=0F2H，TYPE=0E8H，INFO=0|无（仅确认）|未发送则再次读取同一记录，触发0EBH错误|
|查询节假日表|GROUP=0F2H，TYPE=0E9H，INFO=0|68字节（2字节有效标识+64字节表数据）|16条节假日，每条4字节|
|查询周表|GROUP=0F2H，TYPE=0EAH，INFO=0|67字节（1字节有效标识+64字节表数据）|8类时间（周日-假日），每类8字节|
|获取DI量参数|GROUP=0F2H，TYPE=0EBH，INFO=1字节通道号|5字节（门限+扫描周期+告警延时+联动继电器）|与“DI量参数设置”格式一致|
|获取DO量控制|GROUP=0F2H，TYPE=0ECH，INFO=0|1字节（低4位对应4路继电器状态）|0=关闭，1=开启|
|获取锁工作方式|GROUP=0F2H，TYPE=0F0H（锁1）/0F1H（锁2），INFO=0|1字节（0=电平锁，1=脉冲锁）|与“设置锁工作方式”对应|
|获取设备驱动模式|GROUP=0F2H，TYPE=0F2H，INFO=0|1字节（0=模式0，1=模式1）|与“按钮/读卡器/锁模式”对应|
#### 3.3.2 历史记录格式（表A.27/A.28/A.29）

1. **记录结构**：1字节事件类型 + 4字节卡号 + 3字节年月日 + 3字节时分秒 + 1字节线路状态

2. **事件类型（1字节）**：

    - 00H：无效记录

    - 01H：外部刷卡开门

    - 02H：手动按钮出门

    - 03H：远程开门

    - 04H：钥匙开门

    - 05H：非法开门

    - 06H：受限卡/非法卡刷卡

    - 07H：内部刷卡开门

3. **线路状态（1字节，D7为记录类型标识）**：

    - D7=0：开门事件记录（D6=门初始状态，D5=延时开门状态，D4=关门状态，D3=记录确认标识）

    - D7=1：线路状态记录（D6-D4=门虚掩/强制闭门/撤防/布防状态）

## 四、视频门禁对讲机关联补充

### 4.1 设备组成与工作原理

|组件|功能|
|---|---|
|对讲主机|安装于单元门，支持输入房间号呼叫、视频采集（内置红外摄像机）|
|对讲分机|住户端设备，支持视频通话、远程开锁、监控模式|
|显示屏|2.4寸TFT LCD（320*240分辨率），显示来访者图像|
|UPS电源|保障断电时系统正常工作|
|电控锁/闭门器|执行开门/闭锁动作，配合SM控制器驱动|
### 4.2 核心技术参数（以CS324K为例）

|类别|参数|详情|
|---|---|---|
|无线传输|频率范围|2.4GHz ISM频段（2402~2485.35MHz）|
||传输距离|空旷环境300米|
||发射功率|16~20dBm|
||接收灵敏度|-90dBm|
|视频采集|传感器|1/4” CMOS，0Lux（红外开启时）|
||压缩格式|MJPEG|
|电源|主机供电|DC 5V/1A（待机20-30mA，工作190mA）|
||分机供电|DC 4.5V/1A（待机20-30mA，工作170mA）|
||电池|内置可充电锂电池，待机72小时，USB充电|
|音频|采样速率|8Kbps，12位数字音频|
||铃声|12种可选|
### 4.3 与MJ200协议协同逻辑

1. **视频呼叫触发**：来访者通过对讲主机呼叫，分机响应后建立视频通话，住户确认身份。

2. **远程开锁联动**：住户通过分机发送开锁指令，指令经SM控制器（MJ200协议）解析，触发DO量控制（继电器驱动电控锁开启）。

3. **状态上报**：门磁状态（DI量）通过MJ200协议上报SM，异常开门（如门虚掩）触发本地报警（蜂鸣驱动）并记录历史事件。

## 五、协议应用注意事项

1. **权限管理**：参数设置/修改需先通过密码校验，权限超时（默认10分钟）后需重新校验，避免未授权操作。

2. **数据校验**：所有命令/响应帧需验证CHKSUM，确保传输完整性；校验失败需重发命令。

3. **历史记录读取**：每次读取后需发送确认命令，否则会触发0EBH错误，影响后续记录读取。

4. **节假日/周表设置**：节假日不可跨月，周表需按“星期标识+时间段”格式配置，确保权限控制生效。

5. **设备地址规划**：利用12位扩展地址码（CID1低4位+ADR），避免多设备地址冲突，支持大规模组网。
> （注：文档部分内容可能由 AI 生成）