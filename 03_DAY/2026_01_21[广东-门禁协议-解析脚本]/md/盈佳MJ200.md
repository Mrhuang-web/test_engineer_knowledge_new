\# 门禁控制器通信协议（MJ200V4.0 门禁版本） ## 一、命令类别 | 序号 | 内容 | CID1 | CID2 | 备注 | | --- | --- | --- | --- | --- | | 1 | 获取、取消权限的命令 | 8XH | 48H | | | 2 | 设置(遥控)参数的命令 | 8XH | 49H | | | 3 | 读取参数、记录信息的命令 | 8XH | 4AH | | ## 二、通信协议数据包格式 ### （一）SU 或 SS 发给 SM 的命令信息（表A.2） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | CID1 | CID2 | LENGTH | COMMAND INFO | CHKSUM | EOI | #### 关键说明： - **SOI**：帧起始同步单元，6字节：FA 55 FA 55 FA 55 - **EOI**：帧结束单元，4字节：FD 22 FD 22 - **VER**：协议版本号，出厂默认可设为0X00 - **CHKSUM**：VER到COMMAND INFO的CRC16校验值 - **ADR**：门禁地址，出厂地址为0XFF - **CID1、CID2**：参考命令类别表，CID1低4位“X”与ADR组成扩展地址码（X为高4位，共12位） - **LENGTH**：COMMAND INFO的数据长度 - **COMMAND INFO**：包含子集码、命令号及命令信息，格式如下（表A.4）： | 组成部分 | 子集码 COM GROUP | 命令号 TYPE | 命令信息 INFO | | --- | --- | --- | --- | | 字节数 | 1字节 | 1字节 | N字节 | | 说明 | 区分不同门禁产品的命令子集 | 子集中的命令编号 | 具体命令参数 | ### （二）SM 发给 SU 的响应信息数据包（表A.5） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | 2 | 4 | - | | 格式 | SOI | VER | ADR | CID1 | RTN | LENGTH | DATA INFO | CHKSUM | EOI | #### 关键说明： - **RTN**：返回码，指示命令执行结果，具体含义如下（表A.6）： | 序号 | RTN值(HEX) | 表示意义 | 备注 | | --- | --- | --- | --- | | 1 | 00H | 正常 | | | 2 | 01H | VER错 | 协议版本不符 | | 3 | 02H | CHKSUM错 | | | 4 | 03H | ADR错 | | | 5 | 04H | CID1错 | | | 6 | 05H | CID2错 | | | 7 | 06H | 接收数据LENGTH不匹配 | 指令数据长度异常 | | 8 | 07H | 无效数据 | | | 9 | 0E0H | 权限校验密码不符 | | | 10 | 0E1H | 无访问权限 | | | 11 | 0E2H | 更改密码不成功 | | | 12 | 0E3H | 加卡空间已满 | | | 13 | 0E4H | 历史记录栈全空 | | | 14 | 0E5H | 修改工作参数不成功 | | | 15 | 0E6H | 增加ID相同的用户 | 不接受设置 | | 16 | 0E7H | 信息不存在或已无效 | | | 17 | 0E8H | 设置的工作参数不合法 | | | 18 | 0E9H | 历史记录栈满 | | | 19 | 0EAH | 访问受限制卡 | | | 20 | 0EBH | 该条历史记录未读取，确认错误 | | | 21 | 0ECH | 节假日表满 | 更改之处 | | 22 | 0EDH~EFH | 其他错误 | 用户自定义 | ## 三、核心命令详情 ### （一）获取、取消权限命令 SU 需通过密码确认才能设置、修改 SM 工作参数或访问重要信息，密码由5字节组成。 #### 1. 命令信息格式（表A.7） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | 48H | LENGTH | COMMAND INFO | CHKSUM | EOI | #### 2. 具体命令参数（表A.8） | 内容 | LENGTH | COMMAND INFO | 备注 | | --- | --- | --- | --- | | GROUP | TYPE | INFO | | | 获取权限(密码校验) | 7 | 0F0H | 0E0H | 5字节密码 | | 取消权限 | 2 | 0F0H | 0E1H | 无 | | 更改密码 | 8 | 0F0H | 0E2H | 5字节新密码+1字节异或校验码 | | 修改门禁地址 | 3 | 0F0H | 0E3H | 1字节的新地址 | #### 3. 响应信息格式（表A.9） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | RTN | LENGTH | DATAINFO | CHKSUM | EOI | #### 响应说明： - **RTN=0**：命令正常执行，密码匹配，成功获取/取消权限 - **RTN=0E0H**：操作不成功，权限未获取/取消 - 权限有效时长：默认10分钟（可设置），超时后SM关闭允许设置状态 - 读取参数、记录等操作无需密码校验 ### （二）设置SM工作参数、遥控命令 #### 1. 命令信息格式（表A.10） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | 49H | LENGTH | COM INFO | CHKSUM | EOI | #### 2. 具体命令参数（表A.11） | 序号 | 内容 | LENGTH | COMMAND INFO | 备注 | | --- | --- | --- | --- | --- | --- | | GROUP | TYPE | INFO | | | 1 | 设置系统参数 | 27 | 0F1H | 0E0H | SG2000v10-SYSv10-f5d3（ASCII码，不足25字节用空格填充） | 系统参数配置 | | 2 | 校准SM日期、时间 | 9 | 0F1H | 0E1H | BCD码：年月日星期时分秒（共7字节） | 同步实时时钟 | | 3 | 授权单用户 | 13 | 0F1H | 0E2H | 11字节用户资料（ID卡权限+ID卡号+起止时间） | 向加卡表添加用户 | | 4 | 撤销单用户授权 | 6 | 0F1H | 0E3H | 4字节ID资料 | 删除指定用户权限 | | 5 | 撤销所有用户授权 | 2 | 0F1H | 0E4H | 无 | 建议提示用户确认 | | 6 | 清除所有历史记录 | 2 | 0F1H | 0E5H | 无 | 建议提示用户确认 | | 7 | 遥控开门 | 2 | 0F1H | 0E6H | 无 | 简单放行 | | 8 | SM线路驱动设置 | 3 | 0F1H | 0E7H | 1字节（=1关闭；=0开启） | 控制蜂鸣、门磁等驱动 | | 9 | 设置SM超时主动关闭延时 | 3 | 0F1H | 0E8H | 1字节（5~60分钟，默认9分钟） | 权限有效延时重置 | | 10 | 开门后电子锁锁定延时 | 3 | 0F1H | 0E9H | 1字节（5~30秒，默认8秒） | 刷卡/按钮开门后锁定时间 | | 11 | 本地报警的驱动延时 | 3 | 0F1H | 0EAH | 1字节（1~10分钟，默认1分钟） | 报警持续时间 | | 12 | 允许进入或禁止进入 | 3 | 0F1H | 0EBH | 1字节（1=允许；0=禁止） | 更改之处 | | 13 | 撤防/布防 | 3 | 0F1H | 0ECH | 1字节（0=关闭监视；1=监视门状态） | 布防时上传门开告警 | | 14 | 强制上锁命令 | 2 | 0F1H | 0EDH | 无 | 更改之处 | | 15 | 控制器节假日表设置 | 6 | 0F1H | 0EEH | 4字节/条（年、月、日、时长），共16条 | 不可跨月填写 | | 16 | 控制器周表设置 | 11 | 0F1H | 0EFH | 首字节星期，每天2个时间段（各4字节） | 更改之处 | | 17 | 删除节假日表 | 4 | 0F1H | 0F0H | 2字节16位数据（对应条目置1删除） | 更改之处 | | 18 | 删除周表 | 3 | 0F1H | 0F1H | 1字节（0x00-0x07对应周日-周六+节假日） | 更改之处 | | 19 | DI量参数设置 | 7 | 0F1H | 0F2H | 通道号+门限+扫描周期+告警延时+联动继电器 | 周期/延时单位0.1秒，不可为0 | | 20 | DO量控制 | 3 | 0F1H | 0F3H | 1字节（控制4路继电器输出） | 更改之处 | | 27 | 远程开门2 | 2 | 0F1H | 0F6H | 无 | 模式0无效，模式1有效 | | 28 | 设置锁1的工作方式 | 3 | 0F1H | 0F7H | 1字节（0=电平锁；1=脉冲锁） | 更改之处 | | 29 | 设置锁2的工作方式 | 3 | 0F1H | 0F8H | 1字节（0=电平锁；1=脉冲锁） | 更改之处 | | 30 | 按钮、读卡器、锁继电器工作模式 | 3 | 0F1H | 0F9H | 1字节（0=模式0；1=模式1） | 模式0：双锁联动；模式1：分路控制 | | 31 | 远程复位 | 2 | 0F1H | 0FFH | 无 | 远程复位指令 | #### 3. 用户授权资料格式（表A.13） | 内容 | 字节数 | 说明 | | --- | --- | --- | | ID卡权限 | 1 | 0x00=无效卡；0x01=不限时有效卡；0x02=限周内工作日卡；0x04=限月日时卡；0x08=限年月日卡；0x12=限周内工作日正常工作时间（8:00~18:00）卡；0x18=限年月日正常工作时间卡 | | ID卡号 | 4 | 持卡人唯一标识 | | 允许进入的起始时间 | 3 | 年月日或月日时格式 | | 允许进入的最后时间 | 3 | 年月日或月日时格式 | #### 4. 响应信息格式（表A.12） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | RTN | LENGTH | DATAINFO | CHKSUM | EOI | #### 响应说明： - **DATAINFO**：为空或返回SM工作状态数据（DATAFLAG1字节+RUNSTATE2字节） - **RTN=0**：命令执行成功；其他值参考返回码表 ### （三）读取SM工作参数、历史记录命令 #### 1. 命令信息格式（表A.22） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | 4AH | LENGTH | COM INFO | CHKSUM | EOI | #### 2. 具体命令参数（表A.23） | 序号 | 内容 | COMMAND INFO | SM返回 | | --- | --- | --- | --- | --- | | GROUP | TYPE | INFO | | | 1 | 读取系统参数 | 0F2H | 0E0H | =0 | ASCII码：SG2000v10-SysSWv10-f5d3 | | 2 | 读取SM日期、时间 | 0F2H | 0E1H | =0 | BCD码：年、月、日、时、分、秒（6字节） | | 3 | 查询指定ID卡号用户信息 | 0F2H | 0E2H | ID卡号 | 表A.18格式数据 | | 4 | 读取授权用户的数量 | 0F2H | 0E3H | =0 | 2字节用户数目 | | 5 | 读取历史记录栈中总记录数 | 0F2H | 0E4H | 无 | 2字节记录总数 | | 6 | 读取历史记录命令 | 0F2H | 0E5H | 无 | 每次1条记录，需上位机确认后读取下一条 | | 7 | 读取门禁状态 | 0F2H | 0E6H | =0 | 2字节状态（表A.30） | | 8 | 读取延时时间参数信息 | 0F2H | 0E7H | =0 | 3字节：密码权限延时(分)、报警延时(分)、开门锁定延时(秒) | | 9 | 历史记录接收成功确认命令 | 0F2H | 0E8H | =0 | 读取记录后需发送，否则返回0xEB错误 | | 10 | 查询节假日表 | 0F2H | 0E9H | 无 | 68字节（2字节有效记录+64字节表数据） | | 11 | 查询周表 | 0F2H | 0EAH | 无 | 67字节（1字节有效记录+64字节表数据） | | 12 | 获取DI量参数 | 0F2H | 0EBH | 通道号 | 5字节：通道号+门限+扫描周期+告警延时+联动继电器 | | 13 | 获取DO量输出控制 | 0F2H | 0ECH | 无 | 1字节（低4位控制4路继电器） | | 20 | 获取锁1的工作方式 | 0F2H | 0F0H | 无 | 1字节（0=电平锁；1=脉冲锁） | | 21 | 获取锁2的工作方式 | 0F2H | 0F1H | 无 | 1字节（0=电平锁；1=脉冲锁） | | 22 | 获取读卡器、锁的工作模式 | 0F2H | 0F2H | 无 | 1字节（0=模式0；1=模式1） | #### 3. 历史记录格式（表A.27、A.28、A.29） | 记录组成 | 事件类型（1字节） | ID卡号（4字节） | 日期（3字节） | 时间（3字节） | 线路状态（1字节） | | --- | --- | --- | --- | --- | --- | | 事件类型代码 | 0x00=无效记录；0x01=外部刷卡开门；0x02=手动按钮出门；0x03=远程开门；0x04=钥匙开门；0x05=非法开门；0x06=受限卡/非法卡刷卡；0x07=内部刷卡开门 | #### 线路状态说明（表A.29）： | 位 | 含义 | | --- | --- | | D7 | 0=开门事件记录；1=线路状态事件记录 | | D6 | 0=开门前门关闭；1=开门前门开启（D7=1时表示门虚掩/强制闭门） | | D5 | 0=延时内开门；1=延时超时未开门（D7=1时表示撤防/布防事件） | | D4 | 0=开门后已关门；1=开门后未关门 | | D3 | 0=正常；1=记录未确认 | | D2 | 开门动作方式标识 | #### 4. 门禁状态说明（表A.30） | 位 | 含义 | | --- | --- | | D15 | 0=正常；1=DI3告警 | | D14 | 0=正常；1=DI2告警 | | D13 | 0=正常；1=DI1告警 | | D12 | 0=第二扇门关闭；1=第二扇门开启告警 | | D11 | 0=正常；1=按钮按下 | | D10 | 0=正常；1=非法开门告警 | | D9 | 0=正常；1=非法刷卡告警 | | D8 | 0=门关闭；1=门开启 | | D7 | 0=开门继电器驱动打开；1=不驱动 | | D6 | 0=按钮开启；1=不开启 | | D5 | 0=门磁驱动开启；1=不开启 | | D4 | 0=蜂鸣及警报开启；1=不开启 | | D3 | 0=布防状态；1=撤防状态 | | D2 | 0=允许进入；1=禁止进入 | | D1 | 0=不报警；1=蜂鸣报警（门未关延时到） | | D0 | 0=门关闭；1=门开启（合法开门/撤防时不告警） | #### 5. 响应信息格式（表A.24） | 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | | 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 | | 格式 | SOI | VER | ADR | 8XH | RTN | LENGTH | DATAINFO | CHKSUM | EOI |