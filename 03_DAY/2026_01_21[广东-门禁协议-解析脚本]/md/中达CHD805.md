\# 门禁控制器通信协议(RS485) ## V2.0 局站控制单元(SUPERVISION UNIT，以下简称 “上位机” 或 SU )，与门控器(SUPERVISION MODULE，以下简称 “下位机” 或SM )之间的通信，采用“主---从”方式，主方（SU）发送设置命令或读取命令给从方（SM），从方（SM）将设置结果应答SU，或将读取的信息返回给SU。 ## 一、通信规范 ### 1.1 通信速率与数据格式 #### 通信速率 9600 B/S，SM内应有改变速率的机制。 #### 数据格式 1起始位，8数据位，1停止位，校验方式位。校验方式有：无校验；奇校验；偶校验；MARK(1)校验；SPACE（0）校验。参考CHD805系列键盘操作说明书有关章节。 #### 信息交换的数据桢(命令数据包，或信息数据包) 协议数据包的基本格式: |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字段|起始符|版本|组内地址|类码与组地址|类别|参数长度校验|参数|桢校验|结束符| |字节数|1|1|1|1|1|2|N字节|2|1| |符号|SOI|VER|ADR|CID1|CID2/RTN|L.TH|INFO|CHK-SUM|EOI| - **SOI**：发送信息起始符 =7EH（START OF INFORMATION） - **EOI**：发送信息结束符 =0DH（END OF INFORMATION） - **VER**：通信协议的版本（=10H，表示1.0） - **ADR**：被定名设备（CHD805A/B）的RS485网上地址（设备ID）（有效值：1-254）。 - **CID2/RTN**：当主控制机（HOST或SU）发送命令时为CID2，实际上是命令的分类码，区分不同类的设备；当控制器（CHD805A/B等）向SU回答时为RTN，反应对命令的处理结果。 - **L．TH**：为携带参数的长度标识部分（计算见后） - **INFO**：传递的信息部分（不同设备可以有不同的定义），SU对SM命令时为命令参数COMINFO，包括：命令分类，命令号，参数；SM对SU的回复时为返回数据DATAINFO：参数信息； - **CHK-SUM**：传送一桢信息的检查和，从VER开始到INFO最后字节结束，都参与计算。SUM是两字节，高位在前。 ### 1.2 数据传输与超时错 #### (1)传输的方法 SOI，EOI 是按单字节(HEX)直接发送，其它(从VER 至 SUM结束)都是将单字节(HEX)按高半4位(0-9,A-F)，低半4位(0-9,A-F)拆分开，按ASCII码发送，先高4位ASCII码，后低4位ASCII码。 #### SU 与SM之间的通信类型 - 设置SM的权限确认； - 设置SM参数命令； - 读取SM信息的命令。 #### SU 发送命令(设置SM工作参数，或读取SM信息)格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|CID2|L.TH|COMINFO|SUM|EOI| #### SM 对SU的设置命令的应答格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|无|2|1| |格式|SOI|VER|ADR|CID1|RTN|0,0|无|SUM|EOI| #### SM对SU读取命令的返回格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|RTN|L.TH|DATAINFO|SUM|EOI| #### 说明 - **SOI**：信息传输起始标志位 (1字节)，START OF INFORMATION，固定值=0X7E，发送时按一字节(7EH)发送。 - **VER**：通信协议版本号 (从 0X10开始)。 - **ADR**：设备地址描述 (1—254；0和255保留)。 - **CID1**：设备类型标识控制码，(对门控器高半字节=8)，兼作扩展ADR用，（设备多于254个时，其分组号在CID1的低半字节）。 - **CID2/RTN**：在SU 向SM发送命令时，该位为CID2，表明命令的不同内容，在 SM 向 SU 发应答时，该位为RTN ( 见下述 )； - **L.TH(LENGTH)**：命令帧中“数据信息部份”的字节长度表示（两字节）： |高字节|高字节|高字节|高字节|高字节|高字节|高字节|高字节|高字节|低字节|低字节|低字节|低字节|低字节|低字节|低字节|低字节|低字节| |---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---| |校验码LCHKSUM|校验码LCHKSUM|校验码LCHKSUM|校验码LCHKSUM|校验码LCHKSUM|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)|长度标示码LENID(表示INFO的传送中ASC码的字节数)| |D15|D14|D13|D12|D11|D11|D10|D9|D8|D8|D7|D6|D5|D4|D3|D2|D1|D0| 数据信息部份”的字节长度=L（即有L个字节数据为命令的参数），那么发送的ASCII码个数 LENID=2L，按4位（BIT）一组，即（D11，D10，D9，D8）（D7，D6，D5，D4）；（D3，D2，D1，D0）；仍按4位（BIT）相累加，结果模16后，对16取补（即4BIT求反加1），作为LCHKSUM（D15，D14，D13，D12） 检验方法：从D15到D0按4BIT组成4个4位数，全部相加，结果得零。 - **INFO**：在SU 向SM发送命令时，为COMMAND INFO；在 SM 向 SU 发应答时，为DATA INFO。 - **SUM (CHECKSUM)**：数据桢的校验码：CHECKSUM 的计算是：整个数据桢中除SOI，EOI和SUM本身之外的其他字符，按发送的ASCII码累加求和（双字节和），将结果模65536后取补运算（余数取反加1）。高位在前，低位在后。 - **EOI**：结束码（固定为 0DH，发送是按 0DH 直接发送）。 #### (2) 超时错时间 500毫秒 ### 1.3 设备应答 设备SM 应答 或返回的 RTN 基本值: - RTN=00H：SM 正常执行 SU 发来的命令。 - RTN=01H：VER 不符，命令未执行。 - RTN=02H：SM接收的命令帧，累加和检查不对。 - RTN=03H：SM接收的命令帧，参数部份的累加和检查不对。 - RTN=04H：无效的CID2 。 - RTN=05H：不能识别的命令格式。 - RTN=06H：SM接收的命令帧，数据信息部份有无效数据。 - RTN=07H：SU无设置SM（或访问SM的重要信息）之权限。 - RTN=E0H：SU 与SM 之间的密码确认不正确。 - RTN=E1H：SU对SM 内部密码的修改不成功。 - RTN=E2H：SM内部相应设置项存储空间已满。 - RTN=E3H：SU对SM内部参数的修改（或删除）不成功。 - RTN=E4H：SM内部相应设置项的存储空间已空。 - RTN=E5H：SM内部无相应信息项。 - RTN=E6H：SU重复设入SM相同ID的用户，SM保持原用户不变。 - RTN=E7H：SU重复设入相同卡号的RF卡，给不同的用户。 - RTN=E8H：SU重复设入完全相同的用户。 ## 二、通信命令的种类 SU 与SM之间的通信有以下二种： - 设置SM的参数命令； - 读取SM内部信息的命令。 ## 三、设置命令 SU通过对SM的访问权限认证后，就可以对SM的所有工作参数进行设定。 SU发送的命令桢: CID2=49H SU发送设置命令的COMMAND INFO部分如下： |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF1|0XE0至0XFB|参数若干字节| SM返回： RTN=0，表示设置成功；非零值表不成功。 ### 3.1 设置日期时间的命令 - **COMMAND TYPE**=0XE0 - **DATAF**=年（2），月，日，星期，时，分，秒，共8字节（BCD）；其中：年（2000---2099），2字节，月（1---12）；日（1---31），星期（1---7 ，=7代表星期日）。 SM返回： RTN=0，表示设置成功；非零值，表示不成功。 ### 3.2 设置准进时段 #### 3.2.1 将准进时段、管理时段设置成缺省值 - **COMMAND TYPE**=0XE1 - **DATAF**=1字节（=1） 设置工作日准进时段：00：00—23：59全天能进； 设置休息日准进时段：00：00—23：59全天能进； 设置星期一至星期日的所有准进时段表：00：00—23：59全天能进； 管理时段： - 门常开：无效； - 门常闭：无效； - 二次加密时段：无效； - 红外、门磁监控布防时段：无效； #### 3.2.2 置所有时段无效 - **COMMAND TYPE**=0XE1 - **DATAF**=1字节（=0） 设置工作日准进时段：无效； 设置休息日准进时段：无效； 设置星期一至星期日的所有准进时段表：无效； 管理时段： - 门常开：无效； - 门常闭：无效； - 二次加密时段：无效； - 红外、门磁监控布防时段：无效； #### 3.2.3 设置工作日的准进时段 - **COMMAND TYPE**=0XE1 - **DATAF**部分: |GROUP No.|16字节准进时段描述列表| |---|---| |1字节(1—4)|HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM| 其中：GROUP_No.( 有效值1---4，1字节)，表示该时段在系统内的编号。 表示：在工作日内4段从“起始时间”至 “结束时间”才准进。 门控器最多存放4张工作日准进列表（GROUP No.=1--4），每张列表表明工作日内的4个准进时段，每个准进时段用：“起始时间---结束时间”4字节BCD码表示在该时间段内准进。例如：00：00(02:00, 04:00(06:30, 08:00(20:00, 22:10(22:45。表示从0点至2点，4点至6点30分，8点至20点，22点10分至22点45分共4个时间段才准进，其它时间不准进。(上述表示HH:MM的数值均为BCD码，如22：45是0X22，0X45两字节 )。又如：07:00(08:00, 09:00(09:78, FF:00(13:15, 12:00(14:59，因 “FF”为无效时间值，“78”也为无效时间值，所以上述的第二，三段无效，准进时间为：7点至8点，12点至14点59分，其它时间不准进。 SM返回： RTN=0，表示设置成功；其它值：不成功。 #### 3.2.4 设置非工作日（节假日，或星期内休息日）的准进时段 - **COMMAND TYPE**=0XE2 - **DATAF**部分（共17字节）: 第1字节必须=1； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节=1|HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM| 其中： 时段描述（16字节）：共4组 “起始时间---结束时间” 列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) 表示：在非工作日内，从“起始时间”至 “结束时间”才准进。门控器最多存放1张 “非工作日准进” 列表。 SM返回： RTN=0，表示设置成功；其它值：不成功。 #### 3.2.5 设定星期准进时间段列表 - **COMMAND TYPE**=0XF1 - **DATAF**：26字节。 前1、2字节：表示第几张表的星期几，如9，6表示第9+1张表的星期六。SM内最多存储16张表，每张表有7天（星期一至星期日），每天有6个准进时段，每个时段占用4字节（表示“起始时间(结束时间”的BCD值）。 第一字节的有效值 0—15（=0X0F） 第二字节的有效值 1—7 从第三字节至26字节该设定日的6个准进列表，每个准进列表占4字节（BCD，表示“起始时间(结束时间”） HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) SM返回： RTN=0，表示设置成功；=其它值：不成功。 ### 3.3 用户(准进人员)管理 #### 3.3.1增加一个用户（至门控制器） - **COMMAND TYPE**=0XE3 - **DATAF**=新用户描述16字节） |卡片编号|用户编号ID|用户密码|有效期4字节|用户权限1字节| |---|---|---|---|---| |5字节（HEX）|4字节（BCD|2字节（BCD）|YYYY，MM，DD|VIP，时段码| 有效期（4字节）：年（2字节），月，日（BCD） 如：0X20，0X12，0X12，0X31，表直到2012年12月31日才过期。 用户权限（1字节）：D7---D0（D0为低位BIT） - D7，D6=0，0 ：一般用户（受星期准进时段限制） - =0，1 ：一般用户（受星期准进时段限制） - =1，0 ：一般用户（受工作日/休息日准进时段限制） - D7，D6=1，1 ：特权用户（不受任何准进时段限制），但受有效期等限制。    （1）当D7，D6=1，0时， D4，D3，D2 ：保留    D1，D0：一般用户的工作日的准进时段GROUP.No；    0，0 对应第一张表    0，1 对应第二张表    1，0 对应第三张表    1，1 对应第四张表    D5=1，此用户为黑名单禁止一切开门，D5=0正常用户    （2）当D7，D6=0，0或0，1时， D4：保留    D3，D2，D1，D0：该用户适用的星期列表的第几张(索引系统的准进列表)。    D5=1，此用户为黑名单禁止一切开门，D5=0正常用户 SM返回： RTN=0，表示设置成功；=0XE2表SM内已满； RTN=E7H，卡号重复；=E6H用户ID号重复；=E8H用户信息项全部重复设置 其它值：不成功。 #### 3.3.2更新原用户某些信息 （1） - **COMMAND TYPE**=0XE3 - **DATAF**=16字节：5字节卡号 + 4字节用户号 + 7字节更新信息 |用户标识信息（卡号+ID编号）|用户标识信息（卡号+ID编号）|更新如下信息|更新如下信息|更新如下信息| |---|---|---|---|---| |卡片编号|用户编号ID|用户密码|有效期4字节|用户权限1字节| |5字节（HEX）|4字节（BCD|2字节（BCD）|YYYY，MM，DD|VIP，时段码| 原来的CHD806AT不满足以下操作跟新： （2） - **COMMAND TYPE**=0XE3 - **DATAF**=12字节：5字节卡号 + 7字节用户信息项 |标识|标识|更新如下信息|更新如下信息| |---|---|---|---| |卡片编号|用户密码|有效期4字节|用户权限| |5字节（HEX）|2字节（BCD）|YYYY，MM，DD|VIP，时端码| （3） - **COMMAND TYPE**=0XE3 - **DATAF**=6字节：5字节卡号 + 1字节（用户权限） |卡片编号|新的“用户权限”1字节| |---|---| |5字节（HEX）|VIP，时端码| （4） - **COMMAND TYPE**=0XE3 - **DATAF**=7字节：5字节卡号 + 2字节（用户密码） |卡片编号|新的“用户密码”2字节| |---|---| |5字节（HEX）|用户个人密码| （5） - **COMMAND TYPE**=0XE3 - **DATAF**=9字节：5字节卡号 + 4字节（用户有效期） |卡片编号|新的“用户有效期”4字节| |---|---| |5字节（HEX）|用户有效期：YYYY：MM：DD| 有效期（4字节）：年（2字节），月，日（BCD） 如：0X20，0X12，0X12，0X31，表直到2012年12月31日才过期。 SM返回： RTN=0，表示设置成功； 其他值，表示不成功。 不支持用户密码2个字节0000填充； #### 3.3.3删除用户卡（从门控制器内） - **COMMAND TYPE**=0XE4 - **DATAF**=6字节，如下： |1字节指引|某用户的5字节卡片编号| |---|---| |=0|5字节卡片编号，删除一个用户（以卡片编号检索）| 功能：将该卡号的用户从控制器内删除。 SM返回： RTN=0，表示删除成功；=0XE5表SM内没有该用户；=0XE4，全空； RTN=0XE3，或其它值：不成功。 #### 3.3.4删除用户编号（ID）（从门控制器内） - **COMMAND TYPE**=0XE4 - **DATAF**=6字节，如下： |1字节指引|1字节0 + 4字节用户编号（ID）| |---|---| |=1|00+4字节用户ID ，删除一个用户（以用户ID检索）| 功能：将该ID编号的用户从控制器内删除。 SM返回： RTN=0，表示删除成功；=0XE5表SM内没有该用户；=0XE4，全空； RTN=0XE3，或其它值：不成功。 #### 3.3.5全部删除用户（从门控制器内） - **COMMAND TYPE**=0XE4 - **DATAF**=6字节，如下： |1字节指引|5字节卡片编号，或00+4字节用户ID| |---|---| |=2|5字节全为00 ，删除全部用户| SM返回： RTN=0，表示删除成功；=0XE5表SM内没有该用户；=0XE4，全空； RTN=0XE3，或其它值：不成功。 ### 3.4设定门的特性参数 #### 3.4.1 门锁继电器执行时间(单独设定) - **COMMAND TYPE**=0XE6 - **DATAF**：1字节，（1--255），单位：0.1 秒。 例如：DATAF=50（十进制），表对门锁继电器加电5秒钟。 - **COMMAND TYPE**=0XE5 - **DATAF**：5字节或6字节时的第二字节。 #### 3.4.2 开门后等待进入的延时时间(单独设定) - **COMMAND TYPE**=0XE7 - **DATAF**：1字节，（有效值20--255），单位：0.1 秒。 例如：DATAF=50（十进制），表门锁打开后5秒钟内应开门进入，然后关门；未开门进入，视门电磁锁的特性，若必须由机械 “开门--关门”动作，才能重新锁上，则报警，要求“开门--关门”。 保证门准确锁上。 - **COMMAND TYPE**=0XE5 - **DATAF**：5字节或6字节时的第三字节。 #### 3.4.3 门磁感应器的特性（单独设定） 门磁感应器的输出特性状态； 电控锁的输出特性； - **COMMAND TYPE**=0XE5 - **DATAF**=1字节， - D7---D0（D0为低位BIT） - 第一控制字的每一BIT位都有其特定的意义: |BIT位|控制|说明| |---|---|---| |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 <br/>(1)非正常开门；<br/>(2)不能自动关门的锁，刷卡后无开门后--再关门的机械动作；<br/>(3)开门延时结束后，还未关门；| |D6|=0|保留| ||=1|保留| |D5|=0|电磁锁在断电后（或加电后）能自动锁上；| ||=1|必须靠“开门——再关门”机械动作的弹力才能锁上;| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门. =1，禁止.| |D3|=0|设定门磁输出电平为:<br/>开门时门磁两信号线是短路（通）；门关上后，两信号线开路（不通）| ||=1|设定门磁输出电平为:<br/>开门时门磁两信号线是断路（开）；门关上后，两信号线短路合上（通）| |D2|=0|保留| ||=1|保留| |D1|=0|保留| ||=1|保留| |D0|=0|保留| ||=1|保留| #### 3.4.4联动及报警输出特性 - **COMMAND TYPE**=0XFC - **DATAF**：1字节 控制器的工作方式第二控制字为1字节(初始值=0)。它要经过如下计算得到：一字节数（D7—D0）（D0低位），如下定义： |BIT位|控制|说明| |---|---|---| |D7|=0|联动输入CPLD1的有效电平| ||=1|| |D6|=0|联动输入CPLD2的有效电平| ||=1|| |D5||“联动CPLD1，CPLD2”输入，控制器响应的规定动作:| |D4||| |D3|=0/1|ALARM输出在报警时是“导通”=0； “开路”=1| |D2|=1|在刷卡时主动将接受到的维根数据信号发给RS485的连接电脑; =0禁止| |D1|=1|“紧急事件”输入MDIN与GND闭合时，闭门， 任何卡不响应;| ||=0|“紧急事件”输入MDIN与GND闭合时，常开门;| |D0|=0|个人输入ID号+密码开门被禁止；| ||=1|允许个人输入ID号+密码开门；| #### 3.4.5 整体设定(1) 一次设定两个参数： 门磁、红外等感应器的特性（见3.4.3节） 联动及报警输出特性(见3.4.4节) - **COMMAND TYPE**=0XE5 - **DATAF**=2字节时 - 第1字节为: 门磁、红外等感应器的特性（见3.4.3节） - 第2字节为: 联动及报警输出特性(见3.4.4节) SM返回：RTN=0，表示成功； 其它值：不成功。 #### 3.4.6 整体设定(2) 一次设定五个参数： 门磁感应器的特性（见3.4.3节） 门锁继电器执行时间(见3.4.1节) 开门后等待进入的延时时间(见3.4.2节) - **COMMAND TYPE**=0XE5 - **DATAF**=5个字节时 - 第1字节----第5字节依次为: （1）--（5）的内容。 SM返回：RTN=0，表示成功； 其它值：不成功。 #### 3.4.7整体设定(3) 一次设定六个参数： 门磁感应器的特性（见3.4.3节） 门锁继电器执行时间(见3.4.1节) 开门后等待进入的延时时间(见3.4.2节) - **COMMAND TYPE**=0XE5 - **DATAF**=6个字节时 - 第1字节----第6字节依次为: （1）--（6）的内容。 SM返回：RTN=0，表示成功； 其它值：不成功。 #### 3.4.8设定门开关感应器在开门状态时的有效电平（输出给门控器） - **COMMAND TYPE**=0XF7 - **DATAF**：1字节， - =0: 表示低电平有效（或继电器输出时，为吸合）； - =1: 表示高电平（或继电器输出时，继电器断开为有效） SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 3.4.9设定门控电磁锁的（种类）特性 - **COMMAND TYPE**=0XF9 - **DATAF**：1字节， - =0: 断电或加电，能自动锁上----一般电控阴锁口； - =1: 不能自动锁上，必须由“开门再关门”的机械动作才能锁上----一般电脉冲锁。 SM返回：RTN=0，表示设置成功；=其它值：不成功 ### 3.5设定门控器工作方式 #### 3.5.1红外监控的布防与撤防 - **COMMAND TYPE**=0XFA - **DATAF**：1字节， - =0: 关闭监视； - =1: 打开监视。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 3.5.2门开关状态监控的布防与撤防 - **COMMAND TYPE**=0XFB - **DATAF**：1字节， - =0 关闭监视（门开关状态）； - =1 监视（门开关状态）。 SM返回：RTN=0，表示设置成功；=其它值：不成功 #### 3.5.3布防与撤防（第一控制字） - **COMMAND TYPE**=0XE5 - **DATAF**=1字节时，D7---D0（D0为低位BIT） - 第一控制字的每一BIT位都有其特定的意义: |BIT位|控制|说明| |---|---|---| |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 <br/>(1)非正常开门；<br/>(2)不能自动关门的锁，刷卡后无开门后--再关门的机械动作；<br/>(3)开门延时结束后，还未关门；| |D6|=0|| ||=1|| |D5|=0|| ||| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门. | |D3|=0|设定门磁输出电平为:<br/>开门时门磁两信号线是短路（通）；门关上后，两信号线开路（不通）| ||=1|设定门磁输出电平为:<br/>开门时门磁两信号线是断路（开）；门关上后，两信号线短路合上（通）| |D2|=0|| ||=1|| |D1|=0|刷卡合法，就能开门，无须再个人密码确认；| ||| |D0|=0|| ||| ### 3.6节假日管理 #### 3.6.1设定星期内的休息日 - **COMMAND TYPE**=0XEA - **DATAF**：2字节（1--7），代表星期内休息哪两天。 1--6，星期一 至 星期六，7，星期日。其它值，表示不休息，如：7，0XFF，表示仅星期日(=7)休息。 SM返回： RTN=0，表示成功； 其它值：不成功。 #### 3.6.2设定国家法定节假日（不包括星期内休息日） - **COMMAND TYPE**=0XEB - **DATAF**：2字节：MM，DD （月，日）BCD表示。 - 注： SM内最多存放40个节假日。 SM返回： RTN=0，表示成功；=0XE2表SM内已满40组；其它值：不成功。 #### 3.6.3删除一组节假日 - **COMMAND TYPE**=0XEC - **DATAF**：2字节：MM，DD （月，日）BCD表示。 如 DATAF 2字节全00，表全部删除。 SM返回：RTN=0，表示删除成功；=0XE5表SM内没有该组； RTN=0XE4，节假日列表已经全空； 其它值：不成功。 #### 3.6.4清空节假日列表(全部删除) - **COMMAND TYPE**=0XEC - **DATAF**：2字节：全部为00，表全部删除。 SM返回：RTN=0，表示删除成功；RTN=0XE4，节假日列表已经全空； 其它值：不成功。 ### 3.7 记录区的管理 控制器内历史记录的存储示意: (1) 记录未满: BOTTOM             LOADP               SAVEP                MAXLEN 未读 已读 SU 只能读取 “底”BOTTOM（=0）至 “顶”TOP（=SAVEP—1）的区段之有效记录。BOTTOM位置为最早(旧)的记录， “顶” TOP位置为最新的记录。TOP+1(=SAVEP) 至MAXLEN—1区间都是空白区。 TOP的值等于MAXLEN SU能读取整个记录区的记录，记录最早（旧）至最新存放位置： SAVEP ( MAXLEN ( BOTTOM ( SAVEP — 1 SAVEP—1位置为最新记录，而SAVEP位置为最早(旧)记录。 柜桶最大深度MAXLEN：表示SM存储历史记录的最大空间（条数）； 当该空间存储满后，SM将自动覆盖最早的记录（MF的D7=1），存储最新的记录，保留的最新记录MAXLEN条。SM的“覆盖”操作若改动“最后读取指针 LOADP” ，则MF的D0=1 如下计算有效记录数： （1）当MF的D7=0，有效记录数N=SAVEP—BOTTOM LOADP的有效范围：BOTTOM至SAVEP—1 （2）当MF的D7=1，有效记录数 N=MAXLEN LOADP的有效范围：BOTTOM至MAXLEN—1，注意：最早（旧）记录在SAVEP位置，而最新记录在SAVEP—1位置。 如 MF的D0=0 SM内LOADP处的历史记录与SU已读取的记录，是联贯的； 如 MF的D0=1 SM内LOADP处的历史记录与SU已读取的记录，是不联贯的， 部分最早记录在SM中被覆盖。 #### 3.7.1初驶化记录区(清空记录) - **COMMAND TYPE**=0XF0 - **DATAF**：5字节全部为0 SM返回：RTN=0，表示成功； 其它值：不成功。 ### 3.8 远程开关门 #### 3.8.1 单一放行(不带系统操作员信息) - **COMMAND TYPE**=0XED - **DATAF**：1字节时， =1 开门； =0 不操作； SM返回：RTN=0，表示开门成功；其它值：不成功。 #### 3.8.2单一放行(带系统操作员信息) - **COMMAND TYPE**=0XED - **DATAF**=6字节 |第1字节|后5字节| |---|---| |=1开门<br/>=0不操作|操作员编号信息<br/>存放在远程开门记录结构中的前5字节| SM返回：RTN=0，表示开门成功； 其它值：不成功。 ### 3.10布防与撤防 #### 3.10.1门开关状态监控的布防与撤防 - **COMMAND TYPE**=0XFB - **DATAF**：1字节， - =0 关闭监视（门开关状态）；=1 监视（门开关状态）。 SM返回：RTN=0，表示设置成功；=其它值：不成功 ## 四、读取信息命令 SU 随时都可以对SM的历史记录，监控状态等进行读取。 SU发送的命令桢: CID2=4AH SU发送读取命令的COMMAND INFO部分如下： |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF2|0XE0至0XEF|1字节（读取记录命令时，2字节）| ### 4.1读取SM的实时钟 - **COMMAND TYPE**=0XE0 - **DATAF** (1字节) =0 SM 返回： DATAINFO：年（2），月，日，星期，时，分，秒，共8字节BCD。 其中： 年（2字节）：2000---2099  ### 4.2读取记录信息 #### 4.2.2顺序读取一条历史记录 - **COMMAND TYPE**=0XE2 - **DATAF**：无 或 1字节（无定义） SM从LOADP位置读取一条记录返给SU， SM自动将LOADP指向下一条记录。 SM 返回：DATAINFO为 DATAF 位置的一条记录（14字节），参见附录1。 ### 4.3读取时段 #### 4.3.1读取一组工作日准进时段 - **COMMAND TYPE**=0XE3 - **DATAF**（1字节）（1--4）表读哪一组（每组16字节，见上述） SM 返回： DATAINFO 共16字节（BCD）如下： 时段描述（16字节）：起始时间---结束时间列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) #### 4.3.2读取非工作日准进时段 - **COMMAND TYPE**=0XE4 - **DATAF**（1字节）（=1 ） SM 返回：DATAINFO 共16字节（BCD），为“非工作日准进时段”。如下： 时段描述（16字节）：起始时间---结束时间列表： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) #### 4.3.3读取星期一至星期日的准进时间表 - **COMMAND TYPE**=0XEB - **DATAF**：2字节，第一字节：指定读取第几张表（有效值0-15表示第一至 第16张表； 第二字节该表内星期几(1-7，=7表示星期日) 每张准进列表罗列7天（星期一至星期日），而每天共有6个 “起始时间(结束时间” 的准进时段罗列，每个准进罗列用4字节表示。每张表共用： 7 X 6 X 4=168字节。每次只能读取某张表的某一天之准进时间段的列表(24字节) SM 返回：DATAINFO 24字节（BCD）（准进时间段列表） 起始时间-------- 结束时间： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) ### 4.4读取用户信息 #### 4.4.1读取已存储的用户数目 - **COMMAND TYPE**=0XE5 - **DATAF**（1字节）=0 SM 返回： DATAINFO （2字节HEX），表示数量，低8位在前，高8位在后； =0，0 表无用户。 #### 4.4.2读取指定存储位置的用户登记资料 这条命令在SU 通过权限确认后，才能得到正确返回值。 - **COMMAND TYPE**=0XE6 - **DATAF**（2字节HEX数）SM内用户列表中，读取指定存储位置的用户(低位在前，例如0X01，0X02表示第513个用户)。 SM 返回： RTN=0 DATAINFO： |卡编号|用户编号ID|用户密码|有效期4字节|用户权限| |---|---|---|---|---| |5字节（HEX）|4字节（BCD|2字节（BCD）|YYYY，MM，DD|VIP，GROUP| SM 返回：RTN=0XE0， 无权限读取用户资信，无DATAINFO项。 ### 4.5读取休息日、节假日 #### 4.5.1读取星期内休息日 - **COMMAND TYPE**=0XE9 - **DATAF**（1字节）=0 SM 返回：DATAINFO（2字节），每个字节有效值 1—7，=7表示星期日，非有效值，无意义。 #### 4.5.2读取节假日（星期内休息日除外） - **COMMAND TYPE**=0XEA - **DATAF**（1字节）=0 SM 返回： DATAINFO 第一字节：休息日的个数 N （天，每天由：月：日两字节BCD表示） 从第二字节开始列表N天休息日（两字节BCD 月：日），共2 X N 个字节。 ### 4.6远程监控 （1）第1种方法： - **COMMAND TYPE**=0XE7 - **DATAF**（1字节）=0 SM 返回： DATAINFO （2字节） 第一字节： SM的工作状态： D7=0 SM内实时钟IC正常； =1 不正常。 D6=0 SM内存储器正常；=1 不正常； D5 =0 SM的工作电源正常； =1 不正常，供电电压低而CPU被平凡复位。 D4 保留 ； D3=0 不监视红外； =1监视； D2=0 不监视门开关； =1监视； D1=0 门控电磁继电器关闭，=1加电驱动； D0=0 正常工作，=1处于报警状态； 第二字节： SM监控线路的状态： D7 紧急驱动输入 D6 联动输入2 D5 联动输入1 D4 联动输出继电器状态(=0，关闭 ;=1加电驱动) D3=0 门关闭，=1 开启； D2=0 ； D1=0 手动开门键松开，=1按下； D0=0 门控电磁继电器关闭，=1加电驱动； ### 4.7读取工作特性参数 #### 4.7.1读取控制信息 （1）第一种方法： - **COMMAND TYPE**=0XE8 - **DATAF**（1字节）=0 SM 返回：DATAINFO （5字节） 第一字节：门碰开关，红外状态控制字(D0低位) |BIT位|控制|说明| |---|---|---| |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 <br/>(1)非正常开门；<br/>(2)不能自动关门的锁，刷卡后无开门后--再关门的机械动作；<br/>(3)开门延时结束后，还未关门；| |D6|=0|| ||=1|| |D5|=0|电磁锁在断电后（或加电后）能自动锁上；| ||=1|必须靠“开门——再关门”机械动作的弹力才能锁上;| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门. =1，禁止.| |D3|=0|设定门磁输出电平为:<br/>开门时门磁两信号线是短路（通）；门关上后，两信号线开路（不通）| ||=1|设定门磁输出电平为:<br/>开门时门磁两信号线是断路（开）；门关上后，两信号线短路合上（通）| |D2|=0|| ||=1|| |D1|=0|| ||=1|| |D0|=0|| ||=1|| 第二字节：门锁继电器的执行时间（0.1秒为单位）； 第三字节：开门等待进入的延时时间（0.1秒为单位）； 第四字节：红外报警发生至确认的延时时间（0.1秒为单位）。 第五字节：感应卡的号码获取方法控制字； ### 4.8读取设备名称及版本号(待定) - **COMMAND TYPE**=0XEF - **DATAF**（1字节）=0 SM 返回：DATAINFO:18字节，为设备名称及版本: 设备名称与版本号之间用 “,”隔开。 CHD805AE VER3.01或CHD805D ，V5.1 ### 4.9通信命令中的参数说明 所有日期，时间都用BCD格式，例如：0X99，表示99年； 而99（十进制）不是99年。例如：0X10，表示10月，或10时等。 所有数值或地址参数，由SU命令带入SM，或SM返回SU，都是低8位数再前，高8位在后，以HEX（或BCD）形式表示，如：SAVEP，LOADP等指针， 有效用户数量等数值。 SU命令中CID1（1字节）参数是用以区分设备类别，如电源类，环境类设备等。在CHD805系列门控器中，CID1还作为扩展CHD805的ID号用，当一个系统中使用的CHD805数量多于254个，可将CHD805分组，组号从0---15，每组最多可以254个CHD805。 |CID1（1字节HEX）|CID1（1字节HEX）| |---|---| |高半字节|低半字节| |=8（固定，表示门禁类）|组号（0---15）| # 附录: 门控器(SM)的历史记录格式 门控器(SM)对如下事件的发生都有记录： - 刷卡开门 (记录卡号及开门时间， 门是否被开,)。 - 由KEYPAD 键入用户ID及个人密码开门。 - 红外报警开始，红外报警结束。 - 非正常开门， 关门。 - 刷卡或键入ID及个人密码开门 (电磁锁动作)， 但未开门进入。 - 开门进入， 在规定的延时内， 未关门。 - 手动开门。 - 远程（由SU）开门。 - 联动输入引起开门。 - SM内控制参数被修改， 红外监控被关闭， 或开启。 - SM掉电（ 开始时间 ( 结束时间 ） 。 每条记录用14字节表示： |事件来源（5字节）|日期，时间（7字节）|状态（1字节）|备注（1字节）| |---|---|---|---| |卡号或ID号等|年（2），月，日，时，分，秒|STATUS（D7--D0）|REMARK| 备注（1字节）（D7-D0 ，其中D0 最低位）的D7=0 表示该条历史记录从未被SU读取过；D7=1表示该条历史记录已被SU读取过。 1. REMARK=0 刷卡开门记录 “事件来源” = 5字节卡号 STATUS : D7=0 未确认用户个人密码， =1 确认； D6=0 原来门处于关状态， =1 开状态； D5=0 在规定时间内开门进入， =1 未开门进入； D4=0 在开门等待进入延时后，门已正常关闭， =1 仍然开的； D3=1 开门进入后，关闭红外监控， = 0 保持原状态； D2 保留 D1 =0，外接分体刷卡；=1 内置主体刷卡； D0=0，红外监视原来是关的； =1，是开的。 2. REMARK=1 键入用户ID及个人密码开门的记录 “事件来源” = 1字节00， + 4字节用户ID号 STATUS: D7=1 D6—D0 类似 “REMARK=0” 中描述。 3. REMARK=2 远程(由SU)开门记录 “事件来源” = 5字节全0 STATUS: 类似 “REMARK=0” 中描述（D1位=0）。 4. REMARK=3 手动开门记录 “事件来源” = 5字节全0 STATUS: 类似 “REMARK=0” 中描述（D1位=0）。 5. REMARK=4 联动开门记录（无） “事件来源” = 5字节全0 STATUS: 类似 “REMARK=0” 中描述。 6. REMARK=5 报警 (或报警取消) 记录 “事件来源” = 4字节全0 + 报警源 AS(1字节) AS=0 红外报警开始； AS=1 红外停止报警。 AS=2 非正常开门； AS=3 门被关闭（非正常状态的关门记录）。 AS=4 联动(I2 )有效； AS=5 联动(I2 ) 无效。 AS=6 SM内部存储器发生错误， SM自动进行了初始化操作。 AS=7 红外监测被关闭； AS=8 红外监测开启。 AS=9 门碰开关监测被关闭； AS=10 门碰开关监测开启。 AS=18 刷卡未开门进入。 AS=19 刷卡开门进入未关闭。 STATUS: 记录发生时的输入线状态: D0=0 联动 (I2)无效， =1有效； D1=0 手动按键松开， =1按下； D2=0 红外输入无效， =1 报警状态； D3=0 门处于关状态， =1 门处于开状态； D4—D7 保留。 当AS=18时，D5=1 未开门进入； 当AS=19时，D4=1 在开门等待进入延时后，仍然开的； 7. REMARK=6 SM掉电记录 “事件来源” = SM重新掉电的日期，时间：月，日，时，分，秒 STATUS： 重新上电时的输入线状态： D0=0 联动 (I2)无效， =1有效； D1=0 手动按键松开， =1按下； D2=0 红外输入无效， =1 报警状态； D3=0 门处于关状态， =1 门处于开状态； D4—D7 保留。 8. REMARK=7 内部控制参数被修改的记录 “事件来源” = 4字节全0 + 修改标记(1字节) 修改标记(1字节) D0 =1 修改了SM的密码； D1 =1 修改了门的特性控制参数； D2 =1 增加了新用户； D3 =1 删除了用户资料； D4 =1 修改了实时钟； D5 =1 修改了控制准进的时段设置； D6 =1 修改了节假日列表； D7 =1 修改了红外开启（关闭）的设置控制字。 9. REMARK=8 无效的用户卡刷卡记录。 “事件来源” = 5字节卡号 STATUS: 类似 “REMARK=5” 中描述。 10. REMARK=9 用户卡的有效期已过。 “事件来源” = 5字节卡号 STATUS: 类似 “REMARK=5” 中描述。 11. REMARK=10 当前时间该用户卡无进入权限。 “事件来源” = 5字节卡号 STATUS: 类似 “REMARK=5” 中描述。 12. REMARK=11 用户在个人密码确认时，三次全部不正确 。 “事件来源” = 5字节卡号 STATUS: 类似 “REMARK=5” 中描述。 13. REMARK=0X22 有效的消防联动输入开始时间记录 。 “事件来源” = 0，0，0，0，0 STATUS: 类似 “REMARK=5” 中描述。 14. REMARK=0X22 有效的消防联动输入结束时间记录。 “事件来源” = 0，0，0，0，1 STATUS: 类似 “REMARK=5” 中描述。 注意：以下返回的REMARK 值为新增，记录门被打开和关闭时最后一次开门操作命令（包括刷卡开门、用户ID开门、远程开门和手动开门等）的记录的备注值和事件来源，这两种记录类型只在开门等待延内的开门和关门才产生，超过延时只产生非法开门和关门的报警记录，请参看REMARK=5的记录类型。 15. REMARK=0X40 门被打开记录。 STATUS: 上次开门动作的REMARK。 “事件来源”= 上次开门动作的“事件来源” 16. REMARK=0X41 门被关闭记录。 STATUS: 上次关门动作的REMARK。 “事件来源”= 上次关门动作的“事件来源” # 版本修改记录 |版本号|修改日期|修改内容| |---|---|---| |V1.0|20230201|初始版本| |V2.0|20231103|增加黑名单|