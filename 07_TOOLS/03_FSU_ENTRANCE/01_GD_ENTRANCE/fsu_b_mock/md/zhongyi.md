# 中移智能门禁通讯协议解析
## 一、通信接口
| 参数 | 配置详情 |
|------|----------|
| 接口类型 | RS485 |
| 波特率 | 9600 |
| 起始位 | 1位 |
| 数据位 | 8位 |
| 停止位 | 1位 |
| 校验方式 | 无校验 |

## 二、协议格式
### 1. 基础结构
`68H(1字节) + 地址(1字节) + 长度(1字节) + 数据包(最大255字节) + 校验和(1字节) + 0DH(1字节)`

### 2. 字段说明
| 字段 | 详细说明 |
|------|----------|
| 包头 | 固定标识68H，标记协议帧起始 |
| 包尾 | 固定标识0DH，标记协议帧结束 |
| 地址 | 1字节，取值范围0-255，部分设备地址跳线仅支持部分地址空间 |
| 长度 | 1字节，明确数据包的字节数，最大支持255字节 |
| 数据包 | 核心数据载体，由1字节命令 + 若干字节参数/数据组成 |
| 校验和 | 1字节，为数据包所有字节的累加和，用于验证数据传输完整性 |

### 3. 格式示例
`68,01,02,83,00,83,0D`
- 68：包头
- 01：设备地址
- 02：数据包长度
- 83：命令字
- 00：命令参数
- 83：校验和（03+00=03）
- 0D：包尾

## 三、核心功能命令详解
### 3.1 上报组信息（命令字：81H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(81H) + 校验(81H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(09H) + 命令字(81H) + 组类型(8字节) + 校验 + 0DH`

#### 功能说明
上报设备8组（0-7）数据类型，每组占用1字节，明确设备支持的输入输出类型。

#### 组类型定义
| 类型标识 | 含义 |
|----------|------|
| 02H | AI（模拟输入） |
| 04H | DI（数字输入） |
| 06H | DO（数字输出） |
| FFH | 空（无对应功能） |

#### 门禁组配置
当前门禁固定定义为AI一组、DI一组、DO一组。

### 3.2 上报门禁运行数据（命令字：82H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(82H) + 校验(82H) + 0DH`

#### 响应格式
`68H + 地址 + 长度 + 命令字(82H) + 板识别字(1字节) + 数据 + 板识别字(1字节) + 数据 + … + 校验 + 0DH`

#### 功能说明
实时上报各个通道的运行数据，包括门状态、红外、按钮、门磁及门锁控制状态。

#### 关键字段解析
- **板识别字**：高4位为组号（0-7），低4位为组类型（AI=02H、DI=04H、DO=06H），示例：24H表示第3号组为DI类型。
- **数据格式（按组类型）**：
  | 组类型 | 数据长度 | 详细说明 |
  |--------|----------|----------|
  | AI | 16字节（带符号BCD码） | 0-6号通道对应门状态（00H=门关、01H=刷卡开门、02H=中心遥控开门、03H=门内开门、04H=非正常开门）；7号通道为未上报记录个数；低字节在前，示例：34,20对应物理值2034；通道数不足8个仍保留16字节，无效通道数据无意义 |
  | DI | 1字节 | 0-5号通道有效：0=1号红外告警、1=1号红外正常；1=2号红外告警、2=2号红外正常；2=1号出门按钮按下、3=2号出门按钮按下；4=1号门磁开、5=2号门磁开；仅红外状态供上位机使用，其余由控制器自主处理 |
  | DO | 1字节 | 0-1号通道有效，对应门锁控制：1=门锁打开、0=门锁合上，上位机无需干预 |

### 3.3 远程开门控制（命令字：83H）
#### 命令格式
`68H + 地址 + 长度(04H) + 命令字(83H) + 组号 + 通道号 + 动作类型 + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(04H) + 命令字(83H) + 组号 + 通道号 + 动作类型 + 校验 + 0DH`

#### 功能说明
远程控制指定门禁开启，支持精准控制单个门。

#### 参数要求
| 参数 | 取值范围/固定值 | 说明 |
|------|----------------|------|
| 组号 | 02H | 固定组号，对应门禁控制组 |
| 通道号 | 0-1 | 对应2个门，0为第一个门，1为第二个门 |
| 动作类型 | 01H | 仅支持开门操作 |

#### 限制条件
一次只能控制一个门开门，不可同时触发多个门开启指令。

### 3.4 查询时间（命令字：89H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(89H) + 校验(89H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(08H) + 命令字(89H) + 时间(7字节) + 校验 + 0DH`

#### 功能说明
查询门禁控制器的实时时间，控制器内置不掉电实时时钟，确保时间准确性。

#### 时间格式（16进制表示）
| 字段 | 范围 | 字节数 | 说明 |
|------|------|--------|------|
| 年 | 2000-9999 | 2字节 | 低字节在前 |
| 月 | 1-12 | 1字节 | - |
| 日 | 1-31 | 1字节 | - |
| 时 | 0-23 | 1字节 | - |
| 分 | 0-59 | 1字节 | - |
| 秒 | 0-59 | 1字节 | - |

### 3.5 设置时间（命令字：90H）
#### 命令格式
`68H + 地址 + 长度(08H) + 命令字(90H) + 时间(7字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(08H) + 命令字(90H) + 时间(7字节) + 校验 + 0DH`

#### 功能说明
配置门禁控制器的系统时间，时间格式与查询时间命令一致。

### 3.6 发长期卡（命令字：91H）
#### 命令格式
`68H + 地址 + 长度(05H) + 命令字(91H) + 卡号(4字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(91H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 功能说明
发放长期有效门禁卡，卡片未删除前持续有效，无有效期限制。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，采用Intel格式（低字节在前），不足32位高位补0 |
| 结果 | 0=发卡失败、1=发卡成功、2=该卡已存在 |

#### 说明
不可写卡由生产厂商保证唯一性，可写卡由发卡程序保证唯一性。

### 3.7 删除长期卡（命令字：92H）
#### 命令格式
`68H + 地址 + 长度(05H) + 命令字(92H) + 卡号(4字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(92H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 功能说明
删除指定的长期有效门禁卡。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 结果 | 0=删除失败、1=删除成功 |

### 3.8 发短期卡（命令字：93H）
#### 命令格式
`68H + 地址 + 长度(0DH) + 命令字(93H) + 卡号(4字节) + 有效期(8字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(93H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 功能说明
发放有有效期限制的门禁卡，仅在有效期内有效。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 有效期 | 16进制表示，低字节在前：开始年（2字节）、开始月（1字节）、开始日（1字节）、结束年（2字节）、结束月（1字节）、结束日（1字节） |
| 结果 | 0=发卡失败、1=发卡成功、2=该卡已存在（有效期已修改） |

### 3.9 删除短期卡（命令字：94H）
#### 命令格式
`68H + 地址 + 长度(05H) + 命令字(94H) + 卡号(4字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(94H) + 结果(1字节) + 卡号(4字节) + 校验 + 0DH`

#### 功能说明
删除指定的短期有效门禁卡。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 卡号 | 32位16进制数，Intel格式（低字节在前） |
| 结果 | 0=删除失败、1=删除成功 |

### 3.10 删除所有长期卡（命令字：95H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(95H) + 校验(95H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(95H) + 结果(1字节) + 保留(4字节) + 校验 + 0DH`

#### 功能说明
批量删除门禁内所有长期有效门禁卡。

#### 结果说明
0=删除失败、1=删除成功

### 3.11 删除所有短期卡（命令字：96H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(96H) + 校验(96H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(96H) + 结果(1字节) + 保留(4字节) + 校验 + 0DH`

#### 功能说明
批量删除门禁内所有短期有效门禁卡。

#### 结果说明
0=删除失败、1=删除成功

### 3.12 删除所有卡（命令字：97H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(97H) + 校验(97H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(97H) + 结果(1字节) + 保留(4字节) + 校验 + 0DH`

#### 功能说明
一次性删除门禁内所有长期卡和短期卡。

#### 结果说明
0=删除失败、1=删除成功

### 3.13 删除所有开门记录（命令字：98H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(98H) + 校验(98H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(06H) + 命令字(98H) + 结果(1字节) + 保留(4字节) + 校验 + 0DH`

#### 功能说明
删除门禁内存储的所有开门记录。

#### 结果说明
0=删除失败、1=删除成功

### 3.14 查询参数（命令字：A1H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(A1H) + 校验(A1H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(0BH) + 命令字(A1H) + 参数(10字节) + 校验 + 0DH`

#### 功能说明
查询门禁内部关键参数，包括记录数量、卡片数量等。

#### 参数格式（16进制表示，低字节在前）
| 序号 | 参数名称 | 范围 | 字节数 | 意义 |
|------|----------|------|--------|------|
| 1 | 最新记录位置 | 0-1499 | 2 | 当前最新开门记录的位置序号 |
| 2 | 当前有效记录 | 0-1500 | 2 | 当前有效的开门记录个数 |
| 3 | 未读记录数 | 0-1500 | 2 | 未上报的开门记录个数 |
| 4 | 长期卡数 | 0-1024 | 2 | 有效长期卡的个数 |
| 5 | 短期卡数 | 0-500 | 2 | 有效短期卡的个数 |

### 3.15 取长期卡（命令字：A2H）
#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A2H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(0BH) + 命令字(A2H) + 结果(1字节) + 卡序号(2字节) + 新序号(2字节) + 卡号(4字节) + 保留(1字节) + 校验 + 0DH`

#### 功能说明
按序号获取有效的长期卡信息，支持批量读取。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取卡的序号（0-1023） |
| 卡序号 | 当前读取卡的序号 |
| 新序号 | 下一个有效卡的序号（-1表示无后续卡） |
| 卡号 | 32位卡号 |
| 结果 | 0=取卡失败、1=取卡成功（无后续卡）、2=取卡成功（有后续卡） |

#### 说明
取卡采用First-Next方式，从指定序号开始获取首个有效卡及下一个有效卡序号。

### 3.16 取短期卡（命令字：A3H）
#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A3H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(13H) + 命令字(A3H) + 结果(1字节) + 卡序号(2字节) + 新序号(2字节) + 卡号(4字节) + 保留(1字节) + 有效期(8字节) + 校验 + 0DH`

#### 功能说明
按序号获取有效的短期卡信息，支持批量读取。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取卡的序号（0-499） |
| 卡序号 | 当前读取卡的序号 |
| 新序号 | 下一个有效卡的序号（-1表示无后续卡） |
| 卡号 | 32位卡号 |
| 有效期 | 同3.8节短期卡有效期格式 |
| 结果 | 0=取卡失败、1=取卡成功（无后续卡）、2=取卡成功（有后续卡） |

#### 说明
取卡采用First-Next方式，从指定序号开始获取首个有效卡及下一个有效卡序号。

### 3.17 取开门记录（命令字：A6H）
#### 命令格式
`68H + 地址 + 长度(03H) + 命令字(A6H) + 序号(2字节) + 校验 + 0DH`

#### 响应格式
`68H + 地址 + 长度(14H) + 命令字(A6H) + 结果(1字节) + 记录序号(2字节) + 新记录序号(2字节) + 卡号(4字节) + 记录原因(1字节) + 时间(7字节) + 门序号(1字节) + 保留(1字节) + 校验 + 0DH`

#### 功能说明
按序号获取有效的开门记录，支持批量读取历史记录。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 序号 | 欲获取记录的序号（0-1499） |
| 记录序号 | 当前读取记录的序号 |
| 新记录序号 | 下一个有效记录的序号（-1表示无后续记录） |
| 卡号 | 32位卡号（全0表示非刷卡开门） |
| 时间 | 记录发生时间（同3.4节时间格式） |
| 门序号 | 发生操作的门序号（0-1） |
| 结果 | 0=取记录失败、1=取记录成功（无后续记录）、2=取记录成功（有后续记录） |

#### 记录原因格式（1字节）
| 位结构 | 说明 |
|--------|------|
| 高3位 | 保留 |
| 第4位 | 门状态（0=门关、1=门开） |
| 低4位 | 记录状态（1=刷卡开门、2=中心遥控开门、3=门内按钮开门、4=非正常开门） |

#### 说明
取记录采用First-Next方式，从指定序号开始获取首个有效记录及下一个有效记录序号。

### 3.18 取新开门记录（命令字：A7H）
#### 命令格式
`68H + 地址 + 长度(01H) + 命令字(A7H) + 校验(A7H) + 0DH`

#### 响应格式
`68H + 地址 + 长度(14H) + 命令字(A7H) + 结果(1字节) + 记录序号(2字节) + 新记录序号(2字节) + 卡号(4字节) + 记录原因(1字节) + 时间(7字节) + 门序号(1字节) + 保留(1字节) + 校验 + 0DH`

#### 功能说明
获取未上报的新开门记录，支持按时间顺序读取。

#### 关键参数
| 参数 | 说明 |
|------|------|
| 记录序号 | 当前读取记录的序号 |
| 新记录序号 | 下一个有效记录的序号（-1表示无后续记录） |
| 卡号 | 32位卡号（全0表示非刷卡开门） |
| 记录原因 | 同3.17节记录原因格式 |
| 时间 | 记录发生时间（同3.4节时间格式） |
| 门序号 | 发生操作的门序号（0-1） |
| 结果 | 0=取记录失败、1=取记录成功（无后续记录）、2=取记录成功（有后续记录） |

#### 说明
取新记录采用先入先出方式，每次获取当前最早的一条未上报记录。
