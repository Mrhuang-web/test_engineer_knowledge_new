重点：综资的站点等情况信息，是根据动环的来定义进去的

​			power_device_id字段：为动环设备id 

![image-20250915163155484](../00_插图/image-20250915163155484.png)

# 前置参考【陕西】

```
说明：
	集团和陕西,仅仅是ip和端口不一样而已,服务和接口名是一致的

- 定时任务1：优先其他四个任务运行
	`curl -X GET "http://10.12.12.184:8486/v1/hiddenDanger/startOverdue1" -H "accept: */*"`
	每天读取不同设备的综资表，通过处理生成**超期服役设备详情表**，该数据只保留最新的（不是每天保留一份）；



- 定时任务2：
	`curl -X GET "http://10.12.12.184:8486/v1/hiddenDanger/startOverdue2" -H "accept: */*"`
	每天读取不同设备的综资表，通过处理生成**统计分析总表**，该数据每天存储



- 定时任务3：
	`curl -X GET "http://10.12.12.184:8486/v1/hiddenDanger/startOverdue3" -H "accept: */*"`
	每天读取不同设备的综资表，通过处理生成**设备类型统计分析报表**，该数据每天存储



- 定时任务4：
	`curl -X GET "http://10.12.12.184:8486/v1/hiddenDanger/startOverdue4" -H "accept: */*"` 
	每天读取不同设备的综资表，通过处理生成**厂家统计分析报表**，该数据每天存储



- 定时任务5：
	curl -X GET “http://10.12.12.184:8486/v1/hiddenDanger/startOverdue5“ -H “accept: */*“
	每天读取不同设备的综资表，通过处理生成**地市统计分析报表**，该数据每天存储
```

## 数据表

```
集团也是对应的表

overdue_device_detail 超期服役-设备详情表’;
	有sys_device_id才会显示【这个是综资的设备id,需要用这个id结合触发curl,来实现与动环的关联】	
overdue_count_total 超期服役-统计分析总表’;
overdue_count_device 超期服役-设备类型统计分析报表’;
overdue_count_manufactor 超期服役-厂家统计分析报表’;
overdue_count_city 超期服役-地市统计分析报表’;
overdue_device_alert_monthly 超期服役-设备月度告警频次表’;
overdue_device_type_dict 超期服役-配置字典表； — 20231108 逻辑从代码迁移到数据库表配置完成
```









# 集团

## 简介

```
综资是一个有完整页面、服务器和数据库的独立核心系统
	在测试环境，它可能是一个简化版或Mock服务，必须确保其数据模型和接口契约与生产环境一致

本次测试策略
	需要从“只测试界面功能”上升到“**测试系统集成和数据流**”的层面。
	需要和开发或项目经理确认测试环境中综资的形态，并据此设计包括**数据同步、异常处理、关联逻辑**在内的更深度的测试用例
	这样才能保证上线后与真实综资系统对接万无一失。

本次需求修改点：
	只对蓄电池
	空调设备类型的修正
	
主要逻辑：
	1、首先取es对应设备索引，然后设备里面有对应站点、机房等信息【需要匹配对应索引表】
		目前的话：主要是拿dh_id或是dh_name,然后跟gz_name啥的组合
	2、然后把对应的站点机房名称即可显示出来【页面展示】
	3、又通过映射表，把es的综资数据与动环的站点机房啥的关联上【内部数据库关系】
	4、再通过对应的power_device_id,把综资和动环的设备关联起来
	5、这样子触发动环告警,就会进行统计,统计为动环设备【即目前关联的综资】后的告警
		其实就相当于动环的是动态的告警统计,综资的是静态的设备信息,两者结合
			就即知道动态情况,和原始设备情况
			统计告警是根据es,alert告警索引来判断的
```

## 数据表

```
1、综资同步信息表：ansy啥的_主要看模型对应的综资的es索引,对应索引里面就存放了对应模型的数据[模型指的就是设备]
2、其余的表跟陕西的差不多，只是多了一个存储站点类型维度的
```

![image-20250925104722321](../00_插图/image-20250925104722321.png)

## 前置说明

```
数据关联：
	涉及到综资数据【综资同步到es中,目前测试环境中es数据很多脏数据,即综资动环设备id（sys_device_id）是空的,导致无法和动环的关联】
	只有把综资设备id和动环设备id,再对动环id设备进行历史告警写入,才能进行统计
	如果需要有效数据,需要找雨涵到现网捞es综资数据,然后本地进行导入到es中

服务
	hidden服务（后端明林，前端贵荣）
	
4、告警创建
	主要是通过综资的power_device_id  -- >  然后动环的power_device_id字段，关联上综资里面的
```

```
页面数据：
	左侧树结构，目前都是动环的
	查询条件展示的也是动环的
	
	右侧内容
		更新周期：每天或是触发器，让拿到es数据，然后把数据与mysql的周期字典匹配，然后统计后到详情表
		在网时长：是通过综资时间和当前时间的差进行的
		超期服役：通过计算出来的在网时长/周期
		
		其余的都是取纵资表
			然后主要逻辑【可能有问题】：
				1、首先取es对应设备索引，然后设备里面有对应站点、机房等信息【需要匹配对应索引表】
					目前的话：主要是拿dh_id或是dh_name,然后跟gz_name啥的组合
				2、然后把对应的站点机房名称即可显示出来【页面展示】
				3、又通过映射表，把es的综资数据与动环的站点机房啥的关联上【内部数据库关系】  --【好像就是单纯的综资站点】
				4、再通过对应的power_device_id,把综资和动环的设备关联起来	-	【只要关联到动环设备id即可，站点类型不对也行？】
				5、这样子触发动环告警,就会进行统计,统计为动环设备【即目前关联的综资】后的告警
					其实就相当于动环的是动态的告警统计,综资的是静态的设备信息,两者结合
						就即知道动态情况,和原始设备情况
					统计好像是dwd还是啥来着【alert告警索引？】
	补充
		树结构是动环里面的
		筛选条件也是动环里面的
        右侧数据展示
            更新周期：获取es综资后，对数据的设备类型子类，与数据表-周期关联表进行匹配
            在网时间：然后在网运行时长，就结合综资字段值和当前一天时间计算
            超期服役状态：就是通过在网时间 / mysql对应表映射的周期数据
            告警频次：
            	则是通过动环设备的power_device_id，关联上综资对应power_device_id，来实现关联
            	然后使用模拟器在动环里面造数即可，然后触发就会去拿告警索引月统计的
		其他内容：
			全是综资的数据，只需要查看对应es里面的数据即可【有对应的表映射】

        筛选条件
            由于综资有些地市或是站点机房的信息是数字，因此又要涉及到数据表的对应
```



![image-20250925151710143](../00_插图/image-20250925151710143.png)

## 数据准备

```
索引是ods_zz的

注意：
	需要连接的es数据表【10.1.203.38:9200】


综资-原始数据   [接口字段与es表字段一致]

空间表
	站点报表：（es）ods_zz_area_site_202508
	柳州柳江县恒创通讯器材经营部:2017-5
	
	机房报表：（es）ods_zz_area_room_202508

动环属性表
	站点动环属性表：ods_zz_site_property_2025
	机房动环属性表：ods_zz_room_property_2025
	变压器设备报表：ods_zz_device_pe_transform_2025
	变换设备：
	开关电源：ods_zz_device_pe_switch_power_2025
	智能电表：ods_zz_device_pe_smart_mete_2025
	动环监控：ods_zz_device_pe_power_monitor_2025
	发电机组：ods_zz_device_pe_power_generation_2025
	低压直流配电：ods_zz_device_pe_low_dc_distribution_2025
	低压交流配电：ods_zz_device_pe_low_ac_distribution_2025
	高压直流电源：ods_zz_device_pe_high_power_2025
	高压配电设备：ods_zz_device_pe_high_distribution_2025
	高压直流配电：ods_zz_device_pe_high_dc_distribution_2025
	节能设备：ods_zz_device_pe_energy_save_2025
	ods_zz_device_pe_battery_li_202508
	蓄电池：ods_zz_device_pe_battery_202508
	空调：ods_zz_device_pe_air_202508
	其他：ods_zz_device_pe_other
	
	
动环(站点、机房)属性表
	ods开头 -- 映射关联表（即es索引与索引的映射）
	
	
定时器：
	是控制从历史里面统计到设备详情表
触发器：
	是实现设备表统计到统计表
	还有实现告警的
```

## 触发器和定时器

```
具体ip和端口,可以到nacos中查看服务列表的hidden服务

# 一次执行全部,但是会按顺序执行
curl --location --request GET 'http://localhost:28028/v1/hiddenDanger/startOverdueAll'


# 仅执行详情表
curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue1"



【下面分析汇总表，都是会有每天的日期的，具体存多少天的就不清楚了】
详情表 - 需要前面的同步完，执行后才有数据，不然执行后，当天的数据就是0
		例如：今天是28号，但是详情表是昨天数据，那么执行后，分析总表就没有对应数据

# 仅统计分析
curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue2"

# 仅设备
curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue3"

# 厂家
curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue4"

# 仅地市
curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue5"





2.定时任务默认配置
	${
		overdue.cron:0 0 4 * * ?
	}
	

3、告警触发
	curl --location --request GET 'http://localhost:28028/v1/hiddenDanger/startOverdueAlert?202508'
```

## 基本逻辑补充【基本要求】

```
数据同步一致性：
	设备详情表【来源综资 - 与综资es数据做比较 - 选一到两个区域即可】：
		注意：es综资同步过来的,需要机房映射表中有对应的动环id[dh_name]  -- 好像是综资里面的关系、只是说也可以关联到动环的
		
		不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
	
	设备生命周期【来源详情表 - 与详情表做比较 - 选一到两个区域即可】：
		注意：统计的都只是12种设备类型的四种服役类型、且注意[高压直流电源类型未加入 -- 后面优化好像加入了]
		
		统计分析：
			统计逻辑：超期服役包含 - >=150和<150[总数多加了一次>=150,总数的已修改,其余按原需求即可]
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		设备分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		厂家分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
		地市分析：
			不按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
			按站点类型：按省、市、区 - 数据的汇总,以及字段准确性
```

## 计算逻辑补充【重点】

```
在网计算
	当前时间前一天 - 即入网[使用]时间
	主要情况：超出当前时间，等于当前时间、小于当前时间

超期服役率：
	超期服役数/总设备
	主要情况：省市区、站点类型等情况下的统计情况正确率

故障统计：
    故障告警是通过
        动环设备里面的power_device_id字段，关联es即综资里面对应的power_device_id字段
        然后由动环的进行造告警【在告警索引里面去找】

故障率：
	故障设备数量/总设备数量
	主要情况：省市区、站点类型等情况下的统计情况正确率
```

```
告警造数逻辑
	1、同步es综资数据到数据库（overdue详情表） - 触发器1
	2、over里面sys_id，放到device的power_id里面
		【类型要一致，区域位置要一致，如果动环对应区域没有设备，那么直接到已有的站点里面，拿设备改下precinct_id】
	3、写入对应设备的alert历史告警【根据nacos - over配置里面来】
	4、再次触发同步
		【因为告警统计不是实时的，而且会在下一次统计时候巡检月度告警表然后进行统计】
		【但是每次触发会实时统计到月度告警表，用于下次同步详情表时检索】
	5、再次同步后，如果对应区域下【即前面绑定的那个的sys不见了】
		【那么就去month里面拿对应的device_id，放进去，再次执行详情表同步即可】
	
    
	以上的内容都要一一对应
		sys_id必须是由综资同步过来的，自己手动创建的是不行的，因为关联到综资设备是否能匹配到
		好像设备类型不需要对应?,目前造数中有一条是高压直流配电,但是动环中是高压直流电源配电
		同时注意,使用插入es告警历史时,需要注意的时所在区域下的设备在动环系统里面是有的,没有的话需要插入
			使用数据库表插入数据也行,或是直接更改已有的设备为该设备的precinct_id也可以
```

![image-20250926142935744](../00_插图/image-20250926142935744.png)

## 问题总结

```
汇总问题：
	超期服役这块：
		修改地市为区域
		
	2个tab的筛选条件
		需要加上高压直流电源
		
	统计问题【重点】：
		没有类型的不会统计进去【站点类型必须都是要不为空，因为加了站点类型分类】
		如果没有类型、没有关联到动环站点、站点类型、机房等的，也都不会统计进去
		举例：
			目前上海里面就存在没有关联到动环站点、站点类型、机房等的
				详情表会展示【可能会有问题】
				但是生命周期不会统计进去
		距离：
			宁夏的
				没有类型不会展示在详情里面和不会统计进去
	sql缺失：
		好像缺失了判断12种设备类型
		目前是只要over里面有的都统计了
		
	
现网验证时：
	一定要注意，要选对查询时间
	生命周期-统计分析-过滤省份没有设备的，不需要展示
	生命周期-地市统计-目前高压直流没有数据
```



## 附录【映射关系】

| ***\*设备类型\**** | ***\*设备子类\****                                           | ***\*更新周期\**** |
| ------------------ | ------------------------------------------------------------ | ------------------ |
| 变压器             | 全部                                                         | 15年               |
| 高压配电           | 全部                                                         | 15年               |
| 高压直流电源       | 全部                                                         | 10年               |
| 高压直流配电       | 全部                                                         | 15年               |
| 低压交流配电       | 全部                                                         | 15年               |
| 发电机组           | 全部                                                         | 15年               |
| 开关电源           | 全部                                                         | 12年               |
| 低压直流配电       | 全部                                                         | 15年               |
| UPS设备            | 全部                                                         | 10年               |
| 蓄电池             | 1.UPS铅酸电池                                                | 6年                |
|                    | 2.操作电源铅酸电池                                           | 8年                |
|                    | 3.发电机组铅酸电池                                           | 6年                |
|                    | 4.高压直流铅酸电池                                           | 8年                |
|                    | 5.开关电源锂电池                                             | 10年               |
|                    | 6.开关电源铅酸电池                                           | 8年                |
|                    | 7.直流屏铅酸电池                                             | 8年                |
| 空调               | 1.设备类型为普通空调时更新周期6年；                          | 6年                |
|                    | 2.设备类型为其他（机房专用空调、中央空调末端），设备子类为恒湿机、柜式空调 | 6年                |
|                    | 3.设备子类为风冷专用空调                                     | 8年                |
|                    | 4.设备类型为其他（机房专用空调、中央空调末端），设备子类为列间空调、嵌入式空调、热管背板、双冷源专用空调、水冷专用空调 | 10年               |
| 动环监控           | 1.设备子类为FSU、CSC、LSC                                    | 5年                |
|                    | 2.设备子类为蓄电池采集设备                                   | 8年                |





| 设备类型     | device_type     |      |      |
| ------------ | --------------- | ---- | ---- |
| 地市         | city_id         |      |      |
| 站点         | related_site    |      |      |
| 设备标识     | res_code        |      |      |
| 机房         | related_room    |      |      |
| 设备子类     | device_subclass |      |      |
| 设备名称     | zh_label        |      |      |
| 厂家         | vendor_id       |      |      |
| 型号         | product_name    |      |      |
| 开始使用时间 | start_time      |      |      |
| 入网时间     | start_time      |      |      |
|              |                 |      |      |

***\*超期服役设备详情表\****

| 字段           | 字段说明                                                     |      |      |
| -------------- | ------------------------------------------------------------ | ---- | ---- |
| 日期           | 根据综资表的日期                                             |      |      |
| 设备类型       | 综资device_type                                              |      |      |
| 地市           | 综资city_id                                                  |      |      |
| 站点           | 综资related_site                                             |      |      |
| 设备标识       | 综资res_code                                                 |      |      |
| 机房           | 综资related_room                                             |      |      |
| 设备子类       | 综资device_subclass                                          |      |      |
| 设备名称       | 综资zh_label                                                 |      |      |
| 厂家           | 综资vendor_id                                                |      |      |
| 型号           | 综资product_name                                             |      |      |
| 开始使用时间   | 综资start_time                                               |      |      |
| 入网时间       | start_time                                                   |      |      |
| 在网运行时长   | 计算，现在时间（默认前一天的时间）-start_time                |      |      |
| 更新周期       | 根据设备类型按以下表的更新周期填对应年                       |      |      |
| 服役年限分区段 | 更新周期的百分比可配，比如80%，现默认70%，比例可配，根据配置的计算（现在时间-start_time）/更新周期，本字段枚举，若更新周期<（现在时间-start_time），则为“超期服役”；若更新周期>（现在时间-start_time），且（现在时间-start_time）/更新周期<70%的更新周期，则为“<70%”；若更新周期>（现在时间-start_time），且（现在时间-start_time）/更新周期>70%的更新周期，则为“>70%在超期内”； |      |      |
| 动环系统设备ID | 综资power_device_id                                          |      |      |
| 故障告警频次   | 关联动环系统的device_id，默认计算该设备近一个自然月的告警次数，进行累加，如果没有一月的告警数据以从开始有的告警开始进行累加；其中告警统计周期可以进行设置，设置从几月到几月，比如2023年-1到2023年-3；最早只能选到当前时间（查询条件日期）的上月，因为当前月份数据不完整不能统计； |      |      |

