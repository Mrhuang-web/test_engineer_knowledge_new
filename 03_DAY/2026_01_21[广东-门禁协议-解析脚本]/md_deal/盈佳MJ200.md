# 盈佳MJ200门禁控制器协议详细文档

## 1. 协议概述
盈佳MJ200门禁控制器协议是MJ200V4.0门禁版本的通讯协议，用于SU或SS与SM之间的通信，支持获取、取消权限的命令，设置(遥控)参数的命令，以及读取参数、记录信息的命令。

## 2. 命令类别
| 序号 | 内容 | CID1 | CID2 | 备注 |
|------|------|------|------|------|
| 1 | 获取、取消权限的命令 | 8XH | 48H | |
| 2 | 设置(遥控)参数的命令 | 8XH | 49H | |
| 3 | 读取参数、记录信息的命令 | 8XH | 4AH | |

## 3. 通信协议数据包格式

### 3.1 SU或SS发给SM的命令信息
| 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |
|------|------|------|------|------|------|------|------|------|------|
| 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | LENID/2 | 2 | 4 |
| 格式 | SOI | VER | ADR | CID1 | CID2 | LENGTH | COMMAND INFO | CHKSUM | EOI |

#### 关键说明：
- **SOI**：帧起始同步单元，6字节：FA 55 FA 55 FA 55
- **EOI**：帧结束单元，4字节：FD 22 FD 22
- **VER**：协议版本号，出厂默认可设为0X00
- **CHKSUM**：VER到COMMAND INFO的CRC16校验值
- **ADR**：门禁地址，出厂地址为0XFF
- **CID1、CID2**：参考命令类别表，CID1低4位"X"与ADR组成扩展地址码（X为高4位，共12位）
- **LENGTH**：COMMAND INFO的数据长度
- **COMMAND INFO**：包含子集码、命令号及命令信息，格式如下：
| 组成部分 | 子集码 COM GROUP | 命令号 TYPE | 命令信息 INFO |
|----------|------------------|-------------|---------------|
| 字节数 | 1字节 | 1字节 | N字节 |
| 说明 | 区分不同门禁产品的命令子集 | 子集中的命令编号 | 具体命令参数 |

### 3.2 SM发给SU的响应信息数据包
| 序号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |
|------|------|------|------|------|------|------|------|------|------|
| 字节数 | 6 | 1 | 1 | 1 | 1 | 2 | 2 | 4 | - |
| 格式 | SOI | VER | ADR | CID1 | RTN | LENGTH | DATA INFO | CHKSUM | EOI |

#### 关键说明：
- **RTN**：返回码，指示命令执行结果，具体含义如下：
| 序号 | RTN值(HEX) | 表示意义 | 备注 |
|------|------------|----------|------|
| 1 | 00H | 正常 | |
| 2 | 01H | VER错 | 协议版本不符 |
| 3 | 02H | CHKSUM错 | |
| 4 | 03H | ADR错 | |
| 5 | 04H | CID1错 | |
| 6 | 05H | CID2错 | |
| 7 | 06H | 接收数据LENGTH不匹配 | 指令数据长度异常 |
| 8 | 07H | 无效数据 | |
| 9 | 0E0H | 权限校验密码不符 | |
| 10 | 0E1H | 无访问权限 | |
| 11 | 0E2H | 更改密码不成功 | |
| 12 | 0E3H | 加卡空间已满 | |
| 13 | 0E4H | 历史记录栈全空 | |
| 14 | 0E5H | 修改工作参数不成功 | |
| 15 | 0E6H | 增加ID相同的用户 | 不接受设置 |
| 16 | 0E7H | 信息不存在或已无效 | |
| 17 | 0E8H | 设置的工作参数不合法 | |
| 18 | 0E9H | 历史记录栈满 | |
| 19 | 0EAH | 访问受限制卡 | |
| 20 | 0EBH | 该条历史记录未读取，确认错误 | |
| 21 | 0ECH | 节假日表满 | 更改之处 |
| 22 | 0EDH~EFH | 其他错误 | 用户自定义 |

## 4. 核心命令详情

### 4.1 获取、取消权限命令
SU需通过密码确认才能设置、修改SM工作参数或访问重要信息，密码由5字节组成。

### 4.2 设置(遥控)参数的命令
用于设置门禁设备的参数，如门状态、开门延时等。

### 4.3 读取参数、记录信息的命令
用于读取门禁设备的参数和记录信息，如运行状态、刷卡记录等。

## 5. 注意事项

1. 命令格式必须严格按照协议要求，包括帧起始同步单元、版本号、地址、分类码、长度、命令信息、校验值和帧结束单元
2. 校验值必须正确计算，否则会导致命令执行失败
3. 门禁地址必须在有效范围内，出厂地址为0XFF
4. 协议版本号必须匹配，否则会返回"VER错"错误
5. 命令子集和命令号必须正确设置，否则会导致命令执行失败
6. 返回码需要根据实际情况解析，以便了解命令执行结果

## 6. 典型应用流程

1. 初始化通信接口
2. 构建SU发送命令帧，包括帧起始同步单元、版本号、地址、分类码、长度、命令信息、校验值和帧结束单元
3. 发送命令帧到门禁设备
4. 接收门禁设备的应答帧
5. 解析应答帧，提取返回码和返回数据
6. 根据返回码执行相应的操作
7. 定期轮询门禁设备的状态，实现实时监控

## 7. 故障处理

1. 通信超时：检查通信线路、设备地址和通信参数
2. 命令执行失败：检查命令格式、校验值、版本号是否正确
3. 数据解析错误：检查返回数据的格式是否符合协议要求
4. 返回码异常：根据RTN值查找对应的错误原因

## 8. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令号实现
- 扩展后的协议必须保持向前兼容性

## 9. 开发建议

1. 建议使用通信库简化开发工作
2. 实现命令超时重发机制，提高通信可靠性
3. 定期检查设备的运行状态，及时发现故障
4. 实现数据缓存机制，防止数据丢失
5. 遵循协议规范，确保与设备的正常通信
6. 注意帧起始同步单元和帧结束单元的特殊处理
7. 正确计算和验证CRC16校验值，确保数据完整性