\# ES2200一体化门禁控制器（不锈钢防水）通信协议(RS485/RS422) V1.02（2007-1-18修订） 深圳市纽贝尔电子有限公司 2006-04-2（初稿） ## 目录 1. [通信规范](#一-通信规范) 2. [通信命令的种类](#二-通信命令的种类) 3. [访问权限的确认](#三-访问权限的确认) 4. [设置命令](#四-设置命令) 5. [读取信息命令](#五-读取信息命令) 6. [附录: 门控器(SM)的历史记录格式](#附录-门控器sm的历史记录格式) ## 概述 局站控制单元(SUPERVISION UNIT,以下简称 "上位机" 或 SU ),与门控器(SUPERVISION MODULE ,以下简称 "下位机" 或SM 即ES2200)之间的通信，采用"主---从"方式，主方（SU）发送设置命令或读取命令给从方（SM），从方（SM）将设置结果应答SU, 或将读取的信息返回给SU。 # 一. 通信规范 ## 1.1 通信速率与数据格式 ### 通信速率 1200bps,2400bps,4800bps,9600bps,或19200或38400 等，SM内应有改变速率的机制。 ### 数据格式 1起始位，8数据位，1停止位，校验方式位。校验方式有: 无校验;参考es2200系列操作说明书有关章节。 ### 协议数据包的基本格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字段|起始符|版本|组内地址|类码与组地址|类别|参数长度校验|参数|桢校验|结束符| |字节数|1|1|1|1|1|2|N字节|2|1| |符号|SOI|SEQ/VER|ADR|CID1|CID2/RTN|L.TH|INFO|CHK-SUM|EOI| #### 字段说明 - **SOI**：发送信息起始符 =7EH （START OF INFORMATION） - **EOI**：发送信息结束符 =0DH （END OF INFORMATION） - **SEQ/VER**：ES2200作为通信数据帧的表示序号;或通信协议的版本（=10H，表示1.0） - **ADR**：被定名设备（ES2000）的RS485/RS422网上地址（设备ID）（有效值：1-254） - **CID1**：一字节（D7—D0，D7高位），D7—D4为设备分类码（门禁控制类=8，即D7=1，D6=D5=D4=0）；D3—D0为设备分组号（0—15）。意义：当同一系统中设备数目多于254个时，将其分组，最多可以有16*254个设备在同一系统中。 - **CID2/RTN**：当主控制机（HOST或SU）发送命令时为CID2，当SM向SU回答时为RTN。实际上是标识通信数据帧的流向的代码，反应通信数据帧的流向。 - **L．TH**：为携带参数的长度标识部分（计算见后） - **INFO**：传递的信息部分（不同设备可以有不同的定义），SU对SM命令时为命令参数COMINFO（包括：命令分类，命令号，参数）；SM对SU的回复时为返回数据DATAINFO（参数信息） - **CHK-SUM**：传送一桢信息的检查和，从VER开始到INFO最后字节结束，都参与计算。SUM是两字节，高位在前。 ## 1.2 数据传输与超时错 ### (1)传输的方法 - SOI（=7EH ）, EOI（=0DH） 是按单字节(HEX)直接发送, 其它(从VER 至 SUM结束) 都是将单字节(HEX)按高半4位( 0-9,A-F) , 低半4位(0-9,A-F) 拆分开, 按ASCII码发送, 先高4位ASCII码,后低4位ASCII码。 - SU 与SM之间的通信类型：  - 设置SM的权限确认；  - 设置SM参数命令；  - 读取SM信息的命令。 #### SU 发送命令(设置SM工作参数, 或读取SM信息)格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|CID2|L.TH|COMINFO|SUM|EOI| #### SM 对SU的设置命令的应答格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|无|2|1| |格式|SOI|VER|ADR|CID1|RTN|0,0|无|SUM|EOI| #### SM对SU读取命令的返回格式 |序号|1|2|3|4|5|6|7|8|9| |---|---|---|---|---|---|---|---|---|---| |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|RTN|L.TH|DATAINFO|SUM|EOI| ### (2)计算说明 #### L.TH(LENGTH)计算 命令帧中“数据信息部份”的字节长度=L（即有L个字节数据为命令的参数），那么发送的ASCII码个数 LENID = 2L，按4位（BIT）一组，即（D11，D10，D9，D8）（D7，D6，D5，D4）；（D3，D2，D1，D0）；仍按4位（BIT）相累加，结果模16后，对16取补（即4BIT求反加1），作为LCHKSUM（D15，D14，D13，D12）。检验方法：从D15到D0按4BIT组成4个4位数，全部相加，结果得零。 |高字节（8位）|低字节（8位）| |---|---| |D15|D14|D13|D12|D11|D10|D9|D8|D7|D6|D5|D4|D3|D2|D1|D0| |校验码LCHKSUM|长度标示码LENID（表示INFO的传送中ASC码的字节数）| #### SUM (CHECKSUM)计算 CHECKSUM 的计算是：整个数据桢中除SOI、EOI和SUM本身之外的其他字符，按发送的ASCII码累加求和（双字节和），将结果模65536后取补运算（余数取反加1）。高位在前，低位在后。 ### (3) 超时错时间 500毫秒 ## 1.3 设备应答 ### 设备SM 应答或返回的 RTN 基本值 |RTN值|说明| |---|---| |00H|SM 正常执行 SU 发来的命令| |01H|VER 不符，命令未执行| |02H|SM接收的命令帧，累加和检查不对| |03H|SM接收的命令帧，参数部份的累加和检查不对| |04H|无效的CID2| |05H|不能识别的命令格式| |06H|SM接收的命令帧，数据信息部份有无效数据| |07H|SU无设置SM（或访问SM的重要信息）之权限（ES2200取消）| |E0H|SU 与SM 之间的密码确认不正确（ES2200取消）| |E1H|SU对SM 内部密码的修改不成功（ES2200取消）| |E2H|SM内部相应设置项存储空间已满| |E3H|SU对SM内部参数的修改（或删除）不成功| |E4H|SM内部相应设置项的存储空间已空| |E5H|SM内部无相应信息项| |E8H|SU重复设入完全相同的用户（ES2200取消）| # 二. 通信命令的种类 SU 与SM之间的通信有以下三种： 1. 访问SM的权限确认通信命令（ES2200取消）； 2. 设置SM的参数命令； 3. 读取SM内部信息的命令。 # 三. 访问权限的确认 SU 设置 SM 的重要信息，或控制SM动作开门,读取SM内部已授权用户的登记信息等操作之前, 必须通过SM的密码认证, 才能建立对SM的设置（操作）权限。 ## 3.1 访问权限确认（ES2200灵性锁，取消） - ES2200取消下列命令，但该命令如果送达ES2200时，ES2200返回“OK”； - SM的密码由两部分组成：系统密码2字节（每字节：0-255），以及SM设置密码3字节，共5字节组成。 ### SU发送的命令桢 - CID2=48H - COMMAND INFO: |COMMAND GROUP|COMMAND TYPE|DATA| |---|---|---| |0XF0|0XE0|5字节的SM密码| ### 应答说明 如果 DATA “5字节的SM密码” 与被访问的SM的内部密码相符, 则SM返回 ：RTN=0, 表示SU对SM 已通过了设定权限的确认。如果 DATA “5字节的SM密码” 与被访问的SM的内部密码不相符, 则SM返回 : RTN=0XE0, 表示SU未通过设定权限确认。 SU 对SM的设置权限被SM确认后，可以一直保持约1分钟，但是，当SM检测到SU主动取消设置权限时，或SU对SM的设置访问时间间隔超过1分钟，SM将自动取消SU的设置权限。SU只有重新进行“设置权限确认”，才能再次对SM进行设置（控制）操作。 ## 3.2 访问权限的取消（ES2200灵性锁，取消） - ES2200取消下列命令，但该命令如果送达ES2200时，ES2200返回“OK”； SU通过SM的密码校验后，SM才接受SU的设置，并且允许SU设置间隔约1分钟（SM每次正确接受SU的设置，主动提供1分钟延长许可），SU在超过1分钟的时间未设定SM，SM将主动关闭允许设置状态。 SU在对SM进行参数设置完成后，应关闭SM的允许设置状态，使SM不被非法设置。 ### SU发送的命令桢 - CID2=48H - COMMAND INFO: 无DATAF项。 |COMMAND GROUP|COMMAND TYPE| |---|---| |0XF0|0XE1| ### 应答说明 - RTN=0, 表示SM 已取消了SU的设定权限； - RTN 不为零, 表示SU对SM 的设定权限未被SM取消。 ## 3.3 修改SM的访问密码（ES2200灵性锁，取消） - ES2200取消下列命令，但该命令如果送达ES2200时，ES2200返回“OK”； SU 修改 SM 的访问密码之前, 必须通过“权限确认”。 ### SU发送的命令桢 - CID2=48H - COMMAND INFO: |COMMAND GROUP|COMMAND TYPE|DATAF（6字节）| |---|---|---| |0XF0|0XE2|5字节的SM新密码 + 校验码1字节| #### 字段说明 - “5字节的SM新密码”：每个字节0-255； - “校验码”：为 “5字节的SM新密码”的5字节逻辑异或值。 ### 应答说明 - RTN=0, 表示SU对SM 的密码修改成功； - RTN=0XE1, 表示SU对SM 的密码修改不成功。 # 四. 设置命令 SU通过对SM的访问权限认证后, 就可以对SM的所有工作参数进行设定。 SU发送的命令桢: CID2 = 49H SU发送设置命令的COMMAND INFO部分如下： |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF1|0XE0至0XFB|参数若干字节| ### 应答说明 RTN=0，表示设置成功；非零值表不成功。 ## 4.1 设置更改通信地址（ES2200灵性锁由开关设置，取消） - COMMAND TYPE=0XE0 - DATAF为3字节如下: |地址(组内码)|分组地址|校验码| |---|---|---| |1字节(1—254)|0--15|1字节(前2字节的异或码)| ### 应答说明 SM接受设置更改后将产生记录(REMARK=5,AS=91H),见附录1。 - RTN=0，表示设置成功；非零值, 表不成功。 ## 4.2 设置更改通信速率（ES2200灵性锁由开关设置，取消） - COMMAND TYPE=0XE0 - DATAF为2字节如下: |速率代码|同左| |---|---| |1字节|同左| #### 速率代码说明 |速率代码|通信速率| |---|---| |0|1200BPS| |1|2400BPS| |2|4800BPS| |3|9600BPS| |4|19200BPS| |5|38400BPS| ### 应答说明 SM接受设置更改后将产生记录(REMARK=5,AS=91H),见附录1。 - SM 第1次以原速率返回：RTN=0，表示设置成功；非零值, 表不成功； - 如果设置成功，SM以新速率第2次返回 RTN=0。 ## 4.3 设置日期时间的命令 - COMMAND TYPE=0XE0 - DATAF=年（2字节），月（1字节），日（1字节），星期（1字节），时（1字节），分（1字节），秒（1字节），共8字节（BCD）； #### 字段说明 - 年（2000---2099）, 2字节； - 月（1---12）； - 日（1---31）； - 星期（1---7 ，= 7 代表星期日）。 ### 应答说明 RTN=0，表示设置成功；非零值, 表不成功。 ## 4.4 设置准进时段 ### 4.4.1 设置工作日的准进时段 - COMMAND TYPE=0XE1 - DATAF部分: |GROUP No.|16字节准进时段描述列表| |---|---| |1字节(1—4)|HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM| #### 字段说明 - GROUP_No.( 有效值1---4，1字节)，表示该时段在系统内的编号； - 16字节准进时段描述列表：表示在工作日内4段从“起始时间”至 “结束时间”才准进，每个准进时段用“起始时间---结束时间”4字节BCD码表示。 #### 示例 例如：00：00(02:00, 04:00(06:30, 08:00(20:00, 22:10(22:45。 表示从0点至2点, 4点至6点30分, 8点至20点, 22点10分至22点45分 共4个时间段才准进, 其它时间不准进。(上述表示HH:MM的数值均为BCD码，如22：45是0X22，0X45两字节 )。又如：07:00(08:00, 09:00(09:78, FF:00(13:15, 12:00(14:59，因 “FF”为无效时间值, “78”也为无效时间值, 所以上述的第二,三段无效,准进时间为: 7点至8点, 12点至14点59分,其它时间不准进。 ### 应答说明 RTN=0，表示设置成功；其它值：不成功。 ### 4.4.2 设置非工作日（节假日，或星期内休息日）的准进时段 - COMMAND TYPE=0XE2 - DATAF部分（共17字节）:  - 第1字节必须=1； |GROUP No.|16字节准进时段描述列表| |---|---| |1字节 =1|HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM, HH:MM(HH:MM| #### 字段说明 - 16字节准进时段描述列表：共4组 “起始时间---结束时间” 列表，格式为HH：MM (起始) ( HH:MM (结束)，表示在非工作日内, 从“起始时间”至 “结束时间”才准进。门控器最多存放1张 “非工作日准进” 列表。 ### 应答说明 RTN=0，表示设置成功；其它值：不成功。 ### 4.4.3 设定星期准进时间段列表 - COMMAND TYPE=0XF1 - DATAF如下： |表号|表内星期|时段描述| |---|---|---| |0--4|1--7|3段（12字节）、4段（16字节）| #### 字段说明 - 前1、2字节：表示第几张表的星期几，如：0，6则表示设置第1（=0+1）张表的星期六； - SM内最多存储5张表，每张表有7天（星期一至星期日；=7表示星期日），每天有3段/4段的准进时段，多于4段仅取前4段； - 每个时段占用4字节（表示“起始时间(结束时间”的BCD值），格式为HH：MM (起始) ( HH:MM (结束)。 ### 应答说明 RTN=0，表示设置成功；=其它值：不成功。 ## 4.5 用户(准进人员)管理 ### 4.5.1授权一个用户卡（加卡至ES2200） #### 兼容命令（兼容es5000,es2000,es2100） - COMMAND TYPE=0XE3 - DATAF=新用户描述16字节） |卡片编号|用户编号ID|用户密码|结束有效期4字节|用户权限1字节| |---|---|---|---|---| |5字节（HEX）|4字节（BCD）|2字节（BCD）|YYYY，MM，DD|VIP，时段码| ##### 字段说明 - 结束有效期（4字节）：年（2字节），月，日（BCD），如：0X20，0X12，0X12，0X31，表直到2012年12月31日才过期； - 用户权限（1字节）：D7---D0（D0为低位BIT）  - D7，D6 =0，0 ：一般用户（受星期准进时段限制）  - D7，D6 =0，1 ：一般用户（受星期准进时段限制）  - D7，D6 =1，0 ：一般用户（受工作日/休息日准进时段限制）  - D7，D6 =1，1 ：特权用户（不受任何准进时段限制），但受有效期等限制  - 当D7，D6=1，0时，D5，D4，D3，D2 ：保留；D1，D0：一般用户的工作日的准进时段GROUP.No（0，0 对应第一张表；0，1 对应第二张表；1，0 对应第三张表；1，1 对应第四张表）  - 当D7，D6=0，0或0，1时， D5，D4：保留；D3，D2，D1，D0：该用户适用的星期列表的第几张(索引系统的准进列表) #### ES2200新增命令 - COMMAND TYPE=0XE3 - DATAF=新用户描述14字节） |卡片编号|起始有效期(4字节)|结束有效期（4字节）|用户权限1字节| |---|---|---|---| |5字节|YY/MM/DD/HH|YY/MM/DD/HH|VIP，时段码| ##### 字段说明 授权的用户卡从起始时间（年/月/日/时）开始有效，到结束时间（年/月/日/时）失效。其他同兼容命令。 #### 注释 - ES2200在接到原授权命令时，将以授权当前时间为起始有效期，将不再保留用户编号及密码信息； - ES2200在接收到重复卡号设置时，将取代原设置信息，不再返回重复设置的错误（与ES2100同）。 ### 应答说明 - RTN=0，表示设置成功； - =0XE2表SM内已满； - 其它值：不成功。 ### 4.5.2删除用户卡（从门控制器内） - 功能：将该卡号的用户从控制器内删除 - COMMAND TYPE=0XE4 - DATAF=6字节，如下： |1字节指引|某用户的5字节卡片编号| |---|---| |=0|5字节卡片编号，删除一个指定卡号的用户| ### 应答说明 - RTN=0，表示删除成功； - =0XE5表SM内没有该用户； - =0XE4，全空； - RTN=0XE3, 或其它值：不成功。 ### 4.5.3全部删除用户 - COMMAND TYPE=0XE4 - DATAF=6字节，如下： |=2固定|5字节全为00| |---|---| #### 执行结果 删除ES2200内全部用户卡（不可恢复）；并且将本地加卡一同删除（es5000,es2000相同， 但ES2100必需再进行4.5.1的远程授权时才将本地加卡删除）。 ### 应答说明 - RTN=0，表示删除成功； - =0XE5表SM内没有该用户； - =0XE4，全空； - RTN=0XE3, 或其它值：不成功。 ## 4.6设定门的特性参数 ### 4.6.1 开门后等待进入的延时时间 - COMMAND TYPE=0XE7 - DATAF为 1字节，（有效值20--255），单位：0.1 秒。 #### 示例 DATAF=50（十进制），表门锁打开后5秒钟内应开门进入，然后关门。 ### 4.6.2 门禁配置参数 - COMMAND TYPE=0XE5 - DATAF= 1字节（D7---D0，D0为低位BIT） |BIT位|控制|说明| |---|---|---| |D7|=1|监控门开关状态，ES2100/ES2200始终监控| |D6|=0|不监控红外，ES2100/ES2200无外接红外功能| |D5|=0/1|备份| |D4|=0/1|备份| |D3|=0/1|备份| |D2|=0/1|备份| |D1|=0/1|备份| |D0|=0/1|备份| ### 4.6.3设定外接门磁的有效电平（ES2200灵性锁一体门禁，取消） - COMMAND TYPE=0XF7 - DATAF 1字节  - =0: 表示低电平有效（或继电器输出时，为吸合）；  - =1: 表示高电平（或继电器输出时，继电器断开为有效） ### 应答说明 RTN=0，表示设置成功；=其它值：不成功 ### 4.6.4设定是否存在外接门磁（ES2200灵性锁一体门禁，取消） - COMMAND TYPE=0XFD - DATAF 2字节：第1字节=0；第2字节表示如下  - =0: 表示无外接门磁，使用内门磁；  - =1: 表示有外接门磁。有外界门磁时如果存在内门磁，则自动关闭。 ### 应答说明 RTN=0，表示设置成功；=其它值：不成功 ### 4.6.5设置系统支持维根感应头的种类及卡片编号的获取方法 - COMMAND TYPE=0XEE - DATAF 1字节：=0或48，表示两种取卡方法：  - =0取26位感应头的全部做为卡号；  - =48时则将26位中校验的位去掉，剩余24位做卡号。 ### 应答说明 RTN=0，表示设置成功；其它值表示不成功。 ### 4.6.6门开关状态监控的布防与撤防（ES2200灵性锁一直监控门磁） - COMMAND TYPE=0XFB - DATAF 1字节  - =0 关闭监视（门开关状态）；  - =1 监视（门开关状态）。 ### 应答说明 RTN=0，表示设置成功；=其它值：不成功 ## 4.7节假日管理 ### 4.7.1设定星期内的休息日 - COMMAND TYPE=0XEA - DATAF 2字节（1--7），代表星期内休息哪两天。 #### 字段说明 1--6，星期一 至 星期六，7，星期日。其它值，表示不休息，如：7，0XFF，表示仅星期日(=7)休息。 ### 应答说明 RTN=0，表示成功； 其它值：不成功。 ### 4.7.2设定国家法定节假日（不包括星期内休息日） - COMMAND TYPE=0XEB - DATAF 2字节：MM，DD （月，日）BCD表示。 #### 注释 SM内最多存放40个节假日。 ### 应答说明 RTN=0，表示成功；=0XE2表SM内已满40组；其它值：不成功。 ### 4.7.3删除一组节假日 - COMMAND TYPE=0XEC - DATAF 2字节：MM，DD （月，日）BCD表示。 #### 注释 如 DATAF 2字节全00，表全部删除。 ### 应答说明 - RTN=0，表示删除成功； - =0XE5表SM内没有该组； - RTN=0XE4, 节假日列表已经全空; - 其它值：不成功。 ### 4.7.4清空节假日列表(全部删除) - COMMAND TYPE=0XEC - DATAF 2字节：全部为00，表全部删除。 ### 应答说明 - RTN=0，表示删除成功； - RTN=0XE4, 节假日列表已经全空; - 其它值：不成功。 ## 4.8 记录区的管理 ### 控制器内历史记录的存储示意 #### (1) 记录未满 ``` BOTTOM             LOADP           SAVEP            MAXLEN  |                  |               |                |  |<---- 已读 ----->|<---- 未读 ---->|<---- 空白 ---->| ``` SU 只能读取 “底”BOTTOM（=0）至 “顶”TOP（=SAVEP—1）的区段之有效记录。BOTTOM位置为最早(旧)的记录， “顶” TOP位置为最新的记录。TOP+1(=SAVEP) 至MAXLEN—1区间都是空白区。 #### (2) 记录已满 ``` BOTTOM      SAVEP            LOADP            MAXLEN  |           |                |                |  |<-- 已覆盖 -->|<---- 未读 ---->|<---- 已读 ---->| ``` TOP的值等于MAXLEN，SU能读取整个记录区的记录，记录最早（旧）至最新存放位置：SAVEP < MAXLEN < BOTTOM < SAVEP — 1，SAVEP—1位置为最新记录，而SAVEP位置为最早(旧)记录。 #### 关键参数说明 - 柜桶最大深度MAXLEN：表示SM存储历史记录的最大空间（条数）； - 当该空间存储满后，SM将自动覆盖最早的记录（MF的D7=1），存储最新的记录，保留的最新记录MAXLEN条。SM的“覆盖”操作若改动“最后读取指针 LOADP” ，则MF的D0=1。 #### 有效记录数计算 1. 当SAVEP>=LOADP时，剩余未读取的记录数=SAVEP-LOADP 2. 当SAVEP<LOADP 时, 剩余未读取的记录数=MAXLEN-(LOADP-SAVEP) ### 4.8.1初驶化记录区(清空记录) - COMMAND TYPE=0XF0 - DATAF 5字节全部为0 ### 应答说明 RTN=0，表示成功； 其它值：不成功。 ### 4.8.2设定读指针 - COMMAND TYPE=0XF0 - DATAF 3字节 |第1字节|第2字节|第3字节| |---|---|---| |LOADP低位字节|LOADP高位字节|备份| #### 注释 LOADP(高位\低位)必须在BOTTOM至MAXLEN之间。 ### 应答说明 RTN=0，表示成功；其它值：不成功。 ### 4.8.3设定记录区指针 - COMMAND TYPE=0XF0 - DATAF 5字节  |字段|说明| |---|---| |SAVEP（2字节）|表示SM下一条记录存储的位置（低位在前）| |LOADP（2字节）|表示SU下一次读取记录的位置（低位在前）| |备份（1字节）|无实际意义| #### 注释 SAVEP、LOADP(高位|低位) 必须在BOTTOM至MAXLEN之间。 ### 应答说明 RTN=0，表示成功； 其它值：不成功。 ## 4.9 远程开关门 ### 4.9.1单一放行(不带系统操作员信息) - COMMAND TYPE=0XED - DATAF 1字节：=1 开门；=0 不操作； ### 应答说明 RTN=0，表示开门成功；其它值：不成功。 ### 4.9.2单一放行(带系统操作员信息) - COMMAND TYPE=0XED - DATAF=6字节 |第1字节|后5字节| |---|---| |=1开门；=0不操作|操作员编号信息，存放在远程开门记录结构中的前5字节| ### 应答说明 RTN=0，表示开门成功； 其它值：不成功。 # 五. 读取信息命令 SU 随时都可以对SM的历史记录，监控状态等进行读取。 SU发送的命令桢: CID2 = 4AH SU发送读取命令的COMMAND INFO部分如下： |COMMAND GROUP|COMMAND TYPE|DATAF| |---|---|---| |0XF2|0XE0至0XEF|1字节（读取记录命令时，2字节）| ## 5.1读取SM的实时钟 - COMMAND TYPE=0XE0 - DATAF ( 1字节) =0 ### 返回说明 DATAINFO：年（2字节），月（1字节），日（1字节），星期（1字节），时（1字节），分（1字节），秒（1字节），共8字节BCD。其中：年（2字节）：2000---2099  ## 5.2读取记录信息 ### 5.2.1读取历史记录柜桶参数 - COMMAND TYPE=0XE1 - DATAF(1字节) =0 ### 返回说明 DATAINFO(9字节）： |字段|字节数|说明| |---|---|---| |桶底BOTTOM|2字节|无| |下一次新记录存放指针 SAVEP|2字节|无| |下一次读取记录位置指针 LOADP|2字节|无| |备份MF|1字节|无| |柜桶最大深度MAXLEN|2字节|无| #### 有效记录数计算 1. 当SAVEP>=LOADP，剩余未读取的记录数N=SAVEP—LOADP 2. 当SAVEP<LOADP，剩余未读取的记录数N=MAXLEN-(LOADP-SAVEP) ### 5.2.2顺序读取一条历史记录 - COMMAND TYPE=0XE2 - DATAF 无  ### 返回说明 SM从LOADP位置读取一条记录返给SU， SM自动将LOADP指向下一条记录。DATAINFO为 DATAF 位置的一条记录（14字节），参见附录1。 ### 5.2.3随机读取记录(指定位置读取) - COMMAND TYPE=0XE2 - DATAF （2字节）参数(低位在前) ### 返回说明 SM以DATAF位LOADP值, 在此位置读取一条历史记录，SM不改变原LOADP值。如果SM内历史记录已全部读完（LOADP位置已是空白），或参数DATAF指向空白记录区，SM将返回错误提示。DATAINFO为 DATAF 位置的一条记录（14字节），参见附录1。 ### 5.2.4附带顺序号读取记录（防止丢失记录） - COMMAND TYPE=0XEE - DATAF 1字节=1 ### 返回说明 SM将LOADP位置的历史记录, 连同LOADP本身一并返回, 共16字节 |前2字节|后14字节| |---|---| |读出记录的位置LOADP值|记录见 “附录1”| #### 注释 LOADP在0---MAXLEN之间是顺序的，可以判断在读记录的操作中有无发生因RS485线路问题造成记录丢失。如果控制器内已全部读完, 返回 :无记录标识。 ### 5.2.5读取最新刷卡 - COMMAND TYPE=0XEE - DATAF 1字节=0 ### 返回说明 SM将最新发生的刷卡事件返回, 共14字节（记录见 “附录1”） ## 5.3读取时段 ### 5.3.1读取一组工作日准进时段 - COMMAND TYPE=0XE3 - DATAF （1字节）（1--4）表读哪一组（每组16字节） ### 返回说明 DATAINFO 共16字节（BCD）如下： 时段描述（16字节）：起始时间---结束时间列表： ``` HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) ``` ### 5.3.2读取非工作日准进时段 - COMMAND TYPE=0XE4 - DATAF （1字节）（=1 ） ### 返回说明 DATAINFO 共16字节（BCD），为“非工作日准进时段”。如下： 时段描述（16字节）：起始时间---结束时间列表： ``` HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) ``` ### 5.3.3读取星期一至星期日的准进时间表 - COMMAND TYPE=0XEB - DATAF 2字节：  - 第一字节：指定读取第几张表（有效值0-4表示第一至第五张表）；  - 第二字节：该表内星期几(1-7,=7表示星期日) ### 返回说明 DATAINFO 16字节（BCD）（准进时间段列表）： ``` 起始时间-------- 结束时间： HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) ``` #### 注释 考虑与ES5000，ES2000的兼容，在16字节后，多加8字节0。 ## 5.4读取用户信息 ### 5.4.1读取已存储的用户数目 - COMMAND TYPE=0XE5 - DATAF （1字节）=0 ### 返回说明 DATAINFO （2字节HEX），表示数量, 低8位在前,高8位在后; =0，0 表无用户。 ### 5.4.2读取指定存储位置的用户登记资料 #### 说明 这条命令在SU 通过权限确认后，才能得到正确返回值。 ##### (1)兼容es5000,es2000,es2100 - COMMAND TYPE=0XE6 - DATAF （2字节HEX数）SM内用户列表中,读取指定存储序号位置的用户(序号是低位在前,例如0X01,0X02表示第513个用户)。 ###### 返回说明 - RTN=0，DATAINFO：（共16字节） |用户卡号|用户编号（4字节）|密码|有效期（4字节）|用户权限（1字节）| |---|---|---|---|---| |5字节（HEX）|卡号后4字节|0，0|20H，年、月、日|VIP，GROUP| ##### (2）ES2200独立的命令 - COMMAND TYPE=0XE6 - DATAF （3字节HEX数）：第1字节=0，第2，3字节同（1）表示SM内用户列表中的序号位置,读取指定存储位置的用户(序号是低位在前,例如0X01,0X02表示第513个用户)。 ###### 返回说明 - RTN=0，DATAINFO：（共14字节） |用户卡号|开始有效期（4字节）|结束有效期（4字节）|用户权限（1字节）| |---|---|---|---| |5字节（HEX）|年、月、日、时|年、月、日、时|VIP，GROUP| - RTN=0XE0, 无权限读取用户资信，无DATAINFO项。 ### 5.4.3查询指定卡号的用户卡是否存在 #### 说明 这条命令在SU 通过权限确认后，才能得到正确返回值。 ##### (1)兼容es5000,es2000,es2100 - COMMAND TYPE=0XE6 - DATAF=5字节卡号。 ###### 返回说明 - RTN=0，DATAINFO：（共16字节） |用户卡号|用户编号（4字节）|密码|有效期（4字节）|用户权限（1字节）| |---|---|---|---|---| |5字节（HEX）|卡号后4字节|0，0|20H，年、月、日|VIP，GROUP| - RTN=0XE0, 无权限读取用户资信，无DATAINFO项。 ##### (2）ES2200独立的命令 - COMMAND TYPE=0XE6 - DATAF （6字节HEX数）：第1字节=0，第2--6字节同（1）表示待读取用户的卡号。 ###### 返回说明 - RTN=0，DATAINFO：（共14字节） |用户卡号|开始有效期（4字节）|结束有效期（4字节）|用户权限（1字节）| |---|---|---|---| |5字节（HEX）|年、月、日、时|年、月、日、时|VIP，GROUP| - RTN=0XE0, 无权限读取用户资信，无DATAINFO项。 ## 5.5读取休息日、节假日 ### 5.5.1读取星期内休息日 - COMMAND TYPE=0XE9 - DATAF （1字节）=0 ### 返回说明 DATAINFO（2字节），每个字节有效值 1—7，=7表示星期日，非有效值，无意义。 ### 5.5.2读取节假日（星期内休息日除外） - COMMAND TYPE=0XEA - DATAF （1字节）=0 ### 返回说明 DATAINFO： - 第一字节：休息日的个数 N （天，每天由：月：日两字节BCD表示） - 从第二字节开始列表N天休息日（两字节BCD 月：日），共2 X N 个字节。 ## 5.6远程监控 - COMMAND TYPE=0XE7 - DATAF （1字节）=0 ### 返回说明 DATAINFO （2字节） #### 第一字节：SM的工作状态 |BIT位|说明| |---|---| |D7|=0 SM内实时钟IC正常; =1 不正常| |D6|=0 SM内存储器正常；=1 不正常| |D5|=0 SM的工作电源正常； =1 不正常，供电电压低而CPU被平凡复位| |D4|备份| |D3|备份| |D2|=0 不监视门开关; =1监视| |D1|备份| |D0|=0 正常工作，=1处于报警状态| #### 第二字节：SM监控线路的状态 |BIT位|说明| |---|---| |D7|备份| |D6|钥匙开关(=1旋力, =0自由)| |D5|大锁舌开关(=1缩入, =0伸出)| |D4|0| |D3|门磁的门关状态: =0闭门， =1 门开启| |D2|0| |D1|出门按钮松开， =1 按下| |D0|门控马达静止，=1加电驱动| ## 5.7读取工作特性参数 - COMMAND TYPE=0XE8 - DATAF （1字节）=0 ### 返回说明 DATAINFO （5字节） #### 第一字节：配置参数1字节(D0低位) |BIT位|控制|说明| |---|---|---| |D7|=0 不监控门开关状态；=1 监控门开关状态（ES2200始终监控）| |D6|=0 无红外（ES2200无外接红外感应输入）| |D5|=0 电磁锁在断电后（或加电后）能自动锁上| |D4|=0 允许 “手动开门”输入线在与电源地线短接时,能开门| |D3|=0 ES2200内置门磁| |D2|备份| |D1|备份| |D0|备份| #### 其他字节说明 - 第二字节：门电机驱动的执行时间（0.1秒为单位）； - 第三字节：开门等待进入的延时时间（0.1秒为单位）； - 第四字节：备份； - 第五字节：感应卡的号码获取方法控制字:=0 或30H。 ## 5.8检查外门磁是否存在（ES2200灵性锁外外接门磁，取消） - COMMAND TYPE=0XEC - DATAF （1字节）=1 ### 返回说明 DATAINFO （4字节）：0，0，ext_ds,0；第三字节ext_ds=0 表示无外接门磁，ext_ds=1表示有外接门磁。 ## 5.9读取设备名称及版本号(待定) - COMMAND TYPE=0XEF - DATAF （1字节）=0 ### 返回说明 DATAINFO:18字节，为设备名称及版本: 设备名称与版本号之间用 “,”隔开。例如：ES2200,VER1.01 # 附录: 门控器(SM)的历史记录格式 门控器(SM)对如下事件的发生都有记录： 1. 刷卡开门 (记录卡号及开门时间, 门是否被开, 是否确认用户个人密码 等)。 2. 由KEYPAD 键入用户ID及个人密码开门。 3. 红外报警开始，红外报警结束。 4. 非正常开门， 关门。 5. 刷卡或键入ID及个人密码开门 (电磁锁动作), 但未开门进入。 6. 开门进入, 在规定的延时内, 未关门。 7. 手动开门。 8. 远程（由SU）开门。 9. 联动输入引起开门。 10. SM内控制参数被修改， 红外监控被关闭， 或开启。 11. SM掉电（ 开始时间 ( 结束时间 ） 。 每条记录用14字节表示： |事件来源（5字节）|日期，时间（7字节）|状态（1字节）|备注（1字节）| |---|---|---|---| |卡号或说明等信息|年（2），月，日，时，分，秒|STATUS（D7--D0）|REMARK| ### 备注字段说明 备注（1字节）（D7-D0 ,其中D0 最低位）的D7=0 表示该条历史记录从未被SU读取过；D7=1表示该条历史记录已被SU读取过。 ### 具体记录类型说明 #### 1. REMARK=0 刷卡开门记录 - “事件来源” = 5字节卡号 - STATUS :  |BIT位|说明|  |---|---|  |D7|=0 未确认用户个人密码, =1 确认|  |D6|=0 刷卡前门原来处于关状态, =1 开状态|  |D5|=0 刷卡后未超时进入, =1 超时未开门|  |D4|=0 未超时正常关门, =1 超时后门仍然开的|  |D3|保留|  |D2|保留|  |D1|=0，外接分体读头刷卡； =1 内置主体刷卡|  |D0|保留| #### 2. REMARK=2 远程(由SU)开门记录 - “事件来源” = 5字节全0 - STATUS:  |BIT位|说明|  |---|---|  |D7|0|  |D6|=0 遥控开门命令前,门处于关状态, =1 开状态|  |D5|=0 命令执行后未超时,开门进入, =1 超时未开门|  |D4|=0 未超时正常关门, =1 超时后门仍然开的|  |D3|保留|  |D2|保留|  |D1|0|  |D0|保留| #### 3. REMARK=3 手动开门记录 - “事件来源” = 5字节全0 - STATUS:  |BIT位|说明|  |---|---|  |D7|0|  |D6|=0 按动之前,门处于关状态, =1 开状态|  |D5|=0 执行后未超时,开门, =1 超时未开门|  |D4|=0 未超时正常关门, =1 超时后门仍然开的|  |D3|保留|  |D2|保留|  |D1|0|  |D0|保留| #### 4. REMARK=5 事件记录 - 格式如下: |事件来源（5字节）|日期，时间（7字节）|状态（1字节）|备注（1字节）| |---|---|---|---| |说明信息（4字节）+ AS（1字节）|年（2），月，日，时，分，秒|STATUS（D7--D0）|REMARK=5| - AS字段说明：  |AS值|说明|  |---|---|  |0|红外报警开始|  |1|红外停止报警|  |2|非正常开门|  |3|门被关闭（非正常状态的关门记录）|  |4|联动(I2 )有效|  |5|联动(I2 ) 无效|  |6|SM内部存储器发生错误, SM自动进行了初始化操作|  |7|红外监测被关闭|  |8|红外监测开启|  |9|门碰开关监测被关闭|  |10|门碰开关监测开启|  |82H|超时未开门(在要求的延时内，门一直关的但锁已开)|  |83H|正常关门(在要求的延时内，关门)|  |84H|超时未关门|  |85H|电机或锁内机械可能有故障，电机在开锁驱动后未能将锁杆拉动,即解除锁止不成功|  |86H|外接门磁反应的状态与锁舌表现的状态不符，可能是设置错误或安装错误|  |90H|改变了通信速率:说明信息4字节=0,0,新速率代码,原速率代码|  |91H|改变了通信地址:说明说明4字节=新地址(2字节),原地址(2字节)| - STATUS: 记录发生时的输入线状态:  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份| #### 5. REMARK=6 SM掉电记录 - “事件来源5字节” = SM掉电的日期,时间：月,日,时,分,秒 - STATUS：重新上电时的输入线状态：  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份| #### 6. REMARK=7 内部控制参数被修改的记录 - “事件来源” = 4字节全0 + 修改标记(1字节) - 修改标记(1字节)  |BIT位|说明|  |---|---|  |D0|=1 修改了SM的密码|  |D1|=1 修改了门的特性控制参数|  |D2|=1 增加了新用户|  |D3|=1 删除了用户资料|  |D4|=1 修改了实时钟|  |D5|=1 修改了控制准进的时段设置|  |D6|=1 修改了节假日列表|  |D7|=1 修改了红外开启（关闭）的设置控制字| - STATUS: 做记录时的状态  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份| #### 7. REMARK=8 无效的用户卡刷卡记录 - “事件来源” = 5字节卡号 - STATUS:  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份| #### 8. REMARK=9 用户卡的有效期已过 - “事件来源” = 5字节卡号 - STATUS:  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份| #### 9. REMARK=10 当前时间该用户卡无进入权限 - “事件来源” = 5字节卡号 - STATUS:  |BIT位|说明|  |---|---|  |D0|0|  |D1|出门按钮状态: =0松开, =1按下|  |D2|0|  |D3|门磁状态, =0门处于关状态, =1 门处于开状态|  |D5|大锁舌状态 =0伸出; =1缩入(锁开)|  |D6|钥匙状态 =0自由; =1钥匙旋力|  |D7|备份|