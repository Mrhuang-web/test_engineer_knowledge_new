# 01功能说明

```
该模块的统计是半实时的：即详情表更新，这个也会跟着变动
数据与综资-原始数据（具有关联性的） -- 在详情统计之后，依造详情表进行汇总
四张统计表都是默认显示全部以及前一天综资表和告警数据的统计值
告警统计不是实时的，而且会在下一次统计时候巡检月度告警表然后进行统计
每次触发会实时统计到月度告警表，用于下次同步详情表时检索




仅做数据中心-核心机楼（通信枢纽楼）下的设备
	动环设备数据 - 与综资对应设备静态参数匹配
	同步周期如下


统计分析维度（统计分析报表）
		总表：按地市 + 设备类型 + 厂家分组统计
		设备类型分析表：按设备类型分组
		厂家分析表：按厂家分组，计算故障率
		地市分析表：按地市分组，统计设备总量和超期占比

超期判断逻辑
		每种设备类型有预设的更新周期（即设计寿命）
		系统计算：
			`已使用时长 = 当前时间 - 开始使用时间`
		判断逻辑：
			`已使用时长 / 更新周期 < 70%` → <70%
			`已使用时长 / 更新周期 > 70%` → > 70%在超期内(即70%更新周期<使用周期<更新周期)
			`已使用时长 > 更新周期` 		 → 超期服役（包含超期服役和>1.5的 - 即3和4的类型）
			`已使用时长 > 更新周期`> 150%`→ > 150% 超期服役（仅4的类型）
	告警统计逻辑
		默认统计近一个自然月的告警次数
		支持自定义时间范围（如2023年1月~2023年3月）
		
	
```

| ***\*设备类型\**** | ***\*设备子类\****                                           | ***\*更新周期\**** |
| ------------------ | ------------------------------------------------------------ | ------------------ |
| 变压器             | 全部                                                         | 15年               |
| 高压配电           | 全部                                                         | 15年               |
| 高压直流电源       | 全部                                                         | 10年               |
| 高压直流配电       | 全部                                                         | 15年               |
| 低压交流配电       | 全部                                                         | 15年               |
| 发电机组           | 全部                                                         | 15年               |
| 开关电源           | 全部                                                         | 12年               |
| 低压直流配电       | 全部                                                         | 15年               |
| UPS设备            | 全部                                                         | 10年               |
| 蓄电池             | 1.UPS铅酸电池                                                | 6年                |
|                    | 2.操作电源铅酸电池                                           | 8年                |
|                    | 3.发电机组铅酸电池                                           | 6年                |
|                    | 4.高压直流铅酸电池                                           | 8年                |
|                    | 5.开关电源锂电池                                             | 10年               |
|                    | 6.开关电源铅酸电池                                           | 8年                |
|                    | 7.直流屏铅酸电池                                             | 8年                |
| 空调               | 1.设备类型为普通空调时更新周期6年；                          | 6年                |
|                    | 2.设备类型为其他（机房专用空调、中央空调末端），设备子类为恒湿机、柜式空调 | 6年                |
|                    | 3.设备子类为风冷专用空调                                     | 8年                |
|                    | 4.设备类型为其他（机房专用空调、中央空调末端），设备子类为列间空调、嵌入式空调、热管背板、双冷源专用空调、水冷专用空调 | 10年               |
| 动环监控           | 1.设备子类为FSU、CSC、LSC                                    | 5年                |
|                    | 2.设备子类为蓄电池采集设备                                   | 8年                |

 

# 02数据来源

```
1、数据均来自于es（通过 zz_data_sync_info配置的批次号，到es中匹配对应月份下对应批次然后回显）
2、目前除了空间_数据中心是取动环数据库，其他都是走es
3、映射表、zz_data_sync_info（需要先修正好批次号）
4、数据来源于详情表 - 从详情表抽离出来统计

涉及服务：
	hidden服务（后端明林，前端贵荣）
    composite-service,


涉及表：
    overdue_count_total 超期服役-统计分析总表’;
    overdue_count_device 超期服役-设备类型统计分析报表’;
    overdue_count_manufactor 超期服役-厂家统计分析报表’;
    overdue_count_city 超期服役-地市统计分析报表’;
    overdue_device_alert_monthly 超期服役-设备月度告警频次表’;


涉及curl：
	# 一次执行全部,但是会按顺序执行
	curl --location --request GET 'http://localhost:28028/v1/hiddenDanger/startOverdueAll'
	# 仅统计分析
	curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue2"
    # 仅设备
    curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue3"
    # 厂家
    curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue4"
    # 仅地市
    curl --location --request GET  "http://localhost:28028/v1/hiddenDanger/startOverdue5"



主要逻辑：
	更新周期数据（根据更新周期表，反向推算出 `start_time`）
	假设当前时间是 `2024-05-27`
	超期服役设备：
		`start_time` = 当前时间 - (更新周期 + 1年)
		一个`变压器`（周期15年），设置 `start_time` 为 `2008-05-27`
	>70%在超期内设备：
		`start_time` = 当前时间 - (更新周期 * 0.8) //取80%，确认>70%
		一个`开关电源`（周期12年），12*0.8=9.6年，约9年7个月
		设置 `start_time` 为 `2014-10-27`
	<70%设备：
		`start_time` = 当前时间 - (更新周期 * 0.5) //取50%，确保小于70%
		一个`动环监控-FSU`（周期5年），5*0.5=2.5年
		设置 `start_time` 为 `2021-11-27`


告警数据
	设备告警表 (`device_alarm_history`) - 来自动环系统
	device_id, alarm_time, 
	alarm_type, alarm_level
	
	同一个设备在不同时间点制造多条告警记录，用来测试“告警频次”统计是否正确
		为 `power_device_id = 'DEVID_0001'` 的设备
		在 `2024-04-01` 到 `2024-04-30` 之间插入10条告警记录
	再在 `2024-03月` 插入5条。当你设置统计时间为 `2024-04` 时，预期频次应为10
	
	


前期测试问题：
	统计问题【重点】：
		没有类型的不会统计进去【站点类型必须都是要不为空，因为加了站点类型分类】
		如果没有类型、没有关联到动环站点、站点类型、机房等的，也都不会统计进去
	2个tab的筛选条件
		需要加上高压直流电源（高压直流开关电源，两种好像都是同一种）
```
