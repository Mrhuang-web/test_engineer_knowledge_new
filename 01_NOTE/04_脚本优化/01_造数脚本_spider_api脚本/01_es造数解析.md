# 01全量插入

```
说明：
	1、使用esDB类中的insert_esdata_device_metecode()函数
	2、会匹配precinctid(可以为站点、楼栋、机房)对应的所有设备、插入对应所有设备测点值

esDB(precinct_id="01-01-23-03-06-01-02", imdate=d, estime='T00:02:04', env="sh").insert_esdata_device_metecode()
```

# 02单量插入

```
说明：
	1、使用esDB类中的insert_esdata_device()函数
	2、会匹配precinctid(可以为站点、楼栋、机房)对应设备、插入对应设备测点值
	3、可在esDB实例中控制对应变量，来指定
		precinct_id
		mete_code		测点编码[对应设备的编码 -- 可以在fsu_data那些里面看]
		device_id		设备id[这个是接入后的设备、每个设备的id都是独立的 -- t_cfg_device]
		minval			最小值
		maxval			最大值
		env				[这是环境、必须选择与所要插入的环境一致 -- conf中config.ini]


esDB(precinct_id="01-01-08-04-12-01", mete_code='009301',device_id='00001006000000154117', imdate="2025-08-29",
minval=800, maxval=800, estime='T00:02:03', env="sh").insert_esdata_device()
```

# 03es类解析

## 逻辑解析

```

```

## 构造函数

```
说明：
	涉及第三方库：urlquote
	用于esdb类的实例变量初始化
	
	

def	__init__(args[形参]):
	args..[实例变量]


形参[可以在实例时赋值、覆盖掉默认值]
	precinct_id,
    mete_code='000000',
    imdate=datetime.datetime.now().strftime('%Y-%m-%d'),
    minval=1,
    maxval=1,
    device_id='1',
    del_col='meteID',
    del_clo_v='1',
    estime='T23:50:50',
    env='release'											默认选择的环境，需要在创建时修改
    注意：
    	minval和maxval，是用来指定生成测点值得区间 -- 两个都是一样，那就是生成指定值
    	

实例变量
	conf = Config()
	self.precinct_id = precinct_id
	self.mete_code = mete_code
	self.imdate = imdate
	self.minval = minval
	self.maxval = maxval
	self.device_id = device_id
	self.del_col = del_col
	self.del_col_v = del_clo_v
	
	
	# 数据库的连接
	self.dbip = conf.get_conf(env, 'dbip')
	self.dbport = conf.get_conf(env, 'dbport')
	self.dbname = conf.get_conf(env, 'dbname')
	self.dbuser = conf.get_conf(env, 'dbuser')
	self.dbpw = conf.get_conf(env, 'dbpw')
	# es的连接信息
	self.url = conf.get_conf(env, 'esurl')
	self.estime = estime
	engines = "mysql+pymysql://" + urlquote(self.dbuser) + ":" + urlquote(self.dbpw) + \
          "@" + self.dbip+":"+self.dbport + "/" + urlquote(self.dbname) + "?charset=utf8"
	engine = create_engine(engines, max_overflow=5)
	self.conn = engine.connect()
	
	
    # es数据列	[不同的es数据格式可能传的列不同]
	self.esparam = param = {
			"point_history_data": {
                "properties": {
                    "airType": {
                        "type": "short"
                    },
                 },
                 ......
            }
	}	
	
	
	# 读取预设的sql		
		-- [这里的sql是查数据是否存在  --存在疑问]
		
    self.sqlfile = open(str(os.path.dirname(__file__) +
                                '/selectForESList.sql'), encoding='utf-8')
```

## get_devicedata

```
说明：
	获取数据库特定设备的相关测点数据【即设备id、所属机楼、关联开关设备、机楼id、测点编码、设备名等】
	用于哪里？？？
		
	
	s = text(
            "SELECT a.device_id,b.precinct_name,a.rated_power,b.precinct_id,c.mete_code,a.device_name,a.manufacturer_id,c.up_mete_id,c.mete_no FROM "
            "t_cfg_device a "
            "INNER JOIN t_cfg_precinct b ON a.precinct_id=b.precinct_id "
            "INNER JOIN t_cfg_metemodel_detail c ON a.device_model=c.model_id "
            "WHERE  a.device_id = :device_id AND c.mete_code = :mete_code")

	# 在连接的数据库中执行相应语句  -- 即相关环境的数据库里
	result = self.conn.execute(
            s, device_id=self.device_id, mete_code=self.mete_code)


	# 使用fetchall，获取所有返回的行数据库，且以列表形式返回
	row = result.fetchall()
        return row
```

## insert_esdata_device_metecode

```
说明：
	生成特定区域的某个测点的数据	[根据初始化中定义参数来判断]


	createim = self.imdate.split("-")
	creattime = createim[0] + createim[1] + createim[2]
	
	es = Elasticsearch(self.url)
	
	# 存放es中的文件格式
	filename = "fsu_" + creattime + "_" + self.precinct_id[0:5]
	indetype = "point_history_data"
	
	# 文件放置的索引路径
	urlputindex = self.url + "/" + filename
	# 文件放置的索引路径映射
	urlputmapping = self.url + "/" + filename + "/" + indetype + "/_mapping"
	# 向es中新增该索引
	requests.put(urlputindex)  # 新增index
	# 设置该索引的配置
	urlputsetting = self.url + "/" + filename + "/_settings"
	# 修改副本数为0
	requests.put(urlputsetting, json.dumps({"index": {"number_of_replicas": "0"}})) 
    
    
    # 将构造函数初始化中的es数据列结构、转成json格式
    pload = json.dumps(self.esparam)
    # 向es映射表里面添加结构
	requests.put(urlputmapping, pload)  # 创建mapping
    
```

