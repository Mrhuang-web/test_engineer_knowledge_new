# 分析——系统报表

涉及服务：eport, external, 前端,composite

公共表（动环综资映射表）：zz_data_sync_info（A）



动环好像通过precinct_id，到对应空间表里面找，然后再找到综资表里面的？（存在疑问）



映射关系：

zz_to_rm_rm_area_site：ods_zz_site

zz_to_rm_rm_area_room：ods_zz_room

zz_to_rm_rm_device：只能相当于映射表（然后通过zh_label和res_code匹配到对应设备索引表）



注意：所有关联起来的批次号都要一致，不然会匹配不到

```
具体走向
	通过precinct_id，到对应表里面拿到数据
	然后通过res_code,int_id,zh_label,取到综资里面匹配数据（前提batch_num要匹配）
```



(通过res_code，进行匹配或是zh_label)



## 局站系统报表

涉及表：zz_to_rm_rm_area_site（B）

涉及索引：ods_zz_site（C）

匹配规则（B表其实就是C同步过来的）：

​	在B表中precinct_id，插入对应动环的id（楼栋或通信机楼），就能与综资匹配起来

映射关系（匹配展开详情时需要）：

​	前提要求（A中，B和C的批次号要与C在es中对应数据的batch_num一致）	

​	方式1：通过B中的int_id匹配拿到数据（也可以匹配到C中的）

​	方式2：通过B中的zh_label拿到数据（也可以匹配到C中的）





## 机房信息表

涉及表：zz_to_rm_rm_area_room（D）

涉及索引：ods_zz_room（E）

匹配规则（D表其实就是E同步过来的）：

​	在D表中precinct_id，插入对应动环的id（机房id），就能与综资匹配起来

映射关系（匹配展开详情时需要）：

​	前提要求（A中，D和E的批次号要与E在es中对应数据的batch_num一致）	

​	方式1：通过D中的int_id匹配拿到数据（也可以匹配到D中的）

​	方式2：通过D中的zh_label拿到数据（也可以匹配到D中的）



## 设备信息表

涉及表：zz_to_rm_rm_device（F）

涉及索引：对应的设备索引（G）

匹配规则（F表其实就是对应G设备索引同步过来的）：

​	在F表中precinct_id，插入对应动环的id（机房id，device_id,power_device_id），就能与综资匹配起来

映射关系（匹配展开详情时需要  -- 综资字段）：

​	前提要求（A中，F和G的批次号要与E在es中对应数据的batch_num一致，同时还要保证动环和综资的power_device_id一致，还需要先保证楼栋和通信枢纽楼等站点已经匹配）	

​	方式1：通过F中的动环监控id匹配拿到数据（也可以匹配到G中的）

​	方式2：通过F中的机房名+设备名（zh_label）拿到数据（也可以匹配到G中的）

注意：

​	动环监控设备id的匹配（需要到接入集团的省份中间库，修改里面的power_device_id，与动环对应设备下的power_device_id一致）

​		以集团接入的贵州为例：

​			先进入贵州的中间库，找接入里面任意一个设备，然后修改power_device_id，然后确认该设备属于哪个机房，再回到动环里面找

​			找到对应id后，就到设备表里面找该机房下的设备，并修改power_device_id与中间库修改一致，即可

```
有改动，需要跟wiki上进行修改（重点）

需要修改点：
	涉及表：zz_to_rm_rm_device（F）

    涉及索引：对应的设备索引（G）

    匹配规则：
        1、是否匹配综资
        先确保precinctid的站点/楼栋，已经匹配到综资
        再在F表中precinct_id，插入对应动环的id（机房id，device_id,power_device_id），起到映射作用
        然后需要通过动环监控设备ID或机房+设备名来实现匹配
        2、动环监控设备id匹配
        需要修改接入省份中设备的power_device_id,与动环设备表中对应power_device_id一致（并且与综资的也保持一致——这个存疑）
    eg:中间库-贵1数据中心楼2交换机房下变压器设备-powerdevice_id为100，那么动环贵1数据中心楼2交换机房下的变压器设备-power_device_id也需为100

    映射关系（匹配展开详情时需要）：
    ​ 前提要求（A中，F和G的批次号要与E在es中对应数据的batch_num一致，同时还要保证动环和综资的power_device_id一致）
    ​ 方式1：通过F中的 动环监控设备ID  匹配拿到数据（也可以匹配到G中的）  （动环监控设备id还是res_code? - 存疑）
    ​ 方式2：通过F中的zh_label拿到数据（也可以匹配到G中的）
```



## 数据中心信息报表

涉及表：zz_to_rm_rm_area_dc（H）

无相关索引

匹配规则：

​	在H表中precinct_id，插入对应动环的id（数据中心id），就能与综资匹配起来

映射关系（匹配展开详情时需要）  --待修改：

​	前提要求（批次号同步）	

​	方式1：通过H中的int_id匹配拿到数据

​	方式2：通过H中的zh_label拿到数据













# 新版本

**涉及服务**：eport, external,config, 前端,composite

**公共表（动环综资映射表）**：zz_data_sync_info（A）

## 局站系统报表

**涉及表**：zz_to_rm_rm_area_site（B）

**涉及索引**：ods_zz_site（C）

**匹配/及映射规则**：
前提要求（A中，B和C的批次号要与C在es中对应数据的batch_num一致）
在B表中precinct_id，插入对应动环的id（楼栋或通信机楼），区域大部分均为综资字段
报表通过precinct_id,查询到B表，及动环和综资的关联关系
弹窗时，通过int_id去匹配 C索引的int_id，返回回来

```
补充：
	ID匹配法（动环precinct_id -> 站点映射表(zz_to_rm_rm_area_site) -> 映射表zg_name -> 空间站点表(ods_zz_site) int_id -> 返回动环）
	名称匹配法（目前不支持）
```

拆分了楼栋，所以表里数据会比页面多





## 机房信息表

**涉及表**：zz_to_rm_rm_area_room（D）

**涉及索引**：ods_zz_room（E）

**匹配/及映射规则**：
前提要求（A中，D和E的批次号要与E在es中对应数据的batch_num一致；也是索引的日期）
在D表中precinct_id，插入对应动环的id（楼栋或通信机楼），区域大部分均为综资字段
报表通过precinct_id,查询到B表，及动环和综资的关联关系
弹窗时，通过int_id去匹配 E索引的int_id，返回回来

## 设备信息表

```
注意（重点）：
​	首先要站点要匹配且入库到zz里面
​	然后es中，对应设备的relate_site也需要关联到站点（即匹配到的站点才行  -- 空间表的int_id） 
​	  ---  ods_zz_irms_site_map(int_id要跟这里的zg_name对上？)
​	ip要改对
	三个对应关系里面的省份编码要一致？

	如果综资站点int_id是这种类型：SITE-7b2f9634e97f420db0067d60460beb6d（这种类型的出不来）
		目前除了数字的可以显示除了，其他的好像都有问题
```



**涉及表**：zz_to_rm_rm_device（F）

**涉及索引**：对应的设备索引（G）

**匹配/及映射规则**：
前提要求（A中，F和G的批次号要与G在es中对应数据的batchnum一致；也是索引的日期）

1、是否匹配综资（需要先匹配站点）
先确保precinct_id的站点/楼栋，已经匹配到综资
再在F表中precinct_id，插入对应动环的id（机房id，device_id,power_device_id）
报表通过precinct_id,查询到B表，及动环和综资的关联关系



2、动环监控设备id匹配
需要修改接入省份中设备的power_device_id,与动环设备表中对应power_device_id一致，且与F表中的power_device_id一致
eg:中间库-贵1数据中心楼2*交换机房下变压器设备-power*device_id为100，那么动环贵1数据中心楼2*交换机房下的变压器设备-power_device_id也需为100

3、弹窗时

通过res_code，和设备类型去匹配 G索引的res_code，返回回来（注意：sync表中device_type与综资还是有去别的，疑问）、

疑问点（设备类型）：综资视图那块的这个接口，和动环设备类型名称不完全对应的上

## 数据中心信息报表

**服务**：config（复用实现弹窗）

**涉及表**：zz_to_rm_rm_area_dc（H）

无相关索引

**匹配/及映射规则**：
前提要求（A中，H的批次号要一致）
在H表中precinct_id，插入对应动环的id（数据中心id）
报表通过precinct_id,查询到H表，及动环和综资的关联关系
弹窗时，通过int_id去匹配 H 的int_id，返回回来

```
补充：
	所有内容仅在H表上操作
```







# 补充逻辑

```
1、批次是根据，索引名的日期来判断的（然后再到里面那指定日期的）
2、所有综资入库 -- 都是走exter服务（即外部服务）


分析涉及表：
	SELECT * FROM zz_data_sync_info;
    SELECT * FROM zz_to_rm_rm_area_dc;
    SELECT * FROM zz_to_rm_rm_area_site;
    SELECT * FROM zz_to_rm_rm_area_room;
    SELECT * FROM zz_to_rm_rm_device;
    SELECT * FROM building_area
    
    日志：
    	站点：综资原始数据es转存数据库任务 - 开始处理省份id:01-3

动环综资稽核涉及表（也受分析影响）
	zz_audit_summary_site
	zz_audit_summary_device_type(summary_id对应中间库设备)
	

同步的时候批次要对上，查询的时候批次也要对上
```



```
涉及curl
# 数据中心
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000047'
# 空间-站点（会去查看SSSP-20250110-000002：站点映射关系  -->  对应关系在总结中说明）
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000010'
# 空间-机房
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000018'
# 高压配电
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000025'
# 低压交流配电
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000031'
# 变压器
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000022'
# 低压直流配电
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000036'
# 发电机组
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000032'
# 开关电源
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000035'
# 蓄电池
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000039'
# UPS设备
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000038'
# 空调
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000040'
# 变换设备
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000023'
# 动环监控
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000042'
# 节能设备
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000041'
# 高压直流电源
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000027'
# 高压直流配电
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000028'
# 智能电表
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000043'
# 其它设备
curl --location --request GET 'http://10.1.202.2:31640/migration/v1/zzSyncData/saveZZData?orderIds=SSSP-20241031-000044'
```



# es操作补充

```
导入索引
elasticdump --input=ods_zz_device_power_monitor_mapping.json --output=http://10.1.203.38:9200/ods_zz_device_switch_power_202505m --type=mapping





导入数据-ods_zz_irms_site_map_data
elasticdump --input=ods_zz_device_power_monitor_data.json --output=http://10.1.203.38:9200/ods_zz_device_power_monitor_202507m --type=data --limit 30000



导出es数据

elasticdump --input=http://10.1.203.38:9200/ods_zz_device_high_distribution_2025y --output=ods_zz_device_high_distribution_2025y.json --type=data
```







# 校验逻辑补充【重点】

## 数据校验

```
第一层：
	综资稽核 -- 与分析统计查询
		机楼
            1、稽核汇总 - 机楼匹配（动环机楼数）/单个省份  		= 分析-统计查询（局站信息表-楼栋+通信枢纽楼）/单个省份
            2、稽核汇总 - 机楼匹配（动环机楼数）/总和     	= 分析-统计查询（局站信息表-楼栋+通信枢纽楼）/总和
            3、稽核明细 - 单个省份之和     				= 稽核汇总对应省份机楼数量
            4、稽核明细 - 全部省份之和     				= 稽核汇总对应全部省份稽核数量
            5、稽核汇总 - 机楼匹配（综资待匹配楼数）/单个省份  = 分析-统计查询（局站信息表-楼栋+通信枢纽楼）/单个省份待匹配
            6、稽核汇总 - 机楼匹配（综资待匹配楼数）/总和      = 分析-统计查询（局站信息表-楼栋+通信枢纽楼）/总和
            7、稽核明细 - 单个省份未匹配之和     				= 稽核汇总对应省份机楼未匹配数量
            8、稽核明细 - 全部省份未匹配之和     				= 稽核汇总对应全部省份稽核未匹配数量
			9、数量与局站统计表和实时监控一致
		
		机房
			1、稽核汇总 - 机房匹配（动环机楼数）/单个省份  		= 分析-统计查询（机房信息表-楼栋+通信枢纽楼）/单个省份
            2、稽核汇总 - 机房匹配（动环机楼数）/总和     	= 分析-统计查询（机房信息表-楼栋+通信枢纽楼）/总和
            3、稽核明细 - 单个省份之和     				= 稽核汇总对应省份机楼数量
            4、稽核明细 - 全部省份之和     				= 稽核汇总对应全部省份稽核数量
            5、稽核汇总 - 机房匹配（综资待匹配楼数）/单个省份  = 分析-统计查询（机房信息表-楼栋+通信枢纽楼）/单个省份待匹配
            6、稽核汇总 - 机房匹配（综资待匹配楼数）/总和      = 分析-统计查询（机房信息表-楼栋+通信枢纽楼）/总和
            7、稽核明细 - 单个省份未匹配之和     				= 稽核汇总对应省份机楼未匹配数量
            8、稽核明细 - 全部省份未匹配之和     				= 稽核汇总对应全部省份稽核未匹配数量
            9、数量与实时监控一致
        
        设备（设备匹配情况）
			1、稽核汇总 - 设备匹配（动环机楼数）/单个省份  		= 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/单个省份
            2、稽核汇总 - 设备匹配（动环机楼数）/总和     	= 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/总和
            3、稽核明细 - 单个省份之和     				= 稽核汇总对应省份机楼数量
            4、稽核明细 - 全部省份之和     				= 稽核汇总对应全部省份稽核数量
            5、稽核汇总 - 设备匹配（综资待匹配楼数）/单个省份  = 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/单个省份待匹配
            6、稽核汇总 - 设备匹配（综资待匹配楼数）/总和      = 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/总和
            7、稽核明细 - 单个省份未匹配之和     				= 稽核汇总对应省份设备未匹配数量
            8、稽核明细 - 全部省份未匹配之和     				= 稽核汇总对应全部省份稽核未匹配数量
            9、稽核明细 - 数据中心之和     				= 稽核汇总对应数据中心设备数量
            10、稽核明细 - 通信枢纽楼之和     				= 稽核汇总对应数据中心设备稽核数量
            11、稽核汇总 - 设备匹配（动环机楼数）/数据中心之和  		= 分析-统计查询（设备信息表-楼栋）
            12、稽核汇总 - 设备匹配（动环机楼数）/通信枢纽楼之和     	= 分析-统计查询（设备信息表-通信枢纽楼）
            11、数量与实时监控一致
		
		设备（其他设备匹配）
			1、稽核汇总 - 设备匹配（动环机楼数）/单个省份  		= 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/单个省份
            2、稽核汇总 - 设备匹配（动环机楼数）/总和     	= 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/总和
            3、稽核明细 - 单个省份之和     				= 稽核汇总对应省份机楼数量
            4、稽核明细 - 全部省份之和     				= 稽核汇总对应全部省份稽核数量
            5、稽核汇总 - 设备匹配（综资待匹配楼数）/单个省份  = 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/单个省份待匹配
            6、稽核汇总 - 设备匹配（综资待匹配楼数）/总和      = 分析-统计查询（设备信息表-楼栋+通信枢纽楼）/总和
            7、稽核明细 - 单个省份未匹配之和     				= 稽核汇总对应省份设备未匹配数量
            8、稽核明细 - 全部省份未匹配之和     				= 稽核汇总对应全部省份稽核未匹配数量
            9、数量与实时监控一致
		
		
		
		3、稽核汇总 - 机楼匹配（动环机楼数）/总和     = 分析-统计查询（局站信息表-楼栋+通信枢纽楼）/总和
```



## 分析-统计查询

```
1、局站信息表 —— 动环数量 --（可以根据监控视图，或是局站统计表查看，需要一致：但是目前局站统计表需要确认）
2、设备信息表 —— 动环数量 --（可以根据监控视图，或是设备统计表查看，需要一致）
3、机房信息表 —— 动环数量 --（可以根据监控视图，需要一致）
```











# 补充排查说明

```
1、先看综资数量
2、看综资明细
3、到分析中对应信息表，下载后进行对比

4、可以到综资 - 原始数据，确认数据是否一致
```









# 疑问点

```
为什么站点时0507
	然后设备时0702
		却只有里面的0507被匹配到了？，其他的0507就不行？
		好像省份和地市也要一样



问题：
	1、重新加载不会覆盖之前的，所以需要重新跑
	2、满足条件的，有些没有写入，需要排查下
	3、如果在匹配的时候，有多个power，是不是去重了，只取一个
```

