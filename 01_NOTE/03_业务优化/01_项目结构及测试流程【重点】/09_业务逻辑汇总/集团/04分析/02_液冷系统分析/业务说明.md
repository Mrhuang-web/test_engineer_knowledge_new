# 01服务-数据库表

```
涉及服务：
    currentmonitor  		 -->  实时监控
    configmanagement  		 --> 配置查询都走这个服务（113上面）
    knowledgemanage，mpp	    -->  报表读数（先mpp取数）


涉及数据库：
	38-中间库：
		d_signalh(现在直接用脚本写入mpp，就不走同步了)
	177-spider库
		t_liquid_cooling_config
		t_liquid_cooling_config_parameter
		t_liquid_cooling_refrigeration_room_config
		t_liquid_cooling_primary_side_config
		t_liquid_cooling_cdu_reference_info
		
		t_liquid_cooling_data_statistics
		t_liquid_cooling_primary_side_statistics
		t_liquid_cooling_refrigeration_room_statistics
	114-dh库
		fact_dwd_signal_value
		dim_liquid_cooling_mete_hour
		dwd_device_detail_v
		dws_liquid_cooling_mete_detail_day


数据同步：
	目前写入数据有两种方法
		方法1：通过写入C中间库 -> 然后c-writer写入mpp（需要确保写入任务是开启的，然后c服务正常）
			show all routine LOAD --> 查看任务是否在运行
			fact_dwd_signal_value --> 确保写入d_signalh的数据有同步到该表中
		方法2：使用智勇提供的脚本直接插入mpp
		
		
涉及curl：
    curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-11-01&startTime=2025-11-03&endTime=2025-11-07" -H "accept: application/json"
    curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-10-01&startTime=2025-10-01&endTime=2025-10-03" -H "accept: application/json"
    curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01&startTime=2025-10-01&endTime=2025-10-03" -H "accept: application/json"
    只能传入楼栋或站点进行统计（传入哪个日期，就生成哪个日期的数据）
    
    
纵横执行
	1、【工作流-工作流定义-液冷测试数据采集】输入一个日期，生成该日期前两天的数据
```



# 02业务需求

```不超过5个
前置条件（仅数据中心楼栋和通信枢纽楼才可以）
	需要先在 - 【配置-设备系统-下钻至楼栋/通信枢纽楼-新增液冷系统】
		
		多测点解释：通过设备id+信号编码+信号通道，来区分测点
		多测点会有平均逻辑：
			单设备下，有多个测点，只需要获取对应测点点位置，进行一次平均
			多设备下，有多个测点，需要先对设备1的测点做平均，再算设备1和2的平均（2次平均）
			
		涉及测点：
			工况环境
				干球温度：仅限中央空调主机013351（可选择多个测点，不超过5个）
				湿球温度：仅限中央空调主机013352（可选择多个测点，不超过5个）
				室外湿度：仅限中央空调主机013353（可选择多个测点，不超过5个）
			系统参数
				总流量：		 中央空调末端012325或中央空调主机013323（测点总和）
				一次侧进液温度：  中央空调末端012318或中央空调主机013206（可选择多个测点，不超过5个）
				一次侧出液温度：  中央空调末端012321或中央空调主机013205（可选择多个测点，不超过5个）
			一次侧机组
				关联设备：	   中央空调主机或中央空调末端设备（下方的测点基于该设备来的，仅展示关联设备下的测点）
				水流量：        中央空调主机013323或中央空调末端012325（仅1测点）
				运行频率：	   中央空调主机013330或中央空调末端012339（仅1测点）
				电流：			仅限中央空调末端才会展示配置
			制冷机房
				二次侧供液温度：	仅限中央空调末端012326（可选择多个测点，不超过5个）
				二次侧回液液温度：	仅限中央空调末端012329（可选择多个测点，不超过5个）
				循环水泵水流量：	仅限中央空调末端012333（仅1测点）
				循环水泵运行频率：	仅限中央空调末端012339（仅1测点）
				循环水泵电流：		 仅限中央空调末端012340（仅1测点）
				二次侧供回液压差：	仅限中央空调末端012334（仅1测点）
				二次侧过滤器压差：	仅限中央空调末端012345（仅1测点）
				一次侧过滤器压差：	仅限中央空调末端012344（仅1测点）
				

报表展示：
	4、12、20三个点位前后1小时离点位最近的值[昨天和前天]-两天数据
```



# 03数据流向

```
1、数据写入mpp
2、纵横执行液冷 - 将数据提取到dws_liquid_cooling_mete_detail_day
3、触发curl -> 生成昨天和前天数据（4，12，20）三个点位
```







# 04其他

```
补充：
	通过设备id+信号编码+信号通道，来区分测点
平均逻辑：
	单设备下，有多个测点，只需要获取对应测点点位置，进行一次平均
	多设备下，有多个测点，需要先对设备1的测点做平均，再算设备1和2的平均（2次平均）
C接口接入测点缺失准备【重点】：
	C接口数据准备文件 - m_signal缺失测点，在xlmx文件字典表找
	然后alarm_level，signalnumber，thredshold，nmalarmid（遥测类可以不用写的 - 目前文件里面是因为脏数据）
	注意点：
		m_device -- 最左边对应的是模板【同名字属于同个模板】
		m_signal -- 信号编码对应 最左列也要跟设备的模板要一致
		m_site -- 数据站点接上去的是楼栋，因此可能要两个（数据中心 - 接入到楼栋里面，其余站点直接接到站点即可 - 数据中心（下再建楼栋））
		设备名的命名_可以随意，主要就是用于区分就行（总要的是首列要和测点要导入设备内的测点的首列一致，这样才能匹配到）
设备与测点模板：
	动环中，每个设备都有对应的一套测点模板（即device_model），用于对应设备对应的测点信号 - 直接修改设备测点模板，就可以给设备换一套测点了（不过正常是一一对应的）
涉及中间库：
	中间库：cinterdb_400_jt_gz（38服务中）


1、单机楼概念（指单个楼栋或是单个通信枢纽楼）
2、单设备（存在同个测点，但是多个通道号）
3、多设备（多个相同类型设备-id和名不同，测点相同，通道号不同）
4、一次侧及制冷机房配置中，涉及绑定设备的信息展示设备名称，涉及绑定测点信息展示绑定的测点数量，未绑定展示空值
5、一次侧机组最多4个
6、制冷机房（仅包括综合/IDC/数据/交换机房，其他类型机房不可选）
7、每个制冷机房的CDU，最多20个
```









```
其他的


1、curl -X GET --header 'Accept: text/plain' 'http://localhost:28090/v1/cinterfaceReader/refreshReaderQueue'
数据流向：
	1、当天会获取昨天和前天（04:00:00,12:00:00,20:00:00）,每个时刻前后1小时距离最近的测点值
	2、单设备测点多通道（会对同个测点多通道，各自取到的最近值，进行平均）
	3、多设备测点多通道（会对同设备同个测点多通道，各自取到的最近值，进行平均;再对不同设备之间进行平均）
	
	4、纵横 - 传入日期，则计算传入日期的前天和昨天的数据
	5、curl - 则是传入前天和昨天的日期，进行获取报表数据(precinct_id，目前传入01？，其他的好像不生效，然后日期好想要拉长点)

大概描述数据走向
	正向
		1、中间库（数据写入到中间库，site，room，device，signal，d_signalh）
		2、d_signalh -- 会通过C接口（write写入）,再通过另一个服务到kafka,在流向到mpp的dh库中的fact_dwd_signal_value表（这里有device_spatial_id）
		3、通过mpp中dim_liquid_cooling_mete_hour表,过滤写入fact_dwd_signal_value的数据（即需求逻辑）
		4、再通过dwd_device_detail_v,过滤出对应设备和楼栋/机房的映射关系,最后生成dws_liquid_cooling_mete_detail_day
		5、通过curl执行,会根据配置表的信息，对应的precinct中的dim_spatial_id 取找到mpp中的日表数据;还有device中的dim_device_id对应的数据
	
	逆向：
		1、如果没有数据，先排查中间库数据是否有插入（即站点或机楼在中间库所对应的位置，然后在中间库d_signalh表中找）
		2、如果没有数据,那么久需要先通过所选择的机房（或是造数的机房或设备的dim_spatial_id等,取到fact_dwd_signal_value表看是否有同步进行）
		3、同步进行后,有没有转化到dws_liquid_cooling_mete_detail_day表中
		4、如果也有数据,那就需要看动环中分析表是否有问题
	考虑：
		这些环节中都需要考虑到设备id,测点id,测点code,测点no（才能精准判断是哪个）
	
	疑问（动环跟mpp，之间为啥要用这里有dim_spatial_id这些？）
	


补充问题：
	一次侧机组（关联设备与测点要对应，否则报表数据出不来）
	一次侧机组要不要取机组名？，不然怎么区分
	运行机状态数据没采集出来
	
	目前只有不同设备。且有多个通道号时（计算逻辑：取最近一个点，然后就设备的平均了）
	
	
集团C接口
	下面的操作好像又不行了
	
	液冷数据 - d_signalh 然后同步到mpp的fact  
	（会经过reader服务，里面的lscid要和precinct对应站点和机房的lscid一致，然后resource_code里面的前几位也要一致）
	这样才能同步过去
	write是写入的 （对应哪个什么v啥的）  -- 好像是write不稳定，需要加内存



# curl
curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-11-01&startTime=2025-11-03&endTime=2025-11-07" -H "accept: application/json"
curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-10-01&startTime=2025-10-01&endTime=2025-10-03" -H "accept: application/json"
curl -X GET "http://localhost:28016/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01&startTime=2025-10-01&endTime=2025-10-03" -H "accept: application/json"
只能传入楼栋或站点进行统计




c服务，写道kafka，在写入mpp数据库 
precint 找dim_xxx  找到mpp里面机房信息  -- 在找到devcie_spatixxx
C接口每次重启需要调用reader


修改点：
	1、冷设备名称：机房+液冷
	2、条件不用过滤
	3、测点拖进后机房+测点名称
	4、展开不用到设备层级


没配置测点不会展示







fact_dwd_signal_value
  │— 时段 + 码值过滤
  ▼
tmp_dws_liquid_cooling_mete_1
  │— join dim_liquid_cooling_mete_hour（拿到整点）
  │— row_number 取最近整点
  ▼
tmp_dws_liquid_cooling_mete_2
  │— join dwd_device_detail_v（补维度）
  │— 过滤 site_type in (1,2) 且未删除
  ▼
dws_liquid_cooling_mete_detail_day   （日粒度 + 3 时段 + 最近整点快照）



先要执行mpp的采集,mpp的任务执行完之后  再执行curl



fact_dwd_signal_value 找个表近数据有任务
show all routine LOAD
任务关闭了	
MPP数据库  ：show all routine LOAD


状态多个测点，只取最近的



curl -X GET "http://10.12.7.160:32533/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-11-01&startTime=2025-12-10&endTime=2025-12-10" -H "accept: application/json"
```



curl -X GET "http://10.12.7.160:32533/v1/liquidCoolingReport/scheduleLiquidCoolingReport?precinctId=01-08-08-01-11-01&startTime=2025-08-01&endTime=2025-08-02" -H "accept: application/json"

