# B接口透传协议详细文档

## 1. 协议概述
B接口透传协议用于FSU与SC之间透传串口数据，支持上行（FSU→SC）和下行（SC→FSU）两个方向，以及FSU透传通道心跳功能。

## 2. 协议格式

### 2.1 基本字段说明
| 字段名 | 字节长度 | 描述 |
|--------|----------|------|
| P_header | 1 byte | 协议包开始标识，固定为0xFF |
| P_dest_addr | 20 bytes | 目标设备地址 |
| P_src_addr | 8 bytes | 源设备地址 |
| P_subDevType | 1 byte | 子设备类型：1-串口设备，2-USB设备，3-IP网络设备 |
| P_subDev_addr | 1 byte | 透传模块：Bit0~4:串口号；Bit5~8：虚拟设备号 |
| P_pLen | 2 bytes | 协议族数据包长度 |
| RtnFlag | 1 byte | 设置/应答类型 |
| CommType | 2 bytes | 命令编号 |
| P_verify | 1 byte | 校验字段，采用异或校验，不包含包头和包尾 |
| P_tailer | 1 byte | 协议包结束标识，固定为0xFE |

### 2.2 转义规则
当协议包头和包尾之间的数据出现0xFF、0xFE或0xFD时，需要转义：
- 0xFF → 0xFD 0x00
- 0xFE → 0xFD 0x01
- 0xFD → 0xFD 0x02

## 3. 功能指令

### 3.1 透传串口数据（命令号：0x0001）

#### 下行方向（SC→FSU）
| 地址 | 协议字段 | 字段长度 | 字段描述 | 默认值 |
|------|----------|----------|----------|--------|
| 0 | P_header | 1 byte | 协议包开始标识 | 0xFF |
| 1-20 | P_dest_addr | 20 bytes | 目标设备地址 | FSU的ID |
| 21-28 | P_src_addr | 8 bytes | 源设备地址 | SC的地址取值为00 |
| 29 | P_subDevType | 1 byte | 子设备类型 | 1 |
| 30 | P_subDev_addr | 1 byte | 透传模块 | 00 |
| 31-32 | P_pLen | 2 bytes | 协议族数据包长度 | 5+N |
| 33 | RtnFlag | 1 byte | 设置/应答类型 | 0xee |
| 34-35 | CommType | 2 bytes | 命令编号 | 0x0001 |
| 36-37 | 透传数据长度 | 2 bytes | 透传数据长度 | - |
| 38-(38+N-1) | 透传数据 | N bytes | 数据内容 | - |
| 38+N | P_verify | 1 byte | 校验字段 | - |
| 39+N | P_tailer | 1 byte | 协议包结束标识 | 0xFE |

#### 上行方向（FSU→SC）
| 地址 | 协议字段 | 字段长度 | 字段描述 | 默认值 |
|------|----------|----------|----------|--------|
| 0 | P_header | 1 byte | 协议包开始标识 | 0xFF |
| 1-8 | P_dest_addr | 8 bytes | 目标设备地址 | SC的地址取值为0x00 |
| 9-28 | P_src_addr | 20 bytes | 源设备地址 | FSU的ID |
| 29 | P_subDevType | 1 byte | 子设备类型 | 1 |
| 30 | P_subDev_addr | 1 byte | 透传模块 | 00 |
| 31-32 | P_pLen | 2 bytes | 协议族数据包长度 | 5+N |
| 33 | RtnFlag | 1 byte | 设置/应答类型 | 0x00 |
| 34-35 | CommType | 2 bytes | 命令编号 | 0x0001 |
| 36-37 | 透传数据长度 | 2 bytes | 透传数据长度 | - |
| 38-(38+N-1) | 透传数据 | N bytes | 数据内容 | - |
| 38+N | P_verify | 1 byte | 校验字段 | - |
| 39+N | P_tailer | 1 byte | 协议包结束标识 | 0xFE |

### 3.2 FSU透传通道心跳（命令号：0x0002）

#### 数据方向：FSU→SC
| 地址 | 协议字段 | 字段长度 | 字段描述 | 默认值 |
|------|----------|----------|----------|--------|
| 0 | P_header | 1 byte | 协议包开始标识 | 0xFF |
| 1-8 | P_addr | 8 bytes | 目标设备地址 | SC的地址为0x00 |
| 9-28 | P_src_addr | 20 bytes | 源设备地址 | FSU的ID |
| 29 | P_subDevType | 1 byte | 子设备类型 | 1 |
| 30 | P_subDev_addr | 1 byte | 透传模块 | 00 |
| 31-32 | P_pLen | 2 bytes | 协议族数据包长度 | 3 |
| 33 | RtnFlag | 1 byte | - | 0xED |
| 34-35 | CommandType | 2 bytes | 命令号 | 0x0002 |
| 36 | P_verify | 1 byte | 校验字段 | - |
| 37 | P_tailer | 1 byte | 协议包结束标识 | 0xFE |

## 4. 功能说明

### 4.1 透传串口数据功能
- **功能**：用于透传串口数据包，支持上下行两个方向
- **应用场景**：FSU与SC之间传输门禁设备的数据
- **数据格式**：透传数据部分为具体的门禁协议数据

### 4.2 心跳功能
- **功能**：FSU定时向SC发送心跳包，用于判断链路连接状态
- **发送间隔**：建议每隔120秒发送一次
- **超时判断**：SC在360秒内未收到心跳消息，则认为透传通道中断

## 5. 注意事项

1. 所有协议包必须包含完整的包头和包尾
2. 数据部分需要按照转义规则进行转义
3. 校验字段必须正确计算，否则会导致数据丢弃
4. 目标设备地址和源设备地址必须填写正确
5. 子设备类型和子设备地址需要根据实际情况填写
6. 心跳包必须按时发送，以维持链路连接

## 6. 典型应用流程

1. SC向FSU发送下行透传命令（0x0001），包含门禁设备的控制指令
2. FSU将透传数据转发给门禁设备
3. 门禁设备执行命令并返回结果
4. FSU将门禁设备的返回结果通过上行透传命令（0x0001）发送给SC
5. FSU定时向SC发送心跳包（0x0002），维持链路连接

## 7. 协议扩展

- 当需要支持新的子设备类型时，可以扩展P_subDevType字段的取值
- 当需要新增功能时，可以添加新的命令号
- 扩展后的协议必须保持向前兼容性