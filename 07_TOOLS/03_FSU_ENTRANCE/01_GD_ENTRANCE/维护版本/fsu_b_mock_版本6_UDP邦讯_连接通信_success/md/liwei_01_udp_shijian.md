# ACUC3.0门禁控制器协议（提取版）
## 一、通信规范
### 1. 通信速率与数据格式
- **通信速率**：9600/19200/2400 B/S 等，设备支持速率调整
- **数据格式**：1起始位、8数据位、1停止位，校验方式支持无校验/奇校验/偶校验/MARK(1)校验/SPACE(0)校验
- **协议数据包基本格式**：

| 序号 | 字段         | 字节数 | 符号       | 说明                                                                 |
|------|--------------|--------|------------|----------------------------------------------------------------------|
| 1    | 起始符       | 1      | SOI        | 固定值0x7E（START OF INFORMATION）                                   |
| 2    | 版本         | 1      | VER        | 通信协议版本，固定0x10（表示1.0）                                    |
| 3    | 组内地址     | 1      | ADR        | 设备RS485地址，有效值1-254（0和255保留）                              |
| 4    | 类码与组地址 | 1      | CID1       | D7-D4为设备分类码（门禁类固定0x8），D3-D0为设备分组号（0-15）         |
| 5    | 类别/返回码  | 1      | CID2/RTN   | 下发命令时为CID2（命令分类码），应答时为RTN（处理结果码）             |
| 6    | 参数长度校验 | 2      | L.TH       | 携带参数的长度标识+校验，计算规则见协议详情                           |
| 7    | 参数         | N字节  | INFO       | 下发时为命令参数（COMINFO），应答时为返回数据（DATAINFO）             |
| 8    | 桢校验       | 2      | CHK-SUM    | 从VER到INFO最后字节的ASCII码累加求和，模65536取补（高位在前）         |
| 9    | 结束符       | 1      | EOI        | 固定值0x0D（END OF INFORMATION）                                     |

### 2. 数据传输与超时
- **传输方法**：SOI、EOI按单字节直接发送；VER至SUM按字节拆分为高4位+低4位ASCII码发送
- **超时时间**：500毫秒

### 3. 设备应答（RTN值说明）
| RTN值  | 含义描述                                                                 |
|--------|--------------------------------------------------------------------------|
| 0x00   | 正常执行命令                                                             |
| 0x01   | 协议版本不符                                                             |
| 0x02   | 命令帧累加和校验错误                                                     |
| 0x03   | 命令帧参数部分累加和校验错误                                             |
| 0x04   | 无效的CID2值                                                             |
| 0x05   | 无法识别的命令格式                                                       |
| 0x06   | 命令帧数据信息部分含无效数据                                             |
| 0x07   | 无访问权限                                                               |
| 0xE0   | 密码确认不正确                                                           |
| 0xE1   | 密码修改不成功                                                           |
| 0xE2   | 对应设置项存储空间已满                                                   |
| 0xE3   | 参数修改/删除不成功                                                      |
| 0xE4   | 对应设置项存储空间已空                                                   |
| 0xE5   | 无对应信息项                                                             |
| 0xE6   | 重复设置相同ID用户（保留原用户）                                         |
| 0xE7   | 重复设置相同卡号（不同用户）                                             |
| 0xE8   | 重复设置完全相同用户                                                     |
| 0xEF   | 未知错误                                                                |

## 二、通信命令分类
1. 访问权限确认（0x48）
2. 设置命令（0x49）
3. 读取信息命令（0x4A）

## 三、访问权限确认命令（0x48）
| 命令功能               | COMMAND GROUP | COMMAND TYPE | 数据参数                          | 应答说明                                  |
|------------------------|---------------|--------------|-----------------------------------|-------------------------------------------|
| 访问权限确认           | 0xF0          | 0xE0         | 5字节SM密码（2字节系统密码+3字节BCD键盘密码） | 密码正确返回RTN=0，错误返回RTN=0xE0        |
| 访问权限取消           | 0xF0          | 0xE1         | 无                                | 成功返回RTN=0                              |
| 修改SM访问密码         | 0xF0          | 0xE2         | 5字节新密码+1字节校验码（新密码异或值）     | 成功返回RTN=0，失败返回RTN=0xE1            |

## 四、设置命令（0x49）
### 1. 设置日期时间（0xE0）
- **COMMAND TYPE**：0xE0
- **数据参数**：年(2字节)、月、日、星期、时、分、秒（共8字节BCD，年范围2000-2099）
- **应答**：成功RTN=0，失败非0

### 2. 准进时段设置
| 命令功能               | COMMAND TYPE | 数据参数                          | 说明                                                                 |
|------------------------|--------------|-----------------------------------|----------------------------------------------------------------------|
| 恢复缺省时段           | 0xE1         | 1字节=1                           | 工作日/休息日/星期准进时段全为00:00-23:59，管理时段无效               |
| 置所有时段无效         | 0xE1         | 1字节=0                           | 所有准进时段及管理时段均无效                                         |
| 设置工作日准进时段     | 0xE1         | 1字节GROUP No.(1-4)+16字节时段列表 | 4个时段（每个时段4字节BCD：HH:MM起始+HH:MM结束）                     |
| 设置非工作日准进时段   | 0xE2         | 1字节=1+16字节时段列表            | 1张列表，含4个准进时段                                               |
| 设定星期准进时段列表   | 0xF1         | 26字节（表号+星期+6个时段）       | 16张表，每张表7天，每天6个时段（每个时段4字节BCD）                   |

### 3. 用户管理
| 命令功能               | COMMAND TYPE | 数据参数                          | 应答说明                                  |
|------------------------|--------------|-----------------------------------|-------------------------------------------|
| 增加用户               | 0xE3         | 16字节用户描述（卡号+ID+密码+有效期+权限） | 成功RTN=0，满员RTN=0xE2，重复卡号RTN=0xE7 |
| 更新用户信息           | 0xE3         | 卡号+需更新字段（密码/有效期/权限等）     | 成功RTN=0                                 |
| 删除用户（按卡号）     | 0xE4         | 1字节=0+5字节卡号                 | 成功RTN=0，无该用户RTN=0xE5               |
| 删除用户（按ID）       | 0xE4         | 1字节=1+4字节用户ID               | 成功RTN=0，无该用户RTN=0xE5               |
| 全部删除用户           | 0xE4         | 1字节=2+5字节全0                  | 成功RTN=0                                 |

### 4. 门特性参数设置
| 命令功能               | COMMAND TYPE | 数据参数                          | 说明                                                                 |
|------------------------|--------------|-----------------------------------|----------------------------------------------------------------------|
| 门锁继电器执行时间     | 0xE6         | 1字节（1-255，单位0.1秒）         | 如50表示5秒                                                          |
| 开门等待进入延时       | 0xE7         | 1字节（20-255，单位0.1秒）         | 超时未进入则报警                                                     |
| 红外报警确认时间       | 0xE8         | 1字节（20-255，单位0.1秒）         | 延时后输出报警信号                                                   |
| 异地报警延时           | 0xE9         | 1字节（0-255，单位0.1秒）         | 0按25.6秒处理                                                        |
| 红外监控开启延时       | 0xEF         | 2字节（0+延时值20-255）            | 开启者离开时间                                                       |
| 感应器特性（第一控制字）| 0xE5         | 1字节（D0-D7位定义）               | 门磁/红外监控、电磁锁类型、开门方式等控制                             |
| 联动及报警输出特性     | 0xFC         | 1字节（第二控制字）                | 联动输入电平、报警输出方式、紧急事件处理等                           |
| 电磁锁类型设定         | 0xF9         | 1字节（0=自动锁，1=机械锁）        |                                                                      |
| 维根感应头设置         | 0xEE         | 1字节（D0-D3维根类型，D4-D7卡号获取方式） | 支持维根26/36/44/34                                                  |

### 5. 门控器工作方式设置
| 命令功能               | COMMAND TYPE | 数据参数                          | 说明                                                                 |
|------------------------|--------------|-----------------------------------|----------------------------------------------------------------------|
| 启用/关闭<ENT>开门     | 0xF4         | 1字节（0=关闭，1=启用）            | CHD805键盘专用                                                       |
| 刷卡加密码设置         | 0xF5         | 1字节（0=无需密码，1=需密码）      |                                                                      |
| 手动开门按键控制       | 0xF8         | 1字节（0=启用，1=关闭）            |                                                                      |
| 红外监控布防/撤防      | 0xFA         | 1字节（0=撤防，1=布防）            |                                                                      |
| 门开关监控布防/撤防    | 0xFB         | 1字节（0=撤防，1=布防）            |                                                                      |
| 第三控制字设置         | 0xFD         | 1字节（D0-D7位定义）               | 常开门/闭门时段启用、胁迫报警、密码时段等控制                         |

### 6. 节假日管理
| 命令功能               | COMMAND TYPE | 数据参数                          | 说明                                                                 |
|------------------------|--------------|-----------------------------------|----------------------------------------------------------------------|
| 设定星期休息日         | 0xEA         | 2字节（1-7，代表星期几）           | 如7,0xFF表示仅星期日休息                                             |
| 设定法定节假日         | 0xEB         | 2字节（MM,DD BCD）                 | 最多存储40个                                                         |
| 删除一组节假日         | 0xEC         | 2字节（MM,DD BCD）                 | 全0则清空所有                                                       |

### 7. 远程开关门
| 命令功能               | COMMAND TYPE | 数据参数                          | 说明                                                                 |
|------------------------|--------------|-----------------------------------|----------------------------------------------------------------------|
| 单一放行（无操作员信息）| 0xED         | 1字节（1=开门，0=不操作）          |                                                                      |
| 单一放行（有操作员信息）| 0xED         | 1字节=1+5字节操作员编号            | 记录操作员信息                                                       |
| 远程常开一段时间       | 0xFE         | 2字节（0+时间1-255分钟）           |                                                                      |
| 远程常闭一段时间       | 0xFE         | 2字节（1+时间1-255分钟）           | 常闭期间不接受刷卡开门                                               |
| 启动声光报警器         | 0xFF         | 2字节（1+0）                       |                                                                      |
| 停止声光报警器         | 0xFF         | 2字节（2+0）                       |                                                                      |

## 五、读取信息命令（0x4A）
### 1. 读取实时钟（0xE0）
- **COMMAND TYPE**：0xE0
- **数据参数**：1字节=0
- **返回数据**：年(2字节)、月、日、星期、时、分、秒（8字节BCD）

### 2. 读取记录信息
| 命令功能               | COMMAND TYPE | 数据参数                          | 返回数据                          |
|------------------------|--------------|-----------------------------------|-----------------------------------|
| 读取历史记录柜桶参数   | 0xE1         | 1字节=0                           | 9字节（BOTTOM/SAVEP/LOADP/MF/MAXLEN） |
| 顺序读取一条历史记录   | 0xE2         | 无                                 | 14字节记录（见附录格式）          |
| 随机读取记录           | 0xE2         | 2字节指定位置（低位在前）          | 14字节记录                        |
| 读取最新事件记录       | 0xEE         | 1字节=0                           | 14字节最新事件记录                |

### 3. 读取时段信息
| 命令功能               | COMMAND TYPE | 数据参数                          | 返回数据                          |
|------------------------|--------------|-----------------------------------|-----------------------------------|
| 读取工作日准进时段     | 0xE3         | 1字节GROUP No.(1-4)               | 16字节时段列表（4个时段）         |
| 读取非工作日准进时段   | 0xE4         | 1字节=1                           | 16字节时段列表                    |
| 读取星期准进时段       | 0xEB         | 2字节（表号0-15+星期1-7）         | 24字节（6个时段）                 |
| 读取常开门时段         | 0xE4         | 1字节=5                           | 16字节时段列表                    |
| 读取二次加密时段       | 0xE4         | 1字节=6                           | 16字节时段列表                    |

### 4. 读取用户信息
| 命令功能               | COMMAND TYPE | 数据参数                          | 返回数据                          |
|------------------------|--------------|-----------------------------------|-----------------------------------|
| 读取用户总数           | 0xE5         | 1字节=0                           | 2字节HEX（低位在前）              |
| 读取指定位置用户信息   | 0xE6         | 2字节存储位置（低位在前）          | 16字节用户描述（卡号+ID+密码等）  |
| 查询用户（按ID）       | 0xE6         | 4字节用户ID                       | 16字节用户描述（无权限返回RTN=0xE0） |
| 查询用户（按卡号）     | 0xE6         | 6字节卡号                         | 16字节用户描述（无权限返回RTN=0xE0） |

### 5. 读取设备信息
| 命令功能               | COMMAND TYPE | 数据参数                          | 返回数据                          |
|------------------------|--------------|-----------------------------------|-----------------------------------|
| 读取设备名称及版本号   | 0xEF         | 1字节=0                           | 格式：ACUC_XXX-V3.xx.xxx-HW:x.xx  |
| 读取控制信息           | 0xE8         | 1字节=0                           | 5字节（控制字+延时参数+卡号获取方式） |
| 读取第二、三控制字     | 0xEC         | 1字节=0                           | 2字节（第二控制字+第三控制字）    |

## 六、附录：门控器(SM)的历史记录格式
### 1. 记录通用结构
| 字段         | 字节数 | 说明                                                                 |
|--------------|--------|----------------------------------------------------------------------|
| 事件来源     | 5      | 卡号/用户ID/全0（根据事件类型）                                      |
| 日期时间     | 7      | 年(2)、月、日、时、分、秒（BCD格式）                                 |
| 状态         | 1      | STATUS(D0-D7位，记录事件细节)                                        |
| 备注         | 1      | REMARK（事件类型标识，D7=1表示已读取，D7=0表示未读取）                |

### 2. 事件类型与对应REMARK值
| 事件类型                     | REMARK值 | 事件来源说明                          | STATUS位关键说明                                                  |
|------------------------------|----------|---------------------------------------|-------------------------------------------------------------------|
| 刷卡开门                     | 0x00     | 5字节卡号                             | D7=1（密码确认），D5=1（未进入），D1=1（主体刷卡）                 |
| 键入ID及密码开门             | 0x01     | 1字节00+4字节用户ID                   | D7=1（固定）                                                      |
| 远程开门                     | 0x02     | 5字节全0                              | D1=0（固定）                                                      |
| 手动开门                     | 0x03     | 5字节全0                              | D1=0（固定）                                                      |
| 联动开门                     | 0x04     | 5字节全0                              |                                                                   |
| 报警（红外/门磁等）          | 0x05     | 4字节全0+1字节报警源AS                | AS=0（红外报警开始），AS=2（非正常开门），AS=6（存储错误）         |
| SM掉电记录                   | 0x06     | 重新上电时间（月/日/时/分/秒）        | 记录上电时输入线状态                                              |
| 内部控制参数修改             | 0x07     | 4字节全0+1字节修改标记                | D0=1（改密码），D2=1（增用户），D5=1（改时段）                     |
| 无效卡刷卡                   | 0x08     | 5字节卡号                             |                                                                   |
| 卡片过期                     | 0x09     | 5字节卡号                             |                                                                   |
| 无进入权限                   | 0x0A     | 5字节卡号                             |                                                                   |
| 密码三次错误                 | 0x0B     | 5字节卡号                             |                                                                   |
| 消防联动输入（开始/结束）    | 0x22     | 5字节全0（开始）/全0+1（结束）        |                                                                   |
| 钥匙开门                     | 0x30     | 5字节全0                              | D6=1（原门开），D5=1（未进入）                                    |

### 3. 报警源AS值说明
| AS值  | 报警类型描述                     |
|-------|----------------------------------|
| 0x00  | 红外报警开始                     |
| 0x01  | 红外停止报警                     |
| 0x02  | 非正常开门                       |
| 0x03  | 非正常状态关门                   |
| 0x04  | 联动I2有效                       |
| 0x05  | 联动I2无效                       |
| 0x06  | SM内部存储器错误（已初始化）     |
| 0x07  | 红外监测关闭                     |
| 0x08  | 红外监测开启                     |
| 0x09  | 门碰开关监测关闭                 |
| 0x0A  | 门碰开关监测开启                 |
| 0x86  | 锁舌状态告警（D5=1告警产生）     |