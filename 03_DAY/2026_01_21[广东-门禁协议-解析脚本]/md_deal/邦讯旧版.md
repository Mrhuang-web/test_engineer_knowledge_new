# 邦讯门禁控制器协议（旧版202003）详细文档

## 1. 协议概述
邦讯门禁控制器协议（旧版202003）用于门禁系统和考勤系统，支持485控制器和.NET控制器两种类型，提供基础功能和扩展功能。

## 2. 设备类型

### 2.1 485控制器（串口通信）
| 序列号范围 | 产品型号 | 说明 |
|------------|----------|------|
| 11000-19999 | AL500A | 单门双向485控制器 |
| 21000-29999 | AL500B | 双门双向485控制器 |
| 41000-49999 | AL500C | 四门单向485控制器 |

### 2.2 .NET控制器（UDP通信）
| 序列号范围 | 产品型号 | 说明 |
|------------|----------|------|
| 34000-39999 | AL600A.NET | 单门双向.NET控制器 |
| 50000-59999 | AL600B.NET | 双门双向.NET控制器 |
| 60000-64999 | AL600C.NET | 四门单向.NET控制器 |

## 3. 通信参数
- 串口通信速率：9600,N,8,1
- UDP通信默认端口：60000

## 4. 基本格式

### 4.1 短时间格式

#### 4.1.1 Time(HMS)（时分秒）
| Bit Position | 0-4 | 5-9 | B-F |
|--------------|-----|-----|-----|
| Length(bit) | 5 | 6 | 5 |
| Contents | Hours(时) | Minutes(分) | 2-second increments(2秒) |
| Value Range | 0–23 | 0–59 | 0-29 in 2-second intervals |

#### 4.1.2 Date(YMD)（年月日）
| Bit Position | 0-6 | 7-A | B-F |
|--------------|-----|-----|-----|
| Length(bit) | 7 | 4 | 5 |
| Contents | Year(年) | Month(月) | Day(日) |
| Value Range | 0–119(relative to 2000) | 1–12 | 1–31 |

### 4.2 记录格式
卡号（4字节）+ 刷卡年月日（2字节）+ 刷卡时分秒（2字节）+ 记录状态（1字节）

## 5. 功能分类

### 5.1 基础功能
- 时间相关：读取时间、校准时间
- 记录相关：提取记录、删除记录
- 权限相关：下传权限、修改权限、删除权限、清空权限、读取权限
- 时段相关：修改时段、读取时段
- 门控制相关：设置门在线/常开/常闭、设置开门延时、远程开门

### 5.2 扩展功能
- 设备管理：搜索TCPIP控制器、配置IP
- 特殊功能：启用密码键盘、启用报警门磁事件记录、双门或多门互锁、首卡开门、多卡开门、胁迫密码、超级密码开门、输"*卡号*密码#"开门、定时任务、扩展板设置
- 系统操作：控制器恢复出厂化设置（格式化）

### 5.3 测试案例演示功能
- 读取控制器运行信息（时间、刷卡记录数、权限数、最近一条刷卡记录、门磁状态、按钮状态、故障信息）
- 读取控制器IP、设置IP（仅用于.NET控制器）
- 校准控制器时间、远程开1号门、提取记录、删除已提取的记录
- 发送权限操作（先清空权限，再添加权限）、发送控制时段、实时监控

## 6. 核心功能指令

### 6.1 读取运行状态信息（1081）
- **功能**：读取控制器的运行状态信息
- **应用场景**：建议从该指令开始控制器操作
- **返回数据**：时间、刷卡记录数、权限数、最近一条刷卡记录、门磁状态、按钮状态、故障信息

### 6.2 格式化指令（10FF）
- **功能**：对设备恢复出厂化设置
- **应用场景**：开发过程中用于重置设备
- **注意事项**：执行该指令会清空所有数据，谨慎使用

### 6.3 远程开门指令
- **功能**：远程控制开门
- **参数**：门号
- **应用场景**：远程控制门禁开门

### 6.4 提取记录指令
- **功能**：提取控制器中的刷卡记录
- **返回数据**：卡号、刷卡时间、记录状态等

### 6.5 设置门状态指令
- **功能**：设置门的状态（在线/常开/常闭）
- **参数**：门号、状态值
- **应用场景**：根据需要设置门的工作模式

## 7. 卡号说明
日常中ID卡或IC卡的卡号，在本协议内由区号+ID号组成（依据Motorola卡定义）。例如ID卡卡号25409969，协议中区号=254，ID号=09969。

## 8. 注意事项

1. 该通讯协议仅推荐用于门禁系统和考勤系统，不建议用于其他应用场合
2. 动态库仅适用于XP以上操作系统，不可用于Windows2000及以下操作系统
3. 建议从"读取运行状态信息"指令开始控制器操作
4. 开发过程中，可采用格式化指令对设备恢复出厂化设置
5. 通讯过程中需要注意数据的完整性和正确性
6. 对于.NET控制器，需要注意UDP通信的可靠性问题
7. 权限操作需要谨慎执行，避免误操作导致权限丢失
8. 记录提取后，建议及时删除已提取的记录，以释放存储空间

## 9. 典型应用流程

1. 初始化通信连接
2. 读取控制器运行状态信息（1081）
3. 校准控制器时间
4. 根据需要设置门状态和开门延时
5. 下传权限信息
6. 实时监控门禁状态
7. 定期提取刷卡记录
8. 删除已提取的记录

## 10. 故障处理

1. 通信超时：检查通信线路、设备地址和通信参数
2. 命令执行失败：检查命令格式、参数是否正确
3. 记录提取失败：检查记录存储空间是否已满
4. 权限下传失败：检查权限数据格式、控制器存储空间是否已满

## 11. 协议扩展

- 该协议支持后续功能扩展
- 新增功能会通过新的命令号实现
- 扩展后的协议保持向前兼容性

## 12. 开发建议

1. 使用厂家提供的动态连接库可以简化开发工作
2. 建议先进行简单功能测试，再逐步扩展到复杂功能
3. 注意异常情况的处理，提高系统的稳定性
4. 定期备份控制器数据，防止数据丢失
5. 遵循协议规范，确保与控制器的正常通信