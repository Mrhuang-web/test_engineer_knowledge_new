\# BASS-260R门禁设备控制系统2M软件版本通讯协议 - 产品名称：BASS-260R门禁260R设备控制系统 - 版本：V2.1 - 编辑软件：Microsoft Office 2000中文版 ## 概述 局站控制单元（SUPERVISION UNIT，以下简称“上位机”或SU）与BASS-260R之间的通信，采用“主-从”方式。主方（SU）发送设置命令或读取命令给260R设备，260R设备将设置结果应答SU，或将读取的信息返回给SU。 ## 一、通信规范 ### 1.1 通信速率与数据格式 #### 1.1.1 通信速率 9600，数据格式：1起始位，8数据位，1停止位，校验方式：无校验。 #### 1.1.2 信息交换的数据帧（命令数据包，或信息数据包） 协议数据包的基本格式如下： |序号|1|2|3|4|5|6|7|8|9| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |字段|起始符|版本|组内地址|类码与组地址|类别|参数长度校验|参数|帧校验|结束符| |字节数|1|1|1|1|1|2|N字节|2|1| |符号|SOI|VER|ADR|CID1|CID2/RTN|L.TH|INFO|CHK-SUM|EOI| - **SOI**：发送信息起始符，=7EH（START OF INFORMATION） - **EOI**：发送信息结束符，=0DH（END OF INFORMATION） - **VER**：通信协议的版本（=20H，表示2.0），本次协议版本号V2.1，上次协议版本号V2.0。版本号处理规则：设备需判断命令的版本号，不支持则返回“RTN=01H VER不符，命令未执行”错误提示信息，且协议中版本号为当前最新版本号；支持则返回相应应答信息，回复信息的版本号和中心命令的版本号一致。 - **ADR**：被定名设备（260R设备）的RS485网上地址（设备ID），有效值：1-254。 - **CID1**：一字节为设备分类码及分组码组合（D7—D0，D7高位）。其中D7—D4为设备分类码，环境控制类=8（D7=1，D6=D5=D4=0）；D3—D0为设备分组号（0—15）。意义：当同一系统中设备数目多于254个时，将其分组，最多可有16*254个设备在同一系统中。260R设备暂时固定分组码=0，因此CID1=80H。 - **CID2/RTN**：主控制机（SU）发送命令时，CID2是命令的分类码，区分给不同类设备的命令；260R设备向SU回答时为RTN，即对上位机命令进行处理的结果。 - **L.TH**：为携带参数的长度标识部分（计算见后） - **INFO**：传递的信息部分（不同设备可有不同定义），SU对260R设备命令时为命令参数COMINFO（包括命令分类、命令号、参数）；260R设备对SU的回复时为返回数据DATAINFO（参数信息）。 - **CHK-SUM**：传送一帧信息的检查和，从VER开始到INFO最后字节结束，都参与计算。SUM是两字节，高位在前。 ### 1.2 数据传输与超时错 监控系统为分布式结构，监控单元（SU）与260R设备的通信为主从方式，监控单元为上位机，260R设备为下位机。 通信过程：SU呼叫260R设备并下发命令，260R设备收到命令后返回响应信息。500ms（毫秒）内，SU接收不到260R设备响应信息或响应信息错误，则认为本次通信过程失败。 #### （1）传输的方法 SOI、EOI是按单字节（HEX）直接发送，其它（从VER至SUM结束）都是将单字节（HEX）按高半4位（0-9，A-F）、低半4位（0-9，A-F）拆分开，按ASCII码发送，先高4位ASCII码，后低4位ASCII码。 SU与260R设备之间的通信有以下两种： - 设置260R设备参数命令； - 读取260R设备信息的命令。 SU发送命令（设置260R设备工作参数，或读取260R设备信息）： |序号|1|2|3|4|5|6|7|8|9| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|CID2|L.TH|COMINFO|SUM|EOI| 260R设备对SU的设置命令的应答： |序号|1|2|3|4|5|6|7|8|9| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |字节|1|1|1|1|1|2|无|2|1| |格式|SOI|VER|ADR|CID1|RTN|0,0|无|SUM|EOI| 260R设备对SU读取命令的返回格式： |序号|1|2|3|4|5|6|7|8|9| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |字节|1|1|1|1|1|2|N|2|1| |格式|SOI|VER|ADR|CID1|RTN|L.TH|DATAINFO|SUM|EOI| **说明如下**： - **SOI**：信息传输起始标志位（1字节），START OF INFORMATION，固定值=0X7E，发送时按一字节（7EH）发送； - **VER**：通信协议版本号（从0X20开始）； - **ADR**：设备地址描述（1—254；0和255保留）； - **CID1**：设备类型标识控制码（对门控器高半字节=8），兼作扩展ADR用（设备多于254个时，其分组号在CID1的低半字节）； - **CID2/RTN**：SU向260R设备发送命令时，该位为CID2，表明命令的不同内容；260R设备向SU发应答时，该位为RTN（见下述）； - **L.TH（LENGTH）**：命令帧中“数据信息部份”的字节长度表示（两字节）： |高字节（D15-D12）|高字节（D11-D8）|低字节（D7-D4）|低字节（D3-D0）| | ---- | ---- | ---- | ---- | |校验码LCHKSUM|长度标示码LENID（表示INFO的传送中ASC码的字节数）|长度标示码LENID（表示INFO的传送中ASC码的字节数）|长度标示码LENID（表示INFO的传送中ASC码的字节数）| 数据信息部份的字节长度=L（即有L个字节数据为命令的参数），那么发送的ASCII码个数LENID=2L，按4位（BIT）一组，即（D11，D10，D9，D8）（D7，D6，D5，D4）；（D3，D2，D1，D0）；仍按4位（BIT）相累加，结果模16后，对16取补（即4BIT求反加1），作为LCHKSUM（D15，D14，D13，D12）； 检验方法：从D15到D0按4BIT组成4个4位数，全部相加，结果得零； - **INFO**：SU向260R设备发送命令时，为COMMAND INFO；260R设备向SU发应答时，为DATA INFO； - **SUM（CHECKSUM）**：数据帧的校验码，CHECKSUM的计算是：整个数据帧中除SOI、EOI和SUM本身之外的其他字符，按发送的ASCII码累加求和（双字节和），将结果模65536后取补运算（余数取反加1）。高位在前，低位在后； - **EOI**：结束码（固定为0DH，发送是按0DH直接发送）。 #### （2）超时错时间 500毫秒（不包括传输时间） ### 1.3 设备应答 设备260R设备应答或返回的RTN基本值： - RTN=00H：260R设备正常执行SU发来的命令。 - RTN=04H：260R设备内部相应设置项的存储空间已空。 - RTN=06H：260R设备接收的命令帧，数据信息部份有无效数据。 - RTN=E3H：SU对260R设备内部参数的修改（或删除）不成功。 - RTN=E4H：260R设备内部相应设置项的存储空间已满。 - RTN=EFH：其他错误。 ## 二、设置命令 SU通过设置命令可以对260R设备的所有工作参数进行设定 SU发送的命令帧：CID2=49H SU发送设置命令的COMMAND INFO部分如下： |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |2.0|0XF1|0XE0至0XFB|参数若干字节| |2.1|0XF3|0XE0至0XFB|参数若干字节| ### 2.1 设置日期时间 #### 2.1.1 设置日期时间的命令 - COMMAND TYPE=0XE0 - DATAF=年（2），月，日，星期，时，分，秒，共8字节（BCD）；其中：年（2000-2099），2字节，月（1-12）；日（1-31），星期（1-7，=7代表星期日）。 260R设备返回： - RTN=0，表示设置成功； - RTN=EFH，表示不成功。 ### 2.2 设置准进时段 #### 2.2.1 设定星期准进时间段列表 - COMMAND TYPE=0XF1；DATAF=26字节。 - 前1、2字节：表示第几张表的星期几，如9，6表示第9+1张表的星期六。260R设备内最多存储16张表，每张表有7天（星期一至星期日），每天有6个准进时段，每个时段占用4字节（表示“起始时间(结束时间”的BCD值）。 - 第一字节的有效值0-15（=0X0F）， - 第二字节的有效值1-7 - 从第三字节至26字节该设定日的6个准进列表，每个准进列表占4字节（BCD，表示“起始时间(结束时间”） ``` HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束)；HH：MM (起始) ( HH:MM (结束) ``` 260R设备返回： - RTN=0，表示设置成功； - RTN=EFH，表示不成功。 **注意**： 1. 260R设备厂家只对编号为0～4的表进行设置（前5张表），对于编号5～15的设置命令统一返回EFH。 2. 设置时，必须从第一张表的星期一开始设置。260R设备在接受对第一张表的星期一设置更改时才擦除FLASH ROM。 ### 2.3 用户（准进人员）管理 #### 2.3.1 增加一个用户（至260R设备） - COMMAND GROUP=0xF1或者0xF3，如果为0xF1，为协议版本为2.0时的协议格式，如果为0xF3，为协议版本为2.1时的协议格式，COMMAND TYPE=0XE3；DATAF=新用户描述。 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF1|DATAF2|DATAF3|DATAF4|DATAF5|DATAF6| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |2.0|0XF1|0XE3|卡片编号（5字节，HEX）|卡片编号（5字节，HEX）|用户编号ID（4字节，BCD）|用户密码（2字节，BCD）|有效期4字节（YYYY，MM，DD，BCD）|用户权限1字节（VIP，时段码）| |2.1|0xF3|0xE3|卡号长度（1字节，HEX）|卡片编号（10字节，HEX）|用户编号ID（4字节，BCD）|用户密码（2字节，BCD）|有效期4字节（YYYY，MM，DD，BCD）|用户权限1字节（VIP，时段码）| 示例： - f1 e3 0000000000 00000001 1234 20121231 00 - 7E 32 30 30 31 38 30 34 41 30 32 34 46 31 45 33 30 30 43 35 31 39 44 42 44 45 30 30 30 30 30 30 30 31 31 32 33 34 32 30 31 32 31 32 33 31 43 30 46 36 30 37 0D - F3 E3 0A 00000000000000000000 00000002 1234 20131231 00 **用户密码（2字节）**：260R设备固定为12H，34H。 **有效期（4字节）**：世纪、年，月，日（BCD），如：0X20，0X12，0X12，0X31，表示直到2012年12月31日才过期。 **用户权限（1字节）**：D7-D0（D0为低位BIT） - D7，D6=0，0：一般用户（受星期准进时段限制） - D7，D6=0，1：一般用户（受星期准进时段限制） - D7，D6=1，0：一般用户（受工作日/休息日准进时段限制） - D7，D6=1，1：特权用户（不受任何准进时段限制），但受有效期等限制。 （1）当D7，D6=1，0时，D5，D4，D3，D2：保留；D1，D0：一般用户的工作日的准进时段GROUP.No；    - 0，0：对应第一张表    - 0，1：对应第二张表    - 1，0：对应第三张表    - 1，1：对应第四张表 （2）当D7，D6=0，0或0，1时，D5，D4：保留；D3，D2，D1，D0：该用户适用的星期列表的第几张（索引系统的准进列表） 260R设备返回： - RTN=0，表示设置成功； - RTN=E3H，SU对260R设备内部参数的修改（或删除）不成功； - RTN=E4H，260R设备内部相应设置项的存储空间已满。 **注意**： 1. 对于用户权限字节，260R设备不判断D7，D6的内容，全部做为星期准进时段方式设置； 2. 用户编号ID，260R设备返回4个字节的0x00。 3. 设置名单时，若设备已有该名单，则直接更新该名单信息，不返回错误。 4. 如果是用2.1版本协议下发四个字节的卡号，则卡号的前面6个字节填0，后面四字节为真实卡号 #### 2.3.2 删除用户卡（从260R设备内） |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF1|DATAF2|DATAF3| | ---- | ---- | ---- | ---- | ---- | ---- | |2.0版本协议|0XF1|0XE4|1字节指引=0|某用户的5字节卡片编号|某用户的5字节卡片编号| |2.1版本协议|0xF3|0xE4|1字节指引＝0|卡号长度（1字节）=4 或=10|“6个字节0”+“4字节卡片编号” 或10字节卡片编号| 功能：将该卡号的用户从控制器内删除。 260R设备返回： - RTN=0，表示删除成功； - RTN=06H：260R设备接收的命令帧，数据信息部份有无效数据； - RTN=E3H，SU对260R设备内部参数的删除不成功。 #### 2.3.3 删除用户编号（ID）（从260R设备内）（没有用到用户编号，现不支持该命令） |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF1|DATAF2| | ---- | ---- | ---- | ---- | ---- | |2.0版本协议|0XF1|0XE4|1字节指引=1|1字节0 + 4字节用户编号（ID）| |2.1版本协议|0xF3|0xE4|1字节指引=1|1字节0 + 4字节用户编号（ID）| 功能：将该ID编号的用户从控制器内删除。 260R设备返回： - RTN=0，表示删除成功； - RTN=06H，260R设备接收的命令帧，数据信息部份有无效数据。 - RTN=E3H，SU对260R设备内部参数的修改（或删除）不成功。 #### 2.3.4 全部删除用户（从260R设备内） - COMMAND TYPE=0XE4 - DATAF=6字节，如下： |1字节指引|5字节卡片编号，或00+4字节用户ID| | ---- | ---- | |=2|5字节全为00，删除全部用户| 260R设备返回： - RTN=0，表示删除成功； - RTN=06H：260R设备接收的命令帧，数据信息部份有无效数据； - RTN=E3H，SU对260R设备内部参数的修改（或删除）不成功。 ### 2.4 设定门的特性参数 #### 2.4.1 门锁继电器执行时间（单独设定） - COMMAND TYPE=0XE6，DATAF1字节，（1--255），单位：0.1秒。 - 例如：DATAF=50（十进制），表对门锁继电器加电5秒钟。 260R设备返回：RTN=0。 #### 2.4.2 开门后等待进入的延时时间（单独设定） - COMMAND TYPE=0XE7，DATAF为1字节，（有效值20--255），单位：0.1秒。 - 例如：DATAF=50（十进制），表门锁打开后5秒钟内应开门进入，然后关门；保证门准确锁上。 260R设备返回：RTN=0。 ### 2.5 记录区的管理 控制器内历史记录的存储示意： （1）记录未满： ``` BOTTOM          LOADP              SAVEP              MAXLEN 未读 已读 ``` 260R设备的记录柜桶从BOTTOM到MAXLEN，深度=16384。从生产线下来的260R设备的LOADP与SAVEP都是BOTTOM（=0），表示无历史记录。 当260R设备有记录时就存储在当前SAVEP指向的位置，然后SAVEP加1； 当SU读取260R设备的历史记录时，260R设备根据SAVEP、LOADP的值计算有无历史记录，如有历史记录，就从LOADP指针位置读取一条历史记录给SU，同时LOADP自动加1； LOADP位置为最早（旧）的记录，SAVEP-1位置为最新的记录。 柜桶最大深度MAXLEN：表示260R设备存储历史记录的最大空间（条数）； 当该空间存储满后，260R设备将自动覆盖最早的记录（MF的D7=1），存储最新的记录，保留的最新记录MAXLEN条。260R设备的“覆盖”操作若改动“最后读取指针LOADP”，则MF的D0=1 如下计算有效记录数： （1）当SAVEP大于LOADP时，BOTTOM到LOADP的范围都是已经读取的记录区：LOADP至SAVEP-1都是未读取的已存储记录。 未读取记录数=SAVEP-LOADP 剩余空间=MAXLEN-未读取记录数 （2）当SAVEP小于LOADP时，表示记录存储已满并且对最旧记录有覆盖。 未读取的记录范围：从LOADP到TOP；以及从BOTTOM至SAVEP-1， 未读取记录数=TOP（MAXLEN）-LOADP+SAVEP-BOTTOM 最早的记录在SAVEP位置，而最新记录在SAVEP—1位置。 #### 2.5.1 初始化记录区（清空记录） - COMMAND TYPE=0XF0；DATAF5字节全部为0 260R设备返回：RTN=0。 #### 2.5.2 设定读指针 - COMMAND TYPE=0XF0；DATAF3字节 |第1字节|第2字节|第3字节| | ---- | ---- | ---- | |LOADP低位字节|LOADP高位字节|MF字节| MF（或LOADP-MF）字节的D7位：表示整个记录区已被历史记录写入过；D0位表示覆盖位。 260R设备返回：RTN=0。 #### 2.5.3 设定整个记录区指针 - COMMAND TYPE=0XF0；DATAF5字节 - SAVEP：（2字节）表示260R设备下一条记录存储的位置（低位在前）； - LOADP：（2字节）表示SU下一次读取记录的位置（低位在前）； - LOADP—MF（1字节） - D7=1，整个记录区已被历史记录写入过，都允许读取； - D7=0，允许读取从0（SAVEP-1的位置的记录 260R设备返回：RTN=0。 ### 2.6 远程开关门 #### 2.6.1 单一放行（不带系统操作员信息） - COMMAND TYPE=0XED，DATAF1字节时，=1开门；=0不操作； 260R设备返回：RTN=0。 #### 2.6.2 单一放行（带系统操作员信息） - COMMAND TYPE=0XED；DATAF=6字节 |第1字节|后5字节| | ---- | ---- | |=1开门 =0不操作|操作员编号信息 存放在远程开门记录结构中的前5字节| 260R设备返回：RTN=0。 5字节的操作员代码只使用后4个，首字节补0。 ### 2.7 设置参数 - CID2=0x80；COMINFO具体如下： |起始符|命令|长度|命令序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |0XFF|0X61|0X1D|0X61|设置参数数据||0XFE| 说明：数据长度固定为0X1C；数据包括如下内容： 区号（6BIT），站号（10BIT），注册码（1BYTE）和用户码（2BYTE），继电器时间（3BYTE），屏蔽时间（2BYTE），恢复提示时间（1BYTE），黑白名单工作方式（4BIT 低位0：白名单；1：黑名单），门数目（4BIT 高位），黑（白）名单数目（2BYTE 暂未使用），时间（7BYTE+1BYTE=0X89）+清除告警（1BYTE=0X89）+是否启动主动上传（1BYTE0：否；1：是）+工作模式（1BYTE 0：使用内部协议；1：使用艾默生协议格式）+485读卡头数目（1BYTE）+新增红外等参数（1BYTE）+预留（1BYTE） 设备应答DATAINFO如下： |起始符|命令|长度|应答序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |FF|0X00|0X01|0X61|无||FE| 260R设备返回：RTN=0。 ### 2.8 增加白、黑名单 - CID2=0x80；COMINFO如下： |起始符|命令|长度|命令序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |0XFF|0X58|0X03 + 数目＊4|0X58|类型（白名单或白名单）+总数目+数据||0XFE| 备注：系统支持黑名单和白名单两种工作方式，一个用户系统的工作方式只能是其中一种。所以协议需要指明工作方式。 设备正确执行返回结果： |命令|长度|应答序号|数据|校验| | ---- | ---- | ---- | ---- | ---- | |0X00|0X01|0X58|无|| ### 2.9 减少白、黑名单 - CID2=0x80；COMINFO如下： |起始符|命令|长度|命令序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |0XFF|0X59|0X03 + 数目＊4|0X59|类型（白名单或白名单）+总数目+数据||0XFE| 备注：系统支持黑名单和白名单两种工作方式，一个用户系统的工作方式只能是其中一种。所以协议需要指明工作方式。 设备正确执行返回结果： |命令|长度|应答序号|数据|校验| | ---- | ---- | ---- | ---- | ---- | |0X00|0X01|0X59|无|| ## 三、读取信息命令 SU随时都可以对260R设备的历史记录，监控状态等进行读取。 SU发送的命令帧： SU发送读取命令的COMMAND INFO部分如下： |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF|备注| | ---- | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XE0至0XEF|1字节（读取记录命令时，2字节）|| |V2.1|0XF4|0XE0至0XEF|1字节（读取记录命令时，2字节）|3.2读取记录信息（V1.1） 3.4读取用户信息（V1.1）| ### 3.1 读取260R设备的实时钟 - CID2=4AH - COMMAND TYPE=0XE0; DATAF (1字节)=0 260R设备返回： DATAINFO：年（2），月，日，星期，时，分，秒，共8字节BCD。其中：年（2字节）：2000-2099 示例：7E32303031383034413030303046324530464342335E ### 3.2 读取记录信息 #### 3.2.1 读取历史记录柜桶参数 - CID2=4AH - COMMAND TYPE=0XE1; DATAF(1字节)=0 260R设备返回：DATAINFO(9字节）： - 桶底BOTTOM（2字节）； - 下一次新记录存放指针SAVEP（2字节）； - 下一次读取记录位置指针LOADP（2字节） - 260R设备已修改LOADP标志MF（1字节）（D0=0 未修改）。 - 柜桶最大深度MAXLEN（2字节）； 260R设备的记录柜桶从BOTTOM到MAXLEN，深度=16384。从生产线下来的260R设备的LOADP与SAVEP都是BOTTOM（=0），表示无历史记录。 当260R设备有记录时就存储在当前SAVEP指向的位置，然后SAVEP加1； 当SU读取260R设备的历史记录时，260R设备根据SAVEP、LOADP的值计算有无历史记录，如有历史记录，就从LOADP指针位置读取一条历史记录给SU，同时LOADP自动加1； LOADP位置为最早（旧）的记录，SAVEP-1位置为最新的记录； 柜桶最大深度MAXLEN：表示260R设备存储历史记录的最大空间（条数）； 当该空间存储满后，260R设备将自动覆盖最早的记录（MF的D7=1），存储最新的记录，保留的最新记录MAXLEN条。260R设备的“覆盖”操作若改动“最后读取指针LOADP”，则MF的D0=1； 如下计算有效记录数： （1）当SAVEP大于LOADP时 BOTTOM到LOADP的范围都是已经读取的记录区：LOADP至SAVEP-1都是未读取的已存储记录。 未读取记录数=SAVEP-LOADP； 剩余空间=MAXLEN-未读取记录数； （2）当SAVEP小于LOADP时，表示记录存储已满并且对最旧记录有覆盖。 未读取的记录范围：从LOADP到TOP；以及从BOTTOM至SAVEP-1； 未读取记录数=TOP（MAXLEN）-LOADP+SAVEP-BOTTOM 最早的记录在SAVEP位置，而最新记录在SAVEP—1位置。 **说明**： （1）260R设备内未存满（未覆盖最早历史记录） ``` BOTTOM          LOADP              SAVEP              MAXLEN 已读取过         未读取过             空白区 ``` SU只能读取BOTTOM（=0）至SAVEP—1的区段之有效记录。 BOTTOM位置为最早（旧）的记录，SAVEP—1位置为最新的记录。 SAVEP至MAXLEN—1区间都是空白区。 （2）260R设备内已存满（已覆盖最早历史记录） ``` BOTTOM         SAVEP                  LOADP              MAXLEN 至最新                 由最早                 新 ``` 整个记录区都有历史记录写入过。 SU能读取整个记录区的记录，记录最早（旧）至最新存放位置： SAVEP ( MAXLEN ( BOTTOM ( SAVEP — 1 SAVEP—1位置为最新记录，而SAVEP位置为最早（旧）记录。 #### 3.2.2 顺序读取一条历史记录 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XE2|=0| |V2.1|0XF4|0XE2|=0| 示例： - 7E 32 30 30 31 38 30 34 41 41 30 30 36 46 32 45 32 30 30 46 43 33 41 0D - 7E 32 31 30 31 38 30 34 41 41 30 30 36 46 34 45 32 30 30 46 43 33 37 0D DATAF无或1字节（无定义） 260R设备从LOADP位置读取一条记录返给SU，260R设备自动将LOADP指向下一条记录。 |协议版本|DATAINFO1|DATAINFO2|DATAINFO3|DATAINFO4|DATAINFO5| | ---- | ---- | ---- | ---- | ---- | ---- | |V2.0|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）|备注（1字节）（REMARK）|| |V2.1|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）|备注（1字节）（REMARK）|| **说明**： 1. 260R设备返回：DATAINFO为DATAF位置的一条记录，参见附录1。 2. 如果返回RTN=0x04，则表示门禁内部相应设置项的存储空间已空。 3. 当下发协议版本为2.1，COMMAND GROUP为0xF4时的数据返回，在刷卡记录中，事件来源为“卡号长度（1字节）+卡号（10字节）”，卡号长度为4字节时，前面的6个字节填0，后边4字节填卡号。对其它记录，事件来源的前6字节都补0，后5字节按原来格式填写。下同 #### //3.2.3 随机读取记录（指定位置读取） - CID2=4AH；COMMAND TYPE=0XE2 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XE2|2字节参数，低位在前| |V2.1|0XF4|0XE2|2字节参数，低位在前| DATAF（2字节）参数（低位在前）， 260R设备以DATAF位LOADP值，在此位置读取一条历史记录，260R设备不改变原LOADP值。 |协议版本|DATAINFO1|DATAINFO2|DATAINFO3|DATAINFO4| | ---- | ---- | ---- | ---- | ---- | |V2.0|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| |V2.1|事件来源（10+1字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| 如果260R设备内历史记录已全部读完（LOADP位置已是空白），或参数DATAF指向空白记录区，260R设备将返回错误提示，返回RTN=0x04。 260R设备返回：DATAINFO为DATAF位置的一条记录 #### //3.2.4 附带顺序号读取记录（防止丢失记录） |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XEE|1字节=1| |V2.1|0XF4|0XEE|1字节=1| DATAF1字节=1，260R设备将LOADP位置的历史记录，连同LOADP本身一并返回。 |协议版本|DATAINFO前2字节|后N个字节1|后N个字节2|后N个字节3|后N个字节4|后N个字节5| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |V2.0|读出记录的位置LOADP值|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）|| |V2.1|读出记录的位置LOADP值|事件来源（10+1字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）|| 如果，控制器内已全部读完，返回：无记录标识。携带LOADP读记录的意义在于：LOADP在0---TOP之间是顺序的，可以判断在读记录的操作中有无发生因RS485线路问题造成记录丢失。 #### 3.2.5 查询控制器的最新事件记录 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XEE|1字节=0| |V2.1|0XF4|0XEE|1字节=0| 示例：7E 32 31 30 31 38 30 34 41 41 30 30 36 46 34 45 45 30 30 46 43 32 34 0D 监控主机将最新发生的事件记录原形返回， |协议版本|DATAINFO1|DATAINFO2|DATAINFO3|DATAINFO4| | ---- | ---- | ---- | ---- | ---- | |V2.0|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| |V2.1|事件来源（10+1字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| DATAF1字节=0，260R设备将最新发生的事件记录原形返回，最新事件包括：刷卡、门磁告警、手动开门等。 ### 3.3 读取时段 #### 3.3.1 读取星期一至星期日的准进时间表 - CID2=4AH；COMMAND TYPE=0XEB - DATAF2字节， - 第一字节：指定读取第几张表（有效值0-15表示第1至第16张表； - 第二字节：该表内星期几(1-7，=7表示星期日) 每张准进列表罗列7天（星期一至星期日），而每天共有6个“起始时间(结束时间”的准进时段罗列，每个准进罗列用4字节表示。每张表共用：7×6×4=168字节。每次只能读取某张表的某一天之准进时间段的列表(24字节)； 260R设备返回：DATAINFO24字节（BCD）（准进时间段列表） 起始时间-------- 结束时间： ``` HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) HH：MM (起始) ( HH:MM (结束) ``` **注意**： 读取编号为5～15的表，260R设备返回DATAINFO填24个字节的0X00。 ### 3.4 读取用户信息 #### 3.4.1 读取已存储的用户数目 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XE5|1字节=0| |V2.1|0XF4|0XE5|1字节=0| 示例：7E 32 31 30 31 38 30 34 41 41 30 30 36 46 34 45 35 30 30 46 43 33 34 0D 260R设备返回：DATAINFO（2字节HEX），表示数量，低8位在前，高8位在后。 #### 3.4.2 读取指定存储位置的用户登记资料 这条命令在SU通过权限确认后，才能得到正确返回值。 |协议版本|COMMAND GROUP|COMMAND TYPE|DATAF| | ---- | ---- | ---- | ---- | |V2.0|0XF2|0XE6|2字节| |V2.1|0XF4|0XE6|2字节| CID2=4AH，COMMAND TYPE=0XE6; DATAF（2字节HEX数）260R设备内用户列表中，读取指定存储位置的用户（低位在前，例如0X01，0X02表示第513个用户）。 260R设备返回：RTN=0 |协议版本|DATAINFO1|DATAINFO2|DATAINFO3|DATAINFO4|DATAINFO5|DATAINFO6|DATAINFO7| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |V2.0|卡片编号（5字节，HEX）|卡片编号（5字节，HEX）|用户编号ID（4字节，BCD）|用户密码（2字节，BCD）|有效期4字节（YYYY，MM，DD，BCD）|用户权限1字节（VIP，时段码）|用户权限1字节（VIP，时段码）| |V2.1|卡号长度（1字节，HEX）|卡片编号（10字节，HEX）|用户编号ID（4字节，BCD）|用户密码（2字节，BCD）|有效期4字节（YYYY，MM，DD，BCD）|用户权限1字节（VIP，时段码）|用户权限1字节（VIP，时段码）| 260R设备返回：RTN=0XE0，无权限读取用户资信，无DATAINFO项。 **注意**： 260R设备返回中用户编号ID填4个字节的0X00，密码填2个字节的0X00。 #### 3.4.3 查询指定用户编号（ID）的用户是否存在 - CID2=4AH - 这条命令在SU通过权限确认后，才能得到正确返回值。 - COMMAND TYPE=0XE6; DATAF=4字节待查询的用户编号 260R设备返回：RTN=0X00。 ### 3.5 远程监控 - CID2=4AH；COMMAND TYPE=0XE7；DATAF1字节）=0 260R设备返回：DATAINFO（2字节） 第一字节：260R设备的工作状态： - D7=0：260R设备内实时钟IC正常；=1 不正常。 - D6=0：260R设备内存储器正常；=1 不正常。 - D5=0：260R设备的工作电源正常；=1 不正常，供电电压低而CPU被频繁复位。 - D4，D3=0，0：保留； - D2=0：不监视门开关；=1监视。 - D1=0：门控电磁继电器关闭，=1加电驱动。 - D0=0：正常工作，=1处于报警状态。 第二字节：260R设备监控线路的状态： - D7：紧急驱动输入。 - D6，D5，D4=0，0，0。 - D3=0：门关闭，=1 开启。 - D2=0。 - D1=0：手动开门键松开，=1 按下。 - D0=0：门控电磁继电器关闭，=1 加电驱动。 ### 3.6 读取工作特性参数 #### 3.6.1 读取控制信息 - CID2=4AH；COMMAND TYPE=0XE8；DATAF（1字节）=0 260R设备返回：DATAINFO（5字节） 第一字节：门碰开关，红外状态控制字（D0低位） |BIT位|控制|说明| | ---- | ---- | ---- | |D7|=0|不监控门开关状态| ||=1|监控门开关状态(通过门磁)，异常报警 （1）非正常开门；（2）不能自动关门的锁，刷卡后无开门后--再关门的机械动作；（3）开门延时结束后，还未关门；| |D6=0|D6=0|D6=0| |D5|=1|必须靠“开门——再关门”机械动作的弹力才能锁上；| |D4|=0|允许 “手动开门”输入线在与电源地线短接时，能开门. =1，禁止.| |D3|=0|设定门磁输出电平为：开门时门磁两信号线是短路（通）；门关上后，两信号线开路（不通）| ||=1|设定门磁输出电平为：开门时门磁两信号线是断路（开）；门关上后，两信号线短路合上（通）| |D2、D1、D0=0，0，0|D2、D1、D0=0，0，0|D2、D1、D0=0，0，0| 注：如果260R设备没有这个功能，相应的BIT位填0。 第二字节：门锁继电器的执行时间（0.1秒为单位）； 第三字节：开门等待进入的延时时间（0.1秒为单位）； 第四字节：未定义 第五字节：感应卡的号码获取方法控制字； ### 3.7 读取设备名称及版本号 - CID2=4AH - COMMAND TYPE=0XEF；DATAF（1字节）=0 260R设备返回：DATAINFO18字节，为设备名称及版本，设备名称与版本号之间用“，”隔开。 例如260R设备VER5.01或其他版本。 注：设备名称及版本以ASCII码格式返回。 ### 3.8 读取所有通道值 - CID2=4AH；COMMAND TYPE=0X7F； - 示例：7E 32 31 30 31 38 30 34 41 43 30 30 34 46 34 37 46 46 43 39 31 0D 返回16个通道及所有输出的值共54个字节。格式如下： 前48个字节为通道的值，每个通道占用3个字节，告警信息（1字节）+通道值（2字节）总共3×16=48个字节。如果通道无设置，则格式为10 00 00；如果为数字通道，则告警信息项，有告警为1，无告警为0，通道值高电平为FF FF，低电平为00 00；模拟通道，则告警信息项，下告为1，上告为2，无告警为0，通道值则为模拟量的值。 第49，50，51个字节为光耦及继电器的输出状态。第49、50字节为16路光耦输出状态，第51字节为8个继电器的输出状态。 第52个字节八位从低位起分别对应三相电压过低，三相电压过高，三相电缺相，三相电断电，门禁1告警，门禁2告警，盗情1告警，盗情2告警等八个项目的告警输出。 第53、54个字节返回值为0。 ### 3.9 读取下挂传感器通道值 - CID2=4AH - COMMAND TYPE=0X9F；DATAF(n字节)，第一个字节为0时读取所有（32个）扩展通道，第一个字节为其他值N（1~31）时，表示后面的N个字节为所要读取的对应扩展通道的编号。 返回N个通道值共3*N个字节。格式如下： 每个通道占用3个字节，告警信息（1字节）+通道值（2字节）。如果无效通道，则格式为10 00 00；如果为数字通道，则告警信息项，有告警为1，无告警为0，通道值高电平为FF FF，低电平为00 00；模拟通道，则告警信息项，下告为1，上告为2，无告警为0，通道值则为模拟量的值。对于有效通道，连续10次收不到传感器的回复，则认为传感器异常，则对应数据格式为00 F0 F0。 通道值为有符号的2字节整形=实际值*100；如0x09E8，对应的实际值为25.36 ### 3.10 参数读取 - CID2=0x80 - COMINFO如下： |起始符|命令|长度|命令序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |FF|0X60|01|0X60|无||FE| 设备正确执行返回结果： |起始符|命令|长度|应答序号|数据|校验|结束符| | ---- | ---- | ---- | ---- | ---- | ---- | ---- | |FF|00|0X1D|0X60|设置参数数据||FE| 说明：数据长度固定为0X14；数据包括如下内容： 区号（6BIT），站号（10BIT），注册码（1BYTE）和用户码（2BYTE），继电器时间（3BYTE），屏蔽时间（2BYTE），恢复提示时间（1BYTE），黑白名单工作方式（4BIT 低位0：白名单；1：黑名单），门数目（4BIT 高位），黑（白）名单数目（2BYTE 暂未使用），时间（7BYTE+1BYTE=0X89）+清除告警（1BYTE=0X89）+是否启动主动上传（1BYTE0：否；1：是）+工作模式（1BYTE 0：使用内部协议；1：使用艾默生协议格式）+485读卡头数目（1BYTE）+新增红外等参数（1BYTE）+预留（1BYTE） 注意：时间按照BCD码，如20日20分应为0X20日0X20分，星期采用1~7表示 ### 3.11 数据包内嵌协议 将原来的通用版本的协议作为2M版本协议的数据包内嵌到本协议里面，可内嵌的指令见附录2。 CID2=0x81 如原来的通用版本的数据包（Hex表示）为FF 00 00 00 00 00 00 00 00 A6 00 02 00 01 A5 FE，现在内嵌到2M版本通信协议里面，代码为81h，则数据包为： 7E 20 01 80 81 E0 20 FF 00 00 00 00 00 00 00 00 A6 00 02 00 01 A5 FE F7 0E 0D 应答时，原来通用版本协议的应答数据作为2M版本协议的数据包，并且应答代码为00H，如原来应答数据包（Hex表示）：FF 00 00 00 00 01 02 03 04 00 A6 00 A2 FE 则应答数据为7E 20 01 80 00 30 1C FF 00 00 00 00 01 02 03 04 00 A6 00 A2 FE F7 D3 0D ### 3.12 通信命令中的参数说明 所有日期，时间都用BCD格式，例如：0X99，表示99年；而99（十进制）不是99年。例如：0X10，表示10月，或10时等。 所有数值或地址参数，由SU命令带入260R设备，或260R设备返回SU，都是低8位数再前，高8位在后，以HEX（或BCD）形式表示，如：SAVEP，LOADP等指针，有效用户数量等数值。 SU命令中CID1（1字节）参数是用以区分设备类别，如电源类，环境类设备等。在260R设备，CID1还作为扩展260R设备的ID号用，当一个系统中使用的260R设备数量多于254个，可将260R设备分组，组号从0---15，每组最多可以254个260R设备。 |CID1（1字节HEX）高半字节|CID1（1字节HEX）低半字节| | ---- | ---- | |=8（固定，表示260R设备类）|组号（0---15）| 注：260R设备2M软件版本同时兼容通用版本的通信协议。 ## 附录1: 260R设备通信协议的历史记录格式 260R设备对如下事件的发生都有记录： - 刷卡开门 (记录卡号及开门时间等)； - 开门记录， 关门记录； - 手动开门； - 远程（由SU）开门； - 联动输入引起开门； - 260R设备内控制参数被修改。 |协议版本|DATAINFO1|DATAINFO2|DATAINFO3|DATAINFO4| | ---- | ---- | ---- | ---- | ---- | |V2.0|事件来源（5字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| |V2.1|事件来源（10+1字节）（卡号或ID号等）|日期，时间（7字节）（年（2），月，日，时，分，秒）|状态（1字节）（STATUS（D7—D0））|备注（1字节）（REMARK）| 备注（1字节）：（D7-D0，其中D0最低位）的D7=0 表示该条历史记录从未被SU读取过；D7=1表示该条历史记录已被SU读取过。 1. REMARK=0 刷卡开门记录 “事件来源”=5字节卡号 STATUS： - D7=0； - D6=0：原来门处于关状态，=1 开状态； - D5=0； - D4=0：在开门等待进入延时后，门已正常关闭，=1 仍然开的； - D3=0； - D2=0：进门标志，=1出门标志； - D1=0； - D0=0。 2. REMARK=2 远程(由SU)开门记录 “事件来源”=5字节全0或由上位机带入的操作员编号 STATUS： 同“REMARK=0”的STATUS描述； 3. REMARK=3 手动开门记录 “事件来源”=5字节全0 STATUS： 同“REMARK=0”的STATUS描述； 4. REMARK=22H 紧急联动事件开始 “事件来源”=5字节全0 STATUS： =0 5. REMARK=22H 紧急联动事件结束 “事件来源”=4字节全0 + 第五字节=1 STATUS： =0 6. REMARK=5 报警 (或报警取消) 记录 “事件来源”=4字节全0+报警源 AS(1字节) AS=2：门开记录； AS=3：门关闭记录； AS=6：260R设备内部存储器发生错误，260R设备自动进行了初始化操作； AS=9：门碰开关监测被关闭； AS=10：门碰开关监测开启； STATUS：记录发生时的输入线状态： - D0=0； - D1=0：手动按键松开，=1 按下； - D2=0； - D3=0：门处于关状态，=1 门处于开状态； - D4—D7 保留。 7. REMARK=6 260R设备掉电记录 “事件来源”=260R设备重新上电的日期，时间：月，日，时，分，秒； STATUS：重新上电时的输入线状态： - D0=0； - D1=0：手动按键松开，=1按下； - D2=0； - D3=0：门处于关状态，=1 门处于开状态； - D4—D7 保留。 8. REMARK=7 内部控制参数被修改的记录 “事件来源”=4字节全0 + 修改标记(1字节) 修改标记(1字节) - D0=1：修改了260R设备的密码； - D1=1：修改了门的特性控制参数； - D2=1：增加了新用户； - D3=1：删除了用户资料； - D4=1：修改了实时钟； - D5=1：修改了控制准进的时段设置； - D6=1：修改了节假日列表； - D7=1：修改了红外开启（关闭）的设置控制字； 9. REMARK=8 无效的用户卡刷卡记录。 “事件来源”=5字节卡号； STATUS：类似上述6项的“REMARK=5”中描述。 10. REMARK=9 用户卡的有效期已过。 “事件来源”=5字节卡号； STATUS：类似“REMARK=5”中描述。 11. REMARK=10 当前时间该用户卡无进入权限。 “事件来源”=5字节卡号 STATUS：类似 “REMARK=5” 中描述。 12. REMARK=11 非法开门事件。 “事件来源”=5字节的0x00 STATUS：0x00。 13. REMARK=12 非法离开事件。 “事件来源”=5字节卡号 STATUS：0x00。 14. REMARK=13 离开未关门事件。 “事件来源”=5字节卡号 STATUS：0x00。 15. REMARK=14 巡检卡事件。 “事件来源”=5字节卡号 STATUS：0x00。 ## 附录2: 2M版本支持的通用协议 以下为2M版本支持的通用协议命令号，可使用FF…FE格式直接发送或使用7E…0D的内嵌指令。不同版本的2M嵌入式软件支持的通用协议可能略有区别，本文档修订时参考BASS-260R 2M3.56&1.56。（2012.5.29） |命令号|说明| | ---- | ---- | |0x02|设备初始化| |0x03|设置地址| |0x04|读取地址| |0x05|读取版本号| |0x06|设置系统时间| |0x07|读取系统时间| |0x08|设置是否主动上送| |0x09|读取是否主动上送| |0x0E|读取当前节能状态| |0x10|读取通道值| |0x11|设置通道属性| |0x12|读取通道属性| |0x13|设置密码| |0x14|读取密码| |0x16|读取历史告警| |0x17|远程控制继电器输出| |0x18|读取继电器输出| |0x19|读取当前告警| |0x23|设置电话号码| |0x24|读取电话号码| |0x28|设置节能参数| |0x29|读取节能参数| |0x2A|远程设防撤防| |0x30|设置锁与读卡头| |0x31|读取锁与读卡头| |0x32|设置门禁参数| |0x33|读取门禁参数| |0x36|增加黑白名单| |0x37|减少黑白名单| |0x38|清空黑白名单| |0x39|读取黑白名单| |0x3A|开锁| |0x3B|设置时段信息| |0x3C|读取时段信息| |0x3D|设置监控中心号码| |0x3E|读取监控中心号码| |0x3F|屏蔽门禁告警| |0x41|设置告警屏蔽时段| |0x42|读取告警屏蔽时段| |0x43|按照地址设置参数| |0x44|按照地址读取参数| |0x45|读取远程控制继电器输出| |0x51|设置风机关闭温度| |0x52|读取风机关闭温度| |0x53|设置卡类型| |0x54|读取卡类型| |0x60|设置通道属性| |0x63|增加临时卡| |0x80|短信开门第一步| |0x81|短信开门第二步| |0x90|读取智能设备数据| |0x91|远程控制空调| |0x92|远程控制开关电源| 完整协议参见《BASS-260R门禁门禁监控系统通讯协议V2.0》。